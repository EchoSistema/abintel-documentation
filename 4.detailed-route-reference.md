# 4.1 Customer Intelligence

**Customer Intelligence endpoints**:  
`purchasing_segmentation*`, `segmentation_report*`, `segment_hierarchy_chart`, `segment_subsegment_explore`, `segment_cluster_profiles`, `customer_segmentation`, `customer_features`, `customer_loyalty`, `customer_rfm`, `customer_clv_features`, `customer_clv_forecast`, `churn_risk`, `nps`, `churn_label`

---

# 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Purpose
Autonomously cluster customers; returns labels, centroids, KPIs, and plain-language personas.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value         |
|---------------------|--------------|
| `X-Customer-Api-Id` | `<uuid>`     |
| `X-Secret`          | `<secret>`   |
| `Content-Type`      | `application/json` |

### Request
```yml
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```
### Body:
```json
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "loyalty_score": 0.72,
        "recency_days": 15
      }
    }
  ]
}
```

#### Request Body Schema

| JSON Key             | Type              | Required | Description                                  | Notes/Formula                              |
|----------------------|-------------------|----------|----------------------------------------------|--------------------------------------------|
| `max_clusters`       | integer ≥ 2       | optional | Upper bound for K-Means & GMM                | Recommend 8–15 for 5k–200k customers       |
| `dbscan_eps`         | float (0 < ε ≤ 1) | optional | Radius for DBSCAN after z-score scaling      | Start at 0.35–0.45                         |
| `dbscan_min_samples` | integer ≥ 3       | optional | Minimum neighbors for DBSCAN core point      | Use 5 (default); adjust for dataset size   |
| `data`               | array<object>     | required | List of customer objects with features       | 12–18 months of transaction data typical   |

#### Features Inside `data[].features`

| Feature             | Type/Range   | Business Definition                          | SQL/Python Example                          |
|---------------------|--------------|----------------------------------------------|---------------------------------------------|
| `purchase_total`    | float ≥ 0    | Lifetime revenue in observation window       | `SUM(order_total)`                          |
| `visit_frequency`   | integer ≥ 0  | Number of distinct purchase sessions         | `COUNT(DISTINCT order_date)`                |
| `avg_ticket`        | float ≥ 0    | Average value per purchase                   | `purchase_total / NULLIF(visit_frequency,0)`|
| `product_diversity` | integer ≥ 0  | Count of distinct product categories         | `COUNT(DISTINCT category_lvl1)`             |
| `loyalty_score`     | float (0–1)  | Normalized loyalty score from points or RFM  | `current_points / max_points_cap`           |
| `recency_days`      | integer ≥ 0  | Days since last order                        | `DATEDIFF(CURRENT_DATE, MAX(order_date))`   |

#### Example Response
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    }
  ],
  "clusters": [],
  "customer_labels": []
}
```

#### Response Keys
| Key                   | Type          | Meaning                                         | Usage                                  |
|-----------------------|---------------|-------------------------------------------------|----------------------------------------|
| `best_algorithm`      | string        | Model with highest silhouette/lowest Davies-Bouldin | Store with run-ID for A/B testing      |
| `evaluation_metrics`  | array<object> | Benchmarks for each algorithm + params           | Monitor in ML-Ops dashboards, rerun if needed |
| `clusters`            | array<object> | Summary of each cluster: ID, size, centroids     | For campaigns, loyalty tiers, bundles  |
| `customer_labels`     | array<object> | Mapping of each `customer_id` → `cluster_id`     | Join back to CRM/CDP for audiences     |

---


# 4.1.2 `/api/v1/ai/customer_features`

### Purpose
Generate a clean, analytically-ready feature vector for every customer by rolling up raw transaction rows (and any supplied loyalty metadata).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json
```
### Response
```json
{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key           | Type / Range          | Required     | Meaning                          | How to obtain / SQL formula                        |
|--------------------|----------------------|--------------|-----------------------------------|----------------------------------------------------|
| `today`            | ISO date (YYYY-MM-DD)| Optional     | Reference date for recency        | `CURRENT_DATE` or pipeline parameter               |
| `customers`        | array<object>        | Yes          | Customer snapshot list            | From daily ETL query                               |
| ↳ `customer_id`    | string               | Yes (unique) | CRM/ERP primary key               | `orders.customer_id`                               |
| ↳ `loyalty_score`  | float (0–1)          | Optional     | Precomputed loyalty or RFM score  | `points / max_points_cap` or `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>        | Yes (≥1)     | Raw transaction data              | Use 12–18 months of history                        |
| ↳ `transaction_id` | string               | Yes          | Order ID                          | `orders.order_id`                                  |
| ↳ `date`           | ISO date             | Yes          | Transaction date                  | `orders.order_date`                                |
| ↳ `amount`         | float ≥ 0            | Yes          | Order total                       | `orders.order_total`                               |
| ↳ `product_id`     | string               | Yes          | SKU or category ID                | `order_items.product_id`                           |

#### Calculated Features

| Feature Key         | Formula                      | Business Interpretation         |
|---------------------|-----------------------------|---------------------------------|
| `purchase_total`    | `SUM(amount)`                | Lifetime spend (GMV)            |
| `visit_frequency`   | `COUNT(transactions)`        | Number of purchase occasions    |
| `avg_ticket`        | `purchase_total / visits`    | Average basket size             |
| `product_diversity` | `COUNT(DISTINCT product_id)` | Breadth of purchase             |
| `loyalty_score`     | passed or `0.0`              | Loyalty indicator               |
| `recency_days`      | `DATEDIFF(today, MAX(date))` | Time since last purchase        |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 918.95,
        "visit_frequency": 2.0,
        "avg_ticket": 459.48,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

#### Response Keys

| Key Path        | Type   | Meaning                 | Usage                                   |
|-----------------|--------|-------------------------|-----------------------------------------|
| `customers[]`   | array  | Each entry = 1 customer | Send to `/purchasing_segmentation`, etc.|
| ↳ `customer_id` | string | Echoes the ID sent      | For joins with CRM/CDP                  |
| ↳ `features`    | object | Vector of 6 KPIs        | Store in feature store or DB            |

> **Why these six features?**  
> They capture monetary, frequency, breadth, loyalty and time dimensions—covering > 80% of purchase-behaviour variance.

---

# 4.1.3 `/api/v1/ai/customer_loyalty`

### Purpose
Calculate a 0–1 loyalty index for every customer using weighted behavioral metrics, then bucket them into business-friendly segments.  
Default tiers: Platinum, Gold, Silver, Bronze, At-Risk.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value              |
|----------------------|------------------- |
| `X-Customer-Api-Id`  | `<uuid>`           |
| `X-Secret`           | `<secret>`         |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_loyalty
Content-Type: application/json

{
  "weights": {
    "purchase_total": 0.25,
    "visit_frequency": 0.30,
    "avg_ticket": 0.10,
    "product_diversity": 0.15,
    "recency_days": 0.20
  },
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "recency_days": 15
      }
    }
  ]
}
```

#### Example Response
```json
{
  "customers": [
    { "customer_id": "C-1001", "loyalty_score": 1.0,    "segment": "Platinum" },
    { "customer_id": "C-1002", "loyalty_score": 0.87,   "segment": "Platinum" }
  ],
  "summary": {
    "mean_score": 0.94,
    "median_score": 0.94,
    "top_decile_threshold": 0.98,
    "segment_counts": {
      "Platinum": 2,
      "Silver":   0,
      "At-Risk":  0
    }
  }
}
```

#### Response Keys

| Key Path                       | Type        | Meaning                                    | Usage                                          |
|--------------------------------|-------------|--------------------------------------------|------------------------------------------------|
| `customers[].loyalty_score`    | float (0–1) | Min-max weighted loyalty index (1 = best)  | Feed into CRM tiers, bid multipliers, exports  |
| `customers[].segment`          | enum        | Default segment tier                       | Override via `segment_thresholds`, remap       |
| `summary.mean_score`           | float       | Average score across cohort                | Track monthly loyalty health                   |
| `summary.top_decile_threshold` | float       | 90th percentile score                      | Use as VIP threshold in campaigns              |
| `summary.segment_counts`       | object      | Distribution across loyalty tiers          | Planning perks, rewards, support resources     |

**Default Segments:**  
- **Platinum:** ≥ 0.85  
- **Gold:** 0.70–0.84  
- **Silver:** 0.50–0.69  
- **Bronze:** 0.30–0.49  
- **At-Risk:** < 0.30  

---
# 4.1.4 `/api/v1/ai/customer_rfm`

### Purpose
Classic RFM (Recency-Frequency-Monetary) scoring, binned into lifecycle tiers (Champion, Loyal, At-Risk, etc.).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_rfm
Content-Type: application/json

{
  "bins": 5,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2025-04-21", "amount": 520.55 },
        { "date": "2025-03-29", "amount": 310.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2025-01-05", "amount": 120.00 },
        { "date": "2024-12-19", "amount": 75.90 }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key         | Type / Range   | Required | Meaning                       | Guideline / SQL Derivation     |
|------------------|----------------|----------|-------------------------------|-------------------------------|
| `bins`           | integer 2–10   | Optional | Number of buckets per metric  | Default = 5 (quintiles)       |
| `today`          | ISO date       | Optional | Reference date for recency    | Omit → server date            |
| `customers`      | array<object>  | Required | List of customer transactions | Output of nightly ETL         |
| ↳ `customer_id`  | string         | Required | Primary key                   | `orders.customer_id`          |
| ↳ `transactions` | array<object>  | Required | List of order events          | 6–18 months typical           |
| ↳ `date`         | ISO date       | Yes      | Order date                    | —                             |
| ↳ `amount`       | float ≥ 0      | Yes      | Order value                   | —                             |

#### Calculated Metrics

| Metric           | Formula                         |
|------------------|---------------------------------|
| `recency_days`   | `DATEDIFF(today, MAX(date))`    |
| `frequency`      | `COUNT(transactions)`           |
| `monetary_total` | `SUM(amount)`                   |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "recency_days": 3,
      "frequency": 2,
      "monetary_total": 830.55,
      "recency_score": 5,
      "frequency_score": 4,
      "monetary_score": 5,
      "rfm_class": "545",
      "rfm_total": 14,
      "rfm_tier": "Champion",
      "interpretation": "Champions – recent, frequent and high-value"
    },
    {
      "customer_id": "C-1002",
      "recency_days": 109,
      "frequency": 2,
      "monetary_total": 195.9,
      "recency_score": 1,
      "frequency_score": 2,
      "monetary_score": 2,
      "rfm_class": "122",
      "rfm_total": 5,
      "rfm_tier": "At-Risk",
      "interpretation": "At-Risk – infrequent, low recent activity"
    }
  ],
  "thresholds": {
    "recency":   [66.6, 24.2, 2.6, 1.8],
    "frequency": [2.4, 2.8, 3.2, 3.6],
    "monetary":  [381.54, 567.18, 773.79, 1001.37]
  }
}
```

#### Response Keys

| Key Path            | Type      | Meaning                                   | Usage                       |
|---------------------|-----------|-------------------------------------------|-----------------------------|
| `customers[]`       | array     | Each entry = 1 customer                   | Segmentation & targeting    |
| ↳ `recency_days`    | int       | Days since last purchase                  | Recency metric              |
| ↳ `frequency`       | int       | Number of transactions                    | Frequency metric            |
| ↳ `monetary_total`  | float     | Total spent                               | Monetary metric             |
| ↳ `recency_score`   | int       | Score for recency (1–bins)                | For RFM class               |
| ↳ `frequency_score` | int       | Score for frequency (1–bins)              | For RFM class               |
| ↳ `monetary_score`  | int       | Score for monetary (1–bins)               | For RFM class               |
| ↳ `rfm_class`       | string    | Concatenation of individual scores        | For tiering/visualization   |
| ↳ `rfm_total`       | int       | Sum of scores                             | Tier mapping                |
| ↳ `rfm_tier`        | enum      | Lifecycle tier                            | Champions, Loyal, At-Risk   |
| ↳ `interpretation`  | string    | Plain-language explanation                | For business users          |
| `thresholds`        | object    | Binning cutoffs per metric                | For audit/debug             |

**Tier Mapping:**  
- **Champion:** `rfm_total ≥ bins*3 – 2`
- **Loyal:** Top 30% by total, not Champion
- **Potential:** Mid-upper band
- **Promising:** Mid-lower band
- **At-Risk:** Bottom 20%

---

# 4.1.5 `/api/v1/ai/customer_clv_features`

### Purpose
Feature-engineer the four classic CLV metrics (frequency, recency, T, monetary_value) ± potential tier for downstream CLV modeling.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_features
Content-Type: application/json

{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-10-12", "amount": 520.55, "cost": 312.33 },
        { "date": "2025-02-20", "amount": 398.40, "cost": 210.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2024-09-05", "amount": 300.00, "cost": 180.00 },
        { "date": "2025-01-17", "amount": 250.00, "cost": 150.00 }
      ]
    }
  ]
}
```

#### Calculated Outputs

| Output Field         | Formula                                    | Notes                                            |
|----------------------|--------------------------------------------|--------------------------------------------------|
| `frequency`          | `#orders − 1`                              | BG/NBD: 0 = one-time buyer                       |
| `recency`            | `days_between(first_tx, last_tx)`          | Float, in days                                   |
| `T`                  | `days_between(first_tx, today)`            | Customer age at snapshot                         |
| `monetary_value`     | `AVG(margin)` if cost present, else `AVG(amount)` |                                                  |
| `churned`            | bool                                       | True if last_tx ≤ threshold (planned feature)    |
| `clv_potential_tier` | enum (High/Medium/Low)                     | High if top 30% monetary_value & frequency ≥1    |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "frequency": 1,
      "recency": 131.0,
      "T": 194.0,
      "monetary_value": 188.40,
      "churned": false,
      "clv_potential_tier": "High",
      "interpretation": "…Focus on VIP retention & upsell.",
      "explanations": {}
    },
    {
      "customer_id": "C-1002",
      "frequency": 1,
      "recency": 134.0,
      "T": 200.0,
      "monetary_value": 110.00,
      "churned": false,
      "clv_potential_tier": "Medium",
      "interpretation": "…Consistent buyer, nurture with offers.",
      "explanations": {}
    }
  ]
}
```

#### Response Keys

| Key Path                  | Type        | Meaning                                | Usage                            |
|---------------------------|-------------|----------------------------------------|----------------------------------|
| `customers[]`             | array       | Each entry = 1 customer                | Segmentation, CLV modeling       |
| ↳ `customer_id`           | string      | Customer identifier                    | Join with CRM/CDP                |
| ↳ `frequency`             | int         | Number of repeat purchases             | For BG/NBD/CLV models            |
| ↳ `recency`               | float       | Days between first and last purchase   | For BG/NBD/CLV models            |
| ↳ `T`                     | float       | Days between first purchase and today  | For BG/NBD/CLV models            |
| ↳ `monetary_value`        | float       | Average margin or amount               | For Gamma-Gamma, CLV tiers       |
| ↳ `churned`               | bool        | Customer churn flag                    | Retargeting, risk analysis       |
| ↳ `clv_potential_tier`    | enum        | CLV potential segment                  | For targeting, dashboard         |
| ↳ `interpretation`        | string      | Business-focused summary               | For reporting, insights          |
| ↳ `explanations`          | object      | Explainable AI breakdowns              | For explainability/audit         |

---

# 4.1.6 `/api/v1/ai/customer_clv_forecast`

### Purpose
Predict dollar-value CLV over 6-, 12-, 36-month horizons; auto-select best model (BG/NBD + Gamma-Gamma or GBM).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_forecast
Content-Type: application/json

{
  "horizon_months": 6,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-01-15", "amount": 250, "cost": 140 },
        { "date": "2024-05-10", "amount": 480, "cost": 270 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2024-02-20", "amount": 350, "cost": 220 },
        { "date": "2024-06-18", "amount": 500, "cost": 320 }
      ]
    }
  ]
}
```


#### Example Response
```json
{
  "best_algorithm": "GradientBoosting",
  "horizon_months": 6,
  "evaluation_mae": { "GradientBoosting": 188.0 },
  "customers": [
    {
      "customer_id": "C-1001",
      "predicted_clv": 188.0,
      "algorithm_used": "GradientBoosting",
      "clv_tier": "Low",
      "interpretation": "…Consider automated win-back.",
      "explanations": {}
    },
    {
      "customer_id": "C-1002",
      "predicted_clv": 225.0,
      "algorithm_used": "GradientBoosting",
      "clv_tier": "Medium",
      "interpretation": "…Consistent spender, nurture with loyalty offers.",
      "explanations": {}
    }
  ]
}
```

### Response Keys

| Key Path                         | Type        | Meaning                                                  | Usage                                   |
|-----------------------------------|-------------|----------------------------------------------------------|-----------------------------------------|
| `best_algorithm`                  | string      | Model with best performance                              | For ML/Ops and reporting                |
| `horizon_months`                  | int         | Forecast window in months                                | Align with business planning            |
| `evaluation_mae`                  | object      | Mean absolute error per algorithm                        | Model selection/monitoring              |
| `customers[].predicted_clv`       | float       | Predicted CLV value for given horizon                    | Use in segmentation, targeting, etc     |
| `customers[].clv_tier`            | enum        | Tier (Low/Medium/High) based on predicted CLV            | For campaign targeting                  |
| `customers[].interpretation`      | string      | Plain-language business summary                          | For executive dashboards                |

---

# 4.1.7 `/api/v1/ai/purchasing_segmentation`

### Purpose
Benchmark four clustering families (K-Means, Gaussian-Mixture, Agglomerative, DBSCAN); auto-select the statistically best model; return:
- **Customer-to-cluster labels**
- **Feature-space centroids**
- **Cluster personas** (English descriptors)
- **Full dendrogram** for visualization

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation
Content-Type: application/json

{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse"] },
    { "id": "C002", "frequency": 5,  "amount_spent": 190.40,  "product_types": ["tea", "coffee"] }
  ],
  "k_range": [3, 4, 5, 6]
}
```

#### Request Body Schema

| JSON Key          | Type / Range                 | Required | Meaning                                   | Best Practice                         |
|-------------------|-----------------------------|----------|-------------------------------------------|---------------------------------------|
| `customers`       | array<object>               | Yes      | One row per shopper with minimal features | Use a materialized view (6–18 months) |
| ↳ `id`            | string (unique)             | Yes      | Primary key from CRM                      | —                                     |
| ↳ `frequency`     | int ≥ 1                     | Yes      | Count of transactions                     | `COUNT(order_id)`                     |
| ↳ `amount_spent`  | float ≥ 0                   | Yes      | Total revenue in window                   | `SUM(order_total)`                    |
| ↳ `product_types` | array<string> (length ≥ 1)  | Yes      | Purchased SKUs or categories              | `array_agg(DISTINCT category_lvl1)`   |
| `k_range`         | array<int> (3–30)           | Optional | k values to try for K-Means, GMM, Agglo   | Keep short (3–10) for performance     |
| `algorithms`      | array<string>               | Optional | Specify algorithm families                | Omit to run all                       |

#### Example Response
```json
{
  "benchmark": [
    {
      "algo": "agglo",
      "k": 3,
      "silhouette": 0.68,
      "davies_bouldin": 0.37
    },
    {
      "algo": "kmeans",
      "k": 3,
      "silhouette": 0.61,
      "davies_bouldin": 0.47
    }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 3,
    "silhouette": 0.68,
    "davies_bouldin": 0.37,
    "n_clusters": 3
  },
  "centroids": [
    [8.81, 591.11, 1.97],
    [23.14, 2577.37, 2.29],
    [29.00, 4321.67, 4.00]
  ],
  "labels": {
    "C001": 2,
    "C002": 0
  },
  "interpretations_en": {
    "0": "avg spend 591, 8.8 purchases/mo. Top categories: wine, cheese.",
    "1": "avg spend 2 577, 23.1 purchases/mo. Top categories: smart-tv, soundbar.",
    "2": "avg spend 4 322, 29.0 purchases/mo. Top categories: laptop, mouse."
  },
  "dendrogram": {}
}
```

#### Response Keys

| Key Path                | Type               | Meaning                                                           | Usage                                      |
|-------------------------|--------------------|-------------------------------------------------------------------|--------------------------------------------|
| `benchmark[]`           | array<object>      | Scorecard for each algorithm and k                                | Compare, monitor, tune                     |
| `best_model`            | object             | Details of the best cluster configuration                         | Model selection                            |
| `centroids[]`           | array<float[3]>    | [frequency, amount_spent, avg_product_types] per cluster          | Cluster profiling                          |
| `labels`                | object             | Mapping customer_id → cluster_id                                  | For CRM/CDP joins                          |
| `interpretations_en`    | object             | Persona blurbs per cluster ID                                     | For business storytelling                  |
| `dendrogram`            | object             | Hierarchical linkage and cluster legend (see dendrogram endpoint) | Visualization, analysis                    |

---

**Next Step:** ▶ POST the same payload to `/api/segmentation_report_json_i18n` for a multilingual KPI + persona pack (EN/ES/PT) ready for slides, dashboards, and strategy reviews.

# 4.1.8 `/api/v1/ai/purchasing_segmentation_dendrogram`

**Rapid Hierarchical-Clustering & Dendrogram Builder**

---

## Purpose

Returns a Ward-linkage matrix, centroids, and labels using **Agglomerative Clustering** only (no K-Means/GMM/DBSCAN sweep).  
The service brute-scans `k = 2 … 10` in one pass, selects the statistically best split, and returns everything required for:
- An interactive dendrogram
- A cluster explorer UI

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header                | Value         |
|-----------------------|--------------|
| X-Customer-Api-Id     | `<uuid>`     |
| X-Secret              | `<secret>`   |
| Content-Type          | application/json |

---

## Request

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation_dendrogram`
```

### Request Body Schema

| JSON Key   | Type / Range  | Required? | Meaning         | Notes                                              |
|------------|---------------|-----------|-----------------|----------------------------------------------------|
| customers  | array         | Yes       | Customer array  | See structure below                                |

#### `customers[]` Structure

| Field         | Type / Range          | Required | Definition                    | Warehouse Derivation        |
|---------------|----------------------|----------|-------------------------------|----------------------------|
| id            | string               | Yes      | Unique customer key           | —                          |
| frequency     | int ≥ 1              | Yes      | Order count within window     | COUNT(order_id)            |
| amount_spent  | float ≥ 0            | Yes      | Revenue in selected time      | SUM(order_total)           |
| product_types | array (≥1 item)      | Yes      | Purchased SKUs/category slugs | ARRAY_AGG(DISTINCT cat_lvl1)|

> **No hyper-parameters to tune.**  
> The endpoint auto-selects optimal k (2–10) via Silhouette↑ / Davies-Bouldin↓.

#### Example Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency": 5, "amount_spent": 190.40, "product_types": ["tea", "coffee"] },
    ...
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ]
}
```

---

## Response

```json
{
  "benchmark": [
    { "algo": "agglo", "k": 2, "silhouette": 0.7077, "davies_bouldin": 0.4514 },
    { "algo": "agglo", "k": 3, "silhouette": 0.6783, "davies_bouldin": 0.3761 },
    ...
    { "algo": "agglo", "k": 10, "silhouette": 0.5709, "davies_bouldin": 0.4166 }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 2,
    "silhouette": 0.7077,
    "davies_bouldin": 0.4514,
    "n_clusters": 2
  },
  "centroids": [
    [24.44, 2964.99, 2.67],
    [8.81, 591.11, 1.97]
  ],
  "labels": {
    "C001": 0, "C002": 1, ..., "C040": 1
  },
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.59, 2.0],
      ...,
      [76.0, 77.0, 8866.56, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": ["C001", ..., "C040"],
    "cluster_legend": [
      { "cluster_id": 0, "n_customers": 9, "avg_spend": 2964.99, "avg_frequency": 24.44, "top_categories": "laptop, mouse, air-fryer" },
      { "cluster_id": 1, "n_customers": 31, "avg_spend": 591.11, "avg_frequency": 8.81, "top_categories": "wine, cheese, diapers" }
    ]
  }
}
```

---

### Response Field Details

#### `benchmark[]` – Score Sweep (`k = 2 → 10`)
- **silhouette** — Cohesion/separation (range: 0–1; higher is better)
- **davies_bouldin** — Intra/extra spread (range: 0–2; lower is better)
- Only Agglomerative entries are shown.

🏆 **Sample: `k = 2` wins with Silhouette = 0.708**

#### `best_model`
- Chosen by highest Silhouette, then lowest Davies-Bouldin.
- `algo`: Always `"agglo"`
- `k`: Cluster count chosen
- `n_clusters`: Redundant copy of `k`

#### `centroids`
- **Order:** `[frequency, amount_spent, avg_product_types]`
- **Units:** Rescaled to original
  - Cluster 0 → 24.4 transactions / 2,965 R$ / 2.7 categories
  - Cluster 1 → 8.8 transactions / 591 R$ / 2.0 categories

#### `labels`
- Dictionary: `customer_id → cluster_id` (0-based)
- Join to your CDP or feed into `/segmentation_report_json_i18n`

#### `dendrogram`
- **linkage_matrix**: SciPy-style `[child1, child2, distance, sample_count]` rows  
  Use with `scipy.cluster.hierarchy.dendrogram()` or Plotly
- **leaf_labels[]**: Customer IDs in leaf order (for hover labels)
- **cluster_legend[]**: Stats per cluster (`n`, spend, freq, top categories)  
  Display in tooltips or side panels

> 💡 **Pro Tip:**  
> Call `/api/segment_hierarchy_chart` with the full dendrogram object to get a ready-made `{nodes, links}` graph for D3 / Plotly – no extra coding needed.

---

## Commercial Interpretation Example

| Cluster | Size | Behavior | Potential Actions |
|---------|------|----------|------------------|
| 0 – “Heavy Tech & Appliance Buyers” | 9 customers <br> avg spend: 2,965 R$ | 24 tx/year, high-ticket electronics, multi-category | VIP concierge, warranty upsell, bundles |
| 1 – “Mainstream Basket Shoppers” | 31 customers <br> avg spend: 591 R$ | 9 tx/year, groceries & small goods | Subscription replenishment, cross-sell, frequency boosters |

---

## FAQ

| Question | Answer |
|----------|--------|
| Can I change the k range? | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize. |
| Why only 2 clusters when I wanted 3? | The score sweep picked k = 2 — k = 3 had lower silhouette. Use `"k_range":[3]` manually. |
| How do I plot the dendrogram quickly? | In Python:<br>```python<br>from scipy.cluster.hierarchy import dendrogram<br>dendrogram(linkage_matrix, labels=leaf_labels)<br>``` |
| What distance metric is used? | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types. |
| Payload limit? | 20 MB (~60k customers). Async bulk version coming in Q4 2025. |

---

## Next Steps

- Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration.
- Use `/purchasing_segmentation` for generating campaign-ready personas.

---

### Typical Workflow

1. **POST** `/purchasing_segmentation_dendrogram` → receive `linkage_matrix` + `labels`
2. **POST** `/segment_hierarchy_chart` → get `{nodes, links}` graph
3. Render in a React or D3 widget
4. Save labels to DB or call `/segmentation_report_json_i18n` for KPI export

**Time to insight:**  
< 1 sec for 10k shoppers on T4 GPU  
~4 sec for 40k shoppers on CPU

---

### FAQ

| Question                                  | Answer                                                                                                             |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Can I change the `k` range?**           | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize.                        |
| **Why only 2 clusters when I wanted 3?**  | The score sweep picked `k = 2` — `k = 3` had lower silhouette. Use `"k_range":[3]` manually.                       |
| **How do I plot the dendrogram quickly?** | In Python:<br>`from scipy.cluster.hierarchy import dendrogram`<br>`dendrogram(linkage_matrix, labels=leaf_labels)` |
| **What distance metric is used?**         | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types.                             |
| **Payload limit?**                        | 20 MB (\~60k customers). Async bulk version coming in Q4 2025.                                                     |

---

### Next Step

Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration, and keep using /purchasing_segmentation for generating campaign-ready personas.

---

# 4.1.9 /api/v1/ai/segment_hierarchy_chart

Turning a Raw Dendrogram into a Front-End-Ready Graph

---

### Purpose

This endpoint accepts the exact dendrogram object returned by:

`/purchasing_segmentation_dendrogram`

or `/purchasing_segmentation`

…and emits two tidy arrays:

`nodes`

`links`

`cluster_legend` (optional)

🎯 Drop these directly into D3.js, Plotly, ECharts, or a React force-graph — no parsing required.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_hierarchy_chart`
```

---

### Request Body Schema

| Key                | Type          | Required | Meaning                                                             |
| ------------------ | ------------- | -------- | ------------------------------------------------------------------- |
| `dendrogram`       | object        | Yes      | Raw dendrogram object (must include three sub-keys below)           |
| → `linkage_matrix` | 2-D array     | Yes      | Ward linkage rows: `[child1, child2, distance, sample_count]`       |
| → `leaf_labels`    | array<string> | Yes      | Customer IDs, ordered to match the leaf index in the linkage matrix |
| → `cluster_legend` | array<object> | Optional | Quick stats per cluster (for tooltips/side panels)                  |

⚡ Payload remains lightweight: ~20–60 KB for tens of thousands of customers.

---

### How the API Transforms the Data

1. Enumerate Leaves
Every original customer becomes a node:

`is_leaf = true`

`id = 0 → (n_leaves − 1)`

---

2. Enumerate Internal Merges
Each row in the `linkage_matrix` becomes one internal node with:

| Field      | Description                         |
| ---------- | ----------------------------------- |
| `id`       | Index starting after last leaf      |
| `distance` | Linkage distance from matrix        |
| `size`     | Number of leaves under this cluster |

---

3. Generate Links
Each merge row creates two directional edges:

| Field      | Description                                                  |
| ---------- | ------------------------------------------------------------ |
| `source`   | ID of new internal node                                      |
| `target`   | IDs of `child1` and `child2` (can be leaves or internal IDs) |
| `distance` | Copied for edge-weight mapping                               |

---

### Request

```json
{
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.5900115966796875, 2.0],
      [16.0, 34.0, 10.246950765959598, 2.0],
      [10.0, 38.0, 14.5, 2.0],
      [18.0, 33.0, 14.684114387072421, 2.0],
      [2.0, 24.0, 14.933482805184708, 2.0],
      [14.0, 20.0, 15.033296378372908, 2.0],
      [8.0, 23.0, 15.033296378372908, 2.0],
      [9.0, 22.0, 16.41102378466232, 2.0],
      [12.0, 40.0, 19.554342797373597, 3.0],
      [30.0, 41.0, 23.67840084690405, 3.0],
      [19.0, 36.0, 24.720185838561353, 2.0],
      [5.0, 31.0, 29.71684244831212, 2.0],
      [3.0, 45.0, 31.75951301054011, 3.0],
      [39.0, 47.0, 37.04603277151646, 3.0],
      [46.0, 49.0, 53.204636389447614, 5.0],
      [7.0, 43.0, 60.837535989873956, 3.0],
      [26.0, 48.0, 75.42189702647553, 4.0],
      [4.0, 35.0, 83.95602895187841, 2.0],
      [50.0, 51.0, 102.69139093644127, 4.0],
      [15.0, 53.0, 135.75478433757996, 4.0],
      [54.0, 56.0, 139.4687935795597, 9.0],
      [21.0, 57.0, 147.95607449395212, 3.0],
      [42.0, 58.0, 193.4435440607144, 6.0],
      [25.0, 29.0, 215.00232556881798, 2.0],
      [44.0, 55.0, 220.82693991432996, 5.0],
      [13.0, 37.0, 221.00452484055614, 2.0],
      [6.0, 11.0, 235.00212764994276, 2.0],
      [52.0, 60.0, 256.36800922508723, 12.0],
      [28.0, 61.0, 336.40545943552, 4.0],
      [0.0, 17.0, 401.8550746056813, 2.0],
      [32.0, 66.0, 522.3946688588159, 3.0],
      [62.0, 64.0, 537.5921954390619, 11.0],
      [63.0, 65.0, 647.7163731140352, 4.0],
      [59.0, 68.0, 743.4835774228395, 8.0],
      [70.0, 72.0, 1528.9174504219059, 7.0],
      [67.0, 71.0, 1623.9774150881199, 23.0],
      [73.0, 75.0, 2865.3048816814076, 31.0],
      [69.0, 74.0, 3076.681261272462, 9.0],
      [76.0, 77.0, 8866.563988339083, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": [
      "C001", "C002", "C003", "C004", "C005", "C006", "C007", "C008", "C009", "C010",
      "C011", "C012", "C013", "C014", "C015", "C016", "C017", "C018", "C019", "C020",
      "C021", "C022", "C023", "C024", "C025", "C026", "C027", "C028", "C029", "C030",
      "C031", "C032", "C033", "C034", "C035", "C036", "C037", "C038", "C039", "C040"
    ],
    "cluster_legend": [
      {
        "cluster_id": 0,
        "n_customers": 9,
        "avg_spend": 2964.99,
        "avg_frequency": 24.44,
        "top_categories": "laptop, mouse, air-fryer"
      },
      {
        "cluster_id": 1,
        "n_customers": 31,
        "avg_spend": 591.11,
        "avg_frequency": 8.81,
        "top_categories": "wine, cheese, diapers"
      }
    ]
  }
}
```

---

### Response

```json
{
  "nodes": [
    { "id": 0, "label": "C001", "is_leaf": true },
    { "id": 1, "label": "C002", "is_leaf": true },
    { "id": 2, "label": "C003", "is_leaf": true },
    { "id": 3, "label": "C004", "is_leaf": true },
    { "id": 4, "label": "C005", "is_leaf": true },
    { "id": 5, "label": "C006", "is_leaf": true },
    { "id": 6, "label": "C007", "is_leaf": true },
    { "id": 7, "label": "C008", "is_leaf": true },
    { "id": 8, "label": "C009", "is_leaf": true },
    { "id": 9, "label": "C010", "is_leaf": true },
    { "id": 10, "label": "C011", "is_leaf": true },
    { "id": 11, "label": "C012", "is_leaf": true },
    { "id": 12, "label": "C013", "is_leaf": true },
    { "id": 13, "label": "C014", "is_leaf": true },
    { "id": 14, "label": "C015", "is_leaf": true },
    { "id": 15, "label": "C016", "is_leaf": true },
    { "id": 16, "label": "C017", "is_leaf": true },
    { "id": 17, "label": "C018", "is_leaf": true },
    { "id": 18, "label": "C019", "is_leaf": true },
    { "id": 19, "label": "C020", "is_leaf": true },
    { "id": 20, "label": "C021", "is_leaf": true },
    { "id": 21, "label": "C022", "is_leaf": true },
    { "id": 22, "label": "C023", "is_leaf": true },
    { "id": 23, "label": "C024", "is_leaf": true },
    { "id": 24, "label": "C025", "is_leaf": true },
    { "id": 25, "label": "C026", "is_leaf": true },
    { "id": 26, "label": "C027", "is_leaf": true },
    { "id": 27, "label": "C028", "is_leaf": true },
    { "id": 28, "label": "C029", "is_leaf": true },
    { "id": 29, "label": "C030", "is_leaf": true },
    { "id": 30, "label": "C031", "is_leaf": true },
    { "id": 31, "label": "C032", "is_leaf": true },
    { "id": 32, "label": "C033", "is_leaf": true },
    { "id": 33, "label": "C034", "is_leaf": true },
    { "id": 34, "label": "C035", "is_leaf": true },
    { "id": 35, "label": "C036", "is_leaf": true },
    { "id": 36, "label": "C037", "is_leaf": true },
    { "id": 37, "label": "C038", "is_leaf": true },
    { "id": 38, "label": "C039", "is_leaf": true },
    { "id": 39, "label": "C040", "is_leaf": true },
    { "id": 40, "distance": 5.5900115966796875, "size": 2, "is_leaf": false },
    { "id": 41, "distance": 10.246950765959598, "size": 2, "is_leaf": false },
    { "id": 42, "distance": 14.5, "size": 2, "is_leaf": false },
    { "id": 43, "distance": 14.684114387072421, "size": 2, "is_leaf": false },
    { "id": 44, "distance": 14.933482805184708, "size": 2, "is_leaf": false },
    { "id": 45, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 46, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 47, "distance": 16.41102378466232, "size": 2, "is_leaf": false },
    { "id": 48, "distance": 19.554342797373597, "size": 3, "is_leaf": false },
    { "id": 49, "distance": 23.67840084690405, "size": 3, "is_leaf": false },
    { "id": 50, "distance": 24.720185838561353, "size": 2, "is_leaf": false },
    { "id": 51, "distance": 29.71684244831212, "size": 2, "is_leaf": false },
    { "id": 52, "distance": 31.75951301054011, "size": 3, "is_leaf": false },
    { "id": 53, "distance": 37.04603277151646, "size": 3, "is_leaf": false },
    { "id": 54, "distance": 53.204636389447614, "size": 5, "is_leaf": false },
    { "id": 55, "distance": 60.837535989873956, "size": 3, "is_leaf": false },
    { "id": 56, "distance": 75.42189702647553, "size": 4, "is_leaf": false },
    { "id": 57, "distance": 83.95602895187841, "size": 2, "is_leaf": false },
    { "id": 58, "distance": 102.69139093644127, "size": 4, "is_leaf": false },
    { "id": 59, "distance": 135.75478433757996, "size": 4, "is_leaf": false },
    { "id": 60, "distance": 139.4687935795597, "size": 9, "is_leaf": false },
    { "id": 61, "distance": 147.95607449395212, "size": 3, "is_leaf": false },
    { "id": 62, "distance": 193.4435440607144, "size": 6, "is_leaf": false },
    { "id": 63, "distance": 215.00232556881798, "size": 2, "is_leaf": false },
    { "id": 64, "distance": 220.82693991432996, "size": 5, "is_leaf": false },
    { "id": 65, "distance": 221.00452484055614, "size": 2, "is_leaf": false },
    { "id": 66, "distance": 235.00212764994276, "size": 2, "is_leaf": false },
    { "id": 67, "distance": 256.36800922508723, "size": 12, "is_leaf": false },
    { "id": 68, "distance": 336.40545943552, "size": 4, "is_leaf": false },
    { "id": 69, "distance": 401.8550746056813, "size": 2, "is_leaf": false },
    { "id": 70, "distance": 522.3946688588159, "size": 3, "is_leaf": false },
    { "id": 71, "distance": 537.5921954390619, "size": 11, "is_leaf": false },
    { "id": 72, "distance": 647.7163731140352, "size": 4, "is_leaf": false },
    { "id": 73, "distance": 743.4835774228395, "size": 8, "is_leaf": false },
    { "id": 74, "distance": 1528.9174504219059, "size": 7, "is_leaf": false },
    { "id": 75, "distance": 1623.9774150881199, "size": 23, "is_leaf": false },
    { "id": 76, "distance": 2865.3048816814076, "size": 31, "is_leaf": false },
    { "id": 77, "distance": 3076.681261272462, "size": 9, "is_leaf": false },
    { "id": 78, "distance": 8866.563988339083, "size": 40, "is_leaf": false }
  ],
  "links": [
    { "source": 40, "target": 1, "distance": 5.5900115966796875 },
    { "source": 40, "target": 27, "distance": 5.5900115966796875 },
    ...
  ],
  "columns": [ "source", "target", "distance" ],
  "cluster_legend": [
    {
      "cluster_id": 0,
      "n_customers": 9,
      "avg_spend": 2964.99,
      "avg_frequency": 24.44,
      "top_categories": "laptop, mouse, air-fryer"
    },
    {
      "cluster_id": 1,
      "n_customers": 31,
      "avg_spend": 591.11,
      "avg_frequency": 8.81,
      "top_categories": "wine, cheese, diapers"
    }
  ]
}
```

---

### Practical Visualisation Snippet (React + d3-hierarchy)

import { hierarchy, cluster } from 'd3-hierarchy';
import { select } from 'd3-selection';

// `nodes`, `links` fetched from the endpoint
const root = hierarchy({ children: nodes.filter(n => !n.is_leaf) })
  .sum(d => (d.is_leaf ? 1 : 0))
  .sort((a, b) => a.data.distance - b.data.distance);

cluster().size([360, 800])(root); // radial dendrogram

select(svgRef.current)
  .selectAll('line')
  .data(links)
  .join('line')
  .attr('x1', d => nodeX(d.source))
  .attr('y1', d => nodeY(d.source))
  .attr('x2', d => nodeX(d.target))
  .attr('y2', d => nodeY(d.target))
  .attr('stroke', '#999');

✅ No need to re-calculate link distances or node sizes—the service already did it.

---

### Commercial Value

| **Stakeholder**     | **Benefit**                                                               |
| ------------------- | ------------------------------------------------------------------------- |
| Merchandising teams | Drill into any branch to see what product mixes bind micro-segments       |
| Marketers           | Drag-select a cluster subtree and export the IDs for niche campaigns      |
| Data Scientists     | Visually validate cluster cohesion; spot outlier merges                   |
| CXO / Board         | Screenshot of radial dendrogram + legend panel tells a clear visual story |

---

### Performance & Limits

Supports up to 100k leaves comfortably (~1 MB JSON)

~50ms latency (parse + map) for 40k leaves on a T4 GPU (network-bound)

Internal node count = n_leaves – 1 (binary tree rule)

👉 Link count = 2 × (n_leaves – 1)

---

### FAQ

| **Question**                         | **Answer**                                                                                                                                            |
| ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| Why do edges have distance?          | To let you map **Ward distance** to stroke width/color—emphasizes similarity depth                                                                    |
| Can I request Spanish or Portuguese? | Yes—`cluster_legend` comes from the original dendrogram request; set `lang` on that call                                                              |
| What if I munged the linkage rows?   | The API checks for length = 4 and valid IDs. Invalid structures return HTTP 400                                                                       |
| We need zoomable sunburst instead    | Convert `nodes` + `links` to nested JSON (e.g., via DAG-to-tree util), or wait for:<br>`/segment_hierarchy_chart?format=sunburst` *(Q4 2025 roadmap)* |

---

### Next Step

Pin the dendrogram to your analytics portal, and let users:

Click-select a cluster

Export audience

Launch campaign — all in minutes

🧠 No Python notebooks, no crontabs required.

---

# 4.1.10 /api/v1/ai/segment_subsegment_explore

Drill-Down Micro-Segmentation Service

---

### Purpose

Take an existing segmentation (customer-to-cluster labels you've already produced) and perform a secondary, in-cluster clustering pass to reveal micro-segments with tighter behavioral alignment.

Ideal for:

Tiered loyalty perks

Hyper-personalised recommendations

“Segment-of-one” exploratory analysis

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_subsegment_explore`
```

---

### Request Body Schema

| Key               | Type / Range  | Required? | Meaning                                      | How to Populate                                  |
| ----------------- | ------------- | --------- | -------------------------------------------- | ------------------------------------------------ |
| `customers`       | array<object> | Yes       | Customer-level feature vectors               | Re-use payload from the first-level segmentation |
| ↳ `id`            | string        | Yes       | Customer ID (CRM primary key)                | —                                                |
| ↳ `frequency`     | int           | Yes       | Orders in the analysis window                | —                                                |
| ↳ `amount_spent`  | float         | Yes       | Revenue in that same window                  | —                                                |
| ↳ `product_types` | array<string> | Yes       | Purchased categories (SKUs or slugs)         | —                                                |
| `labels`          | object        | Yes       | Mapping of `customer_id → parent cluster_id` | Use output from the previous clustering pass     |
| `target_cluster`  | int           | Optional  | Focus on one parent cluster                  | Omit to apply across all parent clusters         |
| `k_range`         | array<int>    | Optional  | Values of `k` to try during sub-clustering   | Default = `[2, 3]`                               |

---

### Algorithm Notes

Within each parent cluster:

The service applies K-Means

On z-scored numeric features:

`frequency`

`amount_spent`

`n_categories` (derived from `product_types`)

It benchmarks each `k` using:

Silhouette (↑ higher is better)

Davies-Bouldin (↓ lower is better)

The sub-cluster with the best statistical cohesion wins.

---

### Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  },   // labels from previous route
  "target_cluster": 1,          // omit to analyse every cluster
  "k_range": [2,3]              // optional sweep for sub-K-means
}
```

---

### Response

```json
{
    "subsegment_results": {
        "1": {
            "benchmark": [
                {
                    "k": 2,
                    "silhouette": 0.4934960901737213,
                    "davies_bouldin": 0.5208518741969365
                },
                {
                    "k": 3,
                    "silhouette": 0.4140159785747528,
                    "davies_bouldin": 0.4869059685396701
                }
            ],
            "best_k": 2,
            "selection_description": "Inside parent-cluster 1, k = 2 yielded the highest silhouette (0.493) and lowest Davies-Bouldin (0.521).",
            "metric_explanation": {
                "silhouette": "Ranges −1…1; closer to 1 means dense & well-separated.",
                "davies_bouldin": "Lower is better; 0 indicates perfect separation."
            },
            "nested_centroids": {
                "columns": [
                    "frequency",
                    "amount_spent",
                    "n_categories"
                ],
                "values": [
                    [
                        21.5,
                        2223.5,
                        1.75
                    ],
                    [
                        25.33333396911621,
                        3049.199951171875,
                        3.0
                    ]
                ]
            },
            "nested_labels": {
                "C007": 1,
                "C012": 1,
                "C014": 0,
                "C026": 0,
                "C030": 0,
                "C033": 1,
                "C038": 0
            },
            "nested_cluster_legend": [
                {
                    "cluster_id": 0,
                    "n_customers": 4,
                    "avg_spend": 2223.5,
                    "avg_frequency": 21.5,
                    "top_categories": "fitness-watch, fridge, water-filter"
                },
                {
                    "cluster_id": 1,
                    "n_customers": 3,
                    "avg_spend": 3049.2,
                    "avg_frequency": 25.33,
                    "top_categories": "smart-tv, soundbar, hdmi-cable"
                }
            ],
            "nested_interpretations_en": {
                "0": "4 customers, avg spend 2,224, 21.5 purchases/mo. Top categories: fitness-watch, fridge, water-filter.",
                "1": "3 customers, avg spend 3,049, 25.3 purchases/mo. Top categories: smart-tv, soundbar, hdmi-cable."
            }
        }
    }
}
```

---

### Key Objects Explained

| **Path**                          | **Meaning**                                         | **Typical Use**                    |
| --------------------------------- | --------------------------------------------------- | ---------------------------------- |
| `benchmark[]`                     | How each `k` performed                              | Show in a dashboard or notebook    |
| `best_k`, `selection_description` | Why the micro-cluster count was chosen              | Traceability / governance          |
| `nested_centroids`                | Raw feature means for sub-clusters                  | Tooltip metrics in BI tools        |
| `nested_labels`                   | `customer_id → sub_cluster_id` (for target cluster) | Push to CRM for hyper-targeting    |
| `nested_cluster_legend`           | Quick KPIs & top categories per sub-segment         | Helps marketers name the segments  |
| `nested_interpretations_en`       | Plain-English persona blurbs                        | Paste into campaigns or PowerPoint |

---

### Commercial Playbooks

| **Scenario**                                                                           | **How Micro-Segments Help**                 | **KPI Lift Seen**     |
| -------------------------------------------------------------------------------------- | ------------------------------------------- | --------------------- |
| High-value tech buyers split into “Smart-TV addicts” vs “Fitness-watch early adopters” | Tailor product recommendations and creative | **+18%** email CTR    |
| Bulk grocery shoppers split into “Organic enthusiasts” vs “Family staples”             | Personalise coupon bundles; adjust margin   | **+7%** basket margin |
| At-risk low spenders further split by category affinity                                | Deliver category-specific win-back offers   | **−4 pp** churn       |

---

### Best-Practice Workflow

1. Call /purchasing_segmentation (or /purchasing_segmentation_dendrogram) and store the labels.

2. Identify the parent cluster to drill into (e.g., largest size, highest CLV, etc.).

3. POST to /segment_subsegment_explore with the target_cluster.

4. Merge the sub-cluster labels back into your customer master table:

UPDATE crm.customers c
SET sub_cluster = l.nested_id
FROM nested_labels l
WHERE l.customer_id = c.id;

5. Trigger personalized campaigns, dynamic content, or inventory actions based on micro-segment tags.

---

### FAQ

| **Question**                        | **Answer**                                                                                                         |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| Can I explore all clusters at once? | Yes — omit `target_cluster`; service returns one object per cluster in `subsegment_results`.                       |
| Why only K-Means?                   | Speed — K-Means is deterministic and \~20× faster at small sizes. Use `/purchasing_segmentation` for richer algos. |
| What about categorical features?    | The API auto one-hots the **top 50 product\_types** to reflect category overlap in clustering.                     |
| Payload limit?                      | 20 MB (\~60,000 customers). Bulk async version planned for **Q4 2025**.                                            |

---

### Next Step
Feed the micro-segment labels into your personalisation engine, or re-run /segment_hierarchy_chart scoped to the parent cluster for an interactive explorer down to “segment-of-five” granularity.

---

# 4.1.11 /api/v1/ai/segment_cluster_profiles

Roll-Up KPI Portraits for Each Cluster

---

### Purpose

Transform a raw customer → cluster mapping + base features into C-level summary cards that answer:

“How big is each segment, what do they buy, how valuable are they, and what should we do next?”

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_cluster_profiles`
```

---

### Request Body Schema

| Key               | Type          | Required? | Meaning                                          | How to Gather                                      |
| ----------------- | ------------- | --------- | ------------------------------------------------ | -------------------------------------------------- |
| `customers`       | array<object> | Yes       | Feature block used across segmentation endpoints | Materialized view of analysis window (6–18 months) |
| ↳ `id`            | string        | Yes       | CRM primary key                                  | —                                                  |
| ↳ `frequency`     | int           | Yes       | Number of orders in analysis window              | —                                                  |
| ↳ `amount_spent`  | float         | Yes       | Total revenue in window                          | —                                                  |
| ↳ `product_types` | array<string> | Yes       | Purchased categories or SKU slugs                | —                                                  |
| `labels`          | object        | Yes       | Mapping `customer_id → cluster_id`               | Use your selected segmentation model output        |

---

⚙️ No hyper-parameters, no pagination — this service acts as a pure aggregation layer for summarizing segment-level KPIs.

---

### Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  }
}
```

---

### Response

```json
{
    "cluster_profiles": [
        {
            "cluster_id": 0,
            "n_customers": 31,
            "avg_spend": 591.11,
            "median_spend": 540.0,
            "avg_frequency": 8.81,
            "top_categories": "wine, cheese, diapers, sd-card, office-chair",
            "share_of_revenue_pct": 40.71,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 1,
            "n_customers": 7,
            "avg_spend": 2577.37,
            "median_spend": 2560.0,
            "avg_frequency": 23.14,
            "top_categories": "smart-tv, soundbar, hdmi-cable, tablet, stylus",
            "share_of_revenue_pct": 40.08,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 2,
            "n_customers": 2,
            "avg_spend": 4321.68,
            "median_spend": 4321.68,
            "avg_frequency": 29.0,
            "top_categories": "laptop, mouse, keyboard, monitor, gaming-pc",
            "share_of_revenue_pct": 19.2,
            "insight": "Growth-potential segment"
        }
    ]
}
```

---

### Cluster Profile Fields

| **Field**              | **Formula / Derivation**                                                                                           | **What It Tells You**     | **Action Trigger**            |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------- | ----------------------------- |
| `cluster_id`           | Echo of your original label                                                                                        | —                         | Key for joins                 |
| `n_customers`          | `COUNT(*)` in cluster                                                                                              | Segment size              | Gauge campaign reach          |
| `avg_spend`            | `AVG(amount_spent)` (in R\$)                                                                                       | Mean value per customer   | Compare to CAC & LTV goals    |
| `median_spend`         | 50th percentile spend                                                                                              | Robust to outliers        | Pricing & discount policy     |
| `avg_frequency`        | `AVG(frequency)` (orders per period)                                                                               | Purchase cadence          | Trigger replenishment flows   |
| `top_categories`       | TF-IDF on `product_types`, top-5 slugs                                                                             | Category affinity         | Creative for ads / email hero |
| `share_of_revenue_pct` | `SUM(amount_spent_cluster) / SUM(amount_spent_total) × 100`                                                        | Revenue weight of segment | Resource allocation           |
| `insight`              | Auto rule-based narrative:                                                                                         | Quick business cue        | Slot into slide decks         |
|                        | If `avg_spend > pop_mean` **and** `share_of_revenue_pct ≥ 30%` ⇒ "Retention & upsell"<br>Else ⇒ "Growth-potential" |                           |                               |

---

### KPI Example – What It Means

| **Cluster**                        | **Portrait**                                              | **Recommended Playbook**                         |
| ---------------------------------- | --------------------------------------------------------- | ------------------------------------------------ |
| `0 – “Mainstream Basket Shoppers”` | 31 cust · 8.8 orders · 591 R\$ avg spend · 41% of revenue | Frequency boosters, cross-sell snacks & CPG      |
| `1 – “Power Electronics Buyers”`   | 7 cust · 23 orders · 2,577 R\$ avg spend · 40% of revenue | VIP concierge, extended warranty, bundle deals   |
| `2 – “Tech Whales”`                | 2 cust · 29 orders · 4,322 R\$ avg spend · 19% of revenue | Dedicated account manager, early-access launches |

---

### Quick SQL Example to Recreate `labels` Join

WITH base AS (
  SELECT c.id, c.cluster_id, f.amount_spent, f.frequency, f.product_types
  FROM crm.customers c
  JOIN api_labels   l ON l.customer_id = c.id         -- mapping from earlier
  JOIN fact_cust_agg f ON f.customer_id = c.id        -- your feature table
)
SELECT
  cluster_id,
  COUNT(*)                    AS n_customers,
  AVG(amount_spent)           AS avg_spend,
  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount_spent) AS median_spend,
  AVG(frequency)              AS avg_frequency,
  ARRAY_TO_STRING(
      ARRAY_SLICE( -- top 5 TF-IDF slugs
         (SELECT slug FROM UNNEST(tfidf_top(product_types)) LIMIT 5),
         1, 5), ', ')          AS top_categories
FROM base
GROUP BY cluster_id;

---

### Commercial Benefits

1. One-click persona cards – Drop `cluster_profiles` into Confluence, Notion, or PDFs.

2. Revenue skew insight – Identify segments that punch above their weight.

3. Creative brief generator – Use `top_categories` + `insight` for instant copy cues.

4. Board dashboards – Share KPIs without exposing `customer-level` data.

---

### FAQ

| **Question**                        | **Answer**                                                                                                 |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| Why both `avg` and `median_spend`?  | Median cushions long-tail outliers; average shows total value for LTV calculations.                        |
| Can I get CLV or churn per cluster? | Yes — join this output with `/customer_clv_forecast` or `/churn_risk` by `customer_id`, then re-aggregate. |
| How many top categories?            | Fixed at 5 for now. Future param: `top_n_categories` coming in v1.8.                                       |
| What languages are supported?       | Currently only English for `insight`. i18n support is expected in Q4 2025.                                 |

---

### Next Step

Embed cluster_profiles in your marketing playbook,
Allocate budget by share_of_revenue_pct,
Tailor creatives using top_categories for each persona.

---

# 4.1.12 /api/v1/ai/segmentation_report_json?lang=en

End-to-End Narrative Generator

---

### Purpose

This endpoint takes the raw artefacts from the segmentation engine—such as:

`customers`

`labels`

`dendrogram`

…and returns a fully-synthetic narrative report in JSON format, including:

Executive summary

Cluster-level KPIs

Marketing guidance

Ready-to-paste slide copy

---

### The output is 100% machine-written but reads like a polished analyst deck, ideal for:

Auto-publishing in BI dashboards

Automated PowerPoint generation

Auto-reply reports to stakeholders

---

### Headers `X-Customer-Api-Id`, `X-Secret`


```yml
POST  `https://api-prod.abintel.ai/api/v1/ai/segmentation_report_json?lang=en`
```


| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request Body Schema

| **Key**      | **Type**      | **Required?**              | **Meaning**                                            | **Typical Source**                                 |
| ------------ | ------------- | -------------------------- | ------------------------------------------------------ | -------------------------------------------------- |
| `customers`  | array<object> | Yes                        | Same feature block used everywhere                     | Materialized view or the last segmentation payload |
| `labels`     | object        | Yes                        | Mapping `customer_id → cluster_id`                     | From `/purchasing_segmentation`                    |
| `dendrogram` | object        | Optional (but recommended) | Raw dendrogram including `linkage`, `labels`, `legend` | From `/purchasing_segmentation_dendrogram`         |

📝 If you omit the `dendrogram`, the service still returns a complete report.
However, the dendrogram-specific insights and visual hierarchy analysis sections will be skipped.

---

### Request

```json
{"customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
 "labels": {
        "C001": 2,
        "C002": 0,
        "C003": 0,
        "C004": 0,
        "C005": 0,
        "C006": 0,
        "C007": 1,
        "C008": 0,
        "C009": 0,
        "C010": 0,
        "C011": 0,
        "C012": 1,
        "C013": 0,
        "C014": 1,
        "C015": 0,
        "C016": 0,
        "C017": 0,
        "C018": 2,
        "C019": 0,
        "C020": 0,
        "C021": 0,
        "C022": 0,
        "C023": 0,
        "C024": 0,
        "C025": 0,
        "C026": 1,
        "C027": 0,
        "C028": 0,
        "C029": 0,
        "C030": 1,
        "C031": 0,
        "C032": 0,
        "C033": 1,
        "C034": 0,
        "C035": 0,
        "C036": 0,
        "C037": 0,
        "C038": 1,
        "C039": 0,
        "C040": 0
    },

   "dendrogram": {
        "linkage_matrix": [
            [
                1.0,
                27.0,
                5.5900115966796875,
                2.0
            ],
            [
                16.0,
                34.0,
                10.246950765959598,
                2.0
            ],
            [
                10.0,
                38.0,
                14.5,
                2.0
            ],
            [
                18.0,
                33.0,
                14.684114387072421,
                2.0
            ],
            [
                2.0,
                24.0,
                14.933482805184708,
                2.0
            ],
            [
                14.0,
                20.0,
                15.033296378372908,
                2.0
            ],
            [
                8.0,
                23.0,
                15.033296378372908,
                2.0
            ],
            [
                9.0,
                22.0,
                16.41102378466232,
                2.0
            ],
            [
                12.0,
                40.0,
                19.554342797373597,
                3.0
            ],
            [
                30.0,
                41.0,
                23.67840084690405,
                3.0
            ],
            [
                19.0,
                36.0,
                24.720185838561353,
                2.0
            ],
            [
                5.0,
                31.0,
                29.71684244831212,
                2.0
            ],
            [
                3.0,
                45.0,
                31.75951301054011,
                3.0
            ],
            [
                39.0,
                47.0,
                37.04603277151646,
                3.0
            ],
            [
                46.0,
                49.0,
                53.204636389447614,
                5.0
            ],
            [
                7.0,
                43.0,
                60.837535989873956,
                3.0
            ],
            [
                26.0,
                48.0,
                75.42189702647553,
                4.0
            ],
            [
                4.0,
                35.0,
                83.95602895187841,
                2.0
            ],
            [
                50.0,
                51.0,
                102.69139093644127,
                4.0
            ],
            [
                15.0,
                53.0,
                135.75478433757996,
                4.0
            ],
            [
                54.0,
                56.0,
                139.4687935795597,
                9.0
            ],
            [
                21.0,
                57.0,
                147.95607449395212,
                3.0
            ],
            [
                42.0,
                58.0,
                193.4435440607144,
                6.0
            ],
            [
                25.0,
                29.0,
                215.00232556881798,
                2.0
            ],
            [
                44.0,
                55.0,
                220.82693991432996,
                5.0
            ],
            [
                13.0,
                37.0,
                221.00452484055614,
                2.0
            ],
            [
                6.0,
                11.0,
                235.00212764994276,
                2.0
            ],
            [
                52.0,
                60.0,
                256.36800922508723,
                12.0
            ],
            [
                28.0,
                61.0,
                336.40545943552,
                4.0
            ],
            [
                0.0,
                17.0,
                401.8550746056813,
                2.0
            ],
            [
                32.0,
                66.0,
                522.3946688588159,
                3.0
            ],
            [
                62.0,
                64.0,
                537.5921954390619,
                11.0
            ],
            [
                63.0,
                65.0,
                647.7163731140352,
                4.0
            ],
            [
                59.0,
                68.0,
                743.4835774228395,
                8.0
            ],
            [
                70.0,
                72.0,
                1528.9174504219059,
                7.0
            ],
            [
                67.0,
                71.0,
                1623.9774150881199,
                23.0
            ],
            [
                73.0,
                75.0,
                2865.3048816814076,
                31.0
            ],
            [
                69.0,
                74.0,
                3076.681261272462,
                9.0
            ],
            [
                76.0,
                77.0,
                8866.563988339083,
                40.0
            ]
        ],
        "columns": [
            "child1",
            "child2",
            "distance",
            "sample_count"
        ],
        "leaf_labels": [
            "C001",
            "C002",
            "C003",
            "C004",
            "C005",
            "C006",
            "C007",
            "C008",
            "C009",
            "C010",
            "C011",
            "C012",
            "C013",
            "C014",
            "C015",
            "C016",
            "C017",
            "C018",
            "C019",
            "C020",
            "C021",
            "C022",
            "C023",
            "C024",
            "C025",
            "C026",
            "C027",
            "C028",
            "C029",
            "C030",
            "C031",
            "C032",
            "C033",
            "C034",
            "C035",
            "C036",
            "C037",
            "C038",
            "C039",
            "C040"
        ],
        "cluster_legend": [
            {
                "cluster_id": 0,
                "n_customers": 31,
                "avg_spend": 591.11,
                "avg_frequency": 8.81,
                "top_categories": "wine, cheese, diapers"
            },
            {
                "cluster_id": 1,
                "n_customers": 7,
                "avg_spend": 2577.37,
                "avg_frequency": 23.14,
                "top_categories": "smart-tv, soundbar, hdmi-cable"
            },
            {
                "cluster_id": 2,
                "n_customers": 2,
                "avg_spend": 4321.68,
                "avg_frequency": 29.0,
                "top_categories": "laptop, mouse, keyboard"
            }
        ]
    }
}
```

---

### What the Service Does Internally

1. Aggregates customer-level data into cluster metrics (`n_customers`, revenue share, TF-IDF categories…).

2. Generates text via a structured NLG pipeline (templating + GPT-4-Turbo fine-tune) in the requested language.

3. Packages everything into a single JSON object – each top-level key is a ready-made paragraph or table.

4. Echoes raw payload at the bottom so the entire request/response is self-contained for audit. Latency: ~400 ms for ≤ 50 k customers on CPU.

---

### Response

```json
{
    "language": "English",
    "generated_on": "2025-05-20T17:47:09",
    "executive_summary": "The segmentation analysis has revealed three distinct customer clusters among the 40 customers, each exhibiting unique buying behaviors, spending patterns, and product preferences. Cluster 0, the largest group with 31 customers, shows moderate spending and lower purchase frequency, with top categories including everyday items like wine, cheese, and diapers. Cluster 1, composed of 7 customers, reflects higher average spending and frequency, with a clear inclination towards home entertainment electronics such as smart TVs, soundbars, and HDMI cables. Meanwhile, Cluster 2, although the smallest with only 2 customers, represents a niche segment focused on premium technology products like laptops, mice, and keyboards. These insights are backed by both the classic cluster legend summary and the dendrogram analysis, which provides granular insights into the hierarchical relationships among the customers based on their purchase behaviors.",
    "cluster_analysis": "The dendrogram and cluster legend provide a thorough breakdown of each cluster, highlighting important metrics such as the average spend and purchase frequency. Cluster 0 has an average spend of approximately 591.11 and purchase frequency of 8.81, indicating a more conservative shopping behavior with emphasis on cost-effective and everyday items. Cluster 1 shows an average spend of about 2577.37 with a frequency of 23.14, suggesting these customers are more engaged, possibly making deliberate and technology-focused investments at a higher price point. Cluster 2, with an average spend of 4321.68 and a purchase frequency of 29, targets power users or tech enthusiasts who demand high-end, performance-oriented products. This segmentation allows for clear targeting and differentiation strategies, ensuring that marketing efforts can be customized based on the customer's spending power and product affinity.",
    "customer_insights": "Each customer segment exhibits distinct characteristics that can be leveraged for targeted communication and engagement. Customers in Cluster 0 are likely to be price-conscious and value-driven, prioritizing affordability and convenience, which aligns with essential or recurring purchases. Cluster 1 customers appear to value enhanced experiences and technological upgrades, demonstrating a willingness to invest in quality home entertainment and electronics. The niche Cluster 2 customers are high spenders with a keen interest in premium technology products, potentially tech-savvy individuals who demand the latest and highest performing gadgets. These insights reveal a layered customer base, where understanding the underlying motivations and purchase patterns is critical in tailoring personalized messaging and offers that meet each segment's unique needs.",
    "marketing_recommendations": "Based on the detailed segmentation, it is recommended that marketing campaigns be highly personalized to address the distinct needs of each cluster. For Cluster 0, promotions should focus on value-for-money, bundling everyday items with loyalty discounts and seasonal offers that emphasize cost savings. Cluster 1 should be targeted with campaigns showcasing cutting-edge technology, product demos, and bundled high-tech entertainment packages alongside opportunities for upgrades and trade-ins. For the high-end Cluster 2, marketing should highlight premium quality, exclusive features, and after-sales support that reaffirms the brand’s leadership in innovation. Cross-channel promotions and personalized offers based on customer behavior analytics will ensure that messaging resonates effectively with each apportioned customer segment.",
    "channel_strategy": "The channel strategy must be diversified to meet the varied preferences of each customer segment. Digital channels, including targeted social media advertising, email marketing, and search engine marketing, can be utilized to effectively reach both Cluster 1 and Cluster 2 populations who are likely to be more digitally connected and responsive to dynamic content. For Cluster 0, a mix of traditional channels like direct mailers, local promotions, and in-store advertisements can complement digital outreach. Additionally, leveraging data-driven platforms to analyze web behavior and purchase history will enable retargeting efforts that refine messaging across channels. An integrated omni-channel approach, supported by a customer relationship management system that tracks engagement across platforms, is essential to deliver timely, relevant communications that drive both acquisition and retention.",
    "product_cross_sell_ideas": "There exists significant potential for cross-selling across the different customer clusters by identifying complementary products based on current purchasing habits. For instance, customers in Cluster 0 purchasing everyday items could be effectively introduced to bundled packages that include high-margin accessories or value-added services such as subscription models for essential consumables. In Cluster 1, a tech pairing of smart TVs with available streaming devices or enhanced sound systems can drive incremental sales. For Cluster 2, premium accessory upgrades such as ergonomic chairs, advanced peripheral devices, or extended warranties for laptops and high-end gadgets can be promoted. Additionally, targeting customers with complementary lifestyle or utility products based on their prior purchases offers the opportunity for personalized recommendations that add value to the customer experience while increasing average order value.",
    "retention_actions": "Retention efforts should focus on creating cohesive loyalty programs and personalized post-purchase support that continuously reinforces the value derived from ongoing engagement with the brand. For Cluster 0, incentives such as reward points, membership discounts, and exclusive offers on repeat purchases will help reduce churn. Cluster 1 customers can benefit from early access to new releases, invitations to exclusive product launches, and dedicated customer support that emphasizes premium service. For the higher-end Cluster 2, tailored concierge services, loyalty tiers with benefits such as extended warranties or priority support, and invitations to VIP events or tech expos can solidify long-term loyalty. Systematic customer engagement initiatives, including follow-up surveys and proactive feedback loops, are recommended to continuously gauge satisfaction levels and preemptively address concerns before they escalate.",
    "next_steps": "The next steps involve a detailed review of the segmentation findings by the marketing, data science, and product teams to align on targeting strategies and content personalization for each distinct customer cluster. It is recommended to develop pilot campaigns for each segment, monitor performance metrics closely, and adjust strategies based on real-time customer feedback and behavior analytics. Investing in advanced CRM tools to better track multi-channel engagement and integrating these insights with customer lifetime value models will further refine targeting refinements. Additionally, a cross-functional workshop should be organized to translate these insights into actionable marketing tactics, ensuring that product development, customer support, and sales are aligned in executing the tailored strategies efficiently and effectively.",
    "auto_insights": [
        "Cluster 0 has the most customers (31).",
        "Cluster 2 shows the highest average ticket (4,322).",
        "Cluster 0 generates 40.7% of total revenue."
    ],
    "dendrogram_insights": "• The clusters can be thought of as segments on a continuum from lower to higher spend and frequency, with Cluster 0 at the lower end and Cluster 2 at the higher end.  \n – Cluster 0:  \n  • 31 customers with the lowest average spend and frequency.  \n  • Their top purchases mix lifestyle goods (wine, cheese) with commodity items (diapers), implying a diverse but low-intensity purchasing pattern.  \n  • Synergy Opportunity: There is potential to cross-promote higher-margin or complementary products that are common to other clusters, by leveraging their everyday purchasing habits.  \n  • Cannibalisation Risk: Minimal if differentiated offers are maintained since their product mix is distinct from technology-focused clusters.  \n  • Migration Path: With targeted marketing or loyalty programs, some users might be nudged toward premium products offered in Clusters 1 and 2 if they develop a taste for technology or upgrade their lifestyle conveniences.\n\n• Cluster 1:  \n – 7 customers with moderate average spend and frequency.  \n – Their top categories are tech-related consumer electronics (smart-tv, soundbar, hdmi-cable), which nestles them between general lifestyle and high-end tech buyers.  \n – Synergy",
    "cluster_metrics": [
        {
            "cluster_id": 0,
            "n_customers": 31,
            "avg_spend": 591.11,
            "avg_frequency": 8.81,
            "top_categories": "wine, cheese, diapers",
            "share_revenue_pct": 40.71244292298313
        },
        {
            "cluster_id": 1,
            "n_customers": 7,
            "avg_spend": 2577.37,
            "avg_frequency": 23.14,
            "top_categories": "smart-tv, soundbar, hdmi-cable",
            "share_revenue_pct": 40.084084732597844
        },
        {
            "cluster_id": 2,
            "n_customers": 2,
            "avg_spend": 4321.68,
            "avg_frequency": 29.0,
            "top_categories": "laptop, mouse, keyboard",
            "share_revenue_pct": 19.20347234441903
        }
    ],
    "raw_payload": {
        "customers": [
            {
                "id": "C001",
                "frequency": 28,
                "amount_spent": 4120.75,
                "product_types": [
                    "laptop",
                    "mouse",
                    "keyboard",
                    "monitor"
                ]
            },
            {
                "id": "C002",
                "frequency": 5,
                "amount_spent": 190.4,
                "product_types": [
                    "tea",
                    "coffee"
                ]
            },
            {
                "id": "C003",
                "frequency": 12,
                "amount_spent": 845.1,
                "product_types": [
                    "jeans",
                    "t-shirt",
                    "sneakers"
                ]
            },
            {
                "id": "C004",
                "frequency": 2,
                "amount_spent": 75.0,
                "product_types": [
                    "notebook"
                ]
            },
            {
                "id": "C005",
                "frequency": 17,
                "amount_spent": 1324.55,
                "product_types": [
                    "smartphone",
                    "earbuds"
                ]
            },
            {
                "id": "C006",
                "frequency": 8,
                "amount_spent": 510.3,
                "product_types": [
                    "dog food",
                    "cat food"
                ]
            },
            {
                "id": "C007",
                "frequency": 24,
                "amount_spent": 2780.9,
                "product_types": [
                    "smart-tv",
                    "soundbar",
                    "hdmi-cable"
                ]
            },
            {
                "id": "C008",
                "frequency": 10,
                "amount_spent": 660.0,
                "product_types": [
                    "yogurt",
                    "milk",
                    "cheese"
                ]
            },
            {
                "id": "C009",
                "frequency": 3,
                "amount_spent": 120.0,
                "product_types": [
                    "stationery"
                ]
            },
            {
                "id": "C010",
                "frequency": 15,
                "amount_spent": 975.65,
                "product_types": [
                    "beer",
                    "wine",
                    "snacks"
                ]
            },
            {
                "id": "C011",
                "frequency": 7,
                "amount_spent": 450.25,
                "product_types": [
                    "books",
                    "pens"
                ]
            },
            {
                "id": "C012",
                "frequency": 25,
                "amount_spent": 3015.9,
                "product_types": [
                    "tablet",
                    "stylus",
                    "cover"
                ]
            },
            {
                "id": "C013",
                "frequency": 6,
                "amount_spent": 210.1,
                "product_types": [
                    "pasta",
                    "sauce"
                ]
            },
            {
                "id": "C014",
                "frequency": 20,
                "amount_spent": 1884.0,
                "product_types": [
                    "fitness-watch"
                ]
            },
            {
                "id": "C015",
                "frequency": 1,
                "amount_spent": 40.0,
                "product_types": [
                    "batteries"
                ]
            },
            {
                "id": "C016",
                "frequency": 13,
                "amount_spent": 1105.35,
                "product_types": [
                    "printer",
                    "ink"
                ]
            },
            {
                "id": "C017",
                "frequency": 4,
                "amount_spent": 160.0,
                "product_types": [
                    "flour",
                    "sugar",
                    "eggs"
                ]
            },
            {
                "id": "C018",
                "frequency": 30,
                "amount_spent": 4522.6,
                "product_types": [
                    "gaming-pc",
                    "rgb-mouse",
                    "gaming-chair",
                    "headset"
                ]
            },
            {
                "id": "C019",
                "frequency": 11,
                "amount_spent": 720.0,
                "product_types": [
                    "makeup",
                    "skincare"
                ]
            },
            {
                "id": "C020",
                "frequency": 9,
                "amount_spent": 585.4,
                "product_types": [
                    "toys",
                    "board-games"
                ]
            },
            {
                "id": "C021",
                "frequency": 2,
                "amount_spent": 55.0,
                "product_types": [
                    "candles"
                ]
            },
            {
                "id": "C022",
                "frequency": 18,
                "amount_spent": 1410.7,
                "product_types": [
                    "camera",
                    "sd-card"
                ]
            },
            {
                "id": "C023",
                "frequency": 14,
                "amount_spent": 992.0,
                "product_types": [
                    "office-chair",
                    "desk-lamp"
                ]
            },
            {
                "id": "C024",
                "frequency": 3,
                "amount_spent": 135.0,
                "product_types": [
                    "juice",
                    "cookies"
                ]
            },
            {
                "id": "C025",
                "frequency": 12,
                "amount_spent": 830.2,
                "product_types": [
                    "running-shoes",
                    "sports-socks"
                ]
            },
            {
                "id": "C026",
                "frequency": 23,
                "amount_spent": 2560.0,
                "product_types": [
                    "fridge",
                    "water-filter"
                ]
            },
            {
                "id": "C027",
                "frequency": 6,
                "amount_spent": 260.4,
                "product_types": [
                    "vitamins"
                ]
            },
            {
                "id": "C028",
                "frequency": 5,
                "amount_spent": 195.99,
                "product_types": [
                    "wine",
                    "cheese"
                ]
            },
            {
                "id": "C029",
                "frequency": 19,
                "amount_spent": 1599.95,
                "product_types": [
                    "e-reader",
                    "ebooks"
                ]
            },
            {
                "id": "C030",
                "frequency": 22,
                "amount_spent": 2345.0,
                "product_types": [
                    "washing-machine",
                    "detergent"
                ]
            },
            {
                "id": "C031",
                "frequency": 4,
                "amount_spent": 175.5,
                "product_types": [
                    "herbs",
                    "spices"
                ]
            },
            {
                "id": "C032",
                "frequency": 8,
                "amount_spent": 540.0,
                "product_types": [
                    "diapers",
                    "baby-wipes",
                    "formula"
                ]
            },
            {
                "id": "C033",
                "frequency": 27,
                "amount_spent": 3350.8,
                "product_types": [
                    "console",
                    "controller",
                    "games"
                ]
            },
            {
                "id": "C034",
                "frequency": 10,
                "amount_spent": 705.35,
                "product_types": [
                    "sunscreen",
                    "after-sun"
                ]
            },
            {
                "id": "C035",
                "frequency": 3,
                "amount_spent": 150.0,
                "product_types": [
                    "frozen-pizza"
                ]
            },
            {
                "id": "C036",
                "frequency": 16,
                "amount_spent": 1240.6,
                "product_types": [
                    "tool-set",
                    "drill"
                ]
            },
            {
                "id": "C037",
                "frequency": 9,
                "amount_spent": 610.1,
                "product_types": [
                    "organic-vegetables"
                ]
            },
            {
                "id": "C038",
                "frequency": 21,
                "amount_spent": 2105.0,
                "product_types": [
                    "air-fryer",
                    "cookbook"
                ]
            },
            {
                "id": "C039",
                "frequency": 7,
                "amount_spent": 435.75,
                "product_types": [
                    "flowers",
                    "vase"
                ]
            },
            {
                "id": "C040",
                "frequency": 14,
                "amount_spent": 1015.9,
                "product_types": [
                    "winter-jacket",
                    "gloves",
                    "scarf"
                ]
            }
        ],
        "labels": {
            "C001": 2,
            "C002": 0,
            "C003": 0,
            "C004": 0,
            "C005": 0,
            "C006": 0,
            "C007": 1,
            "C008": 0,
            "C009": 0,
            "C010": 0,
            "C011": 0,
            "C012": 1,
            "C013": 0,
            "C014": 1,
            "C015": 0,
            "C016": 0,
            "C017": 0,
            "C018": 2,
            "C019": 0,
            "C020": 0,
            "C021": 0,
            "C022": 0,
            "C023": 0,
            "C024": 0,
            "C025": 0,
            "C026": 1,
            "C027": 0,
            "C028": 0,
            "C029": 0,
            "C030": 1,
            "C031": 0,
            "C032": 0,
            "C033": 1,
            "C034": 0,
            "C035": 0,
            "C036": 0,
            "C037": 0,
            "C038": 1,
            "C039": 0,
            "C040": 0
        },
        "dendrogram": {
            "linkage_matrix": [
                [
                    1.0,
                    27.0,
                    5.5900115966796875,
                    2.0
                ],
                [
                    16.0,
                    34.0,
                    10.246950765959598,
                    2.0
                ],
                [
                    10.0,
                    38.0,
                    14.5,
                    2.0
                ],
                [
                    18.0,
                    33.0,
                    14.684114387072421,
                    2.0
                ],
                [
                    2.0,
                    24.0,
                    14.933482805184708,
                    2.0
                ],
                [
                    14.0,
                    20.0,
                    15.033296378372908,
                    2.0
                ],
                [
                    8.0,
                    23.0,
                    15.033296378372908,
                    2.0
                ],
                [
                    9.0,
                    22.0,
                    16.41102378466232,
                    2.0
                ],
                [
                    12.0,
                    40.0,
                    19.554342797373597,
                    3.0
                ],
                [
                    30.0,
                    41.0,
                    23.67840084690405,
                    3.0
                ],
                [
                    19.0,
                    36.0,
                    24.720185838561353,
                    2.0
                ],
                [
                    5.0,
                    31.0,
                    29.71684244831212,
                    2.0
                ],
                [
                    3.0,
                    45.0,
                    31.75951301054011,
                    3.0
                ],
                [
                    39.0,
                    47.0,
                    37.04603277151646,
                    3.0
                ],
                [
                    46.0,
                    49.0,
                    53.204636389447614,
                    5.0
                ],
                [
                    7.0,
                    43.0,
                    60.837535989873956,
                    3.0
                ],
                [
                    26.0,
                    48.0,
                    75.42189702647553,
                    4.0
                ],
                [
                    4.0,
                    35.0,
                    83.95602895187841,
                    2.0
                ],
                [
                    50.0,
                    51.0,
                    102.69139093644127,
                    4.0
                ],
                [
                    15.0,
                    53.0,
                    135.75478433757996,
                    4.0
                ],
                [
                    54.0,
                    56.0,
                    139.4687935795597,
                    9.0
                ],
                [
                    21.0,
                    57.0,
                    147.95607449395212,
                    3.0
                ],
                [
                    42.0,
                    58.0,
                    193.4435440607144,
                    6.0
                ],
                [
                    25.0,
                    29.0,
                    215.00232556881798,
                    2.0
                ],
                [
                    44.0,
                    55.0,
                    220.82693991432996,
                    5.0
                ],
                [
                    13.0,
                    37.0,
                    221.00452484055614,
                    2.0
                ],
                [
                    6.0,
                    11.0,
                    235.00212764994276,
                    2.0
                ],
                [
                    52.0,
                    60.0,
                    256.36800922508723,
                    12.0
                ],
                [
                    28.0,
                    61.0,
                    336.40545943552,
                    4.0
                ],
                [
                    0.0,
                    17.0,
                    401.8550746056813,
                    2.0
                ],
                [
                    32.0,
                    66.0,
                    522.3946688588159,
                    3.0
                ],
                [
                    62.0,
                    64.0,
                    537.5921954390619,
                    11.0
                ],
                [
                    63.0,
                    65.0,
                    647.7163731140352,
                    4.0
                ],
                [
                    59.0,
                    68.0,
                    743.4835774228395,
                    8.0
                ],
                [
                    70.0,
                    72.0,
                    1528.9174504219059,
                    7.0
                ],
                [
                    67.0,
                    71.0,
                    1623.9774150881199,
                    23.0
                ],
                [
                    73.0,
                    75.0,
                    2865.3048816814076,
                    31.0
                ],
                [
                    69.0,
                    74.0,
                    3076.681261272462,
                    9.0
                ],
                [
                    76.0,
                    77.0,
                    8866.563988339083,
                    40.0
                ]
            ],
            "columns": [
                "child1",
                "child2",
                "distance",
                "sample_count"
            ],
            "leaf_labels": [
                "C001",
                "C002",
                "C003",
                "C004",
                "C005",
                "C006",
                "C007",
                "C008",
                "C009",
                "C010",
                "C011",
                "C012",
                "C013",
                "C014",
                "C015",
                "C016",
                "C017",
                "C018",
                "C019",
                "C020",
                "C021",
                "C022",
                "C023",
                "C024",
                "C025",
                "C026",
                "C027",
                "C028",
                "C029",
                "C030",
                "C031",
                "C032",
                "C033",
                "C034",
                "C035",
                "C036",
                "C037",
                "C038",
                "C039",
                "C040"
            ],
            "cluster_legend": [
                {
                    "cluster_id": 0,
                    "n_customers": 31,
                    "avg_spend": 591.11,
                    "avg_frequency": 8.81,
                    "top_categories": "wine, cheese, diapers"
                },
                {
                    "cluster_id": 1,
                    "n_customers": 7,
                    "avg_spend": 2577.37,
                    "avg_frequency": 23.14,
                    "top_categories": "smart-tv, soundbar, hdmi-cable"
                },
                {
                    "cluster_id": 2,
                    "n_customers": 2,
                    "avg_spend": 4321.68,
                    "avg_frequency": 29.0,
                    "top_categories": "laptop, mouse, keyboard"
                }
            ]
        }
    }
}
```

---

### Response Object – Field-by-Field Guide

| **Top-Level Key**           | **Type**       | **Content**                                                           | **How to Use**                   |
| --------------------------- | -------------- | --------------------------------------------------------------------- | -------------------------------- |
| `language`                  | string         | “English”, “Español”, “Português”                                     | Confirms NLG locale              |
| `generated_on`              | ISO timestamp  | Report creation time (UTC)                                            | Versioning / caching             |
| `executive_summary`         | string         | 250–350 word board-level synopsis                                     | Paste directly into slide 1      |
| `cluster_analysis`          | string         | Deeper numeric comparison of clusters                                 | Analyst commentary               |
| `customer_insights`         | string         | Psychographic / behavioral interpretation                             | Brief for CRM & CX               |
| `marketing_recommendations` | string         | Channel / offer guidance                                              | Feed into campaign briefs        |
| `channel_strategy`          | string         | Omnichannel plan aligned to clusters                                  | Share with media agency          |
| `product_cross_sell_ideas`  | string         | Bundle & upsell suggestions                                           | Merchandise roadmap              |
| `retention_actions`         | string         | Loyalty & churn mitigation tactics                                    | CS & Loyalty teams               |
| `next_steps`                | string         | Action plan & governance                                              | Sprint planning                  |
| `auto_insights[]`           | array<string>  | Auto-mined data facts (e.g. “Cluster 0 has 40% of revenue”)           | Tooltip nuggets in BI dashboards |
| `dendrogram_insights`       | string \| null | Hierarchy commentary (only if dendrogram provided)                    | Present with dendrogram visual   |
| `cluster_metrics[]`         | array<object>  | KPI table (ID, size, spend, frequency, top categories, revenue share) | Load into BI dashboards          |
| `raw_payload`               | object         | Echo of your original request (secrets redacted)                      | Use for audit, reproducibility   |

---

### Commercial Value

| **Stakeholder**    | **Pain Solved**                                  | **How This Report Helps**                                        |
| ------------------ | ------------------------------------------------ | ---------------------------------------------------------------- |
| CMO / VP Marketing | Needs quick view of which segments drive revenue | Reads `executive_summary` + `marketing_recommendations` in 3 min |
| Growth Manager     | Lacks campaign copy ideas                        | Uses `product_cross_sell_ideas` directly                         |
| Merchandising Lead | Wants data-backed bundle recommendations         | Refers to `cluster category affinities`                          |
| Data-Ops           | Struggles with manual slide creation             | Automates with `/json → Lucid + PPTX template`                   |

---

### Integration Blueprint

Nightly ETL →
  /purchasing_segmentation →
  /purchasing_segmentation_dendrogram →
  /segmentation_report_json?lang=en →
  Save JSON to S3 / push sections to:
    • Notion wiki
    • Tableau dashboard (via Web Data Connector)
    • Slack #marketing-daily (via webhook)

---

### Minimal Python Example

```Python

import requests, json, boto3, datetime as dt

payload = { "customers": cust, "labels": labels, "dendrogram": dendro }

r = requests.post(
    "https://api.abintel.ai/api/segmentation_report_json?lang=en",
    headers={"X-Customer-Api-Id": ID, "X-Secret": SECRET},
    json=payload, timeout=60
)

report = r.json()

s3.put_object(
    Bucket="reports",
    Key=f"seg_{dt.date.today()}.json",
    Body=json.dumps(report).encode()
)
```

---

### Tips & Best Practices

Send the full dendrogram → unlocks `dendrogram_insights` your execs will love

Localise once, reuse → same payload, change `lang=pt` or `lang=es`

Version pinning → store `generated_on`, regenerate only if model or payload changes

Custom voice → Enterprise tier supports tone-of-voice fine-tuning (contact support)

GDPR compliance → hash `customer_id` before sharing externally

---

### FAQ

| **Question**                  | **Answer**                                                                                   |
| ----------------------------- | -------------------------------------------------------------------------------------------- |
| Can I change insight lengths? | Roadmap param: `depth=brief`                                                                 |
| Why repeat the raw payload?   | For self-contained audit trails. Strip before sharing if payload size matters.               |
| We need a PDF                 | Use `/segmentation_report_pdf` (same payload) or feed JSON into your template engine         |
| Does it support Chinese?      | Chinese/Japanese support is planned for 2026. Meanwhile, use `/translate_document` endpoint. |

---

### Next Step

Wire this endpoint into your marketing analytics CI/CD.
Every morning, wake up to an auto-written segmentation brief, in the right language, ready to ship.

---

# 4.1.13 /api/v1/ai/churn_risk

Predict, Explain & Act on Customer Churn

---

### Purpose

Feed a flat table of behavior + sentiment + billing signals and receive:

1. An auto-benchmarked model choice (LogReg, Tree, Boosting)

2. Probability-of-churn for every customer

3. Segment-level driver insight (what’s pushing risk up/down)

4. Ready-to-deploy retention playbooks per account

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### POST Endpoint

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/churn_risk`
```

---

### Request Body – Field-by-Field Cheat Sheet

| **JSON Key**        | **Type / Range**      | **Required?** | **Business Meaning**                        | **Typical Derivation**                 |
| ------------------- | --------------------- | ------------- | ------------------------------------------- | -------------------------------------- |
| `data[]`            | array<object>         | Yes           | One row per customer snapshot               | Daily view or rolling weekly export    |
| ↳ `customer_id`     | string                | Yes           | Primary key                                 | CRM / user table                       |
| ↳ `tenure`          | int (days ≥ 0)        | Yes           | Account age at snapshot date                | `DATEDIFF(today, first_purchase_date)` |
| ↳ `usage_frequency` | float (sessions/week) | Yes\*         | Avg. engagement over last 12 weeks          | `AVG(weekly_sessions)`                 |
| ↳ `service_tickets` | int ≥ 0               | Yes\*         | Support tickets opened last 90 days         | Zendesk / Freshdesk export             |
| ↳ `nps`             | int (−100…+100)       | Yes\*         | Latest Net Promoter Score                   | Survey DB; use `0` if missing          |
| ↳ `payment_events`  | int ≥ 0               | Yes\*         | Failed / late payments in last 12 months    | Billing logs                           |
| ↳ `churned`         | 0/1                   | Optional      | Ground-truth label for training/A-B scoring | Omit for inference-only use            |

* The model can impute missing numeric fields using medians, but predictive accuracy may be reduced.

---

### Snapshot-to-Label Rules (Industry Presets)

| **Sector**        | **Churned = 1 if…**                              |
| ----------------- | ------------------------------------------------ |
| Subscription SaaS | Cancelled within 30 days after the snapshot date |
| E-commerce        | No purchase in the following 90 days             |
| Pre-paid usage    | Balance hit zero and no top-up next cycle        |

---

### Request

```json
{
  "data": [
    {
      "customer_id": "C-0001",
      "tenure": 915,
      "usage_frequency": 6.2,
      "service_tickets": 1,
      "nps": 58,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0002",
      "tenure": 310,
      "usage_frequency": 1.9,
      "service_tickets": 4,
      "nps": 12,
      "payment_events": 3,
      "churned": 1
    },
    {
      "customer_id": "C-0003",
      "tenure": 442,
      "usage_frequency": 3.1,
      "service_tickets": 0,
      "nps": 70,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0004",
      "tenure": 95,
      "usage_frequency": 0.4,
      "service_tickets": 6,
      "nps": -10,
      "payment_events": 4,
      "churned": 1
    }
  ]
}
```

---

### Under the Hood – Model Selection Flow

1. `Pre-processing` z-score numeric fields, one-hot business rules (high ticket, detractor, failed_pay).

2. `Benchmark` 4 algos with defaults tuned for tabular data:

* Logistic Regression (elastic-net)

* Random Forest (100 trees)

* XGBoost (200 trees, depth 6)

* CatBoost (ordered boosting, depth 6)

3. `Validation` 5-fold stratified CV on labelled rows (if labels supplied; else use hold-out training set).

4. Pick algorithm with highest ROC-AUC, tie-break on F1 → Accuracy.

5. `Explain` LogReg coefficients or Tree SHAP summarised at group level (top_factors placeholder ready). Latency ~250 ms for 5 k rows on CPU.

---

### Response

```json
{
    "best_algorithm": "Logistic Regression",
    "evaluation_metrics": {
        "Logistic Regression": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "Random Forest": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "XGBoost": {
            "roc_auc": 0.5,
            "f1": 0.6666666666666666,
            "accuracy": 0.5
        },
        "CatBoost": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        }
    },
    "interpretation": "Logistic Regression achieved the highest validation performance (ROC-AUC=1.000, F1=1.000). High ticket volume combined with low NPS were the most influential churn drivers, underscoring the importance of support quality.",
    "results": [
        {
            "customer_id": "C-0001",
            "churn_probability": 1.316118330359693e-22,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0002",
            "churn_probability": 0.9993016452809322,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        },
        {
            "customer_id": "C-0003",
            "churn_probability": 0.0006985619483883015,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0004",
            "churn_probability": 0.9999999999992972,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        }
    ]
}
```

---

### Key Fields

| **Path**               | **Type**      | **Meaning**                                | **Ops Use**                                  |
| ---------------------- | ------------- | ------------------------------------------ | -------------------------------------------- |
| `best_algorithm`       | enum          | Algorithm deployed for inference           | Model-ops audit                              |
| `evaluation_metrics`   | nested object | Cross-validation scores per algorithm      | Gauge confidence, consider alternate models  |
| `interpretation`       | string        | One-paragraph driver summary               | Executive readout                            |
| `results[]`            | array         | Per-customer churn probabilities & actions | Feed to CRM / Customer Success               |
| ↳ `churn_probability`  | float (0–1)   | 0 = loyal, 1 = certain churn               | Use 0.5 as high-risk cut-off                 |
| ↳ `top_factors`        | array<string> | SHAP-style explanation (v1.8+)             | Use in rep scripts: "I noticed your ticket…" |
| ↳ `recommended_action` | enum (text)   | Rule-based retention advice                | Auto-trigger customer journeys               |

---

### Actionable Playbooks

| **Risk Band** | **Probability** | **Recommended Motion**                                 | **Typical Uplift** |
| ------------- | --------------- | ------------------------------------------------------ | ------------------ |
| **High**      | ≥ 0.60          | Offer % discount, priority support, concierge outreach | 15–35% save rate   |
| **Medium**    | 0.25–0.59       | Send value-focused email, usage tips, small promo      | 5–10% save rate    |
| **Low**       | < 0.25          | Light-touch nurture (no incentives)                    | Preserve margin    |

---

### Data Engineering Recipe (SQL)

```SQL
WITH sessions AS (
  SELECT user_id,
         COUNT(*)/12.0 AS usage_frequency
  FROM   app_sessions
  WHERE  session_date >= DATE_SUB(CURDATE(), INTERVAL 12 WEEK)
  GROUP  BY 1
),
tickets AS (
  SELECT user_id,
         COUNT(*) AS service_tickets
  FROM   support_tickets
  WHERE  created_at >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
  GROUP  BY 1
),
payments AS (
  SELECT user_id,
         SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) AS payment_events
  FROM   billing_events
  WHERE  event_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
  GROUP  BY 1
)
SELECT JSON_ARRAYAGG(
         JSON_OBJECT(
           'customer_id',    u.id,
           'tenure',         DATEDIFF(CURDATE(), u.first_purchase),
           'usage_frequency',COALESCE(s.usage_frequency, 0),
           'service_tickets',COALESCE(t.service_tickets, 0),
           'nps',            COALESCE(f.nps, 0),
           'payment_events', COALESCE(p.payment_events, 0)
         )
       ) AS payload
FROM users u
LEFT JOIN sessions  s ON s.user_id = u.id
LEFT JOIN tickets   t ON t.user_id = u.id
LEFT JOIN payments  p ON p.user_id = u.id
LEFT JOIN feedback  f ON f.user_id = u.id
WHERE u.status = 'active';
```

---

### Commercial Impact

| **Team**         | **Benefit**                                                  |
| ---------------- | ------------------------------------------------------------ |
| Customer Success | Auto-prioritise call lists; no more manual Excel scoring     |
| Finance          | Forecast MRR at risk; support LTV\:CAC models                |
| Product          | Identify UX churn causes (e.g. tickets → drop-off)           |
| Marketing        | Trigger re-engagement only for risk cohorts; save incentives |

---

### FAQ

| **Question**                        | **Answer**                                                                   |
| ----------------------------------- | ---------------------------------------------------------------------------- |
| Why are RF & CatBoost tied at 1.0?  | Demo set is tiny → perfect separation; real-world data = ROC-AUC \~0.75–0.92 |
| What if I only have 3 months’ data? | Model adapts; shorter tenure still valid                                     |
| GDPR considerations?                | No PII — only `customer_id`. Hash before sending externally                  |
| Can I upload 1M rows?               | Max 20MB per call (\~250k rows). Async bulk endpoint coming Q4 2025          |

---

### Next Step

Pipe the results[] table into your CRM or CDP, auto-trigger journeys for high-risk users, and track your churn-save KPI in your BI dashboard.

---

# 4.1.14 /api/v1/ai/nps

---

### Purpose

Real-Time Net-Promoter-Score Calculator
Compute the overall NPS for a survey batch and, optionally, slice the score by any categorical field (store, region, plan, agent, channel, etc.).
The service returns ready-made percentages plus a quick-read interpretation band so non-analysts can understand at a glance.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/nps
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

| **JSON Key**    | **Type / Range** | **Required?** | **Business Meaning**           | **Notes / Derivation**               |
| --------------- | ---------------- | ------------- | ------------------------------ | ------------------------------------ |
| `group_by`      | string           | optional      | Column to break out NPS by     | Leave empty to skip grouping         |
| `data[]`        | array<object>    | yes           | List of NPS responses          | Max 50,000 rows / 5 MB               |
| ↳ `customer_id` | string           | yes           | Respondent identifier          | For traceability                     |
| ↳ `question`    | string           | optional      | Survey question text           | Echoed back untouched                |
| ↳ `answer`      | int (0–10)       | yes           | Classic NPS scale              | Out-of-range returns HTTP 400        |
| ↳ `group`       | any              | conditional   | Value of the `group_by` column | Can be anything: store, region, etc. |
| ↳ `date`        | ISO-8601         | optional      | Response date                  | Useful for dashboards                |

---

### Request Example

```json
{
  "group_by": "group",
  "data": [
    {
      "customer_id": "C-0001",
      "question": "How likely are you to recommend our app?",
      "answer": 9,
      "group": "Store-A",
      "date": "2025-04-28"
    },
    {
      "customer_id": "C-0002",
      "answer": 4,
      "group": "Store-A",
      "date": "2025-04-28"
    },
    {
      "customer_id": "C-0003",
      "answer": 10,
      "group": "Store-B",
      "date": "2025-04-28"
    }
  ]
}
```

---

### How the Service Calculates NPS

* `Promoters` = answers 9–10

* `Passives` = answers 7–8

* `Detractors` = answers 0–6

`NPS = (%Promoters − %Detractors) × 100`
Values are rounded to two decimals.

---

### Interpretation Bands

| **NPS Score** | **Label**                   |
| ------------- | --------------------------- |
| ≥ 70          | World-class loyalty         |
| 50 – 69       | Excellent                   |
| 30 – 49       | Good                        |
| 0 – 29        | Fair – room for improvement |
| −100 – −1     | Critical warning            |

Customizable in enterprise plan

---

### Response Example

```json
{
  "overall": {
    "nps": 33.33,
    "promoters_pct": 66.67,
    "passives_pct": 0.0,
    "detractors_pct": 33.33,
    "responses": 3,
    "interpretation": "Fair – room for improvement"
  },
  "by_group": [
    {
      "nps": 0.0,
      "promoters_pct": 50.0,
      "passives_pct": 0.0,
      "detractors_pct": 50.0,
      "responses": 2,
      "group": "Store-A",
      "interpretation": "Fair – room for improvement"
    },
    {
      "nps": 100.0,
      "promoters_pct": 100.0,
      "passives_pct": 0.0,
      "detractors_pct": 0.0,
      "responses": 1,
      "group": "Store-B",
      "interpretation": "World-class loyalty"
    }
  ]
}
```

---

### Field Guide

| **Path**                 | **Type** | **Meaning**               | **Dashboard Use**       |
| ------------------------ | -------- | ------------------------- | ----------------------- |
| `overall.nps`            | float    | Global NPS                | Trend analysis          |
| `overall.promoters_pct`  | float %  | Promoter share            | Target ≥ 60%            |
| `overall.passives_pct`   | float %  | Passive share             | Monitor shifts          |
| `overall.detractors_pct` | float %  | Detractor share           | Trigger alerts if >20%  |
| `by_group[]`             | array    | Per-group metrics         | Heat-maps, slice & dice |
| `interpretation`         | string   | Interpretation band label | Copy to Slack, emails   |

---

### Commercial Playbooks

| **Scenario**               | **Action**                                                       | **Outcome**                         |
| -------------------------- | ---------------------------------------------------------------- | ----------------------------------- |
| Store-B pops 100 NPS       | Use as benchmark in testimonials & ads                           | +12% conversion                     |
| Store-A stuck at 0 NPS     | Deep-dive into CSAT logs, fulfilment issues                      | Find root causes (e.g., stock-outs) |
| Overall slips from 45 → 30 | Fire CSAT survey to Passives, route Detractors to retention team | +8pp recovery within 2 weeks        |

---

### Integration Best Practices

1. Collect responses via email, WhatsApp, app, kiosk, etc.

2. ETL raw data into staging table

3. Call /api/nps hourly and store the snapshot

4. Visualise with heat-maps and trend lines

5. Alert on NPS drops across bands

---

### Python Cron Job Example

```Python
payload = build_payload_from_sql(last_hour())
r = requests.post(
    "https://api.abintel.ai/api/nps",
    headers={"X-Customer-Api-Id": ID, "X-Secret": SECRET},
    json=payload,
    timeout=15
)
db.insert("nps_snapshot", r.json())
```

---

### FAQ

| **Question**               | **Answer**                                                         |
| -------------------------- | ------------------------------------------------------------------ |
| Can I group by two fields? | Not yet. Use multiple calls. Multi-dim grouping in roadmap (v1.9). |
| What if answer is 11?      | Will return HTTP 400. Clean data before sending.                   |
| Max number of groups?      | Up to 1,000 unique group values per call.                          |
| Does it store my data?     | No. Stateless; payload is discarded after \~2 minutes.             |

---

### Next Step
Automate NPS snapshots hourly, trigger alerts on Detractor spikes, and share grouped insights with frontline teams to drive continuous improvement in customer experience (CX).

---

# 4.1.15 /api/v1/ai/churn_label

---

### Purpose

Create a binary churn label `(churned = 0 | 1)` from raw customer lifecycle data using vertical-specific business rules.

Use cases:

* Generate training sets for `/api/churn_risk`

* Benchmark retention initiatives (true / false positives)

* Track “new churn” KPI without spreadsheets

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/churn_label
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

| **Key**        | **Type**                                      | **Required** | **Meaning**                      |
| -------------- | --------------------------------------------- | ------------ | -------------------------------- |
| business\_type | enum `"ecommerce"` \| `"saas"` \| `"prepaid"` | yes          | Chooses the rule set (see below) |
| data           | array<object>                                 | yes          | One row per snapshot at time `t` |

Extra fields are ignored (can be used for auditing).

---

### Built-in Churn Rules

| **Business Type** | **Required Fields**                                          | **Churn Rule (churned = 1 if…)**                         | **Typical Window**      |
| ----------------- | ------------------------------------------------------------ | -------------------------------------------------------- | ----------------------- |
| `ecommerce`       | `snapshot_date`, `last_purchase_date`                        | `snapshot_date - last_purchase_date ≥ 90 days`           | 90 days silence = churn |
| `saas`            | `snapshot_date`, `subscription_cancelled` (bool)             | `subscription_cancelled = true`                          | Same-day detection      |
| `prepaid`         | `snapshot_date`, `balance_after_t`, `topped_up_within_cycle` | `balance_after_t = 0 AND topped_up_within_cycle = false` | One billing cycle       |

* Why 90 days for e-commerce? It reflects the industry median reorder interval across 30+ retailers.

---

### Worked Examples

* E-commerce Example

```json
{
  "business_type": "ecommerce",
  "data": [
    {
      "customer_id": "E-101",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2024-12-15"
    },
    {
      "customer_id": "E-102",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2025-03-20"
    }
  ]
}
```

---

### Response

```json
[
  { "customer_id": "E-101", "snapshot_date": "2025-04-01", "churned": 1 },
  { "customer_id": "E-102", "snapshot_date": "2025-04-01", "churned": 0 }
]
```

---

### SaaS Example

```json
{
  "business_type": "saas",
  "data": [
    {
      "customer_id": "S-001",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": true
    },
    {
      "customer_id": "S-002",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": false
    }
  ]
}
```

---

### Prepaid Example

```json
{
  "business_type": "prepaid",
  "data": [
    {
      "customer_id": "P-777",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": false
    },
    {
      "customer_id": "P-778",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": true
    }
  ]
}
```

---

### Field Dictionary & Rationale

| **Field**                | **Why It Matters**                       | **Example**    |
| ------------------------ | ---------------------------------------- | -------------- |
| `snapshot_date`          | Freeze point: when you check churn state | `"2025-04-01"` |
| `last_purchase_date`     | Recency check for e-commerce             | `"2024-12-15"` |
| `subscription_cancelled` | Definitive SaaS churn signal             | `true`         |
| `balance_after_t`        | Prepaid credit balance                   | `0.0`          |
| `topped_up_within_cycle` | Detect lapse vs. engagement              | `false`        |

---

### Typical ETL Pattern (SQL)

```SQL
INSERT INTO churn_labels
SELECT
    c.customer_id,
    DATE ?snapshot AS snapshot_date,
    CASE
      WHEN ?business_type = 'ecommerce'
           AND DATEDIFF(?snapshot, c.last_purchase) >= 90 THEN 1
      WHEN ?business_type = 'saas'
           AND c.subscription_cancelled THEN 1
      WHEN ?business_type = 'prepaid'
           AND c.balance = 0 AND c.topped_up = 0 THEN 1
      ELSE 0
    END AS churned
FROM staging_customers c;
```

Push this result to /api/churn_risk as your label column.

---

### Commercial Uses

| **Team**      | **Use Case**                                          |
| ------------- | ----------------------------------------------------- |
| Data Science  | Build training sets for churn model                   |
| Finance       | Track true churn for forecasting                      |
| Marketing Ops | Launch win-back flows 90 days post last order (e-com) |
| Product       | Evaluate onboarding impact on cancellations (SaaS)    |

---

### FAQ

| **Question**                                 | **Answer**                                                       |
| -------------------------------------------- | ---------------------------------------------------------------- |
| Can I change the churn window for e-com?     | Yes – use `"window_days": 60` (Enterprise only).                 |
| What happens if required fields are missing? | Returns HTTP 400 with the missing keys listed.                   |
| Does the service store data?                 | No – it is stateless. Payload is discarded post-response.        |
| Max batch size?                              | 250,000 rows or 20 MB per request. Async support coming Q4 2025. |

---

### Next Step

Schedule `/api/churn_label` to run daily, pipe results into your churn training pipeline, and keep models fresh—without touching SQL every time.

---

# 4.2 Propensity & Recommendation

---

### Scope

`propensity_buy_product`

`propensity_respond_campaign`

`propensity_upgrade_plan`

`recommend_user_items`

`recommend_similar_items`

`cross_sell_matrix`

`upsell_suggestions`

`dynamic_pricing_recommend`

`uplift_model`

---

# 4.2.1 /api/v1/ai/propensity_buy_product

---

### Purpose

* SKU-Level Uplift Scoring

Predict how likely each individual customer is to purchase a specific product (or close substitute) in the next campaign cycle. Customers are ranked into tiers: Very High → Very Low so you can:

Send SKU-targeted emails/SMS to the top deciles

Optimize look-alike audiences for paid media

Personalize on-site banners and recommendations

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/propensity_buy_product
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

| **Key**       | **Type / Range** | **Required** | **Meaning**                  | **Typical Derivation**     |
| ------------- | ---------------- | ------------ | ---------------------------- | -------------------------- |
| `product_sku` | string           | yes          | The SKU to push              | Use canonical catalogue ID |
| `customers`   | array<object>    | yes          | Rows to score or train+score | From CDP or feature store  |

---

### Customer Object Fields

| **Key**       | **Type** | **Required** | **Meaning**                            |
| ------------- | -------- | ------------ | -------------------------------------- |
| `customer_id` | string   | yes          | CRM primary key                        |
| `features`    | object   | yes          | Flat numeric feature vector            |
| `label_buy`   | 0 / 1    | optional     | Ground-truth flag if used for training |

---

###  Starter Feature Dictionary

| **Feature**               | **Business Meaning**           | **Example SQL**                             |
| ------------------------- | ------------------------------ | ------------------------------------------- |
| `age`                     | Customer's age in years        | `EXTRACT(YEAR FROM AGE(birth_date))`        |
| `tenure_months`           | Lifetime with brand            | `DATEDIFF(MONTH, first_purchase, snapshot)` |
| `category_views_last_30d` | Engagement with SKU's category | GA / Mixpanel page views                    |
| `avg_ticket`              | Mean order value               | `AVG(order_total)`                          |

---

### How It Works Internally

1. Label Check
2. 
Requires ≥ 20 labeled rows per class (0 and 1); otherwise exits with a message.

2. AutoML

Tries LogReg, XGBoost, RF, CatBoost. Chooses best ROC-AUC (5-fold CV).

3. Scoring

Outputs probability `P(buy=1)`.

4. Tier Mapping (defaults)

* Very High ≥ 90%

* High ≥ 70%

* Medium ≥ 40%

* Low ≥ 20%

* Very Low < 20%

---

### Example #1 – Not Enough Labels

## Request

```json
{
  "product_sku": "SKU-A123",
  "customers": [
    {
      "customer_id": "C-1001",
      "features": { "age": 34, "tenure_months": 27, "category_views_last_30d": 15, "avg_ticket": 185.3 },
      "label_buy": 1
    },
    {
      "customer_id": "C-1002",
      "features": { "age": 57, "tenure_months": 3, "category_views_last_30d": 2, "avg_ticket": 42.1 }
    }
  ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    },
    {
      "customer_id": "C-1002",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example #2 – Sufficient Labels (Training + Scoring)

```json
{
  "product_sku": "SKU-A123",
  "customers": [ ... 5000 rows with `label_buy` ... ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1234",
      "probability": 0.91,
      "propensity_tier": "Very High",
      "interpretation": "Very high propensity – prime candidate for personalised offer."
    }
  ],
  "model_info": {
    "best_algorithm": "CatBoost",
    "roc_auc": 0.842,
    "selected_features": ["category_views_last_30d", "tenure_months", "avg_ticket"],
    "train_rows": 4800,
    "test_rows": 200
  }
}
```

---

### Field Glossary – Response

| **Path**                        | **Type**       | **Meaning**                                | **Usage**                 |
| ------------------------------- | -------------- | ------------------------------------------ | ------------------------- |
| `predictions[].probability`     | float or null  | Buy probability                            | Sort for campaigns        |
| `predictions[].propensity_tier` | enum           | Very High / High / Medium / Low / Very Low | Filter by segment         |
| `predictions[].interpretation`  | string         | Simple wording for action                  | Use in CRM/email merge    |
| `model_info.best_algorithm`     | string         | AutoML selected algorithm                  | ML audit                  |
| `model_info.roc_auc`            | float          | AUC on hold-out set                        | Compare to baseline model |
| `model_info.note`               | string or null | Error/skip reason                          | Alert or debug            |

---

### Commercial Playbooks

| **Use-case**             | **Action**                                    | **KPI Lift**         |
| ------------------------ | --------------------------------------------- | -------------------- |
| Email blast optimisation | Send SKU promo only to High & Very High tiers | +22% CTR, –46% unsub |
| On-site banner           | Show product for users with P(buy) ≥ 0.7      | +18% PDP views       |
| Paid social              | Export top 10% to Look-alike on Meta          | –15% CPA             |
| Sales queue              | Push High tier to CRM call list               | +12% close rate      |

---

### Data Engineering Tips

Labeling: Define 30/60/90d window → `label_buy = 1 if purchased`.

Feature TTL: Refresh time-sensitive features (e.g. views) daily.

Cold Start SKUs: Use category-level model if SKU lacks data.

---

### FAQ

| **Q**                                     | **A**                                                           |
| ----------------------------------------- | --------------------------------------------------------------- |
| Can I send categorical features?          | Yes – send as strings, auto-encoded internally.                 |
| Multiple SKUs in one call?                | No – one SKU per request (loop client-side).                    |
| All probabilities `null` – what happened? | Likely fewer than 20 positive labels or only one class present. |
| Can I override tier cut-offs?             | Yes – use `tier_quantiles:[0.9,0.7,0.4,0.2]` (Enterprise only). |
| Max batch size?                           | 100k rows or 20MB per call. Async/bulk version: Q4 2025.        |

---

### Next Step

Pipe High and Very High tiers into your campaign engine.
Suppress Very Low, reduce fatigue, and boost SKU performance per e-mail.

---

# 4.2.2 /api/v1/ai/propensity_respond_campaign

---

### Purpose – Will They Engage With This Campaign?

Forecast the individual likelihood that a customer will open, click, or purchase from a specific marketing campaign. Ideal for:

* Audience trimming to protect deliverability

* Discount allocation (e.g., full coupon only to top deciles)

* Predictive hold-out tests & incremental-lift measurement

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/propensity_respond_campaign
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

## Required Fields

| **Key**       | **Type / Range** | **Required?** | **Meaning**                         | **Typical Derivation**      |
| ------------- | ---------------- | ------------- | ----------------------------------- | --------------------------- |
| `campaign_id` | string           | yes           | ID or slug of the outbound campaign | e.g., `"Spring-Promo-2025"` |
| `customers`   | array<object>    | yes           | Rows to score (or train + score)    | From CDP or ESP export      |

---

### Customer Object Fields

| **Field**       | **Type** | **Required?** | **Business Meaning**               |
| --------------- | -------- | ------------- | ---------------------------------- |
| `customer_id`   | string   | yes           | Primary key (CRM ID)               |
| `features`      | object   | yes           | Numeric/categorical features       |
| `label_respond` | 0 / 1    | optional      | Ground truth if customer responded |

---

### Starter Feature Kit

| **Feature**          | **What it Captures**        | **Example SQL / Source**         |
| -------------------- | --------------------------- | -------------------------------- |
| `email_click_rate`   | Historical email engagement | clicks / sends over last 90 days |
| `sms_opt_in`         | SMS subscription flag       | From ESP opt-in table            |
| `purchases_last_90d` | Recent transaction count    | `COUNT(DISTINCT order_id)`       |

---

### What the Service Does

1. Label Check: Requires ≥ 20 of both label_respond = 0 and label_respond = 1.

2. AutoML: Runs Logistic Regression, XGBoost, Random Forest, CatBoost with 5-fold CV.

3. Scoring: Outputs calibrated P(respond = 1).

4. Tier Mapping (default):

* Very High ≥ 0.9

* High ≥ 0.7

* Medium ≥ 0.4

* Low ≥ 0.2

* Very Low < 0.2

5. Interpretation: Tier-specific explanations in plain English.

---

### Example 1 – Too Few Labels

## Request

```json
{
  "campaign_id": "Spring-Promo-2025",
  "customers": [
    {
      "customer_id": "C-2001",
      "features": {
        "email_click_rate": 0.22,
        "sms_opt_in": 1,
        "purchases_last_90d": 3
      },
      "label_respond": 0
    }
  ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-2001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example 2 – Full Model Training & Scoring

Assume 10,000 rows passed, with 2,000 historical responders (`label_respond = 1`).

## Response Snippet

```json
{
  "predictions": [
    {
      "customer_id": "C-6155",
      "probability": 0.77,
      "propensity_tier": "High",
      "interpretation": "High propensity – include in main send."
    },
    {
      "customer_id": "C-9342",
      "probability": 0.12,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – suppress or cheaper channel."
    }
  ],
  "model_info": {
    "best_algorithm": "XGBoost",
    "roc_auc": 0.812,
    "feature_importance": ["email_click_rate", "purchases_last_90d", "sms_opt_in"],
    "train_rows": 9000,
    "test_rows": 1000
  }
}
```

---

### Response Field Guide

| **Path**                    | **Type**     | **Meaning**                          | **Usage**                        |
| --------------------------- | ------------ | ------------------------------------ | -------------------------------- |
| `predictions[].probability` | float / null | Response probability                 | Score thresholding at 0.7 or 0.4 |
| `propensity_tier`           | enum         | Engagement likelihood tier           | Segment filters in ESP or CRM    |
| `interpretation`            | string       | Readable explanation                 | Sales or support rep copy        |
| `best_algorithm`            | string       | AutoML model used                    | For reproducibility              |
| `roc_auc`                   | float        | Hold-out performance (AUC)           | Model evaluation metric          |
| `note`                      | string       | Shown when model training is skipped | Alert data team if shown         |

---

### Commercial Playbooks

| **Use Case**         | **Action**                                      | **Lift / ROI**                        |
| -------------------- | ----------------------------------------------- | ------------------------------------- |
| Email deliverability | Send only to Medium–Very High tiers             | +8 pp open-rate, –40% spam complaints |
| Discount cost        | Give full discount to High/Very High only       | –18% promo cost, +5% revenue          |
| SMS vs Push          | SMS = High tiers, Push = Medium, Suppress = Low | –27% messaging cost, same revenue     |
| A/B testing          | Hold out 10% of High tier for true uplift       | Clean incremental sales measurement   |

---

###  Data Engineering Best Practices

1. **Label window** – mark `label_respond` = 1 if customer opened OR clicked OR transacted within 7 days of campaign send (customisable).

2. **Feature freshness** – refresh behavioural features nightly; stale email-click rates hurt performance fast.

3. **Cold-start campaigns** – for brand-new `campaign_id` with zero labels, warm-start with a global engagement model (road-map endpoint `propensity_engage_any`).

4. **Feature parity** – keep the same feature set between training and inference to avoid schema drift.

---

### FAQ

| **Q**                                         | **A**                                                       |
| --------------------------------------------- | ----------------------------------------------------------- |
| Can I train once and score later?             | Yes, models are cached for 30 days.                         |
| Can I score for click vs purchase separately? | Multi-class model support planned for Q1 2026.              |
| How many customers per call?                  | 100,000 rows or 20MB; bulk async in roadmap.                |
| PII / GDPR safe?                              | Yes – only `customer_id` is required. Use hashes if needed. |

---

### Next Step

Send High and Very High IDs into your ESP, prioritize based on score, and maximize ROAS while minimizing list fatigue.

Let me know if you'd like me to format the next endpoint `/propensity_upgrade_plan` in the same style.

---

# 4.2.3 /api/v1/ai/propensity_upgrade_plan

---

### Purpose – Upsell-Ready Scores for Plan Upgrades

Predict each customer’s likelihood to upgrade from their current subscription tier to a more lucrative target tier during your next upsell push or in-app paywall.

Use cases:

* Prioritise CSM outreach or in-product nudges

* Forecast revenue upside before launching “Go Gold Now” offers

* Build look-alike audiences for acquisition

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/propensity_upgrade_plan
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body – Schema & Field Guide

## Required Fields

| **Key**        | **Type / Range** | **Required** | **Meaning**             | **Notes / Source**        |
| -------------- | ---------------- | ------------ | ----------------------- | ------------------------- |
| `current_plan` | string           | yes          | Customer’s current tier | e.g., "Starter", "Silver" |
| `target_plan`  | string           | yes          | Tier to upsell to       | e.g., "Gold", "Pro"       |
| `customers`    | array<object>    | yes          | Customer records        | Pulled from CRM/CDP       |

---

### Customer Object Fields

| **Field**       | **Type** | **Required** | **Meaning**                          |
| --------------- | -------- | ------------ | ------------------------------------ |
| `customer_id`   | string   | yes          | CRM primary key                      |
| `features`      | object   | yes          | Flat numeric/categorical feature set |
| `label_upgrade` | 0 / 1    | optional     | 1 if upgraded in historical window   |

---

### Starter Feature Kit

| **Feature**                | **What it Captures**            | **Typical SQL / Metric**                |
| -------------------------- | ------------------------------- | --------------------------------------- |
| `months_on_current_plan`   | Upgrade timing urgency          | `DATEDIFF(MONTH, plan_start, snapshot)` |
| `storage_usage_pct`        | Capacity squeeze trigger        | `(used_storage / quota) * 100`          |
| `support_tickets_last_30d` | Support interactions / friction | `COUNT(Zendesk tickets)`                |

Feel free to add fields like `MRR`, `API_call_volume`, `project_count`, `NPS`, etc.

---

### Engine Workflow

1. Label check: ≥ 20 `label_upgrade = 1` and `0` required for model training.

2. AutoML: Tries Logistic Regression, RF, XGBoost, CatBoost (5-fold CV).

3. Calibrated output: Returns `P(upgrade = 1)` for each customer.

4. Tier mapping:

* Very High ≥ 0.90

* High ≥ 0.70

* Medium ≥ 0.40

* Low ≥ 0.20

* Very Low < 0.20

5. Interpretation: Each score includes a one-line summary.

---

### Example #1 – Not Enough Labels

```json
{
  "current_plan": "Silver",
  "target_plan": "Gold",
  "customers": [
    {
      "customer_id": "C-3001",
      "features": {
        "months_on_current_plan": 8,
        "storage_usage_pct": 92,
        "support_tickets_last_30d": 4
      },
      "label_upgrade": 1
    }
  ]
}
```

---

### Response

```json
{
  "predictions": [
    {
      "customer_id": "C-3001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example #2 – Full Training & Scoring

(5,000 rows; 600 upgrades observed)

---

### Response Snippet

```json
{
  "predictions": [
    {
      "customer_id": "C-3088",
      "probability": 0.86,
      "propensity_tier": "High",
      "interpretation": "High propensity – push personalised upgrade offer."
    },
    {
      "customer_id": "C-3201",
      "probability": 0.18,
      "propensity_tier": "Low",
      "interpretation": "Low propensity – nurture, don’t discount."
    }
  ],
  "model_info": {
    "best_algorithm": "CatBoost",
    "roc_auc": 0.79,
    "selected_features": [
      "storage_usage_pct",
      "months_on_current_plan",
      "support_tickets_last_30d"
    ],
    "train_rows": 4500,
    "test_rows": 500
  }
}
```

---

### Response Field Glossary

| **Path**                    | **Type**      | **Meaning**                                | **Practical Use**                |
| --------------------------- | ------------- | ------------------------------------------ | -------------------------------- |
| `predictions[].probability` | float / null  | Likelihood of upgrade next cycle           | Rank and filter (≥ 0.7 = target) |
| `propensity_tier`           | enum          | Very High / High / Medium / Low / Very Low | CRM / ESP segmentation           |
| `interpretation`            | string        | Sales-friendly summary                     | Tooltips, email, CRM             |
| `model_info.best_algorithm` | string / null | Best AutoML model                          | Audit and reproducibility        |
| `model_info.roc_auc`        | float / null  | Holdout performance                        | Model quality tracking           |
| `model_info.note`           | string / null | Explanation if training skipped            | Alert data/ML team               |

---

### Commercial Playbooks

| **Scenario**        | **Action**                                                | **Lift**                           |
| ------------------- | --------------------------------------------------------- | ---------------------------------- |
| Usage-driven upsell | Auto-trigger in-app pop-up if tier = High + storage > 80% | +22% conversion vs. generic prompt |
| CSM queue           | Push Very High customers into CSM dashboards              | +15% expansion MRR                 |
| Email offer         | Send discounts to Medium–High only; suppress Very Low     | –38% promo cost, same revenue      |
| Pricing strategy    | Compare scores before/after price change                  | Data-driven elasticity measure     |

---

### Data & Ops Best Practices

* Label window: `label_upgrade = 1` if upgrade happened within 90 days after snapshot.

* Feature freshness: Daily update for storage_usage_pct.

* Multi-step ladders: Train per plan hop (e.g., Silver→Gold, Gold→Platinum).

* Model caching: Auto-caches model per `current_plan + target_plan` for 30 days.

---

### FAQ

| **Q**                                      | **A**                                                        |
| ------------------------------------------ | ------------------------------------------------------------ |
| Can I score multiple target plans at once? | No – one per request to avoid model confusion.               |
| Only 12 positive upgrades?                 | Expand window, group tiers, or request generic upsell model. |
| Downgrade prediction?                      | Use `/propensity_downgrade_plan` (beta).                     |
| GDPR?                                      | Hash `customer_id`; no other PII is required.                |
| Max batch size?                            | 100,000 rows or 20MB; async bulk support in Q4 2025.         |

---

### Next Step

Pipe High and Very High propensities into your CSM and marketing tools. Trigger tailored upgrade journeys and watch expansion MRR grow—without blanketing your entire user base.

---

# 4.2.4 /api/v1/ai/recommend_user_items

### Purpose – Hyper-Personalised Product Suggestions in One Call

Generate a ranked list of items most likely to interest a given user by combining historical interactions with product metadata.

Model Logic:

* ALS (matrix factorisation) when ≥ 75 users × ≥ 50 items.

* TF-IDF + cosine similarity for sparse or cold-start scenarios.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/recommend_user_items
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body – Complete Field Reference

## Root Keys

| **JSON Path**  | **Type / Range** | **Required** | **Meaning**                   | **Notes**                                         |
| -------------- | ---------------- | ------------ | ----------------------------- | ------------------------------------------------- |
| `user_id`      | string           | yes          | User to recommend items for   | Example: "U-42"                                   |
| `top_k`        | int (1–100)      | optional     | Max number of recommendations | Default: 10; 5–25 for email; 50–100 for UI scroll |
| `interactions` | array<object>    | yes          | Clicks, views, ratings, buys  | Min 3 rows                                        |
| `items`        | array<object>    | yes          | Items to rank                 | Supply full candidate catalogue                   |

---

### interactions[] Structure

| **Key**   | **Type** | **Required** | **Notes**                               |
| --------- | -------- | ------------ | --------------------------------------- |
| `user_id` | string   | yes          | Can be other users to help matrix build |
| `item_id` | string   | yes          | Must exist in `items[]`                 |
| `rating`  | float    | optional     | 0–5 explicit score; else treated as +1  |

---

### items[] Structure

| **Key**    | **Type** | **Required** | **Notes**                                    |
| ---------- | -------- | ------------ | -------------------------------------------- |
| `item_id`  | string   | yes          | Primary key                                  |
| `metadata` | string   | optional     | Rich attributes: category, brand, tags, etc. |

* You may include extra keys (e.g. price), which are ignored now but stored for future use.

---

### Algorithm Selection & Pipeline

| **Step**              | **Dense Matrix (ALS)**                      | **Sparse / Cold-start (TF-IDF)**           |
| --------------------- | ------------------------------------------- | ------------------------------------------ |
| **1. Check Sparsity** | ≥ 75 users, ≥ 50 items, ≥ 1500 interactions | Otherwise                                  |
| **2. Prepare Data**   | Implicit matrix; weight rating/5 vs. 1      | TF-IDF over metadata (bigrams, idf smooth) |
| **3. Train**          | ALS (50 dims, 30 iterations)                | —                                          |
| **4. Score**          | Cosine similarity in latent space           | Cosine similarity in TF-IDF vector space   |
| **5. Filter**         | Remove already seen items, apply diversity  | —                                          |
| **6. Return**         | Top-K by score                              | Top-K by similarity                        |

## Performance:

* ALS cached: ~60 ms

* TF-IDF fallback: ~15 ms (100k-item catalogue, CPU)

---

### Example Request

```json
{
  "user_id": "U-42",
  "top_k": 5,
  "interactions": [
    {"user_id": "U-42", "item_id": "SKU-A1", "rating": 5},
    {"user_id": "U-42", "item_id": "SKU-B9"},
    {"user_id": "U-17", "item_id": "SKU-C3", "rating": 4}
  ],
  "items": [
    {"item_id": "SKU-A1", "metadata": "Running shoes, Nike, men"},
    {"item_id": "SKU-B9", "metadata": "Trail shoes, Adidas, women"},
    {"item_id": "SKU-C3", "metadata": "Soccer ball, size 5"},
    {"item_id": "SKU-D7", "metadata": "Compression socks, unisex"},
    {"item_id": "SKU-E2", "metadata": "Fitness smartwatch"}
  ]
}
```

---

### Example Response

```json
{
  "recommendations": [
    {
      "item_id": "SKU-B9",
      "score": 0.1783,
      "source": "content-fallback",
      "explanation": "Shares similar attributes/keywords with the reference item."
    },
    {
      "item_id": "SKU-C3",
      "score": 0.0000,
      "source": "content-fallback"
    }
  ],
  "model_info": {
    "algorithm": "TF-IDF cosine",
    "metric": "cosine_sim",
    "value": 1.0,
    "train_rows": 5
  }
}
```

---

### Field Guide

| **Path**                        | **Type**       | **Meaning**                     | **Use**                   |
| ------------------------------- | -------------- | ------------------------------- | ------------------------- |
| `recommendations[].item_id`     | string         | SKU to show                     | PDP, email, widgets       |
| `recommendations[].score`       | float 0–1      | Relevance score                 | Use in ranking / blending |
| `recommendations[].source`      | enum           | `als` or `content-fallback`     | Trace model used          |
| `recommendations[].explanation` | string         | Why it was recommended          | Display in UI             |
| `model_info.algorithm`          | string         | Engine used                     | Audit log                 |
| `model_info.metric/value`       | string / float | Fit score (cosine\_sim or RMSE) | Drift monitoring          |
| `model_info.train_rows`         | int            | Count of training interactions  | Data quality checkpoint   |

---

### Commercial Playbooks

| **Surface**         | **Implementation**                                  | **Lift**               |
| ------------------- | --------------------------------------------------- | ---------------------- |
| PDP                 | Call client-side on load                            | +9% add-to-cart        |
| Post-purchase email | Use `user_id` of last buyer, show top 5 new SKUs    | +18% repeat order rate |
| App push            | Daily cron sends top SKU for user if score > 0.4    | +7% DAU retention      |
| In-store kiosk      | Use loyalty card to get `user_id` → recommendations | +5% basket size        |

---

### Data Engineering & Ops Tips

* Interaction weighting: Multiple rows of same `(user, item)` are summed. Prefer one explicit rating.

* Cold-start items: Add rich metadata for TF-IDF to work well.

* Batching: Loop over users nightly and store results.

* Diversity: Post-process top-k by category/brand to avoid tunnel vision.

* Privacy: `user_id` can be hashed; no PII needed.

---

### FAQ

| **Q**                               | **A**                                                                 |
| ----------------------------------- | --------------------------------------------------------------------- |
| Can I include timestamps?           | Not yet – time-weighted ALS in Q2 2026.                               |
| What if I have 1M items?            | Use `top_k=200`, filter downstream in your DB.                        |
| Can I recommend for multiple users? | Not in one call – use `/bulk_recommend_user_items`.                   |
| Cold-start user?                    | Provide 3+ implicit items (e.g., last views); otherwise returns `[]`. |
| Regulator explainability?           | Add `X-Explain-Features: true` to header (Enterprise).                |

---

### Next step
Pipe the recommendations into your front-end component, measure CTR uplift, and iterate: the more interaction rows you send, the smarter the engine becomes.

---

# 4.2.5 /api/v1/ai/recommend_similar_items

### Purpose

Return the K most similar catalogue items for a given reference SKU by blending collaborative-filter (CF) co-view signals with content-based vector similarity.

Ideal for:

* PDP widgets (“You may also like”)

* Search fallbacks

* Out-of-stock redirects

* Automatic cross-sell bundles

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/recommend_user_items
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Business Value

| **Use Case**                | **Benefit**                                         |
| --------------------------- | --------------------------------------------------- |
| PDP carousel                | +6–12% add-to-cart on long-tail SKUs                |
| Out-of-stock redirect       | Recover 30–40% of lost sessions                     |
| Bundle builder / cross-sell | Lift AOV 8–15% with automatic accessory suggestions |
| Category discovery          | Boost SEO dwell time and pages/session              |

---

### Request Body – Schema

## Top-level keys

| **Key**        | **Type / Range** | **Required?** | **Meaning**                        | **Notes**                                      |
| -------------- | ---------------- | ------------- | ---------------------------------- | ---------------------------------------------- |
| `item_id`      | string           | yes           | SKU to get look-alikes for         | Must exist in `items[]`                        |
| `top_k`        | int (1–100)      | optional      | Number of similar items to return  | Default: 10. Use 4–8 for desktop; 12–16 mobile |
| `items`        | array<object>    | yes           | Catalogue to rank from             | Candidate items                                |
| `interactions` | array<object>    | optional      | User-item historical data (for CF) | 1,000+ rows recommended                        |
| `blend_cf`     | float (0–1)      | optional      | Weight for collaborative filtering | Default: 0.5 (50/50 blend)                     |

---

### items[] structure

| **Key**    | **Type** | **Required?** | **Notes**                       |
| ---------- | -------- | ------------- | ------------------------------- |
| `item_id`  | string   | yes           | SKU                             |
| `metadata` | string   | optional      | Keywords (e.g. brand, category) |

---

### interactions[] structure

| **Key**   | **Type** | **Required?** | **Notes**                         |
| --------- | -------- | ------------- | --------------------------------- |
| `user_id` | string   | yes           | —                                 |
| `item_id` | string   | yes           | Must match an `items[]` entry     |
| `rating`  | float    | optional      | 0–5. Omitted = implicit +1 rating |

---

### How It Works

## When `interactions` are included:

1. Content similarity

* Uses TF-IDF vectorisation on `metadata`

* Scores via cosine similarity

2. Collaborative filtering (CF)

* ALS (30 dims, 20 iterations)

* Requires ≥ 75 users × 50 items

3. Blending

final_score = blend_cf * cf_score + (1 – blend_cf) * content_score

* Items without CF data use cf_score = 0.
  
4. Filter & Rank

* Exclude item_id from results

* Return top k by final_score

## Average latency:

* 80 ms (with CF)

* 20 ms (content-only)

---

### Example Request

```json
{
  "item_id": "SKU-A1",
  "top_k": 4,
  "items": [
    {"item_id": "SKU-A1", "metadata": "Running shoes, Nike, men"},
    {"item_id": "SKU-B9", "metadata": "Trail shoes, Adidas, women"},
    {"item_id": "SKU-C3", "metadata": "Soccer ball, size 5"},
    {"item_id": "SKU-D7", "metadata": "Compression socks, unisex"},
    {"item_id": "SKU-E2", "metadata": "Fitness smartwatch"}
  ],
  "interactions": [
    {"user_id": "U-42", "item_id": "SKU-A1"},
    {"user_id": "U-42", "item_id": "SKU-B9"},
    {"user_id": "U-17", "item_id": "SKU-A1"},
    {"user_id": "U-17", "item_id": "SKU-D7"}
  ],
  "blend_cf": 0.7
}
```

---

### Example Response

```json
{
  "recommendations": [
    {
      "item_id": "SKU-B9",
      "score": 0.1783,
      "source": "content",
      "explanation": "Shares similar attributes/keywords with the reference item."
    },
    ...
  ],
  "model_info": {
    "algorithm": "TF-IDF cosine",
    "metric": "cosine_sim",
    "value": 1.0,
    "train_rows": 5
  }
}
```

---

### Field Reference

| **Path**                        | **Type**     | **Meaning**                    | **Use**                                |
| ------------------------------- | ------------ | ------------------------------ | -------------------------------------- |
| `recommendations[].item_id`     | string       | Similar SKU                    | PDP carousel, alternate SKUs           |
| `recommendations[].score`       | float (0–1)  | Final blended score            | Sort or blend with business logic      |
| `recommendations[].source`      | enum         | `cf`, `content`, or `blend`    | Debug or analytics                     |
| `recommendations[].explanation` | string       | Reason text                    | Tooltip or UI label                    |
| `model_info.algorithm`          | string       | Engine used                    | Audit                                  |
| `model_info.metric/value`       | string/float | Fit quality                    | Model health, drift detection (future) |
| `model_info.train_rows`         | int          | Interactions used for training | Data volume confidence                 |

---

### Commercial Playbooks

| **Surface**           | **Implementation**                              | **KPI Impact**           |
| --------------------- | ----------------------------------------------- | ------------------------ |
| PDP Widget            | Call server-side; cache per SKU for 24h         | +8–15% add-to-cart       |
| Search No-Result      | Recommend alternatives when query fails         | Recover 20–30% drop-offs |
| Out-of-Stock Fallback | Swap unavailable SKU for top 3 look-alikes      | Saves 40% lost sessions  |
| Dynamic Bundles       | Suggest lower-priced accessories on cart > \$50 | +10% attach rate         |

---

### Engineering & Ops Tips

* Metadata: Strip stop-words for clarity.

* Brand weighting: Repeat key attributes to boost TF-IDF `(e.g., "Nike Nike")`.

* Cold start: Provide rich metadata to compensate for no interactions.

* Model freshness: Retrain TF-IDF nightly as catalogue changes.

* Latency: Cache CF model in memory and refresh hourly.

---

### FAQ

| **Q**                          | **A**                                                         |
| ------------------------------ | ------------------------------------------------------------- |
| Can I disable CF?              | Yes — set `"blend_cf": 0` or omit `interactions`.             |
| What if the item is brand-new? | CF score = 0; fallback to content-only.                       |
| Max catalogue size?            | 1M items / \~20 MB JSON. Use gzip & HTTP/2.                   |
| Multi-language metadata?       | Works language-agnostic. Tokenisation required for CN/JP.     |
| GDPR?                          | Only hashed `user_id` if using `interactions`. No PII stored. |

---

### Next Step

Integrate this into your PDP or dynamic widget, cache for 24h per SKU, and run an A/B test vs. your static “similar items” list.

Expect double-digit cross-sell revenue lift in week one.

---

# 4.2.6 /api/v1/ai/cross_sell_matrix

## Quantifying “Bought-Together” Affinity in One Call

## Purpose

Return a square matrix that quantifies how strongly each item or category lifts the probability of another being bought in the same basket.

---

### Business Use Cases

| **Business Play**                          | **Impact**               |
| ------------------------------------------ | ------------------------ |
| “Frequently Bought Together” widget        | +8–18% attach rate       |
| Dynamic bundle & upsell rules at checkout  | +5–12% AOV               |
| Assortment optimisation / planogram design | Higher shelf penetration |
| Category-to-category marketing flows       | 10–25% e-mail CTR        |

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/cross_sell_matrix
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body – Field-by-Field Guide

| **Key**        | **Type / Range**         | **Required**                    | **Meaning**                            | **Notes / Source**                |
| -------------- | ------------------------ | ------------------------------- | -------------------------------------- | --------------------------------- |
| `level`        | `"item"` or `"category"` | optional                        | Matrix granularity                     | Default: `"item"`                 |
| `customer_id`  | `string` or `null`       | optional                        | Set to get personal matrix             | Use global (null) or personal     |
| `transactions` | `array<object>`          | yes                             | Orders: each includes customer + items | 6–36 months history               |
| `item_catalog` | `array<object>`          | req. only if level = "category" | SKU to category mapping                | Needed if using `"category"` mode |

---

### transactions[]

| **Key**       | **Type**        | **Required** | **Description**            |
| ------------- | --------------- | ------------ | -------------------------- |
| `customer_id` | `string`        | yes          | Buyer ID                   |
| `items`       | `array<string>` | yes          | List of SKUs in the basket |

---

### item_catalog[] (for category mode)

| **Key**    | **Type** | **Required** | **Description** |
| ---------- | -------- | ------------ | --------------- |
| `item_id`  | `string` | yes          | SKU             |
| `category` | `string` | yes          | Category slug   |

---

### How the Metric Is Calculated

support(i) = number of orders with item i
support(i & j) = number of orders with both i and j
confidence(i → j) = support(i & j) / support(i)

* Diagonal `(i == j)` = 1.0 by definition

* No negative values (min = 0)

* Optional: compute lift as `confidence / support(j)` downstream

---

### End-to-End Pipeline

1. Pre-clean: De-dupe `items[]` per order

2. Count: Map-reduce to count ``support(i)`` and `support(i & j)`

3. Compute: Calculate `confidence(i → j)` and round

4. Reorder: Sort items by global frequency

5. Return: Include headers + matrix

---

### Example Request

```json
{
  "level": "item",
  "customer_id": null,
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] }
  ],
  "item_catalog": []
}
```

---

### Example Response

```json
{
  "items_or_categories": ["SKU-A1", "SKU-B9", "SKU-D7", "SKU-E2"],
  "matrix": [
    [1.0, 0.5, 0.5, 0.5],
    [0.5, 1.0, 0.0, 0.5],
    [1.0, 0.0, 1.0, 1.0],
    [0.5, 0.5, 0.5, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:33:37.149247Z"
}
```

---

### Field Glossary – Response

| **Path**                | **Type**         | **Meaning**                         | **Use**                  |
| ----------------------- | ---------------- | ----------------------------------- | ------------------------ |
| `items_or_categories[]` | array of strings | Header mapping for matrix           | Display / lookup         |
| `matrix[][]`            | 2D float array   | Confidence(i→j) matrix              | Feed into UI or BI tools |
| `metric`                | string           | Formula used (default = confidence) | Analytics & audit        |
| `generated_at`          | ISO timestamp    | When this was calculated            | Cache strategy           |

---

### Threshold Recipes

| **Use Case**                     | **Rule**                                                                   | **Suggested Threshold**       |
| -------------------------------- | -------------------------------------------------------------------------- | ----------------------------- |
| PDP “Frequently Bought Together” | Show top 3 `j` where `confidence(i→j) ≥ 0.15`                              | 15% (fashion), 3–5% (grocery) |
| Cart Upsell                      | Auto-suggest `j` when `confidence(i→j) ≥ 0.25` and high margin             | 25%                           |
| Bundle Creation                  | Export `i,j` pairs with `confidence ≥ 0.30` and `support(i&j) ≥ 100`       | 30%                           |
| E-mail Cross-sell                | Target buyers of `i` who’ve never bought `j` with `confidence(i→j) ≥ 0.20` | 20%                           |

---

### Engineering & Ops Tips

* Time window: 180d (CPG), 365d (furniture, B2B)

* Large baskets: Trim top 50 items by value if >200 SKUs

* Category mode: Requires `item_catalog`; ideal for long-tail items

* Global vs Personal: Global = all customers; Personal = 1:1

* Visualisation: Use seaborn heatmaps or D3.js chord diagrams

---

### Advanced Configuration (Enterprise)

| **Param**         | **Type**     | **Effect**                                      |
| ----------------- | ------------ | ----------------------------------------------- |
| `metric: "lift"`  | string       | Returns lift = confidence / support(j)          |
| `min_support`     | int ≥ 1      | Filter items with low support count             |
| `symmetric: true` | boolean      | Averages matrix: `M[i][j] = M[j][i]`            |
| `time_range`      | {start, end} | Limit to transaction slice (e.g., Black Friday) |

---

### FAQ

| **Q**                       | **A**                                                         |
| --------------------------- | ------------------------------------------------------------- |
| How big can the matrix get? | Up to 5,000 × 5,000 (200 MB); sparse streaming coming Q4 2025 |
| Why are diagonals all 1.0?  | By definition: item always co-occurs with itself              |
| Any negative values?        | Never – confidence is always ≥ 0                              |
| Can I exclude items?        | Yes – remove them from `transactions[].items` before calling  |
| Real-time latency?          | < 500ms for up to 250k orders                                 |

---

### Quick Win

Pipe the matrix into a rule that auto-inserts the top co-purchased SKU into your cart drawer.

Start with `confidence ≥ 0.20` and watch AOV and attach rate climb.

---

# 4.2.7 /api/v1/ai/cross_sell_matrix

## Category-to-Category Heat-Map

## Purpose

The category-level mode aggregates every SKU into its parent category and tells you:

“When a basket contains any item from category i, how often does it also contain at least one item from category j?”

Use-cases range from macro merchandising to campaign adjacency rules.

---

### Commercial Playbook

| **Commercial Play**            | **How the Matrix Helps**                                            | **Typical Lift**     |
| ------------------------------ | ------------------------------------------------------------------- | -------------------- |
| Homepage “Complete the Look”   | Display the top companion categories while browsing a base category | +6–10% click-through |
| Joint discount bundles         | Identify pairings with high co-occurrence but low margin to bundle  | +4–8% basket value   |
| Store layout / aisle adjacency | Co-locate categories with high mutual confidence                    | +3–5% in-store sales |
| Cross-category e-mail flows    | Target buyers who skipped a usually-linked category                 | 2–3× better response |

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/cross_sell_matrix
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body (Category Mode)

```json
{
  "level": "category",
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-3", "items": ["SKU-D7"] },
    { "customer_id": "C-4", "items": ["SKU-A1", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] },
    { "customer_id": "C-5", "items": ["SKU-A1", "SKU-B9", "SKU-D7"] },
    { "customer_id": "C-6", "items": ["SKU-E2", "SKU-D7"] }
  ],
  "item_catalog": [
    { "item_id": "SKU-A1", "category": "Shoes" },
    { "item_id": "SKU-B9", "category": "Shoes" },
    { "item_id": "SKU-D7", "category": "Accessories" },
    { "item_id": "SKU-E2", "category": "Wearables" }
  ]
}
```

---

### Field-by-Field

| **Path**         | **Type**         | **Required?** | **Meaning**                      | **Tips**                          |
| ---------------- | ---------------- | ------------- | -------------------------------- | --------------------------------- |
| `level`          | `"category"`     | ✅             | Triggers category aggregation    | `"item"` is default               |
| `transactions[]` | `array<object>`  | ✅             | 1 transaction = 1 order          | Clean out test or canceled orders |
| `item_catalog[]` | `array<object>`  | ✅             | SKU → Category map               | Many-to-one is valid              |
| `customer_id`    | `string or null` | optional      | Set for personal matrix (1-to-1) | Keep `null` for global stats      |

---

### Computation Logic

1. SKU → Category: Every SKU becomes its category. Categories are de-duplicated per basket.

2. Support counts:

* support(i) = baskets with category i

* support(i & j) = baskets with both i and j

3. Confidence:

confidence(i → j) = orders_with_both(i, j) / orders_with_i

* Diagonal = 1.0

4. Ordering: Categories sorted by descending global support for consistency.

---

### Response

{
  "items_or_categories": ["Accessories", "Shoes", "Wearables"],
  "matrix": [
    [1.0, 0.5, 0.5],
    [0.4, 1.0, 0.6],
    [0.5, 0.75, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:42:59.767166Z"
}

---

### Interpretation Highlights

* Wearables → Shoes = 0.75
→ 75% of baskets with Wearables also have Shoes — strong attach rate.

* Shoes → Accessories = 0.40
→ Moderate co-occurrence; could justify cross-sell or small bundle.

---

### Practical Thresholds & Actions

| **Confidence(i→j)** | **Interpretation** | **Suggested Action**                        |
| ------------------- | ------------------ | ------------------------------------------- |
| ≥ 0.70              | Must-have pair     | Auto-bundle, display “Complete the Look” UI |
| 0.30 – 0.69         | Strong link        | Use for e-mail flows, cross-sell thumbnails |
| 0.10 – 0.29         | Weak link          | Only use if margin is high                  |
| < 0.10              | Likely noise       | Ignore to reduce UI clutter                 |

---

### SQL Recipe – Category Pair Counts

```SQL
WITH sku_orders AS (
  SELECT o.order_id, p.category
  FROM orders o
  JOIN order_items oi ON oi.order_id = o.order_id
  JOIN products p ON p.sku = oi.sku
  WHERE o.order_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 12 MONTH)
),
pairs AS (
  SELECT o1.category AS cat_i, o2.category AS cat_j, o1.order_id
  FROM sku_orders o1
  JOIN sku_orders o2 ON o1.order_id = o2.order_id
)
SELECT
  cat_i,
  cat_j,
  COUNT(DISTINCT order_id) AS orders_with_i_and_j
FROM pairs
GROUP BY 1, 2;
```

---

### Commercial Recipes (Category-Level)

| **Scenario**             | **Usage**                                              | **Expected KPI**         |
| ------------------------ | ------------------------------------------------------ | ------------------------ |
| Paid search landing page | Add tabs for top co-bought categories                  | +8% session depth        |
| Category hero banners    | Show multi-category bundles (e.g., Shoes + Smartwatch) | +5% CTR                  |
| Stock & demand planning  | Allocate buffer stock to co-bought categories          | Fewer stockouts in promo |
| Loyalty incentives       | Give bonus points for Accessories if Shoes in cart     | +12% attach rate         |

---

### Advanced Parameters (Enterprise)

| **Param**         | **Allowed Values** | **Purpose**                                     |
| ----------------- | ------------------ | ----------------------------------------------- |
| `metric`          | `"lift"`           | Shows lift vs baseline purchase rate            |
| `min_support`     | `int ≥ 5`          | Drop rare categories to reduce noise            |
| `time_range`      | `{start, end}`     | Slice matrix by time (e.g., Black Friday week)  |
| `symmetric: true` | `true/false`       | Average matrix for symmetric display (graphing) |

---

### FAQ

| **Q**                                                 | **A**                                                     |
| ----------------------------------------------------- | --------------------------------------------------------- |
| I have 5,000 SKUs and 30 categories – is this faster? | Yes – runtime scales with categories², not SKUs           |
| Repeated categories in a basket — do they inflate?    | No – duplicates removed before counting                   |
| Can I rename categories?                              | Yes – rename in `item_catalog` before sending             |
| Sparse personal matrix — all 0/1s — why?              | Too little data; use 6–12 mo window or fallback to global |
| Recompute how often?                                  | Weekly (global), daily (real-time cart flows)             |
| Privacy concerns?                                     | Only customer\_id is used (can be hashed); no PII needed  |

---

### Next Step

Feed the category-level matrix into your recommendation engine.
When a shopper adds a category like Shoes, query the matrix and surface top SKUs from the highest-confidence follower category (e.g., Accessories).

* Result: Higher attach rate and AOV — no discounts required.

---

# 4.2.8 /api/v1/ai/dynamic_pricing_recommend

## AI-Driven Price Optimisation in <150 ms\

## Purpose

One call returns the profit- or revenue-maximising price for a SKU, using a micro-trained demand model that considers:

* Historical sell-through

* Competitor prices

* Current inventory

* Shopper context (channel/country)

## Typical lift:

+3–9% gross margin or +4–12% top-line revenue (validated in 14 retailers).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/dynamic_pricing_recommend
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Business Value

| **Scenario**              | **How this endpoint helps**                           | **Impact**                 |
| ------------------------- | ----------------------------------------------------- | -------------------------- |
| Daily price suggestion    | Scheduled call uploads updated prices to POS / web    | +4–6% gross profit         |
| Flash sale tuning         | Frequent calls optimize discount velocity and margins | Sell aged stock 30% faster |
| Competitor price matching | Undercuts rivals only if margin stays healthy         | Hold share, protect margin |
| Marketplace auto-repricer | Trigger on every new bid                              | +15–25% Buy Box win rate   |

---

### Request Body – Schema & Field Descriptions

| **Field**                  | **Type / Range**           | **Required** | **Description**                              |
| -------------------------- | -------------------------- | ------------ | -------------------------------------------- |
| `product_id`               | `string`                   | ✅           | SKU to price                                |
| `cost_per_unit`            | `float ≥ 0`                | ✅           | Landed cost incl. logistics                 |
| `optimize_for`             | \`"profit"                 | "revenue"    | ✅                                          |
| `candidate_prices`         | `array<float>`             | ✅           | Price points to evaluate                    |
| `historical[]`             | `array<object> (≥10 rows)` | ✅           | Recent sales data to train the model        |
| `competitor_price_current` | `float`                    | optional     | Live rival price (defaults to last observed) |
| `inventory_level_current`  | `int`                      | optional     | Current stock level                          |
| `segment_current`          | `object`                   | optional     | Contextual info: channel, country, etc.      |

---

### Historical Row Fields

| **Field**          | **Type**   | **Required** | **Description**                               |
| ------------------ | ---------- | ------------ | --------------------------------------------- |
| `date`             | `ISO date` | ✅            | Day of sale                                  |
| `price`            | `float`    | ✅            | Price used that day                          |
| `units_sold`       | `int ≥ 0`  | ✅            | Quantity sold                                |
| `competitor_price` | `float`    | optional     | Rival price on same day                       |
| `inventory_level`  | `int ≥ 0`  | optional     | Inventory at start of day                     |
| `segment`          | `object`   | optional     | e.g., `{ "channel": "web", "country": "BR" }` |

---

### Sample Request

```json
{
  "product_id": "SKU-123",
  "cost_per_unit": 50.0,
  "optimize_for": "profit",
  "candidate_prices": [79.0, 89.0, 99.0, 109.0],
  "historical": [
    { "date": "2025-03-01", "price": 99.0, "units_sold": 38, "competitor_price": 95.0, "inventory_level": 180, "segment": { "channel": "web", "country": "BR" } },
    { "date": "2025-03-02", "price": 99.0, "units_sold": 41, "competitor_price": 96.0, "inventory_level": 170, "segment": { "channel": "web", "country": "BR" } },
    ...
    { "date": "2025-03-10", "price": 109.0, "units_sold": 25, "competitor_price": 103.0, "inventory_level": 200, "segment": { "channel": "store", "country": "BR" } }
  ],
  "competitor_price_current": 94.0,
  "inventory_level_current": 120,
  "segment_current": { "channel": "mobile", "country": "BR" }
}
```

---

### Engine Workflow (Simplified)

1. Clean & encode data (e.g., one-hot segment, log transform).

2. Train ElasticNet, XGBoost, Random Forest on 75% of history.

3. Extract demand elasticity.

4. Predict demand per price in candidate_prices.

5. Compute:

* revenue = price × expected_units

* profit = (price – cost) × expected_units

6. Select best_price based on objective (profit or revenue).

7. Apply guardrails (min margin, max discount).

8. Return prediction.

9. Log for drift monitoring.

---

### Response

```json
{
  "best_price": 79.0,
  "outcomes": [
    { "candidate_price": 79.0, "expected_units": 85.0, "expected_revenue": 6714.9, "expected_profit": 2464.96 },
    { "candidate_price": 89.0, "expected_units": 61.13, "expected_revenue": 5440.35, "expected_profit": 2383.97 },
    { "candidate_price": 99.0, "expected_units": 44.56, "expected_revenue": 4411.79, "expected_profit": 2183.61 },
    { "candidate_price": 109.0, "expected_units": 35.23, "expected_revenue": 3839.86, "expected_profit": 2078.46 }
  ],
  "model_info": {
    "algorithm": "XGBoost",
    "mape": 0.0,
    "train_rows": 10
  },
  "interpretation": "Setting the price at 79.00 maximises PROFIT: +3.4% versus the next-best option (89.00) given today’s competitor price (94.0) and inventory level (120 units)."
}
```

---

### Response Fields

| **Field**              | **Type** | **Description**                  | **Use Case**               |
| ---------------------- | -------- | -------------------------------- | -------------------------- |
| `best_price`           | `float`  | Optimal price                    | Push to web/POS            |
| `outcomes[]`           | `array`  | Simulated results per candidate  | Build price ladders        |
| ↳ `expected_units`     | `float`  | Forecasted demand                | Plan inventory or ops      |
| ↳ `expected_revenue`   | `float`  | Price × Units                    | —                          |
| ↳ `expected_profit`    | `float`  | (Price – Cost) × Units           | —                          |
| `model_info.algorithm` | `string` | Chosen ML model                  | ML audit                   |
| `model_info.mape`      | `float`  | Mean Absolute % Error (hold-out) | Trigger retrain if > 0.2   |
| `interpretation`       | `string` | Plain-English summary            | Show in pricing dashboards |

---

### Commercial Playbooks

| **Use-case**         | **Recipe**                                                             | **KPI Lift**             |
| -------------------- | ---------------------------------------------------------------------- | ------------------------ |
| Clear slow movers    | Use `[cost×1.05, cost×1.1…]`, optimize\_for: `"revenue"`               | Free DC space 25% faster |
| Flagship products    | Call every 2h if `MAPE < 0.10`; widen price range if `elasticity > -2` | Protect margin & share   |
| End-of-season sale   | Set `cost=0`; maximize revenue                                         | +8–12% clearance revenue |
| Channel segmentation | Call twice: `segment_current.channel = web` vs. `store`                | AOV +3%, Profit +4%      |

---

### Engineering & Ops Tips

* Candidate grid: Try 4–8 prices near current tag

* Psychology-aware: Include .90, .99 variants

* Lagging competitor: Use competitor_price_current explicitly

* Inventory spike: Narrow grid to preserve margin

* Batch nightly: Loop SKUs, push best prices to ERP

* A/B test: +10% pricing to 10% traffic to measure elasticity

---

### FAQ

| **Q**                                    | **A**                                                        |
| ---------------------------------------- | ------------------------------------------------------------ |
| What if `MAPE = 0.00`?                   | Likely only 1 hold-out row; add more historical data.        |
| Minimum distinct prices?                 | At least two – otherwise no curve fitting possible.          |
| Can I add features like weekday/weather? | Yes – include as columns in `historical[]`; auto-encoded.    |
| Currency format?                         | Use same currency throughout; endpoint is currency-agnostic. |
| How to set pricing guardrails?           | Use header: `X-Min-Margin-Pct: 0.25` (Enterprise only).      |

---

### Next Step

Feed yesterday’s sales snapshot into this endpoint with 4–8 candidate prices.
Then push the `best_price` to your e-commerce, store POS or marketplace.
Measure margin lift in days – most clients break even on implementation in < 30 days.

---

# 4.2.9 /api/v1/ai/uplift_model

## Individual-level causal lift scoring

## Purpose

Identify who’s truly persuadable (and who isn’t) before you send your next campaign.
The endpoint ingests treatment / control outcomes and returns an incremental-lift (uplift) score for every single customer plus decile roll-ups.
Typical usage: mail only the top‐2 uplift deciles and hold out the bottom two, slashing CAC 25-40 % while keeping the same conversions.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST  https://api-prod.abintel.ai/api/v1/ai/uplift_model
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

  ---

### Business Value

| **Pain-point**                        | **How the endpoint helps**                                                                | **Typical lift**                               |
| ------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------- |
| Spray-and-pray campaigns waste budget | Scores “true-positives” (= will buy because of the promo) vs. sure-things & never-buyers. | –30 % send volume at flat conversions          |
| Costly hold-outs                      | Automatically produces control deciles (negative uplift) for statistically sound tests.   | +5-8 pp improvement in net incremental revenue |
| Complex in-house causal ML            | Micro-trains a model in < 30 s; no infra to maintain.                                     | Deploy in 1 sprint                             |

---

### Request Body – Every Field

| **JSON path** | **Type / Range** | **Req.?** | **Meaning**                                                            | **Notes**                  |
| ------------- | ---------------- | --------- | ---------------------------------------------------------------------- | -------------------------- |
| contamination | 0 … 1            | optional  | Share of control users who were accidentally exposed to treatment.     | Default 0.0                |
| rows[]       | array<object>    | yes       | Min 200 rows. Each row needs …                                         |                            |
| ↳ id          | string           | yes       | Customer identifier.                                                   | Returned verbatim.         |
| ↳ treatment   | 0 \| 1           | yes       | 1 = received campaign/exposure                                         | Binary only.               |
| ↳ outcome     | 0 \| 1           | yes       | 1 = converted / purchased                                              | Define your success event. |
| ↳ features.* | number \| string | yes       | Any mix of numeric & categorical predictors (age, country, RFM, etc.). | Auto one-hot / scaling.    |

* Data sufficiency rule – at least 200 rows and > 0 variants of both treatment & outcome → else request is rejected.

```SQL
{
  // ──────────────────────────────────────────────────────────────────────────────
  //  🎯  INDIVIDUAL-LEVEL UPLIFT SCORING  –  POST  /api/uplift_model
  //  ---------------------------------------------------------------------------
  //  What this route does
  //  ─────────────────────
  //  • Accepts **treatment / control** data and estimates the incremental
  //    impact (“uplift”, i.e. *causal lift*) of a campaign **for every customer**.
  //  • Internals:
  //        – If the library **causalml** is available the endpoint runs an
  //          `UpliftRandomForestClassifier` (KL criterion).
  //        – Otherwise it falls back to a **T-Learner**: two separate
  //          Gradient-Boosting Models (one on treated rows, one on control).
  //  • Requires **≥ 200 rows** for a stable model (binary *treatment* & *outcome*).
  //
  //  Field-by-field specification
  //  ────────────────────────────
  //  • rows[] (array)          :  Each object **must** contain:
  //        – id          (string) : Unique customer ID.
  //        – treatment    (0|1)   : 1 = received campaign / was exposed.
  //        – outcome      (0|1)   : 1 = converted / purchased / subscribed.
  //        – features     (object): Arbitrary numeric or categorical fields
  //                                  (age, country, prior_purchases, …).
  //                                  Categorical keys are one-hot-encoded auto-
  //                                  matically – you can mix types freely.
  //
  //  What the response means
  //  ───────────────────────
  //  • `average_treatment_effect` – global ATE across all rows (positive = good).
  //  • `decile_summary[]`         – mean uplift & #customers in each decile
  //                                 (1 = lowest, 10 = highest uplift).
  //  • `details[]`                – per-customer uplift score and assigned decile
  //                                 so you can pick top-decile customers for the
  //                                 next wave and hold out the bottom decile.
  //
  //  Practical reading
  //  ─────────────────
  //  • High positive **uplift_score** → customer is MORE likely to convert if
  //    targeted – prioritise for campaigns.
  //  • Negative score → persuasion-proof segment (or even net-negative) – skip
  //    or A/B-test cautiously.
  //
  //  ---------------------------------------------------------------------------
  //  ↓  Stub payload – paste ≥ 200 real rows in “rows[]” before sending
  // ─────────────────────────────────────────────────────────────────────────────
  "contamination": 0.15,
  "rows": [
    { "id": "C-001", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-002", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-003", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-004", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-005", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-006", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-007", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-008", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-009", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-010", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },
    { "id": "C-011", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-012", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-013", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-014", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-015", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-016", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 5 } },
    { "id": "C-017", "treatment": 1, "outcome": 1, "features": { "age": 45, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-018", "treatment": 0, "outcome": 1, "features": { "age": 30, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-019", "treatment": 1, "outcome": 0, "features": { "age": 39, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-020", "treatment": 0, "outcome": 0, "features": { "age": 47, "country": "US", "prior_purchases": 3 } },

    { "id": "C-021", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-022", "treatment": 0, "outcome": 0, "features": { "age": 28, "country": "US", "prior_purchases": 0 } },
    { "id": "C-023", "treatment": 1, "outcome": 1, "features": { "age": 40, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-024", "treatment": 0, "outcome": 0, "features": { "age": 34, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-025", "treatment": 1, "outcome": 0, "features": { "age": 27, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-026", "treatment": 0, "outcome": 0, "features": { "age": 53, "country": "US", "prior_purchases": 4 } },
    { "id": "C-027", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-028", "treatment": 0, "outcome": 1, "features": { "age": 25, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-029", "treatment": 1, "outcome": 0, "features": { "age": 48, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-030", "treatment": 0, "outcome": 0, "features": { "age": 36, "country": "US", "prior_purchases": 2 } },
    { "id": "C-031", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-032", "treatment": 0, "outcome": 1, "features": { "age": 29, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-033", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "US", "prior_purchases": 0 } },
    { "id": "C-034", "treatment": 0, "outcome": 0, "features": { "age": 38, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-035", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-036", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-037", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-038", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-039", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-040", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-041", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-042", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-043", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-044", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-045", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-046", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-047", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-048", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-049", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-050", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-051", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-052", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-053", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-054", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-055", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-056", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-057", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-058", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-059", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-060", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-061", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-062", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-063", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-064", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-065", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-066", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-067", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-068", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-069", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-070", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-071", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-072", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-073", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-074", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-075", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-076", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 5 } },
    { "id": "C-077", "treatment": 1, "outcome": 1, "features": { "age": 45, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-078", "treatment": 0, "outcome": 1, "features": { "age": 30, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-079", "treatment": 1, "outcome": 0, "features": { "age": 39, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-080", "treatment": 0, "outcome": 0, "features": { "age": 47, "country": "US", "prior_purchases": 3 } },

    { "id": "C-081", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-082", "treatment": 0, "outcome": 0, "features": { "age": 28, "country": "US", "prior_purchases": 0 } },
    { "id": "C-083", "treatment": 1, "outcome": 1, "features": { "age": 40, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-084", "treatment": 0, "outcome": 0, "features": { "age": 34, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-085", "treatment": 1, "outcome": 0, "features": { "age": 27, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-086", "treatment": 0, "outcome": 0, "features": { "age": 53, "country": "US", "prior_purchases": 4 } },
    { "id": "C-087", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-088", "treatment": 0, "outcome": 1, "features": { "age": 25, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-089", "treatment": 1, "outcome": 0, "features": { "age": 48, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-090", "treatment": 0, "outcome": 0, "features": { "age": 36, "country": "US", "prior_purchases": 2 } },

    { "id": "C-091", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-092", "treatment": 0, "outcome": 1, "features": { "age": 29, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-093", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "US", "prior_purchases": 0 } },
    { "id": "C-094", "treatment": 0, "outcome": 0, "features": { "age": 38, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-095", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-096", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-097", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-098", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-099", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-100", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-101", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-102", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-103", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-104", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-105", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-106", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-107", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-108", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-109", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-110", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-111", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-112", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-113", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-114", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-115", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-116", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-117", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-118", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-119", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-120", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-121", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-122", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-123", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-124", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-125", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-126", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-127", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-128", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-129", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-130", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-131", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-132", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-133", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-134", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-135", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-136", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-137", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-138", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-139", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-140", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-141", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-142", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-143", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-144", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-145", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-146", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-147", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-148", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-149", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-150", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-151", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-152", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-153", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-154", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-155", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-156", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-157", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-158", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-159", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-160", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-161", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-162", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-163", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-164", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-165", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-166", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-167", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-168", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-169", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-170", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-171", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-172", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-173", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-174", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-175", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-176", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-177", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-178", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-179", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-180", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-181", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-182", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-183", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-184", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-185", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-186", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-187", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-188", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-189", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-190", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-191", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-192", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-193", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-194", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-195", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-196", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-197", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-198", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-199", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-200", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-201", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-202", "treatment": 0, "outcome": 0, "features": { "age": 29, "country": "US", "prior_purchases": 0 } },
    { "id": "C-203", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-204", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-205", "treatment": 1, "outcome": 0, "features": { "age": 30, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-206", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 4 } },
    { "id": "C-207", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-208", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-209", "treatment": 1, "outcome": 0, "features": { "age": 47, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-210", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } }
  ]
}
```

---

### What Happens Under the Hood

1. Pre-process – handle contamination (re-weights control), one-hot categories, scale numerics.

2. Model selection

* If causalml lib present ▶︎ UpliftRandomForestClassifier (KL criterion).

* Else T-Learner (two Gradient-Boosting trees).

3. Cross-validation × 3 folds → choose hyper-parameters with highest Qini uplift.

4. Score each row: P(outcome | treat) – P(outcome | control) → uplift_score.

5. Rank & bucket into ten equal-sized deciles.

6. Return global ATE, conversion rates, decile table & per-ID details. Average latency: < 40 s on 50 k rows (CPU).

---

### Resonse

```json
{
    "average_treatment_effect": 0.3857,
    "treatment_cr": 0.6381,
    "control_cr": 0.2571,
    "decile_summary": [
        {
            "decile": 1,
            "mean_uplift": -0.9986,
            "n_customers": 21
        },
        {
            "decile": 2,
            "mean_uplift": -0.2695,
            "n_customers": 21
        },
        {
            "decile": 3,
            "mean_uplift": 0.0006,
            "n_customers": 24
        },
        {
            "decile": 4,
            "mean_uplift": 0.0018,
            "n_customers": 18
        },
        {
            "decile": 5,
            "mean_uplift": 0.2048,
            "n_customers": 23
        },
        {
            "decile": 6,
            "mean_uplift": 0.9957,
            "n_customers": 19
        },
        {
            "decile": 7,
            "mean_uplift": 0.9988,
            "n_customers": 21
        },
        {
            "decile": 8,
            "mean_uplift": 0.9992,
            "n_customers": 21
        },
        {
            "decile": 9,
            "mean_uplift": 0.9998,
            "n_customers": 21
        },
        {
            "decile": 10,
            "mean_uplift": 0.9999,
            "n_customers": 21
        }
    ],
    "details": [
        {
            "id": "C-001",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-002",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-003",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-004",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-005",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-006",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-007",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-008",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-009",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-010",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-011",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-012",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-013",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-014",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-015",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-016",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-017",
            "uplift_score": 0.9991,
            "uplift_decile": 7
        },
        {
            "id": "C-018",
            "uplift_score": 0.0018,
            "uplift_decile": 4
        },
        {
            "id": "C-019",
            "uplift_score": -0.82,
            "uplift_decile": 2
        },
        {
            "id": "C-020",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-021",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-022",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-023",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-024",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-025",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-026",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-027",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-028",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-029",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-030",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-031",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-032",
            "uplift_score": 0.0026,
            "uplift_decile": 5
        },
        {
            "id": "C-033",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-034",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-035",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-036",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-037",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-038",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-039",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-040",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-041",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-042",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-043",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-044",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-045",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-046",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-047",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-048",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-049",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-050",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-051",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-052",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-053",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-054",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-055",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-056",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-057",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-058",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-059",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-060",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-061",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-062",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-063",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-064",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-065",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-066",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-067",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-068",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-069",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-070",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-071",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-072",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-073",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-074",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-075",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-076",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-077",
            "uplift_score": 0.9991,
            "uplift_decile": 7
        },
        {
            "id": "C-078",
            "uplift_score": 0.0018,
            "uplift_decile": 4
        },
        {
            "id": "C-079",
            "uplift_score": -0.82,
            "uplift_decile": 2
        },
        {
            "id": "C-080",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-081",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-082",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-083",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-084",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-085",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-086",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-087",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-088",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-089",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-090",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-091",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-092",
            "uplift_score": 0.0026,
            "uplift_decile": 5
        },
        {
            "id": "C-093",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-094",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-095",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-096",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-097",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-098",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-099",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-100",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-101",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-102",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-103",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-104",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-105",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-106",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-107",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-108",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-109",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-110",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-111",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-112",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-113",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-114",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-115",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-116",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-117",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-118",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-119",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-120",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-121",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-122",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-123",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-124",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-125",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-126",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-127",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-128",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-129",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-130",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-131",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-132",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-133",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-134",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-135",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-136",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-137",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-138",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-139",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-140",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-141",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-142",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-143",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-144",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-145",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-146",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-147",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-148",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-149",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-150",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-151",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-152",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-153",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-154",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-155",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-156",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-157",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-158",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-159",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-160",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-161",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-162",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-163",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-164",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-165",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-166",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-167",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-168",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-169",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-170",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-171",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-172",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-173",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-174",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-175",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-176",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-177",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-178",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-179",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-180",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-181",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-182",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-183",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-184",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-185",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-186",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-187",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-188",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-189",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-190",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-191",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-192",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-193",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-194",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-195",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-196",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-197",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-198",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-199",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-200",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-201",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-202",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-203",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-204",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-205",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-206",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-207",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-208",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-209",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-210",
            "uplift_score": 0.999,
            "uplift_decile": 7
        }
    ],
    "interpretation": "Treatment group converted at 63.81% vs control 25.71% (ATE +0.386).  **Decile 10** contains 21 customers with mean uplift +1.000, representing ≈ 21.0 additional conversions if fully targeted.  **Decile 1**’s mean uplift is -0.999 — ideal as a hold-out or cost-control segment."
}
```

---

### Path

| Path                       | Meaning                      | How to act                                   |
| -------------------------- | ---------------------------- | -------------------------------------------- |
| average_treatment_effect   | Global incremental lift.     | > 0 → campaign works; < 0 → re-think.        |
| decile_summary[]           | Mean uplift by 10 % buckets. | Target deciles 8-10, test 5-7, suppress 1-2. |
| details[]                  | Per-customer score & bucket. | Feed top deciles into ESP / CRM segment.     |

---

### Activation Recipes

| Goal                   | Playbook                                                      | KPI impact                    |
| ---------------------- | ------------------------------------------------------------- | ----------------------------- |
| Email blast cost-cut   | Send only deciles 8-10; keep 3-4 for future; never email 1-2. | –35 % send cost, flat orders  |
| Personalised discounts | Give 10 % off to decile 10, 5 % to 8-9, none to others.       | Same revenue, half promo cost |
| A/B hold-out           | Use decile 1 as natural control in follow-up experiment.      | Robust incrementality proof   |

---

### Engineering Tips

* Cold-start customers – set treatment=0, outcome=0, include features; they’ll still be scored via model priors.

* Categorical explosions – cap rare categories (< 100 rows) into “Other” to keep trees shallow.

* Feature drift – if ≥ 2 categorical values disappear for > 30 days, re-train.

* Minimum decile size – endpoint enforces ≥ 15 rows; else merges neighbouring buckets.

* Storing scores – upsert uplift_decile column in your CDP for fast audience builds.

---

### Next step
Run a one-off call on last campaign’s data, export the top two uplift deciles, and launch a 72-h retargeting email. Measure incremental revenue v. hold-out – most clients break even in the first blast.

---

# 4.3 Forecasting & Planning

## Forecasting & Planning

`forecast_revenue`, `forecast_units`, `forecast_units_asyncio`, `forecast_cost`, `forecast_cost_improved`

---

# 4.3.1 /api/v1/ai/forecast_revenue

## Purpose
Generate a 12-month revenue outlook (calendar & business days), pick the best model automatically, and get back ready-to-plot numbers plus error diagnostics.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/forecast_revenue
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```

---

### Why you’ll use it

| Business question                           | How the route helps                                                                                      | Typical win                        |
| ------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| “How much cash do we book next quarter?”    | Outputs monthly forecast with 80 % & 95 % CIs (not shown in sample).                                     | Replaces xls extrapolations in 5 s |
| “Which model should we trust?”              | Benchmarks ARIMA, Prophet, ETS, TBATS, Aggregation (naïve), etc., selects the lowest RMSE automatically. | No data-science headcount needed   |
| “Ops wants both calendar & business views.” | Returns two matrices: one counting all days, one excluding weekends/holidays.                            | Direct feed into FP\&A dashboards  |

---

### Request body – every field

| Path             | Type       | Req.? | Meaning                  | Notes                                    |
| ---------------- | ---------- | ----- | ------------------------ | ---------------------------------------- |
| forecast_period  | int ≥ 1    | yes   | # months to predict      | Typical 6-, 12-, 18-month horizons       |
| data[]           | array      | yes   | Historical daily revenue | Needs ≥ 60 rows (≈ 2 months)             |
| ↳ date           | YYYY-MM-DD | yes   | Day in ISO format        | Gaps allowed; endpoint auto-fills zeroes |
| ↳ revenue        | float ≥ 0  | yes   | Gross revenue that day   | Same currency every row                  |

```json
{
  "forecast_period": 12,
  "data": [
    {"date": "2024-01-01", "revenue": 1000.0},
    {"date": "2024-01-02", "revenue": 1010.0},
    {"date": "2024-01-03", "revenue": 1020.0},
    {"date": "2024-01-04", "revenue": 1030.0},
    {"date": "2024-01-05", "revenue": 1040.0},
    {"date": "2024-01-06", "revenue": 824.0},
    {"date": "2024-01-07", "revenue": 832.0},
    {"date": "2024-01-08", "revenue": 1070.0},
    {"date": "2024-01-09", "revenue": 1080.0},
    {"date": "2024-01-10", "revenue": 1090.0},
    {"date": "2024-01-11", "revenue": 1100.0},
    {"date": "2024-01-12", "revenue": 1110.0},
    {"date": "2024-01-13", "revenue": 888.0},
    {"date": "2024-01-14", "revenue": 896.0},
    {"date": "2024-01-15", "revenue": 1140.0},
    {"date": "2024-01-16", "revenue": 1150.0},
    {"date": "2024-01-17", "revenue": 1160.0},
    {"date": "2024-01-18", "revenue": 1170.0},
    {"date": "2024-01-19", "revenue": 1180.0},
    {"date": "2024-01-20", "revenue": 952.0},
    {"date": "2024-01-21", "revenue": 960.0},
    {"date": "2024-01-22", "revenue": 1210.0},
    {"date": "2024-01-23", "revenue": 1220.0},
    {"date": "2024-01-24", "revenue": 1230.0},
    {"date": "2024-01-25", "revenue": 1240.0},
    {"date": "2024-01-26", "revenue": 1250.0},
    {"date": "2024-01-27", "revenue": 1016.0},
    {"date": "2024-01-28", "revenue": 1024.0},
    {"date": "2024-01-29", "revenue": 1280.0},
    {"date": "2024-01-30", "revenue": 1290.0},
    {"date": "2024-01-31", "revenue": 1300.0},
    {"date": "2024-02-01", "revenue": 1000.0},
    {"date": "2024-02-02", "revenue": 1010.0},
    {"date": "2024-02-03", "revenue": 808.0},
    {"date": "2024-02-04", "revenue": 816.0},
    {"date": "2024-02-05", "revenue": 1040.0},
    {"date": "2024-02-06", "revenue": 1050.0},
    {"date": "2024-02-07", "revenue": 1060.0},
    {"date": "2024-02-08", "revenue": 1070.0},
    {"date": "2024-02-09", "revenue": 1080.0},
    {"date": "2024-02-10", "revenue": 864.0},
    {"date": "2024-02-11", "revenue": 872.0},
    {"date": "2024-02-12", "revenue": 1110.0},
    {"date": "2024-02-13", "revenue": 1120.0},
    {"date": "2024-02-14", "revenue": 1130.0},
    {"date": "2024-02-15", "revenue": 1140.0},
    {"date": "2024-02-16", "revenue": 1150.0},
    {"date": "2024-02-17", "revenue": 920.0},
    {"date": "2024-02-18", "revenue": 928.0},
    {"date": "2024-02-19", "revenue": 1180.0},
    {"date": "2024-02-20", "revenue": 1190.0},
    {"date": "2024-02-21", "revenue": 1200.0},
    {"date": "2024-02-22", "revenue": 1210.0},
    {"date": "2024-02-23", "revenue": 1220.0},
    {"date": "2024-02-24", "revenue": 984.0},
    {"date": "2024-02-25", "revenue": 992.0},
    {"date": "2024-02-26", "revenue": 1250.0},
    {"date": "2024-02-27", "revenue": 1260.0},
    {"date": "2024-02-28", "revenue": 1270.0},
    {"date": "2024-02-29", "revenue": 1280.0},
    {"date": "2024-03-01", "revenue": 1000.0},
    {"date": "2024-03-02", "revenue": 800.0},
    {"date": "2024-03-03", "revenue": 808.0},
    {"date": "2024-03-04", "revenue": 1030.0},
    {"date": "2024-03-05", "revenue": 1040.0},
    {"date": "2024-03-06", "revenue": 1050.0},
    {"date": "2024-03-07", "revenue": 1060.0},
    {"date": "2024-03-08", "revenue": 1070.0},
    {"date": "2024-03-09", "revenue": 856.0},
    {"date": "2024-03-10", "revenue": 864.0},
    {"date": "2024-03-11", "revenue": 1100.0},
    {"date": "2024-03-12", "revenue": 1110.0},
    {"date": "2024-03-13", "revenue": 1120.0},
    {"date": "2024-03-14", "revenue": 1130.0},
    {"date": "2024-03-15", "revenue": 1140.0},
    {"date": "2024-03-16", "revenue": 912.0},
    {"date": "2024-03-17", "revenue": 920.0},
    {"date": "2024-03-18", "revenue": 1170.0},
    {"date": "2024-03-19", "revenue": 1180.0},
    {"date": "2024-03-20", "revenue": 1190.0},
    {"date": "2024-03-21", "revenue": 1200.0},
    {"date": "2024-03-22", "revenue": 1210.0},
    {"date": "2024-03-23", "revenue": 976.0},
    {"date": "2024-03-24", "revenue": 984.0},
    {"date": "2024-03-25", "revenue": 1240.0},
    {"date": "2024-03-26", "revenue": 1250.0},
    {"date": "2024-03-27", "revenue": 1260.0},
    {"date": "2024-03-28", "revenue": 1270.0},
    {"date": "2024-03-29", "revenue": 1280.0},
    {"date": "2024-03-30", "revenue": 1048.0}
  ]
}
```

---

### What happens under the hood

1. Pre-process – sort, fill missing days → 0 revenue, detect outliers (IQR winsorise), box-cox if needed.

2. Model zoo – ARIMA, STL-ETS, Prophet, TBATS, Croston (if > 40 % zeros) + Aggregation benchmark.

3. Cross-validation – rolling origin (4 folds) scoring RMSE & MAPE.

4. Champion select – lowest weighted RMSE (calendar 0.6 × business 0.4).

5. Post-process – make sure predictions ≥ 0; re-add outliers if suppressed.

6. Return forecast + error table + run-time.

Average latency: ~0.3 s on 90 days history; scales linearly.

---

### Response

```json
{
    "forecast_period": 12,
    "forecast_result": {
        "analysis_type": "generic_revenue",
        "best_algorithm": "Aggregation",
        "evaluation_metrics": {
            "RMSE": 111.63593256467632,
            "MAE": 109.6766254147977,
            "R2": 0.09176299947242217,
            "average_daily_revenue": 1105.017787752007,
            "Interpretation": "The Aggregation algorithm was selected because it achieved a low RMSE of 111.64, MAE of 109.68, and R² of 0.09. The average daily revenue forecast is 1105.02."
        },
        "forecast": {
            "calendar": [
                {
                    "yyyy-mm": "2024-04",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-05",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-06",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-07",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-08",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-09",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-10",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-11",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-12",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2025-01",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2025-02",
                    "value": 33142.64888364821
                },
                {
                    "yyyy-mm": "2025-03",
                    "value": 36693.6469783248
                }
            ],
            "business": [
                {
                    "yyyy-mm": "2024-04",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2024-05",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-06",
                    "value": 23673.320631177296
                },
                {
                    "yyyy-mm": "2024-07",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-08",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2024-09",
                    "value": 24856.98666273616
                },
                {
                    "yyyy-mm": "2024-10",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-11",
                    "value": 24856.98666273616
                },
                {
                    "yyyy-mm": "2024-12",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2025-01",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2025-02",
                    "value": 23673.320631177296
                },
                {
                    "yyyy-mm": "2025-03",
                    "value": 24856.98666273616
                }
            ]
        }
    },
    "execution_time_seconds": 0.268125057220459
}
```

---

### Field

| Field                | How to read                                | Action                                                             |
| -------------------- | ------------------------------------------ | -----------------------------------------------------------------  |
| best_algorithm       | Model with lowest cross-val error.         | Track changes – if it flips often you may have structural breaks.  |
| evaluation_metrics   | RMSE / MAE (absolute), R² (explained var.) | MAE ≤ 10 % of mean ⇒ “good”; else inspect seasonality or promos   |
| forecast.calendar[]  | Revenue including weekends & holidays.     | Feed to top-line board decks.                                      |
| forecast.business[]  | Revenue excluding weekends/holidays.       | Feed to capacity & staffing planning.                              |

---

### Power-user tips

* Promo bumps – send an extra boolean column `promo_day`: the API auto-segments regime switches (beta preview).

* Currency roll-ups – if you mix multi-currency streams, convert externally first; endpoint expects single unit.

* Edge series (< 60 pts) – fallback to “Aggregation” by design → consider weekly aggregation then re-call.

* Scenario testing – call twice: once full history, once minus last promo month → quantify uplift delta.

---

### Next step
Run the endpoint weekly, store `forecast.calendar` in your BI layer, and chart actual vs forecast. Alert finance if ±10 % deviation materialises for two consecutive weeks — teams can re-allocate paid-media budget in-flight.

---

# 4.3.2 /api/v1/ai/forecast_units

## One-Shot SKU-Level Demand Forecast

## Purpose

Call once, get a 6-month, day-to-business-day unit forecast for an individual SKU – automatically benchmarks statistical & ML models and returns the winner with diagnostics.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/forecast_units
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```

---

### When you’ll reach for it

| Business question                                         | How the route answers                                                                                  | Typical payoff                                 |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| “How many pieces should we replenish per SKU each month?” | Calendar & business-day unit forecast plus ±2 σ error band (not shown below).               | Cuts stock-out/over-stock cost without spreadsheet kung-fu|
| “Which model works for lumpy demand?”                     | Runs ARIMA, TBATS, Prophet, Random-Forest, Gradient Boost, Croston (intermittent) & picks lowest RMSE. | Gives Croston/ML without writing a line of code|
| “Ops wants the figure in pieces, not revenue.”            | Accepts sales_quantity straight from POS/OMS.                                                          | No price inflation noise                       |

---

### Request body – every key explained

| Path              | Type       | Req.? | Meaning                | Notes                       |
| ----------------- | ---------- | ----- | ---------------------- | --------------------------  |
| product_code      | string     | yes   | SKU or internal code   | Returned as-is in response  |
| forecast_period   | int ≥ 1    | yes   | Months to predict      | 3, 6, 12 typical            |
| data[]            | array      | yes   | Daily historical units | ≥ 45 rows recommended       |
| ↳ date            | YYYY-MM-DD | yes   | ISO calendar date      | Gaps auto-filled with 0     |
| ↳ sales_quantity  | int ≥ 0    | yes   | Units sold that day    | Same UoM entire series      |

```json
{
  "product_code": "38788",
  "forecast_period": 6,
  "data": [
    { "date": "2025-02-20", "sales_quantity": 11 },
    { "date": "2025-02-21", "sales_quantity": 12 },
    { "date": "2025-02-22", "sales_quantity": 6  },
    { "date": "2025-02-23", "sales_quantity": 5  },
    { "date": "2025-02-24", "sales_quantity": 14 },
    { "date": "2025-02-25", "sales_quantity": 13 },
    { "date": "2025-02-26", "sales_quantity": 12 },
    { "date": "2025-02-27", "sales_quantity": 13 },
    { "date": "2025-02-28", "sales_quantity": 12 },
    { "date": "2025-03-01", "sales_quantity": 7  },
    { "date": "2025-03-02", "sales_quantity": 6  },
    { "date": "2025-03-03", "sales_quantity": 15 },
    { "date": "2025-03-04", "sales_quantity": 14 },
    { "date": "2025-03-05", "sales_quantity": 13 },
    { "date": "2025-03-06", "sales_quantity": 14 },
    { "date": "2025-03-07", "sales_quantity": 13 },
    { "date": "2025-03-08", "sales_quantity": 7  },
    { "date": "2025-03-09", "sales_quantity": 6  },
    { "date": "2025-03-10", "sales_quantity": 16 },
    { "date": "2025-03-11", "sales_quantity": 15 },
    { "date": "2025-03-12", "sales_quantity": 14 },
    { "date": "2025-03-13", "sales_quantity": 15 },
    { "date": "2025-03-14", "sales_quantity": 14 },
    { "date": "2025-03-15", "sales_quantity": 8  },
    { "date": "2025-03-16", "sales_quantity": 7  },
    { "date": "2025-03-17", "sales_quantity": 16 },
    { "date": "2025-03-18", "sales_quantity": 15 },
    { "date": "2025-03-19", "sales_quantity": 14 },
    { "date": "2025-03-20", "sales_quantity": 15 },
    { "date": "2025-03-21", "sales_quantity": 14 },
    { "date": "2025-03-22", "sales_quantity": 7  },
    { "date": "2025-03-23", "sales_quantity": 6  },
    { "date": "2025-03-24", "sales_quantity": 17 },
    { "date": "2025-03-25", "sales_quantity": 16 },
    { "date": "2025-03-26", "sales_quantity": 15 },
    { "date": "2025-03-27", "sales_quantity": 16 },
    { "date": "2025-03-28", "sales_quantity": 15 },
    { "date": "2025-03-29", "sales_quantity": 8  },
    { "date": "2025-03-30", "sales_quantity": 7  },
    { "date": "2025-03-31", "sales_quantity": 17 },
    { "date": "2025-04-01", "sales_quantity": 16 },
    { "date": "2025-04-02", "sales_quantity": 15 },
    { "date": "2025-04-03", "sales_quantity": 16 },
    { "date": "2025-04-04", "sales_quantity": 15 },
    { "date": "2025-04-05", "sales_quantity": 8  },
    { "date": "2025-04-06", "sales_quantity": 7  },
    { "date": "2025-04-07", "sales_quantity": 18 },
    { "date": "2025-04-08", "sales_quantity": 17 },
    { "date": "2025-04-09", "sales_quantity": 16 },
    { "date": "2025-04-10", "sales_quantity": 17 },
    { "date": "2025-04-11", "sales_quantity": 16 },
    { "date": "2025-04-12", "sales_quantity": 9  },
    { "date": "2025-04-13", "sales_quantity": 8  },
    { "date": "2025-04-14", "sales_quantity": 18 },
    { "date": "2025-04-15", "sales_quantity": 17 },
    { "date": "2025-04-16", "sales_quantity": 16 },
    { "date": "2025-04-17", "sales_quantity": 17 },
    { "date": "2025-04-18", "sales_quantity": 16 },
    { "date": "2025-04-19", "sales_quantity": 9  },
    { "date": "2025-04-20", "sales_quantity": 8  }
  ]
}
```

---

### Behind the curtain

1. Cleaning – sort, fill missing dates (=0), Hampel filter outliers (kept but flagged).

2. Feature crafting – lag-7/14/28, promo/holiday flags (if extra cols present), rolling means.

3. Model zoo – Seasonal-ARIMA, STL-ETS, Prophet, TBATS, Random-Forest Regressor, Gradient-Boost, Croston for intermittent.

4. Cross-val – expanding window, score RMSE/MAE/R².

5. Champion – lowest RMSE (ties → lowest MAE).

6. Forecast – horizon = forecast_period * 30/30.4 calendar & biz-day splits.

7. Safety floor – clip negatives → 0.

8. Return JSON + run-time (seconds).

---

### Response

```json
{
    "forecast_period": 6,
    "forecasts": [
        {
            "product_code": "38788",
            "best_algorithm": "Random Forest",
            "evaluation_metrics": {
                "RMSE": 1.0094506384700848,
                "MAE": 0.9820119348244344,
                "R2": 0.9324114946213251,
                "average_daily_sales": 12.93465473184223,
                "Interpretation": "The Random Forest algorithm was selected because it achieved a low RMSE of 1.01, MAE of 0.98, and R² of 0.93. The average daily sales forecast is 12.93."
            },
            "forecast": {
                "calendar": [
                    {
                        "yyyy-mm": "2025-05",
                        "value": 435.7681071428571
                    },
                    {
                        "yyyy-mm": "2025-06",
                        "value": 420.22091666666665
                    },
                    {
                        "yyyy-mm": "2025-07",
                        "value": 443.83299999999997
                    },
                    {
                        "yyyy-mm": "2025-08",
                        "value": 426.7840714285714
                    },
                    {
                        "yyyy-mm": "2025-09",
                        "value": 429.2682619047619
                    },
                    {
                        "yyyy-mm": "2025-10",
                        "value": 442.8730714285714
                    }
                ],
                "business": [
                    {
                        "yyyy-mm": "2025-05",
                        "value": 362.24461904761904
                    },
                    {
                        "yyyy-mm": "2025-06",
                        "value": 347.66261904761905
                    },
                    {
                        "yyyy-mm": "2025-07",
                        "value": 378.9077619047619
                    },
                    {
                        "yyyy-mm": "2025-08",
                        "value": 345.62752380952384
                    },
                    {
                        "yyyy-mm": "2025-09",
                        "value": 364.3430238095238
                    },
                    {
                        "yyyy-mm": "2025-10",
                        "value": 377.94783333333334
                    }
                ]
            }
        }
    ],
    "execution_time_seconds": 1.5340442657470703
}
```

---

### Field

| Field                 | How to read                    | Action                                                                             |
| --------------------- | ------------------------------ | ---------------------------------------------------------------------------------- |
| best_algorithm        | Model with lowest RMSE.        | Track per-SKU – if it flips to Croston your item may have become slow-moving.      |
| average_daily_sales   | Mean of historical series.     | Quick reasonableness check: forecast shouldn’t diverge > ±30 % unless seasonality. |
| forecast.calendar[]   | Units incl. weekends/holidays. | Feed to S\&OP, supplier POs.                                                       |
| forecast.business[]   | Units excl. weekends.          | Feed to labour & picking slot planning.                                            |

---

### Common gotchas & pro tips

* Intermittent demand – ≥ 40 % zero days? The route auto-tests Croston & TSB – flag appears in `evaluation_metrics.model_candidates` (omit here for brevity).

* Promotions – add a boolean `promo` column; tree models ingest it, improving spikes.

* Multi-channel split – want web vs store? Call the endpoint separately per channel code.

* Very new SKUs – < 30 data points defaults to “Naïve mean” and adds `"note":"cold-start"` in metrics.

---

### Next step

Schedule the call on the 1st business day each month, write `forecast.business` into your ERP replenishment table, and compare actual vs forecast weekly; auto-trigger a re-forecast if absolute error > 20 % for two consecutive weeks.

---

# 4.3.3 /api/v1/ai/forecast_cost

### One-shot daily cost projection

**Purpose** Forecast the total daily COGS/OPEX (or any cost series) out six months.  
The service auto-benchmarks classic time-series models against tree-based ML, picks the champion, and returns both calendar-day and business-day aggregates.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST `https://api.abintel.ai/api/v1/ai/forecast_cost`
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---


---

### Why you’d call it

| Business question                          | How the route helps                                                                        | Typical payoff                                      |
|------------------------------------------  |------------------------------------------------------------------------                    |-----------------------------------------------------|
| “How much cash will we burn next quarter?” | 6-month cost forecast with statistical diagnostics.                                        | Informs cash-flow planning, treasury hedging.       |
| “Which model should finance trust?”        | Cross-validates ARIMA / ETS / Prophet / TBATS / tree ML and returns the lowest-error pick. | Eliminates manual model selection.                  |
| “Need weekends vs workdays split.”         | Returns calendar and business series side-by-side.                                         | Feeds both GL accruals and FP&A staffing models.    |

---

### Request body – field dictionary

| Path            | Type        | Req? | Meaning                          | Notes                                               |
|---------------  |-------------|----- |--------------------------------- |-----------------------------------------------------|
| forecast_period | int ≥ 1     | ✔︎    | Number of months to predict      | 3, 6, 12 common                                     |
| data[]          | array       | ✔︎    | Historic daily cost              | ≥ 45 rows recommended                               |
| ↳ date          | YYYY-MM-DD  | ✔︎    | ISO date                         | Gaps auto-filled with 0                             |
| ↳ cost          | number      | ✔︎    | Cost on that date (same currency)| Negative values allowed (rebates)                   |


---

```json
{
  "forecast_period": 6,
  "data": [
    { "date": "2025-01-01", "cost": 1100.00 },
    { "date": "2025-01-02", "cost": 1112.00 },
    { "date": "2025-01-03", "cost": 1118.00 },
    { "date": "2025-01-04", "cost": 1083.00 },
    { "date": "2025-01-05", "cost": 1078.00 },
    { "date": "2025-01-06", "cost": 1125.00 },
    { "date": "2025-01-07", "cost": 1130.00 },
    { "date": "2025-01-08", "cost": 1136.00 },
    { "date": "2025-01-09", "cost": 1142.00 },
    { "date": "2025-01-10", "cost": 1148.00 },
    { "date": "2025-01-11", "cost": 1105.00 },
    { "date": "2025-01-12", "cost": 1098.00 },
    { "date": "2025-01-13", "cost": 1156.00 },
    { "date": "2025-01-14", "cost": 1162.00 },
    { "date": "2025-01-15", "cost": 1168.00 },
    { "date": "2025-01-16", "cost": 1174.00 },
    { "date": "2025-01-17", "cost": 1180.00 },
    { "date": "2025-01-18", "cost": 1129.00 },
    { "date": "2025-01-19", "cost": 1122.00 },
    { "date": "2025-01-20", "cost": 1195.00 },
    { "date": "2025-01-21", "cost": 1202.00 },
    { "date": "2025-01-22", "cost": 1208.00 },
    { "date": "2025-01-23", "cost": 1215.00 },
    { "date": "2025-01-24", "cost": 1221.00 },
    { "date": "2025-01-25", "cost": 1166.00 },
    { "date": "2025-01-26", "cost": 1158.00 },
    { "date": "2025-01-27", "cost": 1229.00 },
    { "date": "2025-01-28", "cost": 1236.00 },
    { "date": "2025-01-29", "cost": 1242.00 },
    { "date": "2025-01-30", "cost": 1249.00 },
    { "date": "2025-01-31", "cost": 1255.00 },

    { "date": "2025-02-01", "cost": 1205.00 },
    { "date": "2025-02-02", "cost": 1198.00 },
    { "date": "2025-02-03", "cost": 1262.00 },
    { "date": "2025-02-04", "cost": 1268.00 },
    { "date": "2025-02-05", "cost": 1275.00 },
    { "date": "2025-02-06", "cost": 1281.00 },
    { "date": "2025-02-07", "cost": 1287.00 },
    { "date": "2025-02-08", "cost": 1234.00 },
    { "date": "2025-02-09", "cost": 1226.00 },
    { "date": "2025-02-10", "cost": 1293.00 },
    { "date": "2025-02-11", "cost": 1299.00 },
    { "date": "2025-02-12", "cost": 1306.00 },
    { "date": "2025-02-13", "cost": 1312.00 },
    { "date": "2025-02-14", "cost": 1318.00 },
    { "date": "2025-02-15", "cost": 1263.00 },
    { "date": "2025-02-16", "cost": 1255.00 },
    { "date": "2025-02-17", "cost": 1326.00 },
    { "date": "2025-02-18", "cost": 1333.00 },
    { "date": "2025-02-19", "cost": 1339.00 },
    { "date": "2025-02-20", "cost": 1346.00 },
    { "date": "2025-02-21", "cost": 1352.00 },
    { "date": "2025-02-22", "cost": 1296.00 },
    { "date": "2025-02-23", "cost": 1288.00 },
    { "date": "2025-02-24", "cost": 1359.00 },
    { "date": "2025-02-25", "cost": 1366.00 },
    { "date": "2025-02-26", "cost": 1372.00 },
    { "date": "2025-02-27", "cost": 1379.00 },
    { "date": "2025-02-28", "cost": 1385.00 },

    { "date": "2025-03-01", "cost": 1332.00 },
    { "date": "2025-03-02", "cost": 1324.00 },
    { "date": "2025-03-03", "cost": 1392.00 },
    { "date": "2025-03-04", "cost": 1399.00 },
    { "date": "2025-03-05", "cost": 1405.00 },
    { "date": "2025-03-06", "cost": 1412.00 },
    { "date": "2025-03-07", "cost": 1418.00 },
    { "date": "2025-03-08", "cost": 1362.00 },
    { "date": "2025-03-09", "cost": 1355.00 },
    { "date": "2025-03-10", "cost": 1424.00 },
    { "date": "2025-03-11", "cost": 1431.00 },
    { "date": "2025-03-12", "cost": 1437.00 },
    { "date": "2025-03-13", "cost": 1444.00 },
    { "date": "2025-03-14", "cost": 1450.00 },
    { "date": "2025-03-15", "cost": 1393.00 },
    { "date": "2025-03-16", "cost": 1385.00 },
    { "date": "2025-03-17", "cost": 1456.00 },
    { "date": "2025-03-18", "cost": 1463.00 },
    { "date": "2025-03-19", "cost": 1469.00 },
    { "date": "2025-03-20", "cost": 1476.00 },
    { "date": "2025-03-21", "cost": 1482.00 },
    { "date": "2025-03-22", "cost": 1424.00 },
    { "date": "2025-03-23", "cost": 1416.00 },
    { "date": "2025-03-24", "cost": 1488.00 },
    { "date": "2025-03-25", "cost": 1495.00 },
    { "date": "2025-03-26", "cost": 1501.00 },
    { "date": "2025-03-27", "cost": 1508.00 },
    { "date": "2025-03-28", "cost": 1514.00 },
    { "date": "2025-03-29", "cost": 1456.00 },
    { "date": "2025-03-30", "cost": 1448.00 }
  ]
}
```

---

## How it works under the hood

- **Pre-processing** — sort, fill missing dates, Hampel filter outliers (flagged).  
- **Feature engineering** — lag 7/14/28, month & weekday dummies, moving averages.  
- **Model zoo** — Seasonal-ARIMA, ETS, STL-TBATS, Prophet, Random-Forest, Gradient-Boost.  
- **Validation** — expanding-window CV → RMSE/MAE/R².  
- **Champion selection** — lowest RMSE (tie-break: lower MAE).  
- **Forecast horizon** — forecast_period × 30 calendar days, then roll-up to month-level calendar & biz-day.  
- **Post-process** — negatives are clipped to 0; adds two-sigma error band (not shown here).  
- **Return** — JSON + run-time.

---

## Reference response explained

```json
{
  "forecast_period": 6,
  "forecast_result": {
    "analysis_type": "generic_cost",
    "best_algorithm": "Aggregation",
    "evaluation_metrics": {
      "RMSE": 31.871275523384387,
      "MAE": 26.72328927342509,
      "R2": 0.225582055790993,
      "average_daily_cost": 1466.3052433749297,
      "Interpretation": "The Aggregation algorithm was selected because it achieved a low RMSE of 31.87, MAE of 26.72, and R² of 0.23. The average daily cost forecast is 1466.31."
    },
    "forecast": {
      "calendar": [
        { "yyyy-mm": "2025-04", "value": 45003.125869601354 },
        { "yyyy-mm": "2025-05", "value": 46503.23006525473 },
        { "yyyy-mm": "2025-06", "value": 45003.125869601354 },
        { "yyyy-mm": "2025-07", "value": 46503.23006525473 },
        { "yyyy-mm": "2025-08", "value": 46503.23006525473 },
        { "yyyy-mm": "2025-09", "value": 45003.125869601354 }
      ],
      "business": [
        { "yyyy-mm": "2025-04", "value": 33002.29230437432 },
        { "yyyy-mm": "2025-05", "value": 33002.29230437432 },
        { "yyyy-mm": "2025-06", "value": 31502.188108720948 },
        { "yyyy-mm": "2025-07", "value": 34502.3965000277 },
        { "yyyy-mm": "2025-08", "value": 31502.188108720948 },
        { "yyyy-mm": "2025-09", "value": 33002.29230437432 }
      ]
    }
  },
  "execution_time_seconds": 0.2536935806274414
}
```

---

## Field

| Field                | How to read                                     | Suggested action                                                     |
| -------------------- | ----------------------------------------------- | -------------------------------------------------------------------- |
| best_algorithm       | Winner of the bake-off.                         | Track per series; sudden switch to ML may indicate structural break. |
| average_daily_cost   | Mean of the historic series.                    | Quick sense-check vs budget.                                         |
| calendar             | 100 % of days, weekends included.               | Use for cash-flow burn rate.                                         |
| business             | Mon-Fri (holidays removed via region calendar). | Feed to workforce & AP accrual planning.                             |

---

## Tips & caveats

* Commodity price shocks — Pass an extra column `commodity_index` (numeric) — tree models will pick it up.

* Public holidays — Send `"holiday":"NYD"` etc.; Prophet & trees exploit it.

* Variance bounds — Add `"return_prediction_interval": true` to get 80 % / 95 % bands.

* Very new cost centre (< 30 pts) — Service falls back to naïve mean and sets `"note":"cold-start"`.

---

## Next step
Automate this call on the last calendar day each month; push the business forecast into your rolling 13-week cash-flow model, and trigger re-forecast if actuals stray > 15 % outside the 80 % PI for two consecutive weeks.

---

# 4.3.4 /api/v1/ai/forecast_cost_improved

**Nine-month daily cost outlook**

### Purpose 
An extended variant of the generic_cost forecaster that also emits a Business Indicators block – perfect for Finance & FP&A dashboards.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/forecast_cost_improved
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```

### What problem it solves

| Business pain-point                      | How the endpoint helps                                            |
| ---------------------------------------- | ----------------------------------------------------------------- |
| Need a longer horizon (up to 12 m)       | `forecast_period` now accepts 9+ months.                          |
| Want a one-line health read-out          | `business_indicators` summarises trend, volatility, CV, growth %. |
| Must reconcile calendar vs business days | Returns both roll-ups out-of-the-box.                             |

---

### Payload reference

| Path             | Type       | Req? | Purpose                  | Notes                            |
| ---------------- | ---------- | ---- | ------------------------ | -------------------------------- |
| forecast_period  | int ≥ 1    | ✔︎   | Months to project        | e.g. 9                           |
| data[]           | array      | ✔︎   | Historic daily cost rows | ≥ 60 rows for robust seasonality |
| ↳ date           | YYYY-MM-DD | ✔︎   | ISO calendar date        | gaps auto-filled at 0            |
| ↳ cost           | number     | ✔︎   | Cost amount              | currency agnostic                |


```json
{
  "forecast_period": 9,
  "data": [
    { "date": "2024-10-01", "cost": 950.00 },
    { "date": "2024-10-02", "cost": 956.00 },
    { "date": "2024-10-03", "cost": 962.00 },
    { "date": "2024-10-04", "cost": 968.00 },
    { "date": "2024-10-05", "cost": 921.00 },
    { "date": "2024-10-06", "cost": 915.00 },
    { "date": "2024-10-07", "cost": 975.00 },
    { "date": "2024-10-08", "cost": 981.00 },
    { "date": "2024-10-09", "cost": 987.00 },
    { "date": "2024-10-10", "cost": 993.00 },
    { "date": "2024-10-11", "cost": 999.00 },
    { "date": "2024-10-12", "cost": 952.00 },
    { "date": "2024-10-13", "cost": 946.00 },
    { "date": "2024-10-14", "cost": 1005.00 },
    { "date": "2024-10-15", "cost": 1011.00 },
    { "date": "2024-10-16", "cost": 1017.00 },
    { "date": "2024-10-17", "cost": 1023.00 },
    { "date": "2024-10-18", "cost": 1029.00 },
    { "date": "2024-10-19", "cost": 981.00 },
    { "date": "2024-10-20", "cost": 975.00 },

    { "date": "2024-11-01", "cost": 1040.00 },
    { "date": "2024-11-02", "cost": 995.00 },
    { "date": "2024-11-03", "cost": 988.00 },
    { "date": "2024-11-04", "cost": 1046.00 },
    { "date": "2024-11-05", "cost": 1052.00 },
    { "date": "2024-11-06", "cost": 1058.00 },
    { "date": "2024-11-07", "cost": 1064.00 },
    { "date": "2024-11-08", "cost": 1070.00 },
    { "date": "2024-11-09", "cost": 1019.00 },
    { "date": "2024-11-10", "cost": 1012.00 },
    { "date": "2024-11-11", "cost": 1078.00 },
    { "date": "2024-11-12", "cost": 1084.00 },
    { "date": "2024-11-13", "cost": 1090.00 },
    { "date": "2024-11-14", "cost": 1096.00 },
    { "date": "2024-11-15", "cost": 1102.00 },
    { "date": "2024-11-16", "cost": 1050.00 },
    { "date": "2024-11-17", "cost": 1043.00 },

    { "date": "2024-12-01", "cost": 1120.00 },
    { "date": "2024-12-02", "cost": 1127.00 },
    { "date": "2024-12-03", "cost": 1133.00 },
    { "date": "2024-12-04", "cost": 1140.00 },
    { "date": "2024-12-05", "cost": 1146.00 },
    { "date": "2024-12-06", "cost": 1152.00 },
    { "date": "2024-12-07", "cost": 1098.00 },
    { "date": "2024-12-08", "cost": 1091.00 },
    { "date": "2024-12-09", "cost": 1159.00 },
    { "date": "2024-12-10", "cost": 1165.00 },
    { "date": "2024-12-11", "cost": 1171.00 },
    { "date": "2024-12-12", "cost": 1177.00 },
    { "date": "2024-12-13", "cost": 1183.00 },
    { "date": "2024-12-14", "cost": 1128.00 },
    { "date": "2024-12-15", "cost": 1121.00 },

    { "date": "2025-01-01", "cost": 1195.00 },
    { "date": "2025-01-02", "cost": 1201.00 },
    { "date": "2025-01-03", "cost": 1207.00 },
    { "date": "2025-01-04", "cost": 1150.00 },
    { "date": "2025-01-05", "cost": 1143.00 },
    { "date": "2025-01-06", "cost": 1214.00 },
    { "date": "2025-01-07", "cost": 1220.00 },
    { "date": "2025-01-08", "cost": 1226.00 },
    { "date": "2025-01-09", "cost": 1233.00 },
    { "date": "2025-01-10", "cost": 1239.00 },
    { "date": "2025-01-11", "cost": 1182.00 },
    { "date": "2025-01-12", "cost": 1175.00 },
    { "date": "2025-01-13", "cost": 1245.00 },
    { "date": "2025-01-14", "cost": 1251.00 },
    { "date": "2025-01-15", "cost": 1257.00 },

    { "date": "2025-02-01", "cost": 1268.00 },
    { "date": "2025-02-02", "cost": 1260.00 },
    { "date": "2025-02-03", "cost": 1275.00 },
    { "date": "2025-02-04", "cost": 1281.00 },
    { "date": "2025-02-05", "cost": 1287.00 },
    { "date": "2025-02-06", "cost": 1293.00 },
    { "date": "2025-02-07", "cost": 1299.00 },
    { "date": "2025-02-08", "cost": 1241.00 },
    { "date": "2025-02-09", "cost": 1234.00 },
    { "date": "2025-02-10", "cost": 1305.00 },
    { "date": "2025-02-11", "cost": 1311.00 },
    { "date": "2025-02-12", "cost": 1317.00 },
    { "date": "2025-02-13", "cost": 1323.00 },
    { "date": "2025-02-14", "cost": 1329.00 },

    { "date": "2025-03-01", "cost": 1341.00 },
    { "date": "2025-03-02", "cost": 1333.00 },
    { "date": "2025-03-03", "cost": 1348.00 },
    { "date": "2025-03-04", "cost": 1354.00 },
    { "date": "2025-03-05", "cost": 1360.00 },
    { "date": "2025-03-06", "cost": 1366.00 },
    { "date": "2025-03-07", "cost": 1372.00 },
    { "date": "2025-03-08", "cost": 1312.00 },
    { "date": "2025-03-09", "cost": 1305.00 },
    { "date": "2025-03-10", "cost": 1378.00 },
    { "date": "2025-03-11", "cost": 1384.00 },
    { "date": "2025-03-12", "cost": 1390.00 },
    { "date": "2025-03-13", "cost": 1396.00 },
    { "date": "2025-03-14", "cost": 1402.00 },
    { "date": "2025-03-15", "cost": 1341.00 },
    { "date": "2025-03-16", "cost": 1334.00 },
    { "date": "2025-03-17", "cost": 1408.00 },
    { "date": "2025-03-18", "cost": 1414.00 },
    { "date": "2025-03-19", "cost": 1420.00 },
    { "date": "2025-03-20", "cost": 1426.00 },
    { "date": "2025-03-21", "cost": 1432.00 },
    { "date": "2025-03-22", "cost": 1371.00 },
    { "date": "2025-03-23", "cost": 1364.00 },
    { "date": "2025-03-24", "cost": 1438.00 },
    { "date": "2025-03-25", "cost": 1444.00 },
    { "date": "2025-03-26", "cost": 1450.00 },
    { "date": "2025-03-27", "cost": 1456.00 },
    { "date": "2025-03-28", "cost": 1462.00 },
    { "date": "2025-03-29", "cost": 1401.00 },
    { "date": "2025-03-30", "cost": 1394.00 },
    { "date": "2025-03-31", "cost": 1468.00 }
  ]
}
```

### How the engine chooses the “best algorithm”

1. Clean & enrich – fill missing dates, create weekday/holiday dummies, lag & MA features.

2. Model bake-off – ARIMA, STL-ETS, Prophet, TBATS, Gradient-Boost, Random-Forest, plus an Aggregation baseline that averages seasonal buckets (works surprisingly well on linear ramps).

3. Cross-validation – rolling-window CV → RMSE & MAE; lowest RMSE wins.

4. Indicators – trend slope, σ, CV, growth %, cumulative cost for the full horizon.

---

### Canonical response dissected


```json
{
    "forecast_period": 9,
    "forecast_result": {
        "analysis_type": "generic_cost",
        "best_algorithm": "Aggregation",
        "evaluation_metrics": {
            "RMSE": 26.572184922329946,
            "MAE": 21.84404110283987,
            "R2": 0.6666323266549463,
            "average_daily_cost": 1382.5775206313226,
            "Interpretation": "The Aggregation algorithm was selected because it achieved a low RMSE of 26.57, MAE of 21.84, and R² of 0.67. The average daily cost forecast is 1382.58."
        },
        "forecast": {
            "calendar": [
                {
                    "yyyy-mm": "2025-04",
                    "value": 43445.60577367302
                },
                {
                    "yyyy-mm": "2025-05",
                    "value": 44893.792632795456
                },
                {
                    "yyyy-mm": "2025-06",
                    "value": 43445.60577367302
                },
                {
                    "yyyy-mm": "2025-07",
                    "value": 44893.792632795456
                },
                {
                    "yyyy-mm": "2025-08",
                    "value": 44893.792632795456
                },
                {
                    "yyyy-mm": "2025-09",
                    "value": 43445.60577367302
                },
                {
                    "yyyy-mm": "2025-10",
                    "value": 44893.792632795456
                },
                {
                    "yyyy-mm": "2025-11",
                    "value": 43445.60577367302
                },
                {
                    "yyyy-mm": "2025-12",
                    "value": 44893.792632795456
                }
            ],
            "business": [
                {
                    "yyyy-mm": "2025-04",
                    "value": 31860.110900693548
                },
                {
                    "yyyy-mm": "2025-05",
                    "value": 31860.110900693548
                },
                {
                    "yyyy-mm": "2025-06",
                    "value": 30411.924041571114
                },
                {
                    "yyyy-mm": "2025-07",
                    "value": 33308.297759815985
                },
                {
                    "yyyy-mm": "2025-08",
                    "value": 30411.924041571114
                },
                {
                    "yyyy-mm": "2025-09",
                    "value": 31860.110900693548
                },
                {
                    "yyyy-mm": "2025-10",
                    "value": 33308.297759815985
                },
                {
                    "yyyy-mm": "2025-11",
                    "value": 28963.73718244868
                },
                {
                    "yyyy-mm": "2025-12",
                    "value": 33308.297759815985
                }
            ]
        },
        "business_indicators": {
            "historical_average_cost": 1194.37,
            "historical_cost_std": 157.88,
            "historical_coefficient_of_variation": 0.13,
            "historical_trend_slope": 4.783,
            "historical_trend_direction": "increasing",
            "forecast_cumulative_cost_calendar": 398251.39,
            "forecast_average_daily_cost_calendar": 1475.01,
            "forecast_cumulative_cost_business": 285292.81,
            "forecast_average_daily_cost_business": 1509.49,
            "forecast_growth_percentage": 23.5
        }
    },
    "execution_time_seconds": 0.2553369998931885
}
```

### Key take-aways

| Signal                  | Read-out                            | Action                                           |
|------------------------ |------------------------------------ |--------------------------------------------------|
| Trend slope +4.78       | Costs rising ≈ €4.8 per day.        | Investigate drivers (commodity, wage).           |
| CV 0.13                 | Low volatility.                     | Suitable for straight-line accruals.             |
| Forecast growth +23.5 % | 9-month calendar total vs trailing. | Feed to cash-flow & variance tracker.            |

---

### Power-user tips

- **Scenario overlays** – add `override_growth_pct` to shock the baseline (e.g. +10 % inflation).
- **Error bands** – set `"return_prediction_interval": true` to get 80 % & 95 % PI.
- **Cost centres** – batch 50+ series in one call via an array wrapper; each gets its own champion.
- **Alerting** – compare actuals to the PI; if two consecutive business days breach the 80 % upper band, trigger spend-freeze workflow.

---

### Next step

Schedule this endpoint monthly via your orchestration tool (Airflow, Prefect…). Push the business series into your rolling 13-week cash forecast. Combine the growth % indicator with revenue projections to maintain a dynamic gross-margin outlook.

---

# 4.4 Inventory & Supply-Chain
**Inventory & Supply-Chain**

**Endpoints:**
- `inventory_history_improved`
- `inventory_optimization`
- `nlp_openai_excess_inventory_report`
- `excess_inventory_nlp`
- `nlp_analisys`
- `nlp_analisys_en`

---

## 4.4.1 /api/v1/ai/inventory_history_improved
**Daily stock ledger + 360-degree inventory analytics**

**Purpose** A single endpoint that converts raw purchases & sales into a rich inventory ledger, full KPI deck and aging dashboard.

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/inventory_history_improved
Headers:
```json
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### What pain-point it fixes

| Operational headache                       | How the endpoint helps                                                                |
| ------------------------------------------ | ------------------------------------------------------------------------------------- |
| Need a day-by-day ledger for audit & BI    | `daily_inventory[]` rolls every purchase & sale into a running balance with %-changes |
| Finance wants turnover, DOS, volatility…   | `inventory_analysis{}` delivers 30+ KPIs with plain-English explanations              |
| Struggle to spot aging / obsolescence risk | `inventory_aging{}` splits lots into sold vs unsold with aging & risk buckets         |
| Need an all-in margin view                 | Price, cost & daily carrying cost feed margin %, EOQ, price sensitivity               |

---

### Payload reference

| Path                             | Type            | Req? | Purpose                   | Notes                       |
| -------------------------------- | --------------- | ---- | ------------------------- | --------------------------- |
| product_code                     | string / number | ✔︎   | SKU / article code        | returned verbatim           |
| sales_unity_cost                 | number          | ✔︎   | Unit COGS                 | currency-agnostic           |
| sales_unity_price                | number          | ✔︎   | Unit sell price           | used for margin, elasticity |
| inventory_daily_cost             | number          | ✔︎   | Holding cost / unit / day | for EOQ & efficiency flags  |
| lead_time_days                   | number          | ✔︎   | Replenishment lead time   | safety-stock calc           |
| inventory_initial_situation[]    | array           | ✔︎   | Opening stock snapshot    | exactly one row             |
| purchases[]                      | array           | ✔︎   | GRNs during the horizon   | any order                   |
| ↳ purchase_date                  | YYYY-MM-DD      | ✔︎   |                           |                             |
| ↳ purchase_quantity              | number          | ✔︎   | units                     |                             |
| sales[]                          | array           | ✔︎   | Shipments / invoices      | any order                   |
| ↳ invoice_date                   | YYYY-MM-DD      | ✔︎   |                           |                             |
| ↳ sales_quantity                 | number          | ✔︎   | units                     |                             |

---

### Minimal working example

```json
{
  "product_code": 38788,
  "sales_unity_cost": 25.50,
  "sales_unity_price": 60.73,
  "inventory_daily_cost": 0.15,
  "lead_time_days": 7.0,
  "inventory_initial_situation": [
    { "inventory_data": "2023-12-31", "inventory_quantity": 1050.0 }
  ],
  "purchases": [
    { "purchase_date": "2024-01-31", "purchase_quantity": 280.0 },
    { "purchase_date": "2024-02-28", "purchase_quantity": 240.0 },
    { "purchase_date": "2024-03-29", "purchase_quantity": 320.0 }
  ],
  "sales": [
    { "invoice_date": "2024-01-02", "sales_quantity":  5.0 },
    ⋯
    { "invoice_date": "2024-03-15", "sales_quantity": 31.0 }
  ]
}
```

---

### How the engine works (under the hood)

* Calendar scaffold – build a dense date index from min() to max(); back-fill zeros.

* Ledger build – on each day: net_change = purchase – sales, closing_inventory = prior + net_change.

* Activity tagging – No Activity, Only Purchase, Only Sales, Purchase & Sales.

* Stats & classifications – turnover, DOS, volatility, safety-stock, ABC, lifecycle, seasonality.

* Lot ageing – FIFO consume purchases, track days until sold; flag unsold lots >90 days.

* Elasticity & price sensitivity – simple OLS on price vs qty (if price series varied).

---

### Canonical response (excerpt)

```json
{
  "daily_inventory": [
    {
      "date": "2024-01-31",
      "purchase_quantity": 280,
      "sales_quantity": 0,
      "net_change": 280,
      "closing_inventory": 1216,
      "activity": "Only Purchase",
      "pct_change": 29.91
    },
    ⋯
  ],
  "inventory_analysis": {
    "initial_inventory": { "value": 1050, "explanation": "…" },
    "cumulative_purchases": { "value": 840, "explanation": "…" },
    "cumulative_sales": { "value": 721, "explanation": "…" },
    "turnover_ratio_initial": { "value": 0.687, "turnover_description": "Very Low Turnover" },
    "inventory_days_of_supply": { "value": 123.97, "days_supply_description": "Very Sluggish Inventory" },
    ⋯
  },
  "inventory_aging": {
    "sold_vs_unsold": {
      "sold_lots": {
        "summary": {
          "average_aging_days": 22,
          "std_aging_days": 12.73
        }
      },
      "unsold_lots": {
        "summary": { "weighted_average_current_age": 0 }
      }
    }
  },
  "product_details": {
    "product_code": 38788,
    "sales_unity_cost": 25.5,
    "sales_unity_price": 60.73,
    "inventory_daily_cost": 0.15
  },
  "processing_info": {
    "processing_time_seconds": 0.026,
    "calculation_date": "2025-05-21"
  }
}
```

---

### Reading the numbers — quick insights for this sample

| Insight                | Metric                  | Why it matters                                      |
| ---------------------- | ----------------------- | --------------------------------------------------- |
| Excess-inventory alert | DOS = 124 days          | Capital locked; consider promo / PO deferral.       |
| Safety stock needed    | 42.7 units              | Cover 7-day lead time with demand σ ≈ 9.8.          |
| Low turnover           | 0.69× initial stock     | SKU is slow-moving → review range or price.         |
| Lot ageing healthy     | All sold within 31 days | No obsolescence yet; monitor the 320-unit lot.      |
| Price sensitivity      | CV margin ≈ 0 → Low     | Room for small price rises with minimal demand hit. |

---

### Core flow metrics
(See full list of KPIs in your source.)

---

### Next step

Feed `daily_inventory` into your BI layer for real-time stock dashboards.

Trigger alerts:
if `inventory_days_of_supply > 90` and `excess_inventory_risk = High` → auto-suggest clearance promo.

Loop with forecasting: pair this ledger with `/api/forecast_units` to simulate future stock-outs & reorder points.

---

# 4.4.2 /api/v1/ai/inventory_optimization

**Find the sweet-spot between too much and too little stock**

### Purpose 
A single endpoint that converts raw purchases & sales into a rich inventory ledger, full KPI deck and aging dashboard.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST `https://api.abintel.ai/api/v1/ai/inventory_optimization`
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```

---

### Why this endpoint exists

| Pain-point                                               | What the route delivers                                                                                    |
| -------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| “How many units should I order & when?”                  | `stock_optimization_and_replenishment{}` → Re-order Point, Safety-Stock, EOQ & optimal order frequency.    |
| “Am I over-stocked‐or‐short against the sales plan?”     | `inventory_analysis.excess_or_shortfall_analysis` compares today’s stock with the entire forecast horizon. |
| “Need a single dashboard for demand trend, variability…” | `forecast_demand_analysis{}` – growth %, volatility, above/below-average months, exhaustion month.         |
| Finance wants profit impact of shortfalls                | `financial_analysis.shortfall_cost_details` converts lost units → lost margin.                             |
| Ops needs actionable alerts                              | `alerts{}` tell planners exactly what’s at risk.                                                           |

---

### Payload reference

| JSON path                                    | Type   | Req? | Purpose                   | Details                          |
| -------------------------------------------- | ------ | ---- | ------------------------- | -------------------------------- |
| inventory_last_position.closing_inventory    | number | ✔︎   | Current on-hand qty       | baseline for coverage & turnover |
| inventory_last_position.last_count_date      | date   | ✔︎   | Date of stock count       | ISO YYYY-MM-DD                   |
| inventory_last_position.warehouse            | string | ✔︎   | Location label            | free text                        |
| product_details                              | object | ✔︎   | Static SKU metadata       | echoed back                      |
| forecast[]                                   |  array | ✔︎   | Monthly demand projection | yyyy-mm, value                   |
| lead_time_days                               | number | ✔︎   | Replenishment lead time   | calendar days                    |
| daily_cost                                   | number | ✔︎   | Holding cost / unit / day | local currency                   |
| ordering_cost                                | number | ✔︎   | Cost per purchase order   | used in EOQ                      |
| sales_revenue                                | number | ✔︎   | Unit sell price           | for revenue ratio                |
| sales_profit                                 | number | ✔︎   | Unit contribution margin  | for shortfall loss               |
| buy_cost                                     | number | ✔︎   | Unit purchase cost        | inventory value                  |

Tip: supply ≥ 12 months of forecast for best EOQ & coverage logic.

---

### Minimal working example

```json
{
  "inventory_last_position": {
    "closing_inventory": 50000,
    "last_count_date": "2025-04-15",
    "warehouse": "Central-SP"
  },
  "product_details": {
    "product_code": "38788",
    "product_name": "Widget Pro XL",
    "category": "Industrial Components",
    "uom": "units",
    "supplier": "WidgetCo Brazil"
  },
  "forecast": [
    { "yyyy-mm": "2025-05", "value": 2500 },
    ⋯
    { "yyyy-mm": "2027-04", "value": 3450 }
  ],
  "lead_time_days": 15,
  "daily_cost": 0.12,
  "ordering_cost": 150,
  "sales_revenue": 75,
  "sales_profit": 25,
  "buy_cost": 30
}
```

### Canonical response (key parts)

```json
{
  "inventory_analysis": {
    "inventory_coverage_ratio": {
      "months_of_inventory": 15.79,
      "days_of_inventory": 473.68,
      "description": "On-hand ÷ average monthly demand."
    },
    "excess_or_shortfall_analysis": {
      "stock_status": "Shortfall",
      "difference": 26000
    }
  },
  "stock_optimization_and_replenishment": {
    "reorder_point": 1678.68,
    "safety_stock": 95.35,
    "economic_order_quantity": 510.17,
    "optimal_order_frequency": 45.27,
    "inventory_turnover_ratio": 1.52
  },
  "forecast_demand_analysis": {
    "average_monthly_demand": 3166.67,
    "average_forecast_growth_rate": 1.83,
    "forecast_variability": {
      "coefficient_of_variation": 0.141
    },
    "cumulative_demand_projection": {
      "exhaustion_month": "2026-09"
    }
  },
  "financial_analysis": {
    "inventory_value": 1500000,
    "shortfall_cost_details": {
      "shortfall_quantity": 26000,
      "profit_loss": 650000
    }
  },
  "alerts": {
    "stock_status_alert": "Alert: Stock Shortfall – immediate replenishment required."
  },
  "processing_info": {
    "processing_time_seconds": "0.005",
    "calculation_date": "2025-05-21"
  }
}
```

### Interpreting the sample

| What you learn          | Sample value       | Action                                                               |
| ----------------------- | ------------------ | -------------------------------------------------------------------- |
| Coverage                | 15.8 mo (474 days) | Looks ample, but cumulative demand shows shortfall later             |
| ROP                     | 1 679 u            | When projected balance drops to this level, place an order           |
| EOQ                     | 510 u              | Ideal order batch size to minimise total cost                        |
| Safety stock            | 95 u               | Covers 1.8 days at avg demand; low variability justifies lean buffer |
| Loss if not replenished | 650 k profit       | Quantifies urgency for finance & supply-chain                        |

---

### KPI (JSON path)

| KPI path                                                               | Technical meaning                      | Commercial meaning                                     |
| ---------------------------------------------------------------------- | -------------------------------------- | ------------------------------------------------------ |
| current_stock_level.closing_inventory                                  | Physical units on hand                 | Starting point for turnover & cash-tied-up discussions |
| inventory_coverage_ratio.months_of_inventory / days_of_inventory       | Stock ÷ avg monthly forecast (×30)     | How long you can keep selling before zero stock        |
| excess_or_shortfall_analysis.stock_status & difference                 | Compares stock to full forecast demand | Hidden lost-sales cost or excess carrying cost         |
| average_monthly_demand                                                 | Mean of forecast[].value              | Baseline for planning                                   |
| forecast_trends[].percentage_change                                    | MoM % delta                            | Demand acceleration signal                             |
| average_forecast_growth_rate                                           | Mean of MoM changes                    | Feed to revenue planning                               |
| seasonality_analysis.months_above_average                              | Month index > avg                      | Promo planning                                         |
| forecast_variability.coefficient_of_variation                          | std_dev ÷ mean                        | Safety stock guidance                                   |
| cumulative_demand_projection.exhaustion_month                          | First month demand > stock             | Deadline to order                                      |

---

### Replenishment Block

| KPI                        | Formula                                                          | Meaning                     |
| -------------------------- | ---------------------------------------------------------------- | --------------------------- |
| reorder_point              | (avg daily demand × lead-time) + safety_stock                    | PO trigger                  |
| safety_stock               | Z × σ(daily demand) × √lead-time (Z≈1.65)                        | Noise buffer                |
| economic_order_quantity    | √((2 × annual demand × ordering_cost) / holding_cost per unit)   | Cost-efficient batch size   |
| optimal_order_frequency    | cumulative demand ÷ EOQ                                          | Orders needed               |
| inventory_turnover_ratio   | forecast_period_demand ÷ current_stock                           | Sales cash conversion speed |

---

### Classification Block

| KPI path                       | Meaning                                          |
| ------------------------------ | ------------------------------------------------ |
| demand_classification.value    | Rule-based demand tier                           |
| turnover_classification.value  | Rule-based on stock velocity                     |
| criticality.value              | Combines turnover & shortfall to prioritise SKUs |

---

### Risk & Sensitivity

| KPI path                                          | What it tells you                     |
| ------------------------------------------------- | ------------------------------------- |
| demand_sensitivity_analysis.demand_sensitivity    | CV grouped to High/Med/Low            |
| additional_indicators.stock_out_risk              | Heuristic flag for sales & SLA impact |

---

### Money Block

| KPI path                              | Meaning                       |
| ------------------------------------- | ----------------------------- |
| financial_analysis.inventory_value    | Capital locked                |
| profit_margin_percent                 | Contribution %                |
| sales_to_inventory_ratio              | ROI metric                    |
| shortfall_cost_details.profit_loss    | Lost margin from missed sales |

---

### Alerts

* Auto-generated flag: "Alert: Stock Shortfall – immediate replenishment required."

---

### processing_info.processing_time_seconds

* Runtime: 0.005

---

### How to use the list

* Daily Ops: monitor ROP and auto-issue POs.

* Monthly S&OP: check forecast_variability, EOQ, seasonality.

* Quarterly Finance: review inventory_value, profit_loss, and sales_to_inventory_ratio.

---

#### Next step

* Create an automation that checks exhaustion_month weekly and warns 90 days in advance.

* Push ROP & EOQ into ERP/MRP for PO creation.

* Benchmark SKUs: average inventory_turnover_ratio and coefficient_of_variation to flag tuning candidates.

---

# 4.4.3 /api/v1/ai/nlp_openai_excess_inventory_report

**Turn raw inventory JSON into a board-ready excess-stock report**

### Purpose
One POST and you receive a fully drafted English-language report (tech insights + action plan) ready to paste into e-mail, slide deck or ERP note.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST `https://api.abintel.ai/api/v1/ai/nlp_openai_excess_inventory_report`
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```

---

### Why this endpoint exists

| Pain-point                                                             | What the route delivers |
| ---------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ |
| Inventory analysts spend hours turning data into plain-English reports |`response.report_text` ⇒ 3-to-5-page narrative: product facts, stock/coverage, demand, financials, alerts, plus an excess-reduction playbook|
| Need to justify carrying costs to finance                              | `financial_analysis.excess_cost_details` is automatically interpreted and explained in prose.                                              |
| Execs want actionable strategies not just numbers                      | Section “Strategic Action Plan” (promo tiers, BOGO, flash-sale, etc.) with timeline, impact & KPIs.                                        |
| Avoid copy-paste errors between BI tools & docs                     |Endpoint takes exact same JSON your BI engine already produces(from `/inventory_optimization` or `/inventory_history`), no field mapping needed|

---

### Payload reference

| JSON path                              | Type          | Req? | Notes                                                                     |
| -------------------------------------- | ------------- | ---- | ------------------------------------------------------------------------- |
| `product_details.product_code`         | string/number | ✔︎   | Echoed back in report headline                                             |
| `product_details.product_name`         | string        | ✔︎   |                                                                            |
| `inventory_analysis`                   | object        | ✔︎   | At minimum include `current_stock_level`, `excess_or_shortfall_analysis`   |
| `forecast_demand_analysis`             | object        | ✔︎   | Needs `average_monthly_demand` and `forecast_trends` for trend commentary  |
| `stock_optimization_and_replenishment` | object        | ✱    | Optional but recommended (ROP, EOQ, etc.)                                 |
| `financial_analysis`                   | object        | ✱    | Required only if you want cost breakdown & profit impact paragraphs       |
| `management_insights` / `alerts`       | object        | ✱    | Will be quoted verbatim inside the narrative if provided                  |

✱ = optional but the more you include, the richer the report.

---

Tip: All sections mirror the output of `/api/inventory_optimization`.
Pipe that JSON straight in here – no transformation needed.

---

### 3 Minimal working example

```json
{
    "product_details": {
        "product_code": 38788,
        "product_name": "LUBR ACEITE AMBRA MULT-G 10W30 API GL-4"
    },
    "inventory_analysis": {
        "current_stock_level": {
            "closing_inventory": 1123.0,
            "unit": "units",
            "description": "Closing inventory used as the baseline for all calculations."
        },
        "inventory_coverage_ratio": {
            "months_of_inventory": 68.45148469030566,
            "unit_months": "months",
            "days_of_inventory": 2053.5445407091697,
            "unit_days": "days",
            "description": "Calculated by dividing the closing inventory by the average monthly forecast demand. Days of inventory are estimated assuming 30 days per month."
        },
        "excess_or_shortfall_analysis": {
            "cumulative_forecast_demand": 164.05780021876473,
            "unit": "units",
            "stock_status": "Excess",
            "difference": 958.9421997812353,
            "unit_difference": "units",
            "optimal_stock_level": 164.05780021876473,
            "unit_optimal": "units",
            "description": "Compares current inventory against the cumulative forecast demand. Excess indicates overstock; shortfall indicates potential stock-out risk."
        }
    },
    "forecast_demand_analysis": {
        "cumulative_forecast_demand": 164.05780021876473,
        "unit": "units",
        "average_monthly_demand": 16.405780021876474,
        "unit_avg": "units/month",
        "forecast_trends": [
            {
                "from": "2023-04",
                "to": "2023-05",
                "percentage_change": 14.999999999999991,
                "unit": "percent"
            },
            {
                "from": "2023-05",
                "to": "2023-06",
                "percentage_change": -4.347826086956509,
                "unit": "percent"
            },
            {
                "from": "2023-06",
                "to": "2023-07",
                "percentage_change": -4.545454545454553,
                "unit": "percent"
            },
            {
                "from": "2023-07",
                "to": "2023-08",
                "percentage_change": 9.523809523809518,
                "unit": "percent"
            },
            {
                "from": "2023-08",
                "to": "2023-09",
                "percentage_change": -8.69565217391304,
                "unit": "percent"
            },
            {
                "from": "2023-09",
                "to": "2023-10",
                "percentage_change": 4.761904761904771,
                "unit": "percent"
            },
            {
                "from": "2023-10",
                "to": "2023-11",
                "percentage_change": 0.0,
                "unit": "percent"
            },
            {
                "from": "2023-11",
                "to": "2023-12",
                "percentage_change": -4.545454545454553,
                "unit": "percent"
            },
            {
                "from": "2023-12",
                "to": "2024-01",
                "percentage_change": 9.523809523809518,
                "unit": "percent"
            }
        ],
        "average_forecast_growth_rate": 1.8527929397494607,
        "unit_growth": "percent",
        "seasonality_analysis": {
            "months_above_average": [
                "2023-05",
                "2023-06",
                "2023-08",
                "2023-10",
                "2023-11",
                "2024-01"
            ],
            "months_below_average": [
                "2023-04",
                "2023-07",
                "2023-09",
                "2023-12"
            ],
            "description": "Identifies months with forecast demand above or below the average, suggesting seasonality patterns."
        },
        "forecast_variability": {
            "standard_deviation": 0.7772393003825065,
            "unit_std": "units",
            "variance": 0.6041009300590882,
            "unit_variance": "units^2",
            "coefficient_of_variation": 0.047375943072873586,
            "unit_cv": "ratio",
            "description": "Indicates the volatility and relative variability of the forecast demand."
        },
        "cumulative_demand_projection": {
            "cumulative_demand_by_month": [
                {
                    "yyyy-mm": "2023-04",
                    "cumulative_demand": 15.051174331996764
                },
                {
                    "yyyy-mm": "2023-05",
                    "cumulative_demand": 32.36002481379304
                },
                {
                    "yyyy-mm": "2023-06",
                    "cumulative_demand": 48.91631657898948
                },
                {
                    "yyyy-mm": "2023-07",
                    "cumulative_demand": 64.72004962758608
                },
                {
                    "yyyy-mm": "2023-08",
                    "cumulative_demand": 82.02890010938236
                },
                {
                    "yyyy-mm": "2023-09",
                    "cumulative_demand": 97.83263315797896
                },
                {
                    "yyyy-mm": "2023-10",
                    "cumulative_demand": 114.38892492317541
                },
                {
                    "yyyy-mm": "2023-11",
                    "cumulative_demand": 130.94521668837186
                },
                {
                    "yyyy-mm": "2023-12",
                    "cumulative_demand": 146.74894973696846
                },
                {
                    "yyyy-mm": "2024-01",
                    "cumulative_demand": 164.05780021876473
                }
            ],
            "exhaustion_month": "Not reached",
            "description": "Projects when current inventory might be exhausted if the forecast consumption rate holds."
        }
    },
    "stock_optimization_and_replenishment": {
        "reorder_point": {
            "value": 16.63992134544594,
            "unit": "units",
            "description": "Reorder Point (ROP) is calculated as the average daily demand multiplied by the lead time plus safety stock. Since 'lead_time_days' is provided, these values are computed accordingly."
        },
        "safety_stock": {
            "value": 0.23414132356946787,
            "unit": "units",
            "description": "Safety stock is determined using forecast variability and lead time to buffer against demand surges."
        },
        "economic_order_quantity": {
            "value": 9.685202611139799,
            "unit": "units",
            "description": "EOQ is calculated using the formula sqrt((2 * Annual Demand * Ordering Cost) / (Annual Holding Cost)). Annual Demand is extrapolated from the forecast, Ordering Cost defaults to 100 if not provided, and Annual Holding Cost is daily_cost * 365."
        },
        "optimal_order_frequency": {
            "orders_in_forecast_period": 9.859289404854339,
            "unit": "orders",
            "description": "Optimal order frequency is derived by dividing the cumulative forecast demand by the reorder point."
        },
        "inventory_turnover_ratio": {
            "value": 0.1460888692954272,
            "unit": "ratio",
            "description": "Calculated as the cumulative forecast demand divided by the closing inventory, representing how quickly inventory cycles."
        }
    },
    "product_classification": {
        "demand_classification": {
            "value": "Medium Demand",
            "description": "Classifies the product demand level based on the average monthly forecast demand."
        },
        "turnover_classification": {
            "value": "Slow-moving",
            "description": "Classifies the product based on the forecast-based turnover ratio."
        },
        "criticality": {
            "value": "Low (Stable)",
            "description": "Indicates the risk of stock-out if the cumulative forecast demand exceeds current inventory."
        }
    },
    "demand_sensitivity_analysis": {
        "coefficient_of_variation": 0.047375943072873586,
        "unit": "ratio",
        "demand_sensitivity": "Low Sensitivity (Stable forecast)",
        "description": "Assesses forecast sensitivity using the coefficient of variation; higher values indicate greater sensitivity."
    },
    "additional_indicators": {
        "supply_chain_risk": {
            "value": "High",
            "description": "Assesses potential supply chain risk based on the inventory turnover ratio; lower ratios may indicate obsolescence risk."
        },
        "stock_out_risk": {
            "value": "Low",
            "description": "Indicates the risk of stock-out based on current inventory versus forecast consumption."
        }
    },
    "financial_analysis": {
        "sales_revenue": 12.45,
        "sales_profit": 2.12,
        "buy_cost": 6.13,
        "profit_margin_percent": 17.0281124497992,
        "inventory_value": 6883.99,
        "sales_to_inventory_ratio": 0.0018085441727835165,
        "excess_cost_details": {
            "excess_quantity": 958.9421997812353,
            "months_to_optimize": 59,
            "monthly_breakdown": [
                {
                    "month": 1,
                    "starting_excess": 958.9421997812353,
                    "ending_excess": 942.5364197593589,
                    "average_excess": 950.739309770297,
                    "monthly_holding_cost": 32800.50618707525,
                    "cumulative_holding_cost": 32800.50618707525
                },
                {
                    "month": 2,
                    "starting_excess": 942.5364197593589,
                    "ending_excess": 926.1306397374824,
                    "average_excess": 934.3335297484207,
                    "monthly_holding_cost": 32234.506776320515,
                    "cumulative_holding_cost": 65035.01296339576
                },
                {
                    "month": 3,
                    "starting_excess": 926.1306397374824,
                    "ending_excess": 909.7248597156059,
                    "average_excess": 917.9277497265441,
                    "monthly_holding_cost": 31668.507365565772,
                    "cumulative_holding_cost": 96703.52032896153
                },
                {
                    "month": 4,
                    "starting_excess": 909.7248597156059,
                    "ending_excess": 893.3190796937295,
                    "average_excess": 901.5219697046678,
                    "monthly_holding_cost": 31102.507954811037,
                    "cumulative_holding_cost": 127806.02828377257
                },
                {
                    "month": 5,
                    "starting_excess": 893.3190796937295,
                    "ending_excess": 876.913299671853,
                    "average_excess": 885.1161896827912,
                    "monthly_holding_cost": 30536.508544056294,
                    "cumulative_holding_cost": 158342.53682782885
                },
                {
                    "month": 6,
                    "starting_excess": 876.913299671853,
                    "ending_excess": 860.5075196499765,
                    "average_excess": 868.7104096609148,
                    "monthly_holding_cost": 29970.50913330156,
                    "cumulative_holding_cost": 188313.0459611304
                },
                {
                    "month": 7,
                    "starting_excess": 860.5075196499765,
                    "ending_excess": 844.1017396281001,
                    "average_excess": 852.3046296390382,
                    "monthly_holding_cost": 29404.509722546816,
                    "cumulative_holding_cost": 217717.55568367723
                },
                {
                    "month": 8,
                    "starting_excess": 844.1017396281001,
                    "ending_excess": 827.6959596062236,
                    "average_excess": 835.8988496171619,
                    "monthly_holding_cost": 28838.51031179208,
                    "cumulative_holding_cost": 246556.0659954693
                },
                {
                    "month": 9,
                    "starting_excess": 827.6959596062236,
                    "ending_excess": 811.2901795843471,
                    "average_excess": 819.4930695952853,
                    "monthly_holding_cost": 28272.51090103734,
                    "cumulative_holding_cost": 274828.57689650665
                },
                {
                    "month": 10,
                    "starting_excess": 811.2901795843471,
                    "ending_excess": 794.8843995624707,
                    "average_excess": 803.087289573409,
                    "monthly_holding_cost": 27706.511490282606,
                    "cumulative_holding_cost": 302535.08838678926
                },
                {
                    "month": 11,
                    "starting_excess": 794.8843995624707,
                    "ending_excess": 778.4786195405942,
                    "average_excess": 786.6815095515324,
                    "monthly_holding_cost": 27140.512079527864,
                    "cumulative_holding_cost": 329675.60046631715
                },
                {
                    "month": 12,
                    "starting_excess": 778.4786195405942,
                    "ending_excess": 762.0728395187177,
                    "average_excess": 770.275729529656,
                    "monthly_holding_cost": 26574.51266877313,
                    "cumulative_holding_cost": 356250.1131350903
                },
                {
                    "month": 13,
                    "starting_excess": 762.0728395187177,
                    "ending_excess": 745.6670594968413,
                    "average_excess": 753.8699495077794,
                    "monthly_holding_cost": 26008.51325801839,
                    "cumulative_holding_cost": 382258.6263931087
                },
                {
                    "month": 14,
                    "starting_excess": 745.6670594968413,
                    "ending_excess": 729.2612794749648,
                    "average_excess": 737.4641694859031,
                    "monthly_holding_cost": 25442.513847263654,
                    "cumulative_holding_cost": 407701.14024037233
                },
                {
                    "month": 15,
                    "starting_excess": 729.2612794749648,
                    "ending_excess": 712.8554994530883,
                    "average_excess": 721.0583894640265,
                    "monthly_holding_cost": 24876.514436508915,
                    "cumulative_holding_cost": 432577.65467688127
                },
                {
                    "month": 16,
                    "starting_excess": 712.8554994530883,
                    "ending_excess": 696.4497194312119,
                    "average_excess": 704.6526094421502,
                    "monthly_holding_cost": 24310.51502575418,
                    "cumulative_holding_cost": 456888.16970263544
                },
                {
                    "month": 17,
                    "starting_excess": 696.4497194312119,
                    "ending_excess": 680.0439394093354,
                    "average_excess": 688.2468294202736,
                    "monthly_holding_cost": 23744.515614999436,
                    "cumulative_holding_cost": 480632.6853176349
                },
                {
                    "month": 18,
                    "starting_excess": 680.0439394093354,
                    "ending_excess": 663.6381593874589,
                    "average_excess": 671.8410493983972,
                    "monthly_holding_cost": 23178.516204244705,
                    "cumulative_holding_cost": 503811.2015218796
                },
                {
                    "month": 19,
                    "starting_excess": 663.6381593874589,
                    "ending_excess": 647.2323793655825,
                    "average_excess": 655.4352693765206,
                    "monthly_holding_cost": 22612.516793489962,
                    "cumulative_holding_cost": 526423.7183153696
                },
                {
                    "month": 20,
                    "starting_excess": 647.2323793655825,
                    "ending_excess": 630.826599343706,
                    "average_excess": 639.0294893546443,
                    "monthly_holding_cost": 22046.517382735226,
                    "cumulative_holding_cost": 548470.2356981048
                },
                {
                    "month": 21,
                    "starting_excess": 630.826599343706,
                    "ending_excess": 614.4208193218295,
                    "average_excess": 622.6237093327677,
                    "monthly_holding_cost": 21480.517971980487,
                    "cumulative_holding_cost": 569950.7536700853
                },
                {
                    "month": 22,
                    "starting_excess": 614.4208193218295,
                    "ending_excess": 598.0150392999531,
                    "average_excess": 606.2179293108913,
                    "monthly_holding_cost": 20914.518561225752,
                    "cumulative_holding_cost": 590865.2722313111
                },
                {
                    "month": 23,
                    "starting_excess": 598.0150392999531,
                    "ending_excess": 581.6092592780766,
                    "average_excess": 589.8121492890148,
                    "monthly_holding_cost": 20348.519150471006,
                    "cumulative_holding_cost": 611213.791381782
                },
                {
                    "month": 24,
                    "starting_excess": 581.6092592780766,
                    "ending_excess": 565.2034792562001,
                    "average_excess": 573.4063692671384,
                    "monthly_holding_cost": 19782.519739716274,
                    "cumulative_holding_cost": 630996.3111214984
                },
                {
                    "month": 25,
                    "starting_excess": 565.2034792562001,
                    "ending_excess": 548.7976992343237,
                    "average_excess": 557.0005892452618,
                    "monthly_holding_cost": 19216.52032896153,
                    "cumulative_holding_cost": 650212.8314504599
                },
                {
                    "month": 26,
                    "starting_excess": 548.7976992343237,
                    "ending_excess": 532.3919192124472,
                    "average_excess": 540.5948092233855,
                    "monthly_holding_cost": 18650.520918206796,
                    "cumulative_holding_cost": 668863.3523686667
                },
                {
                    "month": 27,
                    "starting_excess": 532.3919192124472,
                    "ending_excess": 515.9861391905707,
                    "average_excess": 524.1890292015089,
                    "monthly_holding_cost": 18084.521507452053,
                    "cumulative_holding_cost": 686947.8738761187
                },
                {
                    "month": 28,
                    "starting_excess": 515.9861391905707,
                    "ending_excess": 499.58035916869426,
                    "average_excess": 507.7832491796325,
                    "monthly_holding_cost": 17518.52209669732,
                    "cumulative_holding_cost": 704466.395972816
                },
                {
                    "month": 29,
                    "starting_excess": 499.58035916869426,
                    "ending_excess": 483.1745791468178,
                    "average_excess": 491.377469157756,
                    "monthly_holding_cost": 16952.522685942582,
                    "cumulative_holding_cost": 721418.9186587586
                },
                {
                    "month": 30,
                    "starting_excess": 483.1745791468178,
                    "ending_excess": 466.7687991249413,
                    "average_excess": 474.97168913587956,
                    "monthly_holding_cost": 16386.523275187843,
                    "cumulative_holding_cost": 737805.4419339465
                },
                {
                    "month": 31,
                    "starting_excess": 466.7687991249413,
                    "ending_excess": 450.36301910306486,
                    "average_excess": 458.5659091140031,
                    "monthly_holding_cost": 15820.523864433106,
                    "cumulative_holding_cost": 753625.9657983795
                },
                {
                    "month": 32,
                    "starting_excess": 450.36301910306486,
                    "ending_excess": 433.9572390811884,
                    "average_excess": 442.1601290921266,
                    "monthly_holding_cost": 15254.524453678367,
                    "cumulative_holding_cost": 768880.4902520579
                },
                {
                    "month": 33,
                    "starting_excess": 433.9572390811884,
                    "ending_excess": 417.5514590593119,
                    "average_excess": 425.75434907025016,
                    "monthly_holding_cost": 14688.52504292363,
                    "cumulative_holding_cost": 783569.0152949815
                },
                {
                    "month": 34,
                    "starting_excess": 417.5514590593119,
                    "ending_excess": 401.14567903743546,
                    "average_excess": 409.3485690483737,
                    "monthly_holding_cost": 14122.52563216889,
                    "cumulative_holding_cost": 797691.5409271504
                },
                {
                    "month": 35,
                    "starting_excess": 401.14567903743546,
                    "ending_excess": 384.739899015559,
                    "average_excess": 392.9427890264972,
                    "monthly_holding_cost": 13556.526221414153,
                    "cumulative_holding_cost": 811248.0671485645
                },
                {
                    "month": 36,
                    "starting_excess": 384.739899015559,
                    "ending_excess": 368.3341189936825,
                    "average_excess": 376.53700900462076,
                    "monthly_holding_cost": 12990.526810659416,
                    "cumulative_holding_cost": 824238.593959224
                },
                {
                    "month": 37,
                    "starting_excess": 368.3341189936825,
                    "ending_excess": 351.92833897180606,
                    "average_excess": 360.1312289827443,
                    "monthly_holding_cost": 12424.527399904677,
                    "cumulative_holding_cost": 836663.1213591286
                },
                {
                    "month": 38,
                    "starting_excess": 351.92833897180606,
                    "ending_excess": 335.5225589499296,
                    "average_excess": 343.7254489608678,
                    "monthly_holding_cost": 11858.52798914994,
                    "cumulative_holding_cost": 848521.6493482785
                },
                {
                    "month": 39,
                    "starting_excess": 335.5225589499296,
                    "ending_excess": 319.1167789280531,
                    "average_excess": 327.31966893899136,
                    "monthly_holding_cost": 11292.5285783952,
                    "cumulative_holding_cost": 859814.1779266738
                },
                {
                    "month": 40,
                    "starting_excess": 319.1167789280531,
                    "ending_excess": 302.71099890617666,
                    "average_excess": 310.9138889171149,
                    "monthly_holding_cost": 10726.529167640463,
                    "cumulative_holding_cost": 870540.7070943143
                },
                {
                    "month": 41,
                    "starting_excess": 302.71099890617666,
                    "ending_excess": 286.3052188843002,
                    "average_excess": 294.5081088952384,
                    "monthly_holding_cost": 10160.529756885726,
                    "cumulative_holding_cost": 880701.2368512
                },
                {
                    "month": 42,
                    "starting_excess": 286.3052188843002,
                    "ending_excess": 269.8994388624237,
                    "average_excess": 278.10232887336196,
                    "monthly_holding_cost": 9594.530346130987,
                    "cumulative_holding_cost": 890295.767197331
                },
                {
                    "month": 43,
                    "starting_excess": 269.8994388624237,
                    "ending_excess": 253.49365884054725,
                    "average_excess": 261.6965488514855,
                    "monthly_holding_cost": 9028.53093537625,
                    "cumulative_holding_cost": 899324.2981327072
                },
                {
                    "month": 44,
                    "starting_excess": 253.49365884054725,
                    "ending_excess": 237.0878788186708,
                    "average_excess": 245.29076882960902,
                    "monthly_holding_cost": 8462.53152462151,
                    "cumulative_holding_cost": 907786.8296573288
                },
                {
                    "month": 45,
                    "starting_excess": 237.0878788186708,
                    "ending_excess": 220.68209879679432,
                    "average_excess": 228.88498880773255,
                    "monthly_holding_cost": 7896.532113866771,
                    "cumulative_holding_cost": 915683.3617711955
                },
                {
                    "month": 46,
                    "starting_excess": 220.68209879679432,
                    "ending_excess": 204.27631877491785,
                    "average_excess": 212.4792087858561,
                    "monthly_holding_cost": 7330.532703112035,
                    "cumulative_holding_cost": 923013.8944743075
                },
                {
                    "month": 47,
                    "starting_excess": 204.27631877491785,
                    "ending_excess": 187.8705387530414,
                    "average_excess": 196.07342876397962,
                    "monthly_holding_cost": 6764.533292357296,
                    "cumulative_holding_cost": 929778.4277666649
                },
                {
                    "month": 48,
                    "starting_excess": 187.8705387530414,
                    "ending_excess": 171.46475873116492,
                    "average_excess": 179.66764874210315,
                    "monthly_holding_cost": 6198.533881602558,
                    "cumulative_holding_cost": 935976.9616482675
                },
                {
                    "month": 49,
                    "starting_excess": 171.46475873116492,
                    "ending_excess": 155.05897870928845,
                    "average_excess": 163.2618687202267,
                    "monthly_holding_cost": 5632.534470847821,
                    "cumulative_holding_cost": 941609.4961191153
                },
                {
                    "month": 50,
                    "starting_excess": 155.05897870928845,
                    "ending_excess": 138.653198687412,
                    "average_excess": 146.85608869835022,
                    "monthly_holding_cost": 5066.535060093082,
                    "cumulative_holding_cost": 946676.0311792083
                },
                {
                    "month": 51,
                    "starting_excess": 138.653198687412,
                    "ending_excess": 122.24741866553552,
                    "average_excess": 130.45030867647375,
                    "monthly_holding_cost": 4500.535649338344,
                    "cumulative_holding_cost": 951176.5668285467
                },
                {
                    "month": 52,
                    "starting_excess": 122.24741866553552,
                    "ending_excess": 105.84163864365905,
                    "average_excess": 114.04452865459729,
                    "monthly_holding_cost": 3934.536238583606,
                    "cumulative_holding_cost": 955111.1030671303
                },
                {
                    "month": 53,
                    "starting_excess": 105.84163864365905,
                    "ending_excess": 89.43585862178259,
                    "average_excess": 97.63874863272082,
                    "monthly_holding_cost": 3368.536827828868,
                    "cumulative_holding_cost": 958479.6398949592
                },
                {
                    "month": 54,
                    "starting_excess": 89.43585862178259,
                    "ending_excess": 73.03007859990612,
                    "average_excess": 81.23296861084435,
                    "monthly_holding_cost": 2802.53741707413,
                    "cumulative_holding_cost": 961282.1773120333
                },
                {
                    "month": 55,
                    "starting_excess": 73.03007859990612,
                    "ending_excess": 56.624298578029645,
                    "average_excess": 64.82718858896789,
                    "monthly_holding_cost": 2236.538006319392,
                    "cumulative_holding_cost": 963518.7153183527
                },
                {
                    "month": 56,
                    "starting_excess": 56.624298578029645,
                    "ending_excess": 40.21851855615317,
                    "average_excess": 48.421408567091405,
                    "monthly_holding_cost": 1670.5385955646532,
                    "cumulative_holding_cost": 965189.2539139173
                },
                {
                    "month": 57,
                    "starting_excess": 40.21851855615317,
                    "ending_excess": 23.812738534276697,
                    "average_excess": 32.01562854521494,
                    "monthly_holding_cost": 1104.5391848099152,
                    "cumulative_holding_cost": 966293.7930987272
                },
                {
                    "month": 58,
                    "starting_excess": 23.812738534276697,
                    "ending_excess": 7.406958512400223,
                    "average_excess": 15.60984852333846,
                    "monthly_holding_cost": 538.5397740551768,
                    "cumulative_holding_cost": 966832.3328727824
                },
                {
                    "month": 59,
                    "starting_excess": 7.406958512400223,
                    "ending_excess": 0.0,
                    "average_excess": 3.7034792562001115,
                    "monthly_holding_cost": 127.77003433890384,
                    "cumulative_holding_cost": 966960.1029071213
                }
            ],
            "cumulative_holding_cost": 966960.1029071213,
            "excess_buy_cost": 5878.315684658973,
            "total_excess_cost": 972838.4185917802
        }
    },
    "management_insights": {
        "overall_insight": "The inventory is classified as 'Excess' relative to the forecast demand. Reorder point, safety stock, and optimal order frequency were computed using a lead time of 30 days. Forecast variability is low, suggesting stable demand. However, the inventory turnover ratio indicates slow-moving inventory, which might signal an opportunity to optimize stock levels."
    },
    "alerts": {
        "stock_status_alert": "Alert: Excess Inventory - Consider reducing future orders.",
        "inventory_turnover_alert": "Alert: Low turnover ratio indicates slow-moving inventory."
    },
    "processing_info": {
        "processing_time_seconds": "0.005",
        "calculation_date": "2025-03-24",
        "note": "Fields such as reorder point, safety stock, EOQ and financial analysis are computed using the provided parameters."
    }
}
```

---

### Response

```json
{
    "context": {
        "dados_inventario": {
            "product_details": {
                "product_code": 38788,
                "product_name": "LUBR ACEITE AMBRA MULT-G 10W30 API GL-4"
            },
            "inventory_analysis": {
                "current_stock_level": {
                    "closing_inventory": 1123.0,
                    "unit": "units",
                    "description": "Closing inventory used as the baseline for all calculations."
                },
                "inventory_coverage_ratio": {
                    "months_of_inventory": 68.45148469030566,
                    "unit_months": "months",
                    "days_of_inventory": 2053.5445407091697,
                    "unit_days": "days",
                    "description": "Calculated by dividing the closing inventory by the average monthly forecast demand. Days of inventory are estimated assuming 30 days per month."
                },
                "excess_or_shortfall_analysis": {
                    "cumulative_forecast_demand": 164.05780021876473,
                    "unit": "units",
                    "stock_status": "Excess",
                    "difference": 958.9421997812353,
                    "unit_difference": "units",
                    "optimal_stock_level": 164.05780021876473,
                    "unit_optimal": "units",
                    "description": "Compares current inventory against the cumulative forecast demand. Excess indicates overstock; shortfall indicates potential stock-out risk."
                }
            },
            "forecast_demand_analysis": {
                "cumulative_forecast_demand": 164.05780021876473,
                "unit": "units",
                "average_monthly_demand": 16.405780021876474,
                "unit_avg": "units/month",
                "forecast_trends": [
                    {
                        "from": "2023-04",
                        "to": "2023-05",
                        "percentage_change": 14.999999999999991,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-05",
                        "to": "2023-06",
                        "percentage_change": -4.347826086956509,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-06",
                        "to": "2023-07",
                        "percentage_change": -4.545454545454553,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-07",
                        "to": "2023-08",
                        "percentage_change": 9.523809523809518,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-08",
                        "to": "2023-09",
                        "percentage_change": -8.69565217391304,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-09",
                        "to": "2023-10",
                        "percentage_change": 4.761904761904771,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-10",
                        "to": "2023-11",
                        "percentage_change": 0.0,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-11",
                        "to": "2023-12",
                        "percentage_change": -4.545454545454553,
                        "unit": "percent"
                    },
                    {
                        "from": "2023-12",
                        "to": "2024-01",
                        "percentage_change": 9.523809523809518,
                        "unit": "percent"
                    }
                ],
                "average_forecast_growth_rate": 1.8527929397494607,
                "unit_growth": "percent",
                "seasonality_analysis": {
                    "months_above_average": [
                        "2023-05",
                        "2023-06",
                        "2023-08",
                        "2023-10",
                        "2023-11",
                        "2024-01"
                    ],
                    "months_below_average": [
                        "2023-04",
                        "2023-07",
                        "2023-09",
                        "2023-12"
                    ],
                    "description": "Identifies months with forecast demand above or below the average, suggesting seasonality patterns."
                },
                "forecast_variability": {
                    "standard_deviation": 0.7772393003825065,
                    "unit_std": "units",
                    "variance": 0.6041009300590882,
                    "unit_variance": "units^2",
                    "coefficient_of_variation": 0.047375943072873586,
                    "unit_cv": "ratio",
                    "description": "Indicates the volatility and relative variability of the forecast demand."
                },
                "cumulative_demand_projection": {
                    "cumulative_demand_by_month": [
                        {
                            "yyyy-mm": "2023-04",
                            "cumulative_demand": 15.051174331996764
                        },
                        {
                            "yyyy-mm": "2023-05",
                            "cumulative_demand": 32.36002481379304
                        },
                        {
                            "yyyy-mm": "2023-06",
                            "cumulative_demand": 48.91631657898948
                        },
                        {
                            "yyyy-mm": "2023-07",
                            "cumulative_demand": 64.72004962758608
                        },
                        {
                            "yyyy-mm": "2023-08",
                            "cumulative_demand": 82.02890010938236
                        },
                        {
                            "yyyy-mm": "2023-09",
                            "cumulative_demand": 97.83263315797896
                        },
                        {
                            "yyyy-mm": "2023-10",
                            "cumulative_demand": 114.38892492317541
                        },
                        {
                            "yyyy-mm": "2023-11",
                            "cumulative_demand": 130.94521668837186
                        },
                        {
                            "yyyy-mm": "2023-12",
                            "cumulative_demand": 146.74894973696846
                        },
                        {
                            "yyyy-mm": "2024-01",
                            "cumulative_demand": 164.05780021876473
                        }
                    ],
                    "exhaustion_month": "Not reached",
                    "description": "Projects when current inventory might be exhausted if the forecast consumption rate holds."
                }
            },
            "stock_optimization_and_replenishment": {
                "reorder_point": {
                    "value": 16.63992134544594,
                    "unit": "units",
                    "description": "Reorder Point (ROP) is calculated as the average daily demand multiplied by the lead time plus safety stock. Since 'lead_time_days' is provided, these values are computed accordingly."
                },
                "safety_stock": {
                    "value": 0.23414132356946787,
                    "unit": "units",
                    "description": "Safety stock is determined using forecast variability and lead time to buffer against demand surges."
                },
                "economic_order_quantity": {
                    "value": 9.685202611139799,
                    "unit": "units",
                    "description": "EOQ is calculated using the formula sqrt((2 * Annual Demand * Ordering Cost) / (Annual Holding Cost)). Annual Demand is extrapolated from the forecast, Ordering Cost defaults to 100 if not provided, and Annual Holding Cost is daily_cost * 365."
                },
                "optimal_order_frequency": {
                    "orders_in_forecast_period": 9.859289404854339,
                    "unit": "orders",
                    "description": "Optimal order frequency is derived by dividing the cumulative forecast demand by the reorder point."
                },
                "inventory_turnover_ratio": {
                    "value": 0.1460888692954272,
                    "unit": "ratio",
                    "description": "Calculated as the cumulative forecast demand divided by the closing inventory, representing how quickly inventory cycles."
                }
            },
            "product_classification": {
                "demand_classification": {
                    "value": "Medium Demand",
                    "description": "Classifies the product demand level based on the average monthly forecast demand."
                },
                "turnover_classification": {
                    "value": "Slow-moving",
                    "description": "Classifies the product based on the forecast-based turnover ratio."
                },
                "criticality": {
                    "value": "Low (Stable)",
                    "description": "Indicates the risk of stock-out if the cumulative forecast demand exceeds current inventory."
                }
            },
            "demand_sensitivity_analysis": {
                "coefficient_of_variation": 0.047375943072873586,
                "unit": "ratio",
                "demand_sensitivity": "Low Sensitivity (Stable forecast)",
                "description": "Assesses forecast sensitivity using the coefficient of variation; higher values indicate greater sensitivity."
            },
            "additional_indicators": {
                "supply_chain_risk": {
                    "value": "High",
                    "description": "Assesses potential supply chain risk based on the inventory turnover ratio; lower ratios may indicate obsolescence risk."
                },
                "stock_out_risk": {
                    "value": "Low",
                    "description": "Indicates the risk of stock-out based on current inventory versus forecast consumption."
                }
            },
            "financial_analysis": {
                "sales_revenue": 12.45,
                "sales_profit": 2.12,
                "buy_cost": 6.13,
                "profit_margin_percent": 17.0281124497992,
                "inventory_value": 6883.99,
                "sales_to_inventory_ratio": 0.0018085441727835165,
                "excess_cost_details": {
                    "excess_quantity": 958.9421997812353,
                    "months_to_optimize": 59,
                    "monthly_breakdown": [
                        {
                            "month": 1,
                            "starting_excess": 958.9421997812353,
                            "ending_excess": 942.5364197593589,
                            "average_excess": 950.739309770297,
                            "monthly_holding_cost": 32800.50618707525,
                            "cumulative_holding_cost": 32800.50618707525
                        },
                        {
                            "month": 2,
                            "starting_excess": 942.5364197593589,
                            "ending_excess": 926.1306397374824,
                            "average_excess": 934.3335297484207,
                            "monthly_holding_cost": 32234.506776320515,
                            "cumulative_holding_cost": 65035.01296339576
                        },
                        {
                            "month": 3,
                            "starting_excess": 926.1306397374824,
                            "ending_excess": 909.7248597156059,
                            "average_excess": 917.9277497265441,
                            "monthly_holding_cost": 31668.507365565772,
                            "cumulative_holding_cost": 96703.52032896153
                        },
                        {
                            "month": 4,
                            "starting_excess": 909.7248597156059,
                            "ending_excess": 893.3190796937295,
                            "average_excess": 901.5219697046678,
                            "monthly_holding_cost": 31102.507954811037,
                            "cumulative_holding_cost": 127806.02828377257
                        },
                        {
                            "month": 5,
                            "starting_excess": 893.3190796937295,
                            "ending_excess": 876.913299671853,
                            "average_excess": 885.1161896827912,
                            "monthly_holding_cost": 30536.508544056294,
                            "cumulative_holding_cost": 158342.53682782885
                        },
                        {
                            "month": 6,
                            "starting_excess": 876.913299671853,
                            "ending_excess": 860.5075196499765,
                            "average_excess": 868.7104096609148,
                            "monthly_holding_cost": 29970.50913330156,
                            "cumulative_holding_cost": 188313.0459611304
                        },
                        {
                            "month": 7,
                            "starting_excess": 860.5075196499765,
                            "ending_excess": 844.1017396281001,
                            "average_excess": 852.3046296390382,
                            "monthly_holding_cost": 29404.509722546816,
                            "cumulative_holding_cost": 217717.55568367723
                        },
                        {
                            "month": 8,
                            "starting_excess": 844.1017396281001,
                            "ending_excess": 827.6959596062236,
                            "average_excess": 835.8988496171619,
                            "monthly_holding_cost": 28838.51031179208,
                            "cumulative_holding_cost": 246556.0659954693
                        },
                        {
                            "month": 9,
                            "starting_excess": 827.6959596062236,
                            "ending_excess": 811.2901795843471,
                            "average_excess": 819.4930695952853,
                            "monthly_holding_cost": 28272.51090103734,
                            "cumulative_holding_cost": 274828.57689650665
                        },
                        {
                            "month": 10,
                            "starting_excess": 811.2901795843471,
                            "ending_excess": 794.8843995624707,
                            "average_excess": 803.087289573409,
                            "monthly_holding_cost": 27706.511490282606,
                            "cumulative_holding_cost": 302535.08838678926
                        },
                        {
                            "month": 11,
                            "starting_excess": 794.8843995624707,
                            "ending_excess": 778.4786195405942,
                            "average_excess": 786.6815095515324,
                            "monthly_holding_cost": 27140.512079527864,
                            "cumulative_holding_cost": 329675.60046631715
                        },
                        {
                            "month": 12,
                            "starting_excess": 778.4786195405942,
                            "ending_excess": 762.0728395187177,
                            "average_excess": 770.275729529656,
                            "monthly_holding_cost": 26574.51266877313,
                            "cumulative_holding_cost": 356250.1131350903
                        },
                        {
                            "month": 13,
                            "starting_excess": 762.0728395187177,
                            "ending_excess": 745.6670594968413,
                            "average_excess": 753.8699495077794,
                            "monthly_holding_cost": 26008.51325801839,
                            "cumulative_holding_cost": 382258.6263931087
                        },
                        {
                            "month": 14,
                            "starting_excess": 745.6670594968413,
                            "ending_excess": 729.2612794749648,
                            "average_excess": 737.4641694859031,
                            "monthly_holding_cost": 25442.513847263654,
                            "cumulative_holding_cost": 407701.14024037233
                        },
                        {
                            "month": 15,
                            "starting_excess": 729.2612794749648,
                            "ending_excess": 712.8554994530883,
                            "average_excess": 721.0583894640265,
                            "monthly_holding_cost": 24876.514436508915,
                            "cumulative_holding_cost": 432577.65467688127
                        },
                        {
                            "month": 16,
                            "starting_excess": 712.8554994530883,
                            "ending_excess": 696.4497194312119,
                            "average_excess": 704.6526094421502,
                            "monthly_holding_cost": 24310.51502575418,
                            "cumulative_holding_cost": 456888.16970263544
                        },
                        {
                            "month": 17,
                            "starting_excess": 696.4497194312119,
                            "ending_excess": 680.0439394093354,
                            "average_excess": 688.2468294202736,
                            "monthly_holding_cost": 23744.515614999436,
                            "cumulative_holding_cost": 480632.6853176349
                        },
                        {
                            "month": 18,
                            "starting_excess": 680.0439394093354,
                            "ending_excess": 663.6381593874589,
                            "average_excess": 671.8410493983972,
                            "monthly_holding_cost": 23178.516204244705,
                            "cumulative_holding_cost": 503811.2015218796
                        },
                        {
                            "month": 19,
                            "starting_excess": 663.6381593874589,
                            "ending_excess": 647.2323793655825,
                            "average_excess": 655.4352693765206,
                            "monthly_holding_cost": 22612.516793489962,
                            "cumulative_holding_cost": 526423.7183153696
                        },
                        {
                            "month": 20,
                            "starting_excess": 647.2323793655825,
                            "ending_excess": 630.826599343706,
                            "average_excess": 639.0294893546443,
                            "monthly_holding_cost": 22046.517382735226,
                            "cumulative_holding_cost": 548470.2356981048
                        },
                        {
                            "month": 21,
                            "starting_excess": 630.826599343706,
                            "ending_excess": 614.4208193218295,
                            "average_excess": 622.6237093327677,
                            "monthly_holding_cost": 21480.517971980487,
                            "cumulative_holding_cost": 569950.7536700853
                        },
                        {
                            "month": 22,
                            "starting_excess": 614.4208193218295,
                            "ending_excess": 598.0150392999531,
                            "average_excess": 606.2179293108913,
                            "monthly_holding_cost": 20914.518561225752,
                            "cumulative_holding_cost": 590865.2722313111
                        },
                        {
                            "month": 23,
                            "starting_excess": 598.0150392999531,
                            "ending_excess": 581.6092592780766,
                            "average_excess": 589.8121492890148,
                            "monthly_holding_cost": 20348.519150471006,
                            "cumulative_holding_cost": 611213.791381782
                        },
                        {
                            "month": 24,
                            "starting_excess": 581.6092592780766,
                            "ending_excess": 565.2034792562001,
                            "average_excess": 573.4063692671384,
                            "monthly_holding_cost": 19782.519739716274,
                            "cumulative_holding_cost": 630996.3111214984
                        },
                        {
                            "month": 25,
                            "starting_excess": 565.2034792562001,
                            "ending_excess": 548.7976992343237,
                            "average_excess": 557.0005892452618,
                            "monthly_holding_cost": 19216.52032896153,
                            "cumulative_holding_cost": 650212.8314504599
                        },
                        {
                            "month": 26,
                            "starting_excess": 548.7976992343237,
                            "ending_excess": 532.3919192124472,
                            "average_excess": 540.5948092233855,
                            "monthly_holding_cost": 18650.520918206796,
                            "cumulative_holding_cost": 668863.3523686667
                        },
                        {
                            "month": 27,
                            "starting_excess": 532.3919192124472,
                            "ending_excess": 515.9861391905707,
                            "average_excess": 524.1890292015089,
                            "monthly_holding_cost": 18084.521507452053,
                            "cumulative_holding_cost": 686947.8738761187
                        },
                        {
                            "month": 28,
                            "starting_excess": 515.9861391905707,
                            "ending_excess": 499.58035916869426,
                            "average_excess": 507.7832491796325,
                            "monthly_holding_cost": 17518.52209669732,
                            "cumulative_holding_cost": 704466.395972816
                        },
                        {
                            "month": 29,
                            "starting_excess": 499.58035916869426,
                            "ending_excess": 483.1745791468178,
                            "average_excess": 491.377469157756,
                            "monthly_holding_cost": 16952.522685942582,
                            "cumulative_holding_cost": 721418.9186587586
                        },
                        {
                            "month": 30,
                            "starting_excess": 483.1745791468178,
                            "ending_excess": 466.7687991249413,
                            "average_excess": 474.97168913587956,
                            "monthly_holding_cost": 16386.523275187843,
                            "cumulative_holding_cost": 737805.4419339465
                        },
                        {
                            "month": 31,
                            "starting_excess": 466.7687991249413,
                            "ending_excess": 450.36301910306486,
                            "average_excess": 458.5659091140031,
                            "monthly_holding_cost": 15820.523864433106,
                            "cumulative_holding_cost": 753625.9657983795
                        },
                        {
                            "month": 32,
                            "starting_excess": 450.36301910306486,
                            "ending_excess": 433.9572390811884,
                            "average_excess": 442.1601290921266,
                            "monthly_holding_cost": 15254.524453678367,
                            "cumulative_holding_cost": 768880.4902520579
                        },
                        {
                            "month": 33,
                            "starting_excess": 433.9572390811884,
                            "ending_excess": 417.5514590593119,
                            "average_excess": 425.75434907025016,
                            "monthly_holding_cost": 14688.52504292363,
                            "cumulative_holding_cost": 783569.0152949815
                        },
                        {
                            "month": 34,
                            "starting_excess": 417.5514590593119,
                            "ending_excess": 401.14567903743546,
                            "average_excess": 409.3485690483737,
                            "monthly_holding_cost": 14122.52563216889,
                            "cumulative_holding_cost": 797691.5409271504
                        },
                        {
                            "month": 35,
                            "starting_excess": 401.14567903743546,
                            "ending_excess": 384.739899015559,
                            "average_excess": 392.9427890264972,
                            "monthly_holding_cost": 13556.526221414153,
                            "cumulative_holding_cost": 811248.0671485645
                        },
                        {
                            "month": 36,
                            "starting_excess": 384.739899015559,
                            "ending_excess": 368.3341189936825,
                            "average_excess": 376.53700900462076,
                            "monthly_holding_cost": 12990.526810659416,
                            "cumulative_holding_cost": 824238.593959224
                        },
                        {
                            "month": 37,
                            "starting_excess": 368.3341189936825,
                            "ending_excess": 351.92833897180606,
                            "average_excess": 360.1312289827443,
                            "monthly_holding_cost": 12424.527399904677,
                            "cumulative_holding_cost": 836663.1213591286
                        },
                        {
                            "month": 38,
                            "starting_excess": 351.92833897180606,
                            "ending_excess": 335.5225589499296,
                            "average_excess": 343.7254489608678,
                            "monthly_holding_cost": 11858.52798914994,
                            "cumulative_holding_cost": 848521.6493482785
                        },
                        {
                            "month": 39,
                            "starting_excess": 335.5225589499296,
                            "ending_excess": 319.1167789280531,
                            "average_excess": 327.31966893899136,
                            "monthly_holding_cost": 11292.5285783952,
                            "cumulative_holding_cost": 859814.1779266738
                        },
                        {
                            "month": 40,
                            "starting_excess": 319.1167789280531,
                            "ending_excess": 302.71099890617666,
                            "average_excess": 310.9138889171149,
                            "monthly_holding_cost": 10726.529167640463,
                            "cumulative_holding_cost": 870540.7070943143
                        },
                        {
                            "month": 41,
                            "starting_excess": 302.71099890617666,
                            "ending_excess": 286.3052188843002,
                            "average_excess": 294.5081088952384,
                            "monthly_holding_cost": 10160.529756885726,
                            "cumulative_holding_cost": 880701.2368512
                        },
                        {
                            "month": 42,
                            "starting_excess": 286.3052188843002,
                            "ending_excess": 269.8994388624237,
                            "average_excess": 278.10232887336196,
                            "monthly_holding_cost": 9594.530346130987,
                            "cumulative_holding_cost": 890295.767197331
                        },
                        {
                            "month": 43,
                            "starting_excess": 269.8994388624237,
                            "ending_excess": 253.49365884054725,
                            "average_excess": 261.6965488514855,
                            "monthly_holding_cost": 9028.53093537625,
                            "cumulative_holding_cost": 899324.2981327072
                        },
                        {
                            "month": 44,
                            "starting_excess": 253.49365884054725,
                            "ending_excess": 237.0878788186708,
                            "average_excess": 245.29076882960902,
                            "monthly_holding_cost": 8462.53152462151,
                            "cumulative_holding_cost": 907786.8296573288
                        },
                        {
                            "month": 45,
                            "starting_excess": 237.0878788186708,
                            "ending_excess": 220.68209879679432,
                            "average_excess": 228.88498880773255,
                            "monthly_holding_cost": 7896.532113866771,
                            "cumulative_holding_cost": 915683.3617711955
                        },
                        {
                            "month": 46,
                            "starting_excess": 220.68209879679432,
                            "ending_excess": 204.27631877491785,
                            "average_excess": 212.4792087858561,
                            "monthly_holding_cost": 7330.532703112035,
                            "cumulative_holding_cost": 923013.8944743075
                        },
                        {
                            "month": 47,
                            "starting_excess": 204.27631877491785,
                            "ending_excess": 187.8705387530414,
                            "average_excess": 196.07342876397962,
                            "monthly_holding_cost": 6764.533292357296,
                            "cumulative_holding_cost": 929778.4277666649
                        },
                        {
                            "month": 48,
                            "starting_excess": 187.8705387530414,
                            "ending_excess": 171.46475873116492,
                            "average_excess": 179.66764874210315,
                            "monthly_holding_cost": 6198.533881602558,
                            "cumulative_holding_cost": 935976.9616482675
                        },
                        {
                            "month": 49,
                            "starting_excess": 171.46475873116492,
                            "ending_excess": 155.05897870928845,
                            "average_excess": 163.2618687202267,
                            "monthly_holding_cost": 5632.534470847821,
                            "cumulative_holding_cost": 941609.4961191153
                        },
                        {
                            "month": 50,
                            "starting_excess": 155.05897870928845,
                            "ending_excess": 138.653198687412,
                            "average_excess": 146.85608869835022,
                            "monthly_holding_cost": 5066.535060093082,
                            "cumulative_holding_cost": 946676.0311792083
                        },
                        {
                            "month": 51,
                            "starting_excess": 138.653198687412,
                            "ending_excess": 122.24741866553552,
                            "average_excess": 130.45030867647375,
                            "monthly_holding_cost": 4500.535649338344,
                            "cumulative_holding_cost": 951176.5668285467
                        },
                        {
                            "month": 52,
                            "starting_excess": 122.24741866553552,
                            "ending_excess": 105.84163864365905,
                            "average_excess": 114.04452865459729,
                            "monthly_holding_cost": 3934.536238583606,
                            "cumulative_holding_cost": 955111.1030671303
                        },
                        {
                            "month": 53,
                            "starting_excess": 105.84163864365905,
                            "ending_excess": 89.43585862178259,
                            "average_excess": 97.63874863272082,
                            "monthly_holding_cost": 3368.536827828868,
                            "cumulative_holding_cost": 958479.6398949592
                        },
                        {
                            "month": 54,
                            "starting_excess": 89.43585862178259,
                            "ending_excess": 73.03007859990612,
                            "average_excess": 81.23296861084435,
                            "monthly_holding_cost": 2802.53741707413,
                            "cumulative_holding_cost": 961282.1773120333
                        },
                        {
                            "month": 55,
                            "starting_excess": 73.03007859990612,
                            "ending_excess": 56.624298578029645,
                            "average_excess": 64.82718858896789,
                            "monthly_holding_cost": 2236.538006319392,
                            "cumulative_holding_cost": 963518.7153183527
                        },
                        {
                            "month": 56,
                            "starting_excess": 56.624298578029645,
                            "ending_excess": 40.21851855615317,
                            "average_excess": 48.421408567091405,
                            "monthly_holding_cost": 1670.5385955646532,
                            "cumulative_holding_cost": 965189.2539139173
                        },
                        {
                            "month": 57,
                            "starting_excess": 40.21851855615317,
                            "ending_excess": 23.812738534276697,
                            "average_excess": 32.01562854521494,
                            "monthly_holding_cost": 1104.5391848099152,
                            "cumulative_holding_cost": 966293.7930987272
                        },
                        {
                            "month": 58,
                            "starting_excess": 23.812738534276697,
                            "ending_excess": 7.406958512400223,
                            "average_excess": 15.60984852333846,
                            "monthly_holding_cost": 538.5397740551768,
                            "cumulative_holding_cost": 966832.3328727824
                        },
                        {
                            "month": 59,
                            "starting_excess": 7.406958512400223,
                            "ending_excess": 0.0,
                            "average_excess": 3.7034792562001115,
                            "monthly_holding_cost": 127.77003433890384,
                            "cumulative_holding_cost": 966960.1029071213
                        }
                    ],
                    "cumulative_holding_cost": 966960.1029071213,
                    "excess_buy_cost": 5878.315684658973,
                    "total_excess_cost": 972838.4185917802
                }
            },
            "management_insights": {
                "overall_insight": "The inventory is classified as 'Excess' relative to the forecast demand. Reorder point, safety stock, and optimal order frequency were computed using a lead time of 30 days. Forecast variability is low, suggesting stable demand. However, the inventory turnover ratio indicates slow-moving inventory, which might signal an opportunity to optimize stock levels."
            },
            "alerts": {
                "stock_status_alert": "Alert: Excess Inventory - Consider reducing future orders.",
                "inventory_turnover_alert": "Alert: Low turnover ratio indicates slow-moving inventory."
            },
            "processing_info": {
                "processing_time_seconds": "0.005",
                "calculation_date": "2025-03-24",
                "note": "Fields such as reorder point, safety stock, EOQ and financial analysis are computed using the provided parameters."
            }
        },
        "prompt_utilizado": "\nVocê é um especialista em análise de inventário e supply chain. Abaixo estão os dados de um produto no formato JSON, contendo informações completas sobre o inventário, previsão de demanda, análise financeira e métricas de desempenho.\n\nCom base nesses dados, elabore um **relatório técnico e estratégico, em Inglês**, com linguagem clara e acessível para gestores e clientes não técnicos. O relatório deve ser completo e conter:\n\n1. **Detalhes do Produto**: código, nome e características relevantes.\n2. **Análise de Estoque e Cobertura**: níveis atuais de estoque, cobertura em dias e meses, giro e status (excesso ou déficit).\n3. **Análise de Demanda e Tendências**: previsão média mensal, crescimento ou queda percentual mês a mês, sazonalidades e volatilidade.\n4. **Identificação de Excesso ou Déficit de Estoque**: comparar estoque atual com demanda acumulada e apontar riscos.\n5. **Projeções de Consumo**: detalhar quando o estoque será consumido com base na demanda atual.\n6. **Indicadores de Otimização**:\n    - Ponto de Pedido (ROP)\n    - Estoque de Segurança\n    - Lote Econômico de Compra (EOQ)\n    - Frequência ideal de pedidos\n    - Giro de Estoque\n7. **Classificações do Produto**:\n    - Nível de demanda (alta, média, baixa)\n    - Rotatividade (rápida, lenta)\n    - Criticidade (alta, média, baixa)\n    - Sensibilidade da demanda (baixa, média, alta)\n8. **Análise Financeira**:\n    - Receita de vendas\n    - Lucro bruto\n    - Valor de estoque\n    - Custo do excesso de estoque (armazenagem, capital, obsolescência)\n9. **Análise Detalhada dos Custos de Excesso de Estoque**:\n    - Interprete a seção \"excess_cost_details\", detalhando o valor do excesso, o número de meses para otimização, a análise do \"monthly_breakdown\" com os custos mensais e o custo total acumulado.\n    - Explique a variação dos custos mês a mês e identifique os pontos críticos que podem impactar a gestão financeira.\n10. **Insights de Gestão e Alertas**: gerar insights de tomada de decisão com base nos dados.\n11. **Plano de Ação Estratégico em caso de Excesso de Estoque**:\n\n    Caso o produto esteja classificado como “excesso de estoque”, elabore um **plano detalhado de redução de estoque** baseado nas estratégias abaixo. Para **cada estratégia**, explique:\n    \n    - Como ela será executada na prática\n    - Em que canais pode ser aplicada (vendas diretas, e-commerce, distribuidores, etc.)\n    - Qual o impacto esperado na redução de estoque\n    - Em quanto tempo pode começar a gerar resultado\n    - Quais cuidados devem ser tomados\n    - Como mensurar o sucesso da estratégia\n\n    Estratégias:\n    \n    **1) Promoções e Descontos Progressivos**  \n    Crie campanhas com descontos escalonados por volume ou tempo. Por exemplo: 10% na primeira semana, 20% na segunda. Explique como isso acelera a saída do estoque sem prejudicar tanto a margem. Indique público-alvo, canais e forma de divulgação.\n\n    **2) Oferta “Compre Um, Leve Outro” (BOGO)**  \n    Desenvolva uma campanha do tipo “Compre 1, Leve 2” ou “Compre 2, Leve 3”. Explique como essa tática aumenta o volume vendido rapidamente e como posicionar a ação para gerar percepção de valor. Indique como controlar estoques, definir regras e prever impacto na margem.\n\n    **3) Liquidação Sazonal Estratégica**  \n    Planeje uma liquidação com base em datas promocionais ou estações (ex: início do ano fiscal, trocas de linha). Explique como embutir a ação no calendário promocional da empresa, como comunicar de forma massiva, e como evitar canibalizar vendas regulares.\n\n    **4) Venda Flash (Flash Sale)**  \n    Estruture uma campanha de “oferta-relâmpago” com duração limitada (ex: 48h) e grande apelo visual e de urgência. Indique como configurar em plataformas online, alertar clientes recorrentes e gerar tráfego com anúncios digitais. Mostre o potencial de engajamento e queima rápida do estoque.\n\nPor fim, reforce as recomendações com base nas métricas e forneça um resumo executivo com as principais ações recomendadas.\n\nDados:\n{\n    \"product_details\": {\n        \"product_code\": 38788,\n        \"product_name\": \"LUBR ACEITE AMBRA MULT-G 10W30 API GL-4\"\n    },\n    \"inventory_analysis\": {\n        \"current_stock_level\": {\n            \"closing_inventory\": 1123.0,\n            \"unit\": \"units\",\n            \"description\": \"Closing inventory used as the baseline for all calculations.\"\n        },\n        \"inventory_coverage_ratio\": {\n            \"months_of_inventory\": 68.45148469030566,\n            \"unit_months\": \"months\",\n            \"days_of_inventory\": 2053.5445407091697,\n            \"unit_days\": \"days\",\n            \"description\": \"Calculated by dividing the closing inventory by the average monthly forecast demand. Days of inventory are estimated assuming 30 days per month.\"\n        },\n        \"excess_or_shortfall_analysis\": {\n            \"cumulative_forecast_demand\": 164.05780021876473,\n            \"unit\": \"units\",\n            \"stock_status\": \"Excess\",\n            \"difference\": 958.9421997812353,\n            \"unit_difference\": \"units\",\n            \"optimal_stock_level\": 164.05780021876473,\n            \"unit_optimal\": \"units\",\n            \"description\": \"Compares current inventory against the cumulative forecast demand. Excess indicates overstock; shortfall indicates potential stock-out risk.\"\n        }\n    },\n    \"forecast_demand_analysis\": {\n        \"cumulative_forecast_demand\": 164.05780021876473,\n        \"unit\": \"units\",\n        \"average_monthly_demand\": 16.405780021876474,\n        \"unit_avg\": \"units/month\",\n        \"forecast_trends\": [\n            {\n                \"from\": \"2023-04\",\n                \"to\": \"2023-05\",\n                \"percentage_change\": 14.999999999999991,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-05\",\n                \"to\": \"2023-06\",\n                \"percentage_change\": -4.347826086956509,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-06\",\n                \"to\": \"2023-07\",\n                \"percentage_change\": -4.545454545454553,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-07\",\n                \"to\": \"2023-08\",\n                \"percentage_change\": 9.523809523809518,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-08\",\n                \"to\": \"2023-09\",\n                \"percentage_change\": -8.69565217391304,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-09\",\n                \"to\": \"2023-10\",\n                \"percentage_change\": 4.761904761904771,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-10\",\n                \"to\": \"2023-11\",\n                \"percentage_change\": 0.0,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-11\",\n                \"to\": \"2023-12\",\n                \"percentage_change\": -4.545454545454553,\n                \"unit\": \"percent\"\n            },\n            {\n                \"from\": \"2023-12\",\n                \"to\": \"2024-01\",\n                \"percentage_change\": 9.523809523809518,\n                \"unit\": \"percent\"\n            }\n        ],\n        \"average_forecast_growth_rate\": 1.8527929397494607,\n        \"unit_growth\": \"percent\",\n        \"seasonality_analysis\": {\n            \"months_above_average\": [\n                \"2023-05\",\n                \"2023-06\",\n                \"2023-08\",\n                \"2023-10\",\n                \"2023-11\",\n                \"2024-01\"\n            ],\n            \"months_below_average\": [\n                \"2023-04\",\n                \"2023-07\",\n                \"2023-09\",\n                \"2023-12\"\n            ],\n            \"description\": \"Identifies months with forecast demand above or below the average, suggesting seasonality patterns.\"\n        },\n        \"forecast_variability\": {\n            \"standard_deviation\": 0.7772393003825065,\n            \"unit_std\": \"units\",\n            \"variance\": 0.6041009300590882,\n            \"unit_variance\": \"units^2\",\n            \"coefficient_of_variation\": 0.047375943072873586,\n            \"unit_cv\": \"ratio\",\n            \"description\": \"Indicates the volatility and relative variability of the forecast demand.\"\n        },\n        \"cumulative_demand_projection\": {\n            \"cumulative_demand_by_month\": [\n                {\n                    \"yyyy-mm\": \"2023-04\",\n                    \"cumulative_demand\": 15.051174331996764\n                },\n                {\n                    \"yyyy-mm\": \"2023-05\",\n                    \"cumulative_demand\": 32.36002481379304\n                },\n                {\n                    \"yyyy-mm\": \"2023-06\",\n                    \"cumulative_demand\": 48.91631657898948\n                },\n                {\n                    \"yyyy-mm\": \"2023-07\",\n                    \"cumulative_demand\": 64.72004962758608\n                },\n                {\n                    \"yyyy-mm\": \"2023-08\",\n                    \"cumulative_demand\": 82.02890010938236\n                },\n                {\n                    \"yyyy-mm\": \"2023-09\",\n                    \"cumulative_demand\": 97.83263315797896\n                },\n                {\n                    \"yyyy-mm\": \"2023-10\",\n                    \"cumulative_demand\": 114.38892492317541\n                },\n                {\n                    \"yyyy-mm\": \"2023-11\",\n                    \"cumulative_demand\": 130.94521668837186\n                },\n                {\n                    \"yyyy-mm\": \"2023-12\",\n                    \"cumulative_demand\": 146.74894973696846\n                },\n                {\n                    \"yyyy-mm\": \"2024-01\",\n                    \"cumulative_demand\": 164.05780021876473\n                }\n            ],\n            \"exhaustion_month\": \"Not reached\",\n            \"description\": \"Projects when current inventory might be exhausted if the forecast consumption rate holds.\"\n        }\n    },\n    \"stock_optimization_and_replenishment\": {\n        \"reorder_point\": {\n            \"value\": 16.63992134544594,\n            \"unit\": \"units\",\n            \"description\": \"Reorder Point (ROP) is calculated as the average daily demand multiplied by the lead time plus safety stock. Since 'lead_time_days' is provided, these values are computed accordingly.\"\n        },\n        \"safety_stock\": {\n            \"value\": 0.23414132356946787,\n            \"unit\": \"units\",\n            \"description\": \"Safety stock is determined using forecast variability and lead time to buffer against demand surges.\"\n        },\n        \"economic_order_quantity\": {\n            \"value\": 9.685202611139799,\n            \"unit\": \"units\",\n            \"description\": \"EOQ is calculated using the formula sqrt((2 * Annual Demand * Ordering Cost) / (Annual Holding Cost)). Annual Demand is extrapolated from the forecast, Ordering Cost defaults to 100 if not provided, and Annual Holding Cost is daily_cost * 365.\"\n        },\n        \"optimal_order_frequency\": {\n            \"orders_in_forecast_period\": 9.859289404854339,\n            \"unit\": \"orders\",\n            \"description\": \"Optimal order frequency is derived by dividing the cumulative forecast demand by the reorder point.\"\n        },\n        \"inventory_turnover_ratio\": {\n            \"value\": 0.1460888692954272,\n            \"unit\": \"ratio\",\n            \"description\": \"Calculated as the cumulative forecast demand divided by the closing inventory, representing how quickly inventory cycles.\"\n        }\n    },\n    \"product_classification\": {\n        \"demand_classification\": {\n            \"value\": \"Medium Demand\",\n            \"description\": \"Classifies the product demand level based on the average monthly forecast demand.\"\n        },\n        \"turnover_classification\": {\n            \"value\": \"Slow-moving\",\n            \"description\": \"Classifies the product based on the forecast-based turnover ratio.\"\n        },\n        \"criticality\": {\n            \"value\": \"Low (Stable)\",\n            \"description\": \"Indicates the risk of stock-out if the cumulative forecast demand exceeds current inventory.\"\n        }\n    },\n    \"demand_sensitivity_analysis\": {\n        \"coefficient_of_variation\": 0.047375943072873586,\n        \"unit\": \"ratio\",\n        \"demand_sensitivity\": \"Low Sensitivity (Stable forecast)\",\n        \"description\": \"Assesses forecast sensitivity using the coefficient of variation; higher values indicate greater sensitivity.\"\n    },\n    \"additional_indicators\": {\n        \"supply_chain_risk\": {\n            \"value\": \"High\",\n            \"description\": \"Assesses potential supply chain risk based on the inventory turnover ratio; lower ratios may indicate obsolescence risk.\"\n        },\n        \"stock_out_risk\": {\n            \"value\": \"Low\",\n            \"description\": \"Indicates the risk of stock-out based on current inventory versus forecast consumption.\"\n        }\n    },\n    \"financial_analysis\": {\n        \"sales_revenue\": 12.45,\n        \"sales_profit\": 2.12,\n        \"buy_cost\": 6.13,\n        \"profit_margin_percent\": 17.0281124497992,\n        \"inventory_value\": 6883.99,\n        \"sales_to_inventory_ratio\": 0.0018085441727835165,\n        \"excess_cost_details\": {\n            \"excess_quantity\": 958.9421997812353,\n            \"months_to_optimize\": 59,\n            \"monthly_breakdown\": [\n                {\n                    \"month\": 1,\n                    \"starting_excess\": 958.9421997812353,\n                    \"ending_excess\": 942.5364197593589,\n                    \"average_excess\": 950.739309770297,\n                    \"monthly_holding_cost\": 32800.50618707525,\n                    \"cumulative_holding_cost\": 32800.50618707525\n                },\n                {\n                    \"month\": 2,\n                    \"starting_excess\": 942.5364197593589,\n                    \"ending_excess\": 926.1306397374824,\n                    \"average_excess\": 934.3335297484207,\n                    \"monthly_holding_cost\": 32234.506776320515,\n                    \"cumulative_holding_cost\": 65035.01296339576\n                },\n                {\n                    \"month\": 3,\n                    \"starting_excess\": 926.1306397374824,\n                    \"ending_excess\": 909.7248597156059,\n                    \"average_excess\": 917.9277497265441,\n                    \"monthly_holding_cost\": 31668.507365565772,\n                    \"cumulative_holding_cost\": 96703.52032896153\n                },\n                {\n                    \"month\": 4,\n                    \"starting_excess\": 909.7248597156059,\n                    \"ending_excess\": 893.3190796937295,\n                    \"average_excess\": 901.5219697046678,\n                    \"monthly_holding_cost\": 31102.507954811037,\n                    \"cumulative_holding_cost\": 127806.02828377257\n                },\n                {\n                    \"month\": 5,\n                    \"starting_excess\": 893.3190796937295,\n                    \"ending_excess\": 876.913299671853,\n                    \"average_excess\": 885.1161896827912,\n                    \"monthly_holding_cost\": 30536.508544056294,\n                    \"cumulative_holding_cost\": 158342.53682782885\n                },\n                {\n                    \"month\": 6,\n                    \"starting_excess\": 876.913299671853,\n                    \"ending_excess\": 860.5075196499765,\n                    \"average_excess\": 868.7104096609148,\n                    \"monthly_holding_cost\": 29970.50913330156,\n                    \"cumulative_holding_cost\": 188313.0459611304\n                },\n                {\n                    \"month\": 7,\n                    \"starting_excess\": 860.5075196499765,\n                    \"ending_excess\": 844.1017396281001,\n                    \"average_excess\": 852.3046296390382,\n                    \"monthly_holding_cost\": 29404.509722546816,\n                    \"cumulative_holding_cost\": 217717.55568367723\n                },\n                {\n                    \"month\": 8,\n                    \"starting_excess\": 844.1017396281001,\n                    \"ending_excess\": 827.6959596062236,\n                    \"average_excess\": 835.8988496171619,\n                    \"monthly_holding_cost\": 28838.51031179208,\n                    \"cumulative_holding_cost\": 246556.0659954693\n                },\n                {\n                    \"month\": 9,\n                    \"starting_excess\": 827.6959596062236,\n                    \"ending_excess\": 811.2901795843471,\n                    \"average_excess\": 819.4930695952853,\n                    \"monthly_holding_cost\": 28272.51090103734,\n                    \"cumulative_holding_cost\": 274828.57689650665\n                },\n                {\n                    \"month\": 10,\n                    \"starting_excess\": 811.2901795843471,\n                    \"ending_excess\": 794.8843995624707,\n                    \"average_excess\": 803.087289573409,\n                    \"monthly_holding_cost\": 27706.511490282606,\n                    \"cumulative_holding_cost\": 302535.08838678926\n                },\n                {\n                    \"month\": 11,\n                    \"starting_excess\": 794.8843995624707,\n                    \"ending_excess\": 778.4786195405942,\n                    \"average_excess\": 786.6815095515324,\n                    \"monthly_holding_cost\": 27140.512079527864,\n                    \"cumulative_holding_cost\": 329675.60046631715\n                },\n                {\n                    \"month\": 12,\n                    \"starting_excess\": 778.4786195405942,\n                    \"ending_excess\": 762.0728395187177,\n                    \"average_excess\": 770.275729529656,\n                    \"monthly_holding_cost\": 26574.51266877313,\n                    \"cumulative_holding_cost\": 356250.1131350903\n                },\n                {\n                    \"month\": 13,\n                    \"starting_excess\": 762.0728395187177,\n                    \"ending_excess\": 745.6670594968413,\n                    \"average_excess\": 753.8699495077794,\n                    \"monthly_holding_cost\": 26008.51325801839,\n                    \"cumulative_holding_cost\": 382258.6263931087\n                },\n                {\n                    \"month\": 14,\n                    \"starting_excess\": 745.6670594968413,\n                    \"ending_excess\": 729.2612794749648,\n                    \"average_excess\": 737.4641694859031,\n                    \"monthly_holding_cost\": 25442.513847263654,\n                    \"cumulative_holding_cost\": 407701.14024037233\n                },\n                {\n                    \"month\": 15,\n                    \"starting_excess\": 729.2612794749648,\n                    \"ending_excess\": 712.8554994530883,\n                    \"average_excess\": 721.0583894640265,\n                    \"monthly_holding_cost\": 24876.514436508915,\n                    \"cumulative_holding_cost\": 432577.65467688127\n                },\n                {\n                    \"month\": 16,\n                    \"starting_excess\": 712.8554994530883,\n                    \"ending_excess\": 696.4497194312119,\n                    \"average_excess\": 704.6526094421502,\n                    \"monthly_holding_cost\": 24310.51502575418,\n                    \"cumulative_holding_cost\": 456888.16970263544\n                },\n                {\n                    \"month\": 17,\n                    \"starting_excess\": 696.4497194312119,\n                    \"ending_excess\": 680.0439394093354,\n                    \"average_excess\": 688.2468294202736,\n                    \"monthly_holding_cost\": 23744.515614999436,\n                    \"cumulative_holding_cost\": 480632.6853176349\n                },\n                {\n                    \"month\": 18,\n                    \"starting_excess\": 680.0439394093354,\n                    \"ending_excess\": 663.6381593874589,\n                    \"average_excess\": 671.8410493983972,\n                    \"monthly_holding_cost\": 23178.516204244705,\n                    \"cumulative_holding_cost\": 503811.2015218796\n                },\n                {\n                    \"month\": 19,\n                    \"starting_excess\": 663.6381593874589,\n                    \"ending_excess\": 647.2323793655825,\n                    \"average_excess\": 655.4352693765206,\n                    \"monthly_holding_cost\": 22612.516793489962,\n                    \"cumulative_holding_cost\": 526423.7183153696\n                },\n                {\n                    \"month\": 20,\n                    \"starting_excess\": 647.2323793655825,\n                    \"ending_excess\": 630.826599343706,\n                    \"average_excess\": 639.0294893546443,\n                    \"monthly_holding_cost\": 22046.517382735226,\n                    \"cumulative_holding_cost\": 548470.2356981048\n                },\n                {\n                    \"month\": 21,\n                    \"starting_excess\": 630.826599343706,\n                    \"ending_excess\": 614.4208193218295,\n                    \"average_excess\": 622.6237093327677,\n                    \"monthly_holding_cost\": 21480.517971980487,\n                    \"cumulative_holding_cost\": 569950.7536700853\n                },\n                {\n                    \"month\": 22,\n                    \"starting_excess\": 614.4208193218295,\n                    \"ending_excess\": 598.0150392999531,\n                    \"average_excess\": 606.2179293108913,\n                    \"monthly_holding_cost\": 20914.518561225752,\n                    \"cumulative_holding_cost\": 590865.2722313111\n                },\n                {\n                    \"month\": 23,\n                    \"starting_excess\": 598.0150392999531,\n                    \"ending_excess\": 581.6092592780766,\n                    \"average_excess\": 589.8121492890148,\n                    \"monthly_holding_cost\": 20348.519150471006,\n                    \"cumulative_holding_cost\": 611213.791381782\n                },\n                {\n                    \"month\": 24,\n                    \"starting_excess\": 581.6092592780766,\n                    \"ending_excess\": 565.2034792562001,\n                    \"average_excess\": 573.4063692671384,\n                    \"monthly_holding_cost\": 19782.519739716274,\n                    \"cumulative_holding_cost\": 630996.3111214984\n                },\n                {\n                    \"month\": 25,\n                    \"starting_excess\": 565.2034792562001,\n                    \"ending_excess\": 548.7976992343237,\n                    \"average_excess\": 557.0005892452618,\n                    \"monthly_holding_cost\": 19216.52032896153,\n                    \"cumulative_holding_cost\": 650212.8314504599\n                },\n                {\n                    \"month\": 26,\n                    \"starting_excess\": 548.7976992343237,\n                    \"ending_excess\": 532.3919192124472,\n                    \"average_excess\": 540.5948092233855,\n                    \"monthly_holding_cost\": 18650.520918206796,\n                    \"cumulative_holding_cost\": 668863.3523686667\n                },\n                {\n                    \"month\": 27,\n                    \"starting_excess\": 532.3919192124472,\n                    \"ending_excess\": 515.9861391905707,\n                    \"average_excess\": 524.1890292015089,\n                    \"monthly_holding_cost\": 18084.521507452053,\n                    \"cumulative_holding_cost\": 686947.8738761187\n                },\n                {\n                    \"month\": 28,\n                    \"starting_excess\": 515.9861391905707,\n                    \"ending_excess\": 499.58035916869426,\n                    \"average_excess\": 507.7832491796325,\n                    \"monthly_holding_cost\": 17518.52209669732,\n                    \"cumulative_holding_cost\": 704466.395972816\n                },\n                {\n                    \"month\": 29,\n                    \"starting_excess\": 499.58035916869426,\n                    \"ending_excess\": 483.1745791468178,\n                    \"average_excess\": 491.377469157756,\n                    \"monthly_holding_cost\": 16952.522685942582,\n                    \"cumulative_holding_cost\": 721418.9186587586\n                },\n                {\n                    \"month\": 30,\n                    \"starting_excess\": 483.1745791468178,\n                    \"ending_excess\": 466.7687991249413,\n                    \"average_excess\": 474.97168913587956,\n                    \"monthly_holding_cost\": 16386.523275187843,\n                    \"cumulative_holding_cost\": 737805.4419339465\n                },\n                {\n                    \"month\": 31,\n                    \"starting_excess\": 466.7687991249413,\n                    \"ending_excess\": 450.36301910306486,\n                    \"average_excess\": 458.5659091140031,\n                    \"monthly_holding_cost\": 15820.523864433106,\n                    \"cumulative_holding_cost\": 753625.9657983795\n                },\n                {\n                    \"month\": 32,\n                    \"starting_excess\": 450.36301910306486,\n                    \"ending_excess\": 433.9572390811884,\n                    \"average_excess\": 442.1601290921266,\n                    \"monthly_holding_cost\": 15254.524453678367,\n                    \"cumulative_holding_cost\": 768880.4902520579\n                },\n                {\n                    \"month\": 33,\n                    \"starting_excess\": 433.9572390811884,\n                    \"ending_excess\": 417.5514590593119,\n                    \"average_excess\": 425.75434907025016,\n                    \"monthly_holding_cost\": 14688.52504292363,\n                    \"cumulative_holding_cost\": 783569.0152949815\n                },\n                {\n                    \"month\": 34,\n                    \"starting_excess\": 417.5514590593119,\n                    \"ending_excess\": 401.14567903743546,\n                    \"average_excess\": 409.3485690483737,\n                    \"monthly_holding_cost\": 14122.52563216889,\n                    \"cumulative_holding_cost\": 797691.5409271504\n                },\n                {\n                    \"month\": 35,\n                    \"starting_excess\": 401.14567903743546,\n                    \"ending_excess\": 384.739899015559,\n                    \"average_excess\": 392.9427890264972,\n                    \"monthly_holding_cost\": 13556.526221414153,\n                    \"cumulative_holding_cost\": 811248.0671485645\n                },\n                {\n                    \"month\": 36,\n                    \"starting_excess\": 384.739899015559,\n                    \"ending_excess\": 368.3341189936825,\n                    \"average_excess\": 376.53700900462076,\n                    \"monthly_holding_cost\": 12990.526810659416,\n                    \"cumulative_holding_cost\": 824238.593959224\n                },\n                {\n                    \"month\": 37,\n                    \"starting_excess\": 368.3341189936825,\n                    \"ending_excess\": 351.92833897180606,\n                    \"average_excess\": 360.1312289827443,\n                    \"monthly_holding_cost\": 12424.527399904677,\n                    \"cumulative_holding_cost\": 836663.1213591286\n                },\n                {\n                    \"month\": 38,\n                    \"starting_excess\": 351.92833897180606,\n                    \"ending_excess\": 335.5225589499296,\n                    \"average_excess\": 343.7254489608678,\n                    \"monthly_holding_cost\": 11858.52798914994,\n                    \"cumulative_holding_cost\": 848521.6493482785\n                },\n                {\n                    \"month\": 39,\n                    \"starting_excess\": 335.5225589499296,\n                    \"ending_excess\": 319.1167789280531,\n                    \"average_excess\": 327.31966893899136,\n                    \"monthly_holding_cost\": 11292.5285783952,\n                    \"cumulative_holding_cost\": 859814.1779266738\n                },\n                {\n                    \"month\": 40,\n                    \"starting_excess\": 319.1167789280531,\n                    \"ending_excess\": 302.71099890617666,\n                    \"average_excess\": 310.9138889171149,\n                    \"monthly_holding_cost\": 10726.529167640463,\n                    \"cumulative_holding_cost\": 870540.7070943143\n                },\n                {\n                    \"month\": 41,\n                    \"starting_excess\": 302.71099890617666,\n                    \"ending_excess\": 286.3052188843002,\n                    \"average_excess\": 294.5081088952384,\n                    \"monthly_holding_cost\": 10160.529756885726,\n                    \"cumulative_holding_cost\": 880701.2368512\n                },\n                {\n                    \"month\": 42,\n                    \"starting_excess\": 286.3052188843002,\n                    \"ending_excess\": 269.8994388624237,\n                    \"average_excess\": 278.10232887336196,\n                    \"monthly_holding_cost\": 9594.530346130987,\n                    \"cumulative_holding_cost\": 890295.767197331\n                },\n                {\n                    \"month\": 43,\n                    \"starting_excess\": 269.8994388624237,\n                    \"ending_excess\": 253.49365884054725,\n                    \"average_excess\": 261.6965488514855,\n                    \"monthly_holding_cost\": 9028.53093537625,\n                    \"cumulative_holding_cost\": 899324.2981327072\n                },\n                {\n                    \"month\": 44,\n                    \"starting_excess\": 253.49365884054725,\n                    \"ending_excess\": 237.0878788186708,\n                    \"average_excess\": 245.29076882960902,\n                    \"monthly_holding_cost\": 8462.53152462151,\n                    \"cumulative_holding_cost\": 907786.8296573288\n                },\n                {\n                    \"month\": 45,\n                    \"starting_excess\": 237.0878788186708,\n                    \"ending_excess\": 220.68209879679432,\n                    \"average_excess\": 228.88498880773255,\n                    \"monthly_holding_cost\": 7896.532113866771,\n                    \"cumulative_holding_cost\": 915683.3617711955\n                },\n                {\n                    \"month\": 46,\n                    \"starting_excess\": 220.68209879679432,\n                    \"ending_excess\": 204.27631877491785,\n                    \"average_excess\": 212.4792087858561,\n                    \"monthly_holding_cost\": 7330.532703112035,\n                    \"cumulative_holding_cost\": 923013.8944743075\n                },\n                {\n                    \"month\": 47,\n                    \"starting_excess\": 204.27631877491785,\n                    \"ending_excess\": 187.8705387530414,\n                    \"average_excess\": 196.07342876397962,\n                    \"monthly_holding_cost\": 6764.533292357296,\n                    \"cumulative_holding_cost\": 929778.4277666649\n                },\n                {\n                    \"month\": 48,\n                    \"starting_excess\": 187.8705387530414,\n                    \"ending_excess\": 171.46475873116492,\n                    \"average_excess\": 179.66764874210315,\n                    \"monthly_holding_cost\": 6198.533881602558,\n                    \"cumulative_holding_cost\": 935976.9616482675\n                },\n                {\n                    \"month\": 49,\n                    \"starting_excess\": 171.46475873116492,\n                    \"ending_excess\": 155.05897870928845,\n                    \"average_excess\": 163.2618687202267,\n                    \"monthly_holding_cost\": 5632.534470847821,\n                    \"cumulative_holding_cost\": 941609.4961191153\n                },\n                {\n                    \"month\": 50,\n                    \"starting_excess\": 155.05897870928845,\n                    \"ending_excess\": 138.653198687412,\n                    \"average_excess\": 146.85608869835022,\n                    \"monthly_holding_cost\": 5066.535060093082,\n                    \"cumulative_holding_cost\": 946676.0311792083\n                },\n                {\n                    \"month\": 51,\n                    \"starting_excess\": 138.653198687412,\n                    \"ending_excess\": 122.24741866553552,\n                    \"average_excess\": 130.45030867647375,\n                    \"monthly_holding_cost\": 4500.535649338344,\n                    \"cumulative_holding_cost\": 951176.5668285467\n                },\n                {\n                    \"month\": 52,\n                    \"starting_excess\": 122.24741866553552,\n                    \"ending_excess\": 105.84163864365905,\n                    \"average_excess\": 114.04452865459729,\n                    \"monthly_holding_cost\": 3934.536238583606,\n                    \"cumulative_holding_cost\": 955111.1030671303\n                },\n                {\n                    \"month\": 53,\n                    \"starting_excess\": 105.84163864365905,\n                    \"ending_excess\": 89.43585862178259,\n                    \"average_excess\": 97.63874863272082,\n                    \"monthly_holding_cost\": 3368.536827828868,\n                    \"cumulative_holding_cost\": 958479.6398949592\n                },\n                {\n                    \"month\": 54,\n                    \"starting_excess\": 89.43585862178259,\n                    \"ending_excess\": 73.03007859990612,\n                    \"average_excess\": 81.23296861084435,\n                    \"monthly_holding_cost\": 2802.53741707413,\n                    \"cumulative_holding_cost\": 961282.1773120333\n                },\n                {\n                    \"month\": 55,\n                    \"starting_excess\": 73.03007859990612,\n                    \"ending_excess\": 56.624298578029645,\n                    \"average_excess\": 64.82718858896789,\n                    \"monthly_holding_cost\": 2236.538006319392,\n                    \"cumulative_holding_cost\": 963518.7153183527\n                },\n                {\n                    \"month\": 56,\n                    \"starting_excess\": 56.624298578029645,\n                    \"ending_excess\": 40.21851855615317,\n                    \"average_excess\": 48.421408567091405,\n                    \"monthly_holding_cost\": 1670.5385955646532,\n                    \"cumulative_holding_cost\": 965189.2539139173\n                },\n                {\n                    \"month\": 57,\n                    \"starting_excess\": 40.21851855615317,\n                    \"ending_excess\": 23.812738534276697,\n                    \"average_excess\": 32.01562854521494,\n                    \"monthly_holding_cost\": 1104.5391848099152,\n                    \"cumulative_holding_cost\": 966293.7930987272\n                },\n                {\n                    \"month\": 58,\n                    \"starting_excess\": 23.812738534276697,\n                    \"ending_excess\": 7.406958512400223,\n                    \"average_excess\": 15.60984852333846,\n                    \"monthly_holding_cost\": 538.5397740551768,\n                    \"cumulative_holding_cost\": 966832.3328727824\n                },\n                {\n                    \"month\": 59,\n                    \"starting_excess\": 7.406958512400223,\n                    \"ending_excess\": 0.0,\n                    \"average_excess\": 3.7034792562001115,\n                    \"monthly_holding_cost\": 127.77003433890384,\n                    \"cumulative_holding_cost\": 966960.1029071213\n                }\n            ],\n            \"cumulative_holding_cost\": 966960.1029071213,\n            \"excess_buy_cost\": 5878.315684658973,\n            \"total_excess_cost\": 972838.4185917802\n        }\n    },\n    \"management_insights\": {\n        \"overall_insight\": \"The inventory is classified as 'Excess' relative to the forecast demand. Reorder point, safety stock, and optimal order frequency were computed using a lead time of 30 days. Forecast variability is low, suggesting stable demand. However, the inventory turnover ratio indicates slow-moving inventory, which might signal an opportunity to optimize stock levels.\"\n    },\n    \"alerts\": {\n        \"stock_status_alert\": \"Alert: Excess Inventory - Consider reducing future orders.\",\n        \"inventory_turnover_alert\": \"Alert: Low turnover ratio indicates slow-moving inventory.\"\n    },\n    \"processing_info\": {\n        \"processing_time_seconds\": \"0.005\",\n        \"calculation_date\": \"2025-03-24\",\n        \"note\": \"Fields such as reorder point, safety stock, EOQ and financial analysis are computed using the provided parameters.\"\n    }\n}\n\n<!-- NONCE: cba04f3d-c7e2-40c0-a1a9-3a43f95eec61 -->"
    },
    "request": {
        "model": "o3-mini-2025-01-31",
        "max_completion_tokens": 15000
    },
    "response": {
        "report_text": "Below is the technical and strategic report for the product “LUBR ACEITE AMBRA MULT-G 10W30 API GL-4” (code 38788):\n\n──────────────────────────────\n1. PRODUCT DETAILS\n\n• Product Code: 38788  \n• Product Name: LUBR ACEITE AMBRA MULT-G 10W30 API GL-4  \n• Key Characteristics:  \n – It is an industrial lubricant used for engine and mechanical applications.  \n – The product parameters (viscosity grade, API classification) ensure compliance with industry standards.\n\n──────────────────────────────\n2. STOCK AND COVERAGE ANALYSIS\n\n• Current Stock Levels:  \n – Closing inventory stands at 1123 units.  \n• Inventory Coverage:  \n – The stock represents approximately 68.45 months of inventory coverage or 2053.54 days when compared to the monthly forecast.  \n• Inventory Turn:  \n – The calculated turnover ratio is 0.146 (cumulative forecast demand divided by closing inventory), suggesting that the inventory is cycling very slowly.  \n• Stock Status:  \n – Comparison of current stock (1123 units) with a cumulative forecast demand of roughly 164 units indicates an excess inventory situation (more than 958 extra units).\n\n──────────────────────────────\n3. DEMAND ANALYSIS AND TRENDS\n\n• Forecast Demand:  \n – The average monthly demand is approximately 16.41 units and the cumulative forecast demand for the period is about 164 units.  \n• Month-to-Month Trends:  \n – There are fluctuations with increases (e.g., +15% from April to May, +9.52% in selected months) and decreases (for instance, around –4.35% to –8.70% in other months).  \n• Seasonality & Volatility:  \n – Several months (May, June, August, October, November, January) record demand above average, whereas other months (April, July, September, December) remain below average.  \n – Forecast variability is low (coefficient of variation of approximately 0.047), suggesting demand stability.\n\n──────────────────────────────\n4. EXCESS OR DEFICIT OF STOCK\n\n• Comparison with Demand:  \n – With a current inventory of 1123 units versus a cumulative forecast demand of 164 units, there is an excess of approximately 959 units.  \n• Risk Implications:  \n – Excess inventory brings risks including high holding costs, potential obsolescence, and increased storage and capital costs.\n\n──────────────────────────────\n5. PROJECTIONS OF INVENTORY CONSUMPTION\n\n• Forecasted Consumption:  \n – The cumulative demand projection shows a gradual increase month by month. However, with the current stock level, the inventory is far from being consumed, and the “exhaustion_month” remains “Not reached.”  \n• Implication:  \n – If the current low consumption rate continues, the existing stock will remain unsold for a significant period, compounding holding and capital costs.\n\n──────────────────────────────\n6. OPTIMIZATION INDICATORS\n\n• Reorder Point (ROP):  \n – Calculated at approximately 16.64 units (based on average demand, lead time, and safety stock considerations).  \n• Safety Stock:  \n – Very low at approximately 0.234 units, due to the low forecast variability and stable demand.  \n• Economic Order Quantity (EOQ):  \n – Approximately 9.69 units, calculated by standard inventory formulas (considering ordering and holding costs).  \n• Optimal Order Frequency:  \n – About 9.86 orders during the forecast period, meaning orders should be placed roughly 10 times over the period rather than in one bulk order.  \n• Inventory Turnover Ratio:  \n – A low turnover of 0.146 indicates the product is slow-moving relative to its high stock level.\n\n──────────────────────────────\n7. PRODUCT CLASSIFICATIONS\n\n• Demand Level:  \n – Classified as “Medium Demand” based on the average monthly forecast.  \n• Turnover:  \n – “Slow-moving,” as reflected by the low turnover ratio and extended coverage period.  \n• Criticality:  \n – Rated as “Low (Stable)” in terms of risk for stock-out, given the excess inventory relative to forecast.  \n• Demand Sensitivity:  \n – “Low Sensitivity,” thanks to a stable forecast with minimal variability.\n\n──────────────────────────────\n8. FINANCIAL ANALYSIS\n\n• Sales Revenue and Profitability:  \n – Sales revenue is reported at 12.45 (currency unspecified) with a sales profit of 2.12.  \n – This results in a profit margin of approximately 17.03%.  \n• Inventory Value:  \n – Standing at 6883.99, which suggests that a significant capital is tied up in this product.  \n• Sales-to-Inventory Ratio:  \n – Extremely low (0.00181), reinforcing the concern of slow-moving inventory.  \n• Excess Stock Cost:  \n – The excess inventory cost includes costs of warehousing, capital investment, and potential obsolescence which compound over time.\n\n──────────────────────────────\n9. DETAILED COST ANALYSIS OF EXCESS INVENTORY\n\n• Overview of Excess Costs:  \n – The current excess quantity is around 959 units, with the model projecting roughly 59 months needed for optimization at present consumption rates.  \n• Monthly Breakdown:  \n – The monthly breakdown details a reduction in excess units month over month accompanied by monthly holding costs. For example, in Month 1, holding cost is around 32,800; Month 2 is around 32,235; with gradually declining excess levels as the months progress.  \n• Cost Trend and Critical Points:  \n – As months advance, monthly holding costs gradually decline, but the cumulative holding cost reaches nearly 966,960 over 59 months.  \n – Key critical points include the early months where holding costs are highest per unit of excess, and a potential risk that if demand does not pick up, this capital continues to tie up resources and inflate storage costs.  \n – Moreover, even though the cost per month decreases as inventory depletes slowly, the aggregated impact is significant and financially unsustainable if not addressed.\n\n──────────────────────────────\n10. MANAGEMENT INSIGHTS AND ALERTS\n\n• Insights:  \n – The overall insight is that the product is in “Excess Inventory” territory, with a very slow turnover ratio highlighting the need for strategic reductions.  \n – Forecast demand is stable; hence, the decline in turnover is mainly due to overstocking rather than a market downturn.  \n• Alerts:  \n – “Excess Inventory – Consider reducing future orders”  \n – “Low turnover ratio indicates slow-moving inventory”\n• Implication for Decision Makers:  \n – Immediate actions are recommended to prevent further capital lock-up and rising holding costs while aligning the inventory levels with actual demand.\n\n──────────────────────────────\n11. STRATEGIC ACTION PLAN FOR STOCK REDUCTION\n\nGiven the clear “excess inventory” classification, the following strategies are proposed:\n\nA. Promotions and Progressive Discounts\n\n • Execution:  \n  – Launch promotions with tiered discounts (e.g., 10% off during the first week, escalating to 20% off in the second week) to stimulate rapid sales.  \n • Channels:  \n  – Can be applied across direct sales, e-commerce platforms, and distributor networks.  \n • Impact:  \n  – Expected to accelerate inventory turnover by increasing sales volume while managing margin reductions over time.  \n • Timeline:  \n  – Results may begin within 2–4 weeks as customers respond to increasing discounts.  \n • Precautions:  \n  – Monitor margin impacts closely to ensure the discount strategy does not erode overall profitability excessively.  \n • Metrics:  \n  – Success can be measured by tracking the reduction in inventory levels, increased order volumes, and margin performance.\n\nB. “Buy One, Get One” (BOGO) Offers\n\n • Execution:  \n  – Design a BOGO campaign such as “Buy 1, Get 1 Free” or “Buy 2, Get 1 Free” to quickly boost sales volume.  \n • Channels:  \n  – Effective on online stores, retail promotions, and through established distributor channels.  \n • Impact:  \n  – This tactic not only moves more stock but improves customer perception by delivering an immediate added value.  \n • Timeline:  \n  – A flash campaign over 1–2 weeks can trigger immediate uptake.  \n • Precautions:  \n  – Careful control is required regarding stock availability and clear communication about campaign terms to prevent stock-outs of other products.  \n • Metrics:  \n  – Evaluate success by assessing the sales uplift and tracking redemption rates of the offer.\n\nC. Strategic Seasonal Liquidation\n\n • Execution:  \n  – Schedule a clearance sale aligned with key promotional calendar dates (such as fiscal year end or seasonal transitions).  \n • Channels:  \n  – Utilize mass marketing channels including email campaigns, social media, and in-store promotions.  \n • Impact:  \n  – Expect to stimulate a surge in orders with planned reductions in excess inventory without disrupting the regular pricing structure during off-promotional periods.  \n • Timeline:  \n  – Results should be observable within the specific season or promotional period (e.g., a month-long event).  \n • Precautions:  \n  – Ensure that regular sales do not suffer through proper segmentation and timing of the clearance compared to standard offerings.  \n • Metrics:  \n  – Success is measured by the volume sold during the liquidation period and the resulting reduction in excess holding costs.\n\nD. Flash Sale Strategy\n\n • Execution:  \n  – Organize a flash sale event lasting 48 hours featuring deep discounts and an urgency message (e.g., “limited time only”) to drive rapid purchases.  \n • Channels:  \n  – Focus on digital platforms (company website, social media, mobile apps) and send notifications to existing customer databases.  \n • Impact:  \n  – This tactic can produce a quick spike in orders and rapidly decrease stock levels in a compressed time frame.  \n • Timeline:  \n  – Immediate results are expected within the 48-hour period and shortly thereafter.  \n • Precautions:  \n  – Monitor site performance and inventory levels in real time to ensure the promotion does not create logistical issues or oversell.  \n • Metrics:  \n  – Key performance indicators include website traffic spikes, conversion rates during the sale, and post-sale inventory reduction.\n\n──────────────────────────────\nExecutive Summary & Recommendations\n\n• The product “LUBR ACEITE AMBRA MULT-G 10W30 API GL-4” is currently burdened by over 1123 units in stock against a monthly forecast demand of just 16.41 units, resulting in an excess of nearly 959 units.  \n• The coverage period (68+ months) and very low inventory turnover ratio indicate potential liquidity and obsolescence risks, which are further compounded by substantial cumulative holding costs.  \n• Demand forecasts are stable; hence, the main challenge lies in aligning the inventory levels with actual consumption by:\n\n – Implementing aggressive promotional strategies (progressive discounts, BOGO, seasonal liquidation, and flash sales)  \n – Monitoring the financial impact through monthly KPI reviews (sales volume, margins, and inventory holdings)  \n – Adjusting purchase and ordering strategies (reviewing reorder point and EOQ calculations) to prevent recurrence of overstock situations  \n – Using targeted, cross-channel marketing to improve inventory turnover without severely affecting profit margins.\n\nManagers and clients are advised to prioritize a rapid reduction in excess inventory to free up capital, reduce holding costs, and maintain overall supply chain efficiency. The action plan provided should be executed in phases with clear tracking of performance metrics to ensure the effectiveness of the interventions.\n\n──────────────────────────────\nEnd of Report\n\nThis comprehensive assessment should provide clarity on current risks and actionable strategies that align with both inventory optimization and financial health objectives.",
        "usage": {
            "prompt_tokens": 8604,
            "completion_tokens": 2567,
            "total_tokens": 11171
        },
        "total_cost_usd": 0.020759200000000002
    },
    "processing_info": {
        "execution_time_seconds": 24.0562424659729,
        "openai_processing_time_seconds": 24.055137634277344
    },
    "credit_info": {
        "credit_before": {
            "credit_before": "N/A",
            "credit_after": "N/A",
            "balance": "N/A"
        },
        "credit_after": {
            "credit_before": "N/A",
            "credit_after": "N/A",
            "balance": "N/A"
        },
        "balance": "N/A"
    }
}
```

---

`response.report_text` is a Markdown-friendly block covering 11 sections:

1. Product details
2. Stock & coverage analysis
3. Demand & trends
4. Excess/deficit evaluation
5. Consumption projection
6. Optimization indicators (ROP, EOQ, etc.)
7. Product classifications
8. Financial analysis
9. Cost of excess inventory — monthly breakdown & cumulative
10. Management insights & alerts
11. Action plan with four tactical levers (Progressive Discounts, BOGO, Seasonal Liquidation, Flash Sale)

---

## Interpreting the sample

| Insight               | Sample value   | What it means                                     |
|---------------------- |----------------|-------------------------------------------------- |
| **Coverage**          | 68.4 months    | 5.6 years of stock ⇒ urgent reduction needed     |
| **Turnover ratio**    | 0.146          | Very slow-moving SKU                              |
| **Excess quantity**   | 958 u          | Equals 86 × monthly demand                        |
| **Cum. holding cost** | ≈ $967 k over 59 mo | Hidden drain on working capital              |
| **Action plan KPIs**  | timeline 2–4 wk results | Clear, measurable playbook               |

---

## Next steps

1. `Schedule` a monthly automation to re-run this endpoint and track how “excess quantity” shrinks.
2. `Embed` the `report_text` directly into PowerPoint via your BI pipeline.
3. `Trigger` promotional workflows automatically when `stock_status_alert` = "Excess".

---

# 4.4.4 /api/v1/ai/nlp_analisys_en

**Turn raw SKU data into an executive-ready sales & inventory report**

### Purpose 
Send one JSON with purchases + sales + stock and get back a polished English report (insights / recommendations / next steps) ready to copy-paste.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/nlp_analisys_en
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### What problem this route solves

| **Stakeholder pain-point**                                        | **What you get from the endpoint**                                                                                               |
|------------------------------------------------------------------ |--------------------------------------------------------------------------------------------------------------------------------- |
| Analysts spend hours building SKU performance write-ups           | `response.report_text` → multi-section report (inventory, unit economics, channel & regional sales, patterns, recs, next steps). |
| Need to justify inventory levels                                  | Section *Product & Inventory Overview* flags whether stock > safety / ROP.                                                       |
| Sales & ops teams need single source for channel vs region splits | Report highlights discrepancies and calls out alignment actions.                                                                 |
| Execs want actionable steps not raw data                          | Built-in *Recommendations and Next Steps* lists.                                                                                 |

---

### Payload reference

| **Path**               | **Type**       | **Required** | **Notes**                                                                 |
|------------------------|----------------|--------------|---------------------------------------------------------------------------|
| `product_code`         | string/number  | ✔︎           | Echoed in report header.                                                  |
| `product_name`         | string         | ✔︎           |                                                                           |
| `category`             | string         | ✔︎           |                                                                           |
| `uom`                  | string         | ✔︎           |                                                                           |
| `inventory_snapshot`   | object         | ✔︎           | Needs `current_stock_units`, `safety_stock_units`, `reorder_point_units`. |
| `unit_economics`       | object         | ✔︎           | Requires `unit_cost`, `unit_price`.                                       |
| `purchases[]`          | array          | ✱            | Purchase history (date, qty, supplier) enhances the purchasing section.   |
| `returns[]`            | array          | ✱            | Return analysis shown if supplied.                                        |
| `channel_sales_units`  | object         | ✱            | Breaks down sales by channel (e-commerce, retail, etc.).                  |
| `regional_sales_units` | object         | ✱            | Breaks down sales by world region.                                        |
| `daily_sales_history[]`| array          | ✱            | Use as many days as you have; the LLM summarises patterns automatically.  |
| `metadata`             | object         | ✱            | Echoed back for traceability (prep timestamp, source system).             |

 ✱ = optional but highly recommended for a richer report.

---

**Shortcut:** dump the same JSON you already generate for your BI dashboard—the model ignores fields it doesn’t recognise.

---

### Request

```json
{
  "product_code": 56421,
  "product_name": "Smart LED Bulb 9 W – Wi‑Fi (E27)",
  "category": "Lighting > Smart Home",
  "uom": "unit",

  "inventory_snapshot": {
    "snapshot_date": "2024-03-31",
    "current_stock_units": 780,
    "safety_stock_units": 300,
    "reorder_point_units": 450
  },

  "unit_economics": {
    "unit_cost": 2.65,
    "unit_price": 6.90,
    "currency": "USD"
  },

  "purchases": [
    { "purchase_date": "2024-01-08", "quantity": 1000, "supplier": "LumiTech Ltd." },
    { "purchase_date": "2024-02-12", "quantity": 900,  "supplier": "LumiTech Ltd." },
    { "purchase_date": "2024-03-15", "quantity": 850,  "supplier": "BrightSource Inc." }
  ],

  "returns": [
    { "return_date": "2024-02-27", "quantity": 19, "reason": "Factory defect" },
    { "return_date": "2024-03-18", "quantity": 11, "reason": "Buyer remorse" }
  ],

  "channel_sales_units": {
    "ecommerce": 2460,
    "retail_stores": 890,
    "marketplace": 610,
    "wholesale": 430
  },

  "regional_sales_units": {
    "north_america": 1820,
    "europe": 1100,
    "latin_america": 720,
    "asia_pacific": 550,
    "middle_east_africa": 100
  },

  "daily_sales_history": [
    /* ------------- JAN 2024 -------------- */
    { "date": "2024-01-01", "units": 38 },
    { "date": "2024-01-02", "units": 41 },
    { "date": "2024-01-03", "units": 36 },
    { "date": "2024-01-04", "units": 40 },
    { "date": "2024-01-05", "units": 28 },
    { "date": "2024-01-06", "units": 0  },
    { "date": "2024-01-07", "units": 20 },
    /* … continue until 2024‑01‑31 … */

    /* ------------- FEB 2024 -------------- */
    { "date": "2024-02-01", "units": 52 },
    { "date": "2024-02-02", "units": 55 },
    { "date": "2024-02-03", "units": 50 },
    /* … continue until 2024‑02‑29 … */

    /* ------------- MAR 2024 -------------- */
    { "date": "2024-03-01", "units": 59 },
    { "date": "2024-03-02", "units": 63 },
    { "date": "2024-03-03", "units": 57 }
    /* … continue until 2024‑03‑31 … */
  ],

  "metadata": {
    "data_extract_timestamp": "2024-04-01T11:30:00Z",
    "prepared_by": "ERP‑Integrator‑v2.3"
  }
}
```

---

### Response

```json
{
    "context": {
        "dados": {
            "product_code": 56421,
            "product_name": "Smart LED Bulb 9 W – Wi‑Fi (E27)",
            "category": "Lighting > Smart Home",
            "uom": "unit",
            "inventory_snapshot": {
                "snapshot_date": "2024-03-31",
                "current_stock_units": 780,
                "safety_stock_units": 300,
                "reorder_point_units": 450
            },
            "unit_economics": {
                "unit_cost": 2.65,
                "unit_price": 6.9,
                "currency": "USD"
            },
            "purchases": [
                {
                    "purchase_date": "2024-01-08",
                    "quantity": 1000,
                    "supplier": "LumiTech Ltd."
                },
                {
                    "purchase_date": "2024-02-12",
                    "quantity": 900,
                    "supplier": "LumiTech Ltd."
                },
                {
                    "purchase_date": "2024-03-15",
                    "quantity": 850,
                    "supplier": "BrightSource Inc."
                }
            ],
            "returns": [
                {
                    "return_date": "2024-02-27",
                    "quantity": 19,
                    "reason": "Factory defect"
                },
                {
                    "return_date": "2024-03-18",
                    "quantity": 11,
                    "reason": "Buyer remorse"
                }
            ],
            "channel_sales_units": {
                "ecommerce": 2460,
                "retail_stores": 890,
                "marketplace": 610,
                "wholesale": 430
            },
            "regional_sales_units": {
                "north_america": 1820,
                "europe": 1100,
                "latin_america": 720,
                "asia_pacific": 550,
                "middle_east_africa": 100
            },
            "daily_sales_history": [
                {
                    "date": "2024-01-01",
                    "units": 38
                },
                {
                    "date": "2024-01-02",
                    "units": 41
                },
                {
                    "date": "2024-01-03",
                    "units": 36
                },
                {
                    "date": "2024-01-04",
                    "units": 40
                },
                {
                    "date": "2024-01-05",
                    "units": 28
                },
                {
                    "date": "2024-01-06",
                    "units": 0
                },
                {
                    "date": "2024-01-07",
                    "units": 20
                },
                {
                    "date": "2024-02-01",
                    "units": 52
                },
                {
                    "date": "2024-02-02",
                    "units": 55
                },
                {
                    "date": "2024-02-03",
                    "units": 50
                },
                {
                    "date": "2024-03-01",
                    "units": 59
                },
                {
                    "date": "2024-03-02",
                    "units": 63
                },
                {
                    "date": "2024-03-03",
                    "units": 57
                }
            ],
            "metadata": {
                "data_extract_timestamp": "2024-04-01T11:30:00Z",
                "prepared_by": "ERP‑Integrator‑v2.3"
            }
        },
        "prompt_utilizado": "\n        You are a highly qualified business analyst. You have received the following data in JSON format:\n\n        Data:\n        {\n    \"product_code\": 56421,\n    \"product_name\": \"Smart LED Bulb 9 W – Wi‑Fi (E27)\",\n    \"category\": \"Lighting > Smart Home\",\n    \"uom\": \"unit\",\n    \"inventory_snapshot\": {\n        \"snapshot_date\": \"2024-03-31\",\n        \"current_stock_units\": 780,\n        \"safety_stock_units\": 300,\n        \"reorder_point_units\": 450\n    },\n    \"unit_economics\": {\n        \"unit_cost\": 2.65,\n        \"unit_price\": 6.9,\n        \"currency\": \"USD\"\n    },\n    \"purchases\": [\n        {\n            \"purchase_date\": \"2024-01-08\",\n            \"quantity\": 1000,\n            \"supplier\": \"LumiTech Ltd.\"\n        },\n        {\n            \"purchase_date\": \"2024-02-12\",\n            \"quantity\": 900,\n            \"supplier\": \"LumiTech Ltd.\"\n        },\n        {\n            \"purchase_date\": \"2024-03-15\",\n            \"quantity\": 850,\n            \"supplier\": \"BrightSource Inc.\"\n        }\n    ],\n    \"returns\": [\n        {\n            \"return_date\": \"2024-02-27\",\n            \"quantity\": 19,\n            \"reason\": \"Factory defect\"\n        },\n        {\n            \"return_date\": \"2024-03-18\",\n            \"quantity\": 11,\n            \"reason\": \"Buyer remorse\"\n        }\n    ],\n    \"channel_sales_units\": {\n        \"ecommerce\": 2460,\n        \"retail_stores\": 890,\n        \"marketplace\": 610,\n        \"wholesale\": 430\n    },\n    \"regional_sales_units\": {\n        \"north_america\": 1820,\n        \"europe\": 1100,\n        \"latin_america\": 720,\n        \"asia_pacific\": 550,\n        \"middle_east_africa\": 100\n    },\n    \"daily_sales_history\": [\n        {\n            \"date\": \"2024-01-01\",\n            \"units\": 38\n        },\n        {\n            \"date\": \"2024-01-02\",\n            \"units\": 41\n        },\n        {\n            \"date\": \"2024-01-03\",\n            \"units\": 36\n        },\n        {\n            \"date\": \"2024-01-04\",\n            \"units\": 40\n        },\n        {\n            \"date\": \"2024-01-05\",\n            \"units\": 28\n        },\n        {\n            \"date\": \"2024-01-06\",\n            \"units\": 0\n        },\n        {\n            \"date\": \"2024-01-07\",\n            \"units\": 20\n        },\n        {\n            \"date\": \"2024-02-01\",\n            \"units\": 52\n        },\n        {\n            \"date\": \"2024-02-02\",\n            \"units\": 55\n        },\n        {\n            \"date\": \"2024-02-03\",\n            \"units\": 50\n        },\n        {\n            \"date\": \"2024-03-01\",\n            \"units\": 59\n        },\n        {\n            \"date\": \"2024-03-02\",\n            \"units\": 63\n        },\n        {\n            \"date\": \"2024-03-03\",\n            \"units\": 57\n        }\n    ],\n    \"metadata\": {\n        \"data_extract_timestamp\": \"2024-04-01T11:30:00Z\",\n        \"prepared_by\": \"ERP‑Integrator‑v2.3\"\n    }\n}\n\n        **Objective:**\n        1. Analyze the data above and describe relevant insights, correlations, and patterns.\n        2. Structure your answer in a report format, using headings or subheadings to organize your analysis.\n        3. Write clearly and objectively in English.\n        4. Only use information that can be directly inferred from the data provided.\n\n        **Important Instructions:**\n        - Focus exclusively on the data provided (do not include hypotheses about external or unspecified data).\n        - Do not refer to yourself (the model) or the prompt in your answer.\n        - Maintain focus on factual insights and objective analysis. Avoid digressions or comments unrelated to the data.\n        - If the data is insufficient for a definitive conclusion, present only the limitations directly related to the dataset, in a brief and objective manner. Do not mention data or contexts not present in this dataset (for example, profitability, process improvements, or predictive indicators that are not included).\n\n        **Additional Sections:**\n        - Include a **Recommendations** section, detailing possible actions based on the analyzed data.\n        - Include a **Next Steps** section, suggesting follow-up or additional analyses, always drawing exclusively from the data provided.\n\n        Please compose your report below:\n        \n<!-- NONCE: 0c2002fc-1df4-4892-a5cc-15789d6ddbf8 -->"
    },
    "request": {
        "model": "o3-mini-2025-01-31",
        "max_completion_tokens": 15000
    },
    "response": {
        "report_text": "Business Analysis Report: Smart LED Bulb 9 W – Wi‑Fi (E27)\n\n─────────────────────────────  \n1. Product and Inventory Overview  \n─────────────────────────────  \n• Product Details:  \n  – Product Code: 56421  \n  – Product Name: Smart LED Bulb 9 W – Wi‑Fi (E27)  \n  – Category: Lighting > Smart Home  \n  – Unit of Measure: unit\n\n• Inventory Snapshot as of 2024-03-31:  \n  – Current Stock: 780 units  \n  – Safety Stock: 300 units  \n  – Reorder Point: 450 units  \n  Observation: The current inventory level (780 units) is above both the safety stock level and the reorder point. No immediate replenishment appears necessary based solely on the provided inventory thresholds.\n\n─────────────────────────────  \n2. Unit Economics and Purchasing  \n─────────────────────────────  \n• Unit Economics:  \n  – Unit Cost: $2.65  \n  – Unit Price: $6.90  \n  Observation: The difference between the unit price and cost is $4.25, indicating a positive margin per unit sold.\n\n• Purchase History:  \n  – 2024-01-08: 1,000 units from LumiTech Ltd.  \n  – 2024-02-12: 900 units from LumiTech Ltd.  \n  – 2024-03-15: 850 units from BrightSource Inc.  \n  Observation: Purchases have been made consistently over the first quarter of 2024, with two transactions from one supplier and a more recent purchase from an alternate supplier. The total units purchased sum to 2,750.\n\n• Returns Data:  \n  – 2024-02-27: 19 units returned due to a factory defect  \n  – 2024-03-18: 11 units returned due to buyer remorse  \n  Observation: Returns are minimal compared to overall purchase volumes (a total of 30 units), indicating generally acceptable product quality and customer satisfaction levels based on the reasons provided.\n\n─────────────────────────────  \n3. Sales Analysis  \n─────────────────────────────\n\nA. Channel Sales  \n  – Ecommerce: 2,460 units  \n  – Retail Stores: 890 units  \n  – Marketplace: 610 units  \n  – Wholesale: 430 units  \n  Observation: Ecommerce is the dominant sales channel, contributing more than half of the combined sales units from the four channels (total channel sales: 4,390 units). Retail stores and marketplaces also contribute significant volumes, while wholesale represents the smallest channel among those recorded.\n\nB. Regional Sales  \n  – North America: 1,820 units  \n  – Europe: 1,100 units  \n  – Latin America: 720 units  \n  – Asia Pacific: 550 units  \n  – Middle East & Africa: 100 units  \n  Observation: Sales are highest in North America followed by Europe. The data indicates a relatively lower volume in the Middle East & Africa region. The total regional sales add up to 4,290 units, which is close to channel sales but not identical—a slight discrepancy that suggests different aggregation criteria or reporting methods between channels and regions.\n\nC. Daily Sales History (Selected Dates)  \n  – January Sales: Daily recorded units on specific dates total 203 units within the provided subset  \n  – February Sales: Daily recorded units on selected dates total 157 units  \n  – March Sales: Daily recorded units on selected dates total 179 units  \n  Observation: The daily sales figures, although limited in scope, show variability in daily performance. The sample indicates a gradual increase in unit sales from January to March on the specific dates recorded.\n\n─────────────────────────────  \n4. Correlations and Patterns  \n─────────────────────────────  \n• Inventory and Purchasing:  \n  – The current inventory level exceeds both the safety stock and reorder point, suggesting that recent purchasing events have sufficiently replenished the inventory relative to the demand encountered.\n\n• Unit Economics and Sales Channels:  \n  – The favorable margin ($4.25 per unit) likely supports maintaining diverse sales channels. The dominance of ecommerce sales may indicate a successful online strategy for this product.\n\n• Purchase Timing and Returns:  \n  – Purchases spread over the first quarter have managed to maintain inventory levels, even after accounting for returns. Returns remain low relative to purchase volumes, which could indicate that quality issues are isolated or limited in impact.\n\n• Sales Distribution:  \n  – There is consistency in recorded sales across channels and regions, though slight variations exist in total unit counts. Differences between channel and regional totals suggest that further alignment in sales tracking may be beneficial for a more integrated view.\n\n─────────────────────────────  \n5. Recommendations  \n─────────────────────────────  \n• Monitor Inventory Levels:  \n  – Continue regular monitoring to ensure that stock remains above both safety and reorder thresholds, especially as sales volumes are strong.\n\n• Maintain Focus on Ecommerce:  \n  – Given the leading role of ecommerce in channel sales, consider further investments in digital marketing and online sales optimization.\n\n• Evaluate Regional Performance:  \n  – Explore strategies to boost sales in lower-performing regions such as the Middle East & Africa, while continuing to support strong regions like North America and Europe.\n\n• Align Reporting Metrics:  \n  – Review the methodology of aggregating channel versus regional sales to understand and reconcile the slight discrepancy in total units.\n\n─────────────────────────────  \n6. Next Steps  \n─────────────────────────────  \n• Expand Daily Sales Analysis:  \n  – Gather more comprehensive daily sales data over the full periods to better understand demand trends and seasonality.\n\n• Supplier Performance Review:  \n  – Analyze any recurring patterns in purchase quantities, supplier performance, and returns to determine if changes in supplier engagement strategies are needed.\n\n• Integrate Sales Data:  \n  – Evaluate the alignment between various sales reporting metrics (channel and regional) to support more accurate forecasting and decision-making.\n\n• Continued Quality Monitoring:  \n  – Monitor returned units more closely to identify any patterns that could impact inventory planning or quality assurance processes.\n\n─────────────────────────────  \nConclusion  \n─────────────────────────────  \nThe data indicate a well-performing product with strong sales figures, a healthy inventory position, and a favorable unit margin. While the current purchasing and sales patterns appear effective, further analysis on daily trends, data reconciliation between channels and regions, and supplier evaluation could provide additional actionable insights.",
        "usage": {
            "prompt_tokens": 1083,
            "completion_tokens": 2048,
            "total_tokens": 3131
        },
        "total_cost_usd": 0.0102025
    },
    "processing_info": {
        "execution_time_seconds": 21.57326030731201,
        "openai_processing_time_seconds": 21.57306218147278
    },
    "credit_info": {
        "credit_before": {
            "credit_before": "N/A",
            "credit_after": "N/A",
            "balance": "N/A"
        },
        "credit_after": {
            "credit_before": "N/A",
            "credit_after": "N/A",
            "balance": "N/A"
        },
        "balance": "N/A"
    }
}
```

### `response.report_text` sections (auto-generated)

1. **Product & Inventory Overview** – stock vs safety/ROP, immediate replenishment need.

2. **Unit Economics & Purchasing** – margin per unit, supplier mix, return ratio.

3. **Sales Analysis** – by channel and by region, plus daily trend highlights.

4. **Correlations & Patterns** – ties inventory, purchases, sales together.

5. **Recommendations** – concrete actions (e.g., push under-performing regions, align metrics).

6. **Next Steps** – follow-up analyses drawn only from provided data.

---

### Typical workflow

1. **Combine** raw ERP extracts into the JSON schema above.

2. **POST** to this route; capture report_text.

3. **Publish** the text to an email, Confluence page, or slide deck.

4. **Schedule** a weekly run (via automations) to keep the report current.

---

# 4.5 Cost & Risk Analytics  
**Cost & Risk Analytics**

> `credit_risk_score`, `credit_risk_explain`, `channel_attribution`, `journey_markov`, `journey_sequences`, `anomaly_transactions`, `anomaly_accounts`, `anomaly_graph`, `sentiment_realtime`, `sentiment_report`

---

# 4.5.1 /api/v1/ai/credit_risk_score

**Train-and-score a Probability-of-Default (PD) model in one call**

### Purpose
Post a mixed batch of labelled & un-labelled applicants and receive model quality, per-applicant PDs and explainable SHAP drivers.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/credit_risk_score
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```


---

## Why this route matters

| **Pain-point for risk teams**                               | **What the endpoint returns**                                                                              |
|-------------------------------------------------------------|----------------------------------------------------------------------------------------------------------- |
| Need to prototype a scorecard fast without MLOps plumbing   | Automatic model bake-off (LogReg, RF, XGBoost, CatBoost) and AUC on a hold-out split.                      |
| Want explainability for regulators                          | SHAP top-feature list per applicant + human-readable interpretation string.                                |
| Chaos of many CSVs / feature sets                           | Accepts any mix of numeric & categorical fields inside `features{}` — one-hot encoding is handled for you. |
| Must score new applicants daily                             | Same JSON schema works with `label` omitted, endpoint just scores with the latest champion model.          |

---

## Request payload reference

| **Path**             | **Type** | **Required** | **Notes**                                                                 |
|----------------------|----------|--------------|---------------------------------------------------------------------------|
| `test_size`          | float    | ✱            | Share of rows reserved for validation (0 < value < 1).                    |
| `applicants[]`       | array    | ✔︎           | One object per borrower.                                                 |
| ↳ `id`              | string   | ✔︎           | Unique key copied to the response.                                       |
| ↳ `features`        | object   | ✔︎           | Arbitrary key/values. Numeric → used as is; Categorical → one-hot encoded. |
| ↳ `label`           | 0/1      | Training only| 1 = default/charge-off, 0 = good credit. Omit for pure scoring calls.     |

> ✱ If you skip `test_size`, default 0.2 is applied.

---

### Request

```json
{
  "test_size": 0.2,
  "applicants": [
    { "id": "app-001", "features": { "income": 55000, "age": 34, "country": "BR", "late_payments": 0 }, "label": 0 },
    ...
    { "id": "app-050", "features": { "income": 63000, "age": 23, "country": "UK", "late_payments": 0 }, "label": 1 }
  ]
}
```

---

### The route:

1. One-hot encodes categoricals.

2. Model bake-off (LogReg, RF, XGBoost, CatBoost) on the hold-out split.

3. Retrains the best model on ALL data and scores every applicant.

4. Returns:
    • **auc** – overall AUC on hold-out set
    • **best_model** – algorithm selected
    • **predictions[]** – per-applicant PD + SHAP top-features (if available)
    • **interpretation** – English summary

### Pure scoring example

Send the same object without **label** to get PDs using your last trained model.

---

### Response

```json
{
    "auc": 1.0,
    "best_model": "LogisticRegression",
    "predictions": [
        {
            "id": "app-001",
            "probability": 0.0001,
            "shap_values": {
                "num__age": 2.214572098503316,
                "num__late_payments": -1.384564942339434,
                "num__income": -0.893762081144131,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age +2.2 ↑ risk; late payments -1.4 ↓ risk; income -0.9 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-002",
            "probability": 0.317,
            "shap_values": {
                "num__age": 7.589747094870583,
                "num__income": 0.5174412048729179,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253,
                "num__late_payments": -0.1258695402126759
            },
            "shap_interpretation": "PD 31.7 % ⇒ MEDIUM risk.  age +7.6 ↑ risk; income +0.5 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk; late payments -0.1 ↓ risk"
        },
        {
            "id": "app-003",
            "probability": 0.0,
            "shap_values": {
                "num__age": -10.685847892778124,
                "num__income": 1.7718441257769615,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -10.7 ↓ risk; income +1.8 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-004",
            "probability": 0.0006,
            "shap_values": {
                "num__age": 5.439677096323677,
                "num__income": -2.1481650020481746,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.1 % ⇒ LOW risk.  age +5.4 ↑ risk; income -2.1 ↓ risk; late payments -1.4 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-005",
            "probability": 0.0,
            "shap_values": {
                "num__age": -5.310672896410857,
                "num__income": 3.4966481420200215,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -5.3 ↓ risk; income +3.5 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-006",
            "probability": 0.0361,
            "shap_values": {
                "num__age": 9.73981709341749,
                "num__income": -3.5593682880652233,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 3.6 % ⇒ LOW risk.  age +9.7 ↑ risk; income -3.6 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-007",
            "probability": 0.0,
            "shap_values": {
                "num__age": -17.136057888418843,
                "num__income": 4.7510510629240645,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -17.1 ↓ risk; income +4.8 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-008",
            "probability": 0.0001,
            "shap_values": {
                "num__age": 3.2896070977767695,
                "num__income": -2.30496536716118,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age +3.3 ↑ risk; income -2.3 ↓ risk; late payments -1.4 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-009",
            "probability": 0.0,
            "shap_values": {
                "num__age": -3.1606028978639507,
                "num__income": 1.928644490889967,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -3.2 ↓ risk; income +1.9 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-010",
            "probability": 0.0,
            "shap_values": {
                "num__age": -9.61081289350467,
                "num__income": 3.18304741179401,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -9.6 ↓ risk; income +3.2 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-011",
            "probability": 0.177,
            "shap_values": {
                "num__age": 8.664782094144037,
                "num__income": -0.7369617160311256,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 17.7 % ⇒ LOW risk.  age +8.7 ↑ risk; income -0.7 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-012",
            "probability": 0.0,
            "shap_values": {
                "num__late_payments": -1.384564942339434,
                "num__age": -1.0105328993170437,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253,
                "num__income": -0.10976025557910381
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  late payments -1.4 ↓ risk; age -1.0 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk; income -0.1 ↓ risk"
        },
        {
            "id": "app-013",
            "probability": 0.0,
            "shap_values": {
                "num__age": -6.385707895684311,
                "num__income": 1.3014430304379452,
                "num__late_payments": 1.132825861914082,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -6.4 ↓ risk; income +1.3 ↑ risk; late payments +1.1 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-014",
            "probability": 0.0038,
            "shap_values": {
                "num__age": 6.51471209559713,
                "num__late_payments": -1.384564942339434,
                "num__income": -1.3641631764831472,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.4 % ⇒ LOW risk.  age +6.5 ↑ risk; late payments -1.4 ↓ risk; income -1.4 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-015",
            "probability": 0.0,
            "shap_values": {
                "num__age": -14.985987889871938,
                "num__income": 4.123849602472043,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -15.0 ↓ risk; income +4.1 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-016",
            "probability": 0.2195,
            "shap_values": {
                "num__age": 10.814852092690943,
                "num__income": -2.6185660973871907,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 21.9 % ⇒ LOW risk.  age +10.8 ↑ risk; income -2.6 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-017",
            "probability": 0.0,
            "shap_values": {
                "num__age": -18.2110928876923,
                "num__income": 5.064651793150076,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -18.2 ↓ risk; income +5.1 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-018",
            "probability": 0.0,
            "shap_values": {
                "num__income": -1.991364636935169,
                "num__late_payments": -1.384564942339434,
                "num__age": 1.139537099229863,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  income -2.0 ↓ risk; late payments -1.4 ↓ risk; age +1.1 ↑ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-019",
            "probability": 0.0,
            "shap_values": {
                "num__age": -4.235637897137404,
                "num__income": 2.3990455862289832,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -4.2 ↓ risk; income +2.4 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-020",
            "probability": 0.0,
            "shap_values": {
                "num__age": -8.535777894231217,
                "num__income": 3.339847776907016,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -8.5 ↓ risk; income +3.3 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-021",
            "probability": 0.0034,
            "shap_values": {
                "num__age": 4.364642097050223,
                "num__income": -0.5801613509181202,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.3 % ⇒ LOW risk.  age +4.4 ↑ risk; income -0.6 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-022",
            "probability": 0.0,
            "shap_values": {
                "num__age": -2.0855678985904973,
                "num__late_payments": -1.384564942339434,
                "num__income": 0.3606408397599125,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -2.1 ↓ risk; late payments -1.4 ↓ risk; income +0.4 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-023",
            "probability": 0.0,
            "shap_values": {
                "num__age": -7.460742894957764,
                "num__income": 1.4582433955509506,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -7.5 ↓ risk; income +1.5 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-024",
            "probability": 0.0324,
            "shap_values": {
                "num__age": 7.589747094870583,
                "num__income": -1.5209635415961527,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 3.2 % ⇒ LOW risk.  age +7.6 ↑ risk; income -1.5 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-025",
            "probability": 0.0,
            "shap_values": {
                "num__age": -13.910952890598484,
                "num__income": 4.280649967585049,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -13.9 ↓ risk; income +4.3 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-026",
            "probability": 0.1337,
            "shap_values": {
                "num__age": 9.73981709341749,
                "num__income": -3.402567922952218,
                "num__late_payments": 1.132825861914082,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 13.4 % ⇒ LOW risk.  age +9.7 ↑ risk; income -3.4 ↓ risk; late payments +1.1 ↑ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-027",
            "probability": 0.0,
            "shap_values": {
                "num__age": -21.43619788551266,
                "num__income": 5.378252523376086,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -21.4 ↓ risk; income +5.4 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-028",
            "probability": 0.0001,
            "shap_values": {
                "num__age": 2.214572098503316,
                "num__income": -2.1481650020481746,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age +2.2 ↑ risk; income -2.1 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-029",
            "probability": 0.0,
            "shap_values": {
                "num__age": -5.310672896410857,
                "num__income": 2.2422452211159776,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -5.3 ↓ risk; income +2.2 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-030",
            "probability": 0.0,
            "shap_values": {
                "num__age": -10.685847892778124,
                "num__income": 3.4966481420200215,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -10.7 ↓ risk; income +3.5 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-031",
            "probability": 0.0005,
            "shap_values": {
                "num__age": 3.2896070977767695,
                "num__late_payments": -1.384564942339434,
                "num__income": -0.26656062069210923,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age +3.3 ↑ risk; late payments -1.4 ↓ risk; income -0.3 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-032",
            "probability": 0.0001,
            "shap_values": {
                "num__age": -1.0105328993170437,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253,
                "num__late_payments": -0.1258695402126759,
                "num__income": 0.047040109533901635
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -1.0 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk; late payments -0.1 ↓ risk; income +0.0 ↑ risk"
        },
        {
            "id": "app-033",
            "probability": 0.0,
            "shap_values": {
                "num__age": -6.385707895684311,
                "num__late_payments": -1.384564942339434,
                "num__income": 0.9878423002119343,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -6.4 ↓ risk; late payments -1.4 ↓ risk; income +1.0 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-034",
            "probability": 0.0044,
            "shap_values": {
                "num__age": 6.51471209559713,
                "num__late_payments": -1.384564942339434,
                "num__income": -1.2073628113701418,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.4 % ⇒ LOW risk.  age +6.5 ↑ risk; late payments -1.4 ↓ risk; income -1.2 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-035",
            "probability": 0.0,
            "shap_values": {
                "num__age": -16.06102288914539,
                "num__income": 4.594250697811059,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -16.1 ↓ risk; income +4.6 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-036",
            "probability": 0.0201,
            "shap_values": {
                "num__age": 8.664782094144037,
                "num__income": -3.0889671927262072,
                "cat__country_BR": -0.178266075258134,
                "num__late_payments": -0.1258695402126759,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 2.0 % ⇒ LOW risk.  age +8.7 ↑ risk; income -3.1 ↓ risk; country BR -0.2 ↓ risk; late payments -0.1 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-037",
            "probability": 0.0,
            "shap_values": {
                "num__age": -20.361162886239203,
                "num__income": 5.691853253602098,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -20.4 ↓ risk; income +5.7 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-038",
            "probability": 0.0,
            "shap_values": {
                "num__income": -1.8345642718221635,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173,
                "num__age": 0.06450209995640964
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  income -1.8 ↓ risk; late payments -1.4 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk; age +0.1 ↑ risk"
        },
        {
            "id": "app-039",
            "probability": 0.0,
            "shap_values": {
                "num__age": -4.235637897137404,
                "num__income": 2.712646316454994,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253,
                "num__late_payments": -0.1258695402126759
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -4.2 ↓ risk; income +2.7 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk; late payments -0.1 ↓ risk"
        },
        {
            "id": "app-040",
            "probability": 0.0,
            "shap_values": {
                "num__age": -11.760882892051578,
                "num__income": 3.6534485071330267,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 0.0 % ⇒ LOW risk.  age -11.8 ↓ risk; income +3.7 ↑ risk; late payments -1.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-041",
            "probability": 0.9388,
            "shap_values": {
                "num__age": 15.114992089784757,
                "num__income": -6.695375590325332,
                "num__late_payments": 3.6502166661675983,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 93.9 % ⇒ HIGH risk.  age +15.1 ↑ risk; income -6.7 ↓ risk; late payments +3.7 ↑ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-042",
            "probability": 0.9237,
            "shap_values": {
                "num__age": 11.889887091964397,
                "num__income": -6.2249744949863155,
                "num__late_payments": 6.167607470421115,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 92.4 % ⇒ HIGH risk.  age +11.9 ↑ risk; income -6.2 ↓ risk; late payments +6.2 ↑ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-043",
            "probability": 0.7721,
            "shap_values": {
                "num__age": 10.814852092690943,
                "num__income": -5.7545733996473,
                "num__late_payments": 4.908912068294356,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 77.2 % ⇒ HIGH risk.  age +10.8 ↑ risk; income -5.8 ↓ risk; late payments +4.9 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-044",
            "probability": 0.998,
            "shap_values": {
                "num__age": 14.039957090511303,
                "num__late_payments": 7.426302872547873,
                "num__income": -5.911373764760305,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 99.8 % ⇒ HIGH risk.  age +14.0 ↑ risk; late payments +7.4 ↑ risk; income -5.9 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-045",
            "probability": 0.998,
            "shap_values": {
                "num__age": 12.96492209123785,
                "num__late_payments": 8.68499827467463,
                "num__income": -6.381774860099322,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 99.8 % ⇒ HIGH risk.  age +13.0 ↑ risk; late payments +8.7 ↑ risk; income -6.4 ↓ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-046",
            "probability": 0.941,
            "shap_values": {
                "num__age": 11.889887091964397,
                "num__income": -6.538575225212327,
                "num__late_payments": 6.167607470421115,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 94.1 % ⇒ HIGH risk.  age +11.9 ↑ risk; income -6.5 ↓ risk; late payments +6.2 ↑ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-047",
            "probability": 0.9788,
            "shap_values": {
                "num__age": 15.114992089784757,
                "num__income": -6.852175955438337,
                "num__late_payments": 4.908912068294356,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 97.9 % ⇒ HIGH risk.  age +15.1 ↑ risk; income -6.9 ↓ risk; late payments +4.9 ↑ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-048",
            "probability": 0.6843,
            "shap_values": {
                "num__age": 8.664782094144037,
                "num__income": 2.2422452211159776,
                "num__late_payments": -1.384564942339434,
                "cat__country_US": 0.1753505606242486,
                "cat__country_BR": 0.12908922691106253
            },
            "shap_interpretation": "PD 68.4 % ⇒ MEDIUM risk.  age +8.7 ↑ risk; income +2.2 ↑ risk; late payments -1.4 ↓ risk; country US +0.2 ↑ risk; country BR +0.1 ↑ risk"
        },
        {
            "id": "app-049",
            "probability": 0.8344,
            "shap_values": {
                "num__age": 7.589747094870583,
                "num__income": 4.7510510629240645,
                "num__late_payments": -1.384564942339434,
                "cat__country_BR": -0.178266075258134,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 83.4 % ⇒ HIGH risk.  age +7.6 ↑ risk; income +4.8 ↑ risk; late payments -1.4 ↓ risk; country BR -0.2 ↓ risk; country US -0.1 ↓ risk"
        },
        {
            "id": "app-050",
            "probability": 0.982,
            "shap_values": {
                "num__age": 14.039957090511303,
                "num__late_payments": -1.384564942339434,
                "num__income": 0.3606408397599125,
                "cat__country_BR": 0.12908922691106253,
                "cat__country_US": -0.10747292425357173
            },
            "shap_interpretation": "PD 98.2 % ⇒ HIGH risk.  age +14.0 ↑ risk; late payments -1.4 ↓ risk; income +0.4 ↑ risk; country BR +0.1 ↑ risk; country US -0.1 ↓ risk"
        }
    ],
    "interpretation": "AUC=1.0000 with LogisticRegression. Portfolio split: 9 HIGH / 2 MED / 39 LOW."
}
```

---

### Risk buckets in the interpretation

Risk buckets follow default cut-offs:  
- **Low** < 0.25  
- **Medium** < 0.6  
- **High** ≥ 0.6  

 Adjust with a query param: `thresholds=0.2,0.5` if needed.

---

## What happens under the hood

- **Encoding** – numeric features scaled, categoricals one-hot.  
- **Model bake-off** – trains Logistic Regression, Random Forest, XGBoost & CatBoost on the training slice, selects highest AUC.  
- **Retrain** – winning model fit on the full dataset.  
- **Scoring + SHAP** – PD for every row; top-5 absolute SHAP contributors extracted.

---

## Typical workflow

- Batch-train once a day with fresh repayment labels.  
- Store the `best_model` snapshot ID you receive (for audit).  
- Score live applicants during the day by omitting label.  
- Feed PDs into pricing / limit-assignment logic; archive SHAP explanations for compliance.  
- Monitor `auc` drift over time → retrain when it drops below your KPI.

---

# 4.5.2 /api/v1/ai/credit_risk_explain

**Local explainability for one borrower**

### Purpose
Post a mixed batch of labelled & un-labelled applicants and receive model quality, per-applicant PDs and explainable SHAP drivers.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/credit_risk_explain
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```


---

## Why this route exists

| **Need**                                                    | **What the endpoint delivers**                                                                              |
|------------------------------------------------------------ |------------------------------------------------------------------------------------------------------------ |
| Credit officer asks “Why did the model flag this customer?” | Per-feature contribution scores (`explanation{}`) and a plain-English sentence (`interpretation`).          |
| Regulators demand local explanations                        | A local surrogate (LIME) or Tree-SHAP explainer is fit on the fly from the mini training sample you supply. |
| Want to double-check a borderline decision                  | Full PD for the single borrower (probability) is returned along with the drivers.                           |

---

## Request payload reference

| **Path**                  | **Type**       | **Required** | **Notes**                                                                 |
|---------------------------|----------------|--------------|---------------------------------------------------------------------------|
| `applicant.id`            | string         | ✔︎           | Copied back in errors/logs.                                               |
| `applicant.features`      | object         | ✔︎           | Same free-form schema used in training/scoring routes.                    |
| `training_sample[]`       | array          | ✔︎           | ≥ 50 rows with label so the explainer can learn local decision boundaries.|
| ↳ `label`                 | 0 / 1          | ✔︎           | 1 = default / charge-off, 0 = paid back.                                  |

 **Tip** Reuse a random slice of the last batch you posted to `/api/credit_risk_score` to keep payloads light.

---

### Request

```json
{
  "applicant": {
    "id": "app-XYZ",
    "features": {
      "income": 42000,
      "age": 29,
      "country": "BR",
      "late_payments": 2
    }
  },
  "training_sample": [
    { "id": "s-001", "features": { "income": 55000, "age": 34, "country": "BR", "late_payments": 0 }, "label": 0 },
    ...
    { "id": "s-050", "features": { "income": 18500, "age": 24, "country": "BR", "late_payments": 8 }, "label": 1 }
  ]
}
```

---

### Response

```yml
{
  "probability": 0.0,
  "explanation": {
    "income": 0.0,
    "age": -3.469446951953614e-18,
    "late payments": 0.0,
    "country BR": 2.6020852139652106e-18,
    "country CA": 4.336808689942018e-19,
    "country NG": 1.734723475976807e-18,
    "country UK": 3.7947076036992655e-19,
    "country US": 2.3852447794681098e-18
  },
  "interpretation": "PD 0.0 % ⇒ LOW risk.  income +0.0 ↓ risk; age -0.0 ↓ risk; late payments +0.0 ↓ risk; country BR +0.0 ↑ risk; country CA +0.0 ↑ risk; country NG +0.0 ↑ risk; country UK +0.0 ↑ risk; country US +0.0 ↑ risk"
}
```

Magnitudes are additive log-odds (SHAP) or local linear weights (LIME) depending on the data mix; signs show direction.

---

### Under the hood

* Encoding – same one-hot rules as the main scoring service.

* Local neighbourhood – explainer samples ≈ 5,000 synthetic points around the applicant (kernel density).

* Surrogate model – linear/LASSO (LIME) or Tree-SHAP depending on feature types.

* PD computation – uses your last deployed champion model (if any) or fits a quick Logistic Regression on the supplied sample.

* Interpretation string – converts top contributions into a human-readable sentence.

---

### Typical workflow

1. Score batch with `/api/credit_risk_score;` keep IDs with PD ≥ threshold.

2. Explain flagged IDs individually with `/api/credit_risk_explain` and embed the plain-English sentence in your credit-committee UI.

3. Archive both the surrogate coefficients and original PD for audit.

---

# 4.5.3 /api/v1/ai/channel_attribution

**Causal lift per marketing channel**

---

### Purpose  
Pinpoint which channels truly move the conversion needle instead of relying on last-click folklore.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/channel_attribution
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### What the route delivers

| **Your question**                                      | **What the endpoint returns**                                                                 |
|--------------------------------------------------------|-----------------------------------------------------------------------------------------------|
| “Should I pour more budget into Paid Search or Display?” | A ranked table of incremental lifts (`incremental_lift`) for every channel.                 |
| “How many touches did we actually analyse?”            | `n_events` per channel plus an overall AUC if a logistic fallback was used.                  |
| “Is the estimate statistically sound?”                 | The service refuses runs with `< min_events` rows; otherwise it reports the global AUC or, when `doubleml` is available, full Double-ML diagnostics are placed in the job log. |

---

## Request payload reference

| **Path**     | **Type**             | **Required** | **Notes**                                                                                     |
|--------------|----------------------|--------------|-----------------------------------------------------------------------------------------------|
| `min_events` | integer              | ✖︎           | Default 200. Guard-rail for accidental under-sampling.                                       |
| `touches[]`  | array <object>       | ✔︎           | ≥ 200 recommended. Each object is a touch-point.                                             |
| ↳ `user_id`  | string               | ✔︎           | Same user can appear multiple times; every row for that user must carry the same `converted` value. |
| ↳ `channel`  | string               | ✔︎           | Case-sensitive label; the response echoes it verbatim.                                       |
| ↳ `timestamp`| string               | ✔︎           | ISO-8601 UTC. Only kept for audit — model ignores order unless encoded via features.         |
| ↳ `converted`| 0 / 1                | ✔︎           | 1 if the user ultimately converted.                                                           |
| ↳ `features` | object               | ✖︎           | Arbitrary numeric / categorical keys, automatically one-hot encoded. Use for device, geo, creative, etc. |

 **Hint** If you need sequence effects, pre-compute features like `touch_order` or `days_since_first_touch` and pass them here.

---

### Request

```json
{
  // ──────────────────────────────────────────────────────────────────────────────
  //  📈  CHANNEL-LEVEL INCREMENTAL LIFT  –  POST  /api/channel_attribution
  //  ---------------------------------------------------------------------------
  //  What this route does
  //  ─────────────────────
  //  • Ingests *touch-point* data – one JSON object per marketing interaction
  //    (e-mail open, paid-search click, display impression, etc.).
  //  • Calculates the **incremental contribution** (causal lift) of every channel
  //    to the final conversion, instead of naïve last-/first-touch or raw C-rate.
  //  • Needs at least `min_events` (>≈200) rows for a stable estimate.
  //  • Internals:
  //        – If the Python package **doubleml** is installed, the endpoint runs a
  //          Double-Machine-Learning (DML-PLR) estimator that partials out all
  //          feature confounders to return per-channel Average Treatment Effects.
  //        – Otherwise, it falls back to a regularised logistic-regression baseline
  //          whose coefficients act as *pseudo-lifts* and also reports global AUC.
  //
  //  Field-by-field specification
  //  ────────────────────────────
  //  • min_events   (integer) :   Minimum #events you allow; defaults to **200**.
  //
  //  • touches[] (array)      :   Each object **must** contain:
  //        – user_id   (string)  : Consistent identifier; the same user can emit
  //                                multiple touches on different channels.
  //        – channel   (string)  : Channel label – *case-sensitive*; the lift
  //                                table shows these exactly as provided.
  //        – timestamp (string)  : ISO-8601 datetime in UTC (e.g.
  //                                “2025-04-01T09:12:00Z”).  Only for auditing;
  //                                the model ignores order unless you encode it
  //                                yourself via features.
  //        – converted (0 | 1)   : 1 if that **user** eventually converted,
  //                                otherwise 0.  All rows for the same user
  //                                carry the same value.
  //        – features (object)   : *(optional)* arbitrary per-event or
  //                                per-user attributes.  Both numeric and
  //                                categorical keys allowed; the API handles
  //                                one-hot-encoding automatically.
  //
  //  Typical interpretation of the response
  //  ───────────────────────────────────────
  //  The endpoint returns an array `contributions[]`, sorted by
  //  `incremental_lift` (ATE) plus helper columns:
  //        • n_events   – how many touches came from that channel
  //        • raw_cr     – naïve conversion-rate for that channel
  //        • incremental_lift – *causal* (or pseudo-causal) lift
  //        • description – quick qualitative tag:
  //              ↗ strong driver   /  neutral  /  ↘ drag on conversions
  //
  //  Channels tagged “↗ strong driver” deserve more budget; “↘ drag” may warrant
  //  creative tweaks or re-allocation.
  //
  //  ---------------------------------------------------------------------------
  //  ↓  Replace the stub below with ≥200 real rows before hitting “Send”
  // ─────────────────────────────────────────────────────────────────────────────
  "min_events": 200,
  "touches": [
    {
      "user_id": "U-000",
      "channel": "display",
      "timestamp": "2025-04-01T09:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-000",
      "channel": "social",
      "timestamp": "2025-04-01T09:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-000",
      "channel": "social",
      "timestamp": "2025-04-01T10:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 1
    },
    {
      "user_id": "U-000",
      "channel": "social",
      "timestamp": "2025-04-01T10:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-000",
      "channel": "social",
      "timestamp": "2025-04-01T11:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-001",
      "channel": "email",
      "timestamp": "2025-04-01T11:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-001",
      "channel": "email",
      "timestamp": "2025-04-01T12:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-001",
      "channel": "paid_search",
      "timestamp": "2025-04-01T12:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-001",
      "channel": "email",
      "timestamp": "2025-04-01T13:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-001",
      "channel": "social",
      "timestamp": "2025-04-01T13:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-002",
      "channel": "display",
      "timestamp": "2025-04-01T14:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-002",
      "channel": "display",
      "timestamp": "2025-04-01T14:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-002",
      "channel": "email",
      "timestamp": "2025-04-01T15:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-002",
      "channel": "email",
      "timestamp": "2025-04-01T15:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-002",
      "channel": "social",
      "timestamp": "2025-04-01T16:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-003",
      "channel": "display",
      "timestamp": "2025-04-01T16:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-003",
      "channel": "email",
      "timestamp": "2025-04-01T17:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-003",
      "channel": "social",
      "timestamp": "2025-04-01T17:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-003",
      "channel": "social",
      "timestamp": "2025-04-01T18:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-003",
      "channel": "display",
      "timestamp": "2025-04-01T18:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-004",
      "channel": "paid_search",
      "timestamp": "2025-04-01T19:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-004",
      "channel": "display",
      "timestamp": "2025-04-01T19:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-004",
      "channel": "social",
      "timestamp": "2025-04-01T20:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-004",
      "channel": "display",
      "timestamp": "2025-04-01T20:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-004",
      "channel": "social",
      "timestamp": "2025-04-01T21:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-005",
      "channel": "display",
      "timestamp": "2025-04-01T21:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-005",
      "channel": "social",
      "timestamp": "2025-04-01T22:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-005",
      "channel": "paid_search",
      "timestamp": "2025-04-01T22:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-005",
      "channel": "display",
      "timestamp": "2025-04-01T23:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 1
    },
    {
      "user_id": "U-005",
      "channel": "display",
      "timestamp": "2025-04-01T23:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-006",
      "channel": "email",
      "timestamp": "2025-04-02T00:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-006",
      "channel": "paid_search",
      "timestamp": "2025-04-02T00:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-006",
      "channel": "paid_search",
      "timestamp": "2025-04-02T01:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-006",
      "channel": "display",
      "timestamp": "2025-04-02T01:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-006",
      "channel": "display",
      "timestamp": "2025-04-02T02:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-007",
      "channel": "display",
      "timestamp": "2025-04-02T02:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-007",
      "channel": "display",
      "timestamp": "2025-04-02T03:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-007",
      "channel": "display",
      "timestamp": "2025-04-02T03:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-007",
      "channel": "social",
      "timestamp": "2025-04-02T04:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-007",
      "channel": "email",
      "timestamp": "2025-04-02T04:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-008",
      "channel": "paid_search",
      "timestamp": "2025-04-02T05:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-008",
      "channel": "display",
      "timestamp": "2025-04-02T05:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-008",
      "channel": "paid_search",
      "timestamp": "2025-04-02T06:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-008",
      "channel": "social",
      "timestamp": "2025-04-02T06:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-008",
      "channel": "social",
      "timestamp": "2025-04-02T07:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-009",
      "channel": "paid_search",
      "timestamp": "2025-04-02T07:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-009",
      "channel": "display",
      "timestamp": "2025-04-02T08:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-009",
      "channel": "paid_search",
      "timestamp": "2025-04-02T08:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-009",
      "channel": "display",
      "timestamp": "2025-04-02T09:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-009",
      "channel": "social",
      "timestamp": "2025-04-02T09:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-010",
      "channel": "display",
      "timestamp": "2025-04-02T10:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-010",
      "channel": "display",
      "timestamp": "2025-04-02T10:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-010",
      "channel": "social",
      "timestamp": "2025-04-02T11:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-010",
      "channel": "paid_search",
      "timestamp": "2025-04-02T11:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-010",
      "channel": "paid_search",
      "timestamp": "2025-04-02T12:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-011",
      "channel": "social",
      "timestamp": "2025-04-02T12:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-011",
      "channel": "social",
      "timestamp": "2025-04-02T13:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-011",
      "channel": "social",
      "timestamp": "2025-04-02T13:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-011",
      "channel": "paid_search",
      "timestamp": "2025-04-02T14:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-011",
      "channel": "display",
      "timestamp": "2025-04-02T14:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-012",
      "channel": "paid_search",
      "timestamp": "2025-04-02T15:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-012",
      "channel": "paid_search",
      "timestamp": "2025-04-02T15:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-012",
      "channel": "paid_search",
      "timestamp": "2025-04-02T16:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-012",
      "channel": "social",
      "timestamp": "2025-04-02T16:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-012",
      "channel": "paid_search",
      "timestamp": "2025-04-02T17:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-013",
      "channel": "display",
      "timestamp": "2025-04-02T17:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-013",
      "channel": "paid_search",
      "timestamp": "2025-04-02T18:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-013",
      "channel": "email",
      "timestamp": "2025-04-02T18:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-013",
      "channel": "paid_search",
      "timestamp": "2025-04-02T19:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-013",
      "channel": "social",
      "timestamp": "2025-04-02T19:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-014",
      "channel": "email",
      "timestamp": "2025-04-02T20:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-014",
      "channel": "display",
      "timestamp": "2025-04-02T20:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-014",
      "channel": "paid_search",
      "timestamp": "2025-04-02T21:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-014",
      "channel": "display",
      "timestamp": "2025-04-02T21:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-014",
      "channel": "paid_search",
      "timestamp": "2025-04-02T22:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-015",
      "channel": "social",
      "timestamp": "2025-04-02T22:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-015",
      "channel": "paid_search",
      "timestamp": "2025-04-02T23:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-015",
      "channel": "display",
      "timestamp": "2025-04-02T23:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-015",
      "channel": "display",
      "timestamp": "2025-04-03T00:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-015",
      "channel": "paid_search",
      "timestamp": "2025-04-03T00:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-016",
      "channel": "email",
      "timestamp": "2025-04-03T01:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 1
    },
    {
      "user_id": "U-016",
      "channel": "paid_search",
      "timestamp": "2025-04-03T01:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-016",
      "channel": "email",
      "timestamp": "2025-04-03T02:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-016",
      "channel": "paid_search",
      "timestamp": "2025-04-03T02:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 1
    },
    {
      "user_id": "U-016",
      "channel": "email",
      "timestamp": "2025-04-03T03:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-017",
      "channel": "email",
      "timestamp": "2025-04-03T03:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-017",
      "channel": "paid_search",
      "timestamp": "2025-04-03T04:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-017",
      "channel": "paid_search",
      "timestamp": "2025-04-03T04:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-017",
      "channel": "display",
      "timestamp": "2025-04-03T05:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-017",
      "channel": "display",
      "timestamp": "2025-04-03T05:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-018",
      "channel": "social",
      "timestamp": "2025-04-03T06:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-018",
      "channel": "display",
      "timestamp": "2025-04-03T06:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-018",
      "channel": "email",
      "timestamp": "2025-04-03T07:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-018",
      "channel": "display",
      "timestamp": "2025-04-03T07:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-018",
      "channel": "display",
      "timestamp": "2025-04-03T08:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-019",
      "channel": "paid_search",
      "timestamp": "2025-04-03T08:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-019",
      "channel": "display",
      "timestamp": "2025-04-03T09:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-019",
      "channel": "paid_search",
      "timestamp": "2025-04-03T09:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-019",
      "channel": "paid_search",
      "timestamp": "2025-04-03T10:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-019",
      "channel": "display",
      "timestamp": "2025-04-03T10:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-020",
      "channel": "display",
      "timestamp": "2025-04-03T11:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-020",
      "channel": "display",
      "timestamp": "2025-04-03T11:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-020",
      "channel": "display",
      "timestamp": "2025-04-03T12:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-020",
      "channel": "display",
      "timestamp": "2025-04-03T12:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-020",
      "channel": "email",
      "timestamp": "2025-04-03T13:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 1
    },
    {
      "user_id": "U-021",
      "channel": "email",
      "timestamp": "2025-04-03T13:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-021",
      "channel": "social",
      "timestamp": "2025-04-03T14:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-021",
      "channel": "email",
      "timestamp": "2025-04-03T14:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-021",
      "channel": "display",
      "timestamp": "2025-04-03T15:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-021",
      "channel": "display",
      "timestamp": "2025-04-03T15:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-022",
      "channel": "paid_search",
      "timestamp": "2025-04-03T16:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-022",
      "channel": "paid_search",
      "timestamp": "2025-04-03T16:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-022",
      "channel": "display",
      "timestamp": "2025-04-03T17:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-022",
      "channel": "email",
      "timestamp": "2025-04-03T17:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-022",
      "channel": "display",
      "timestamp": "2025-04-03T18:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-023",
      "channel": "social",
      "timestamp": "2025-04-03T18:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-023",
      "channel": "email",
      "timestamp": "2025-04-03T19:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-023",
      "channel": "social",
      "timestamp": "2025-04-03T19:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-023",
      "channel": "paid_search",
      "timestamp": "2025-04-03T20:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-023",
      "channel": "social",
      "timestamp": "2025-04-03T20:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-024",
      "channel": "email",
      "timestamp": "2025-04-03T21:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-024",
      "channel": "paid_search",
      "timestamp": "2025-04-03T21:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-024",
      "channel": "email",
      "timestamp": "2025-04-03T22:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-024",
      "channel": "display",
      "timestamp": "2025-04-03T22:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-024",
      "channel": "social",
      "timestamp": "2025-04-03T23:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-025",
      "channel": "social",
      "timestamp": "2025-04-03T23:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-025",
      "channel": "email",
      "timestamp": "2025-04-04T00:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-025",
      "channel": "paid_search",
      "timestamp": "2025-04-04T00:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-025",
      "channel": "email",
      "timestamp": "2025-04-04T01:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-025",
      "channel": "email",
      "timestamp": "2025-04-04T01:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-026",
      "channel": "paid_search",
      "timestamp": "2025-04-04T02:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-026",
      "channel": "display",
      "timestamp": "2025-04-04T02:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-026",
      "channel": "social",
      "timestamp": "2025-04-04T03:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-026",
      "channel": "display",
      "timestamp": "2025-04-04T03:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-026",
      "channel": "display",
      "timestamp": "2025-04-04T04:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-027",
      "channel": "paid_search",
      "timestamp": "2025-04-04T04:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-027",
      "channel": "paid_search",
      "timestamp": "2025-04-04T05:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-027",
      "channel": "email",
      "timestamp": "2025-04-04T05:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-027",
      "channel": "social",
      "timestamp": "2025-04-04T06:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-027",
      "channel": "paid_search",
      "timestamp": "2025-04-04T06:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-028",
      "channel": "email",
      "timestamp": "2025-04-04T07:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-028",
      "channel": "display",
      "timestamp": "2025-04-04T07:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-028",
      "channel": "email",
      "timestamp": "2025-04-04T08:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-028",
      "channel": "email",
      "timestamp": "2025-04-04T08:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-028",
      "channel": "social",
      "timestamp": "2025-04-04T09:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-029",
      "channel": "social",
      "timestamp": "2025-04-04T09:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-029",
      "channel": "paid_search",
      "timestamp": "2025-04-04T10:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-029",
      "channel": "social",
      "timestamp": "2025-04-04T10:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-029",
      "channel": "display",
      "timestamp": "2025-04-04T11:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-029",
      "channel": "social",
      "timestamp": "2025-04-04T11:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-030",
      "channel": "paid_search",
      "timestamp": "2025-04-04T12:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-030",
      "channel": "paid_search",
      "timestamp": "2025-04-04T12:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-030",
      "channel": "email",
      "timestamp": "2025-04-04T13:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-030",
      "channel": "paid_search",
      "timestamp": "2025-04-04T13:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-030",
      "channel": "display",
      "timestamp": "2025-04-04T14:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-031",
      "channel": "social",
      "timestamp": "2025-04-04T14:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-031",
      "channel": "display",
      "timestamp": "2025-04-04T15:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-031",
      "channel": "social",
      "timestamp": "2025-04-04T15:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-031",
      "channel": "paid_search",
      "timestamp": "2025-04-04T16:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-031",
      "channel": "social",
      "timestamp": "2025-04-04T16:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-032",
      "channel": "social",
      "timestamp": "2025-04-04T17:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-032",
      "channel": "display",
      "timestamp": "2025-04-04T17:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-032",
      "channel": "social",
      "timestamp": "2025-04-04T18:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-032",
      "channel": "paid_search",
      "timestamp": "2025-04-04T18:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-032",
      "channel": "social",
      "timestamp": "2025-04-04T19:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-033",
      "channel": "display",
      "timestamp": "2025-04-04T19:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-033",
      "channel": "social",
      "timestamp": "2025-04-04T20:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-033",
      "channel": "paid_search",
      "timestamp": "2025-04-04T20:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-033",
      "channel": "email",
      "timestamp": "2025-04-04T21:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-033",
      "channel": "paid_search",
      "timestamp": "2025-04-04T21:30:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 1
    },
    {
      "user_id": "U-034",
      "channel": "social",
      "timestamp": "2025-04-04T22:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-034",
      "channel": "email",
      "timestamp": "2025-04-04T22:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-034",
      "channel": "social",
      "timestamp": "2025-04-04T23:00:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-034",
      "channel": "email",
      "timestamp": "2025-04-04T23:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-034",
      "channel": "display",
      "timestamp": "2025-04-05T00:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-035",
      "channel": "paid_search",
      "timestamp": "2025-04-05T00:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-035",
      "channel": "display",
      "timestamp": "2025-04-05T01:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-035",
      "channel": "paid_search",
      "timestamp": "2025-04-05T01:30:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-035",
      "channel": "display",
      "timestamp": "2025-04-05T02:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-035",
      "channel": "paid_search",
      "timestamp": "2025-04-05T02:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 1
    },
    {
      "user_id": "U-036",
      "channel": "display",
      "timestamp": "2025-04-05T03:00:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-036",
      "channel": "paid_search",
      "timestamp": "2025-04-05T03:30:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-036",
      "channel": "display",
      "timestamp": "2025-04-05T04:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-036",
      "channel": "display",
      "timestamp": "2025-04-05T04:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-036",
      "channel": "social",
      "timestamp": "2025-04-05T05:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-037",
      "channel": "email",
      "timestamp": "2025-04-05T05:30:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-037",
      "channel": "social",
      "timestamp": "2025-04-05T06:00:00Z",
      "features": {
        "device": "mobile",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-037",
      "channel": "social",
      "timestamp": "2025-04-05T06:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-037",
      "channel": "social",
      "timestamp": "2025-04-05T07:00:00Z",
      "features": {
        "device": "mobile",
        "country": "UK"
      },
      "converted": 0
    },
    {
      "user_id": "U-037",
      "channel": "social",
      "timestamp": "2025-04-05T07:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-038",
      "channel": "paid_search",
      "timestamp": "2025-04-05T08:00:00Z",
      "features": {
        "device": "desktop",
        "country": "UK"
      },
      "converted": 1
    },
    {
      "user_id": "U-038",
      "channel": "social",
      "timestamp": "2025-04-05T08:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-038",
      "channel": "paid_search",
      "timestamp": "2025-04-05T09:00:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-038",
      "channel": "paid_search",
      "timestamp": "2025-04-05T09:30:00Z",
      "features": {
        "device": "mobile",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-038",
      "channel": "social",
      "timestamp": "2025-04-05T10:00:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-039",
      "channel": "email",
      "timestamp": "2025-04-05T10:30:00Z",
      "features": {
        "device": "desktop",
        "country": "CA"
      },
      "converted": 0
    },
    {
      "user_id": "U-039",
      "channel": "email",
      "timestamp": "2025-04-05T11:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-039",
      "channel": "email",
      "timestamp": "2025-04-05T11:30:00Z",
      "features": {
        "device": "desktop",
        "country": "US"
      },
      "converted": 0
    },
    {
      "user_id": "U-039",
      "channel": "email",
      "timestamp": "2025-04-05T12:00:00Z",
      "features": {
        "device": "desktop",
        "country": "BR"
      },
      "converted": 0
    },
    {
      "user_id": "U-039",
      "channel": "email",
      "timestamp": "2025-04-05T12:30:00Z",
      "features": {
        "device": "mobile",
        "country": "CA"
      },
      "converted": 0
    }
  ]
}
```

---

### Response

```json
{
    "contributions": [
        {
            "channel": "paid_search",
            "n_events": 53,
            "raw_cr": 0.283,
            "incremental_lift": 0.632,
            "description": "↗ strong driver"
        },
        {
            "channel": "social",
            "n_events": 51,
            "raw_cr": 0.1569,
            "incremental_lift": -0.0257,
            "description": "neutral / needs test"
        },
        {
            "channel": "email",
            "n_events": 39,
            "raw_cr": 0.1282,
            "incremental_lift": -0.1928,
            "description": "↘ drag on conversions"
        },
        {
            "channel": "display",
            "n_events": 57,
            "raw_cr": 0.1053,
            "incremental_lift": -0.4127,
            "description": "↘ drag on conversions"
        }
    ],
    "global_auc": 0.6589,
    "interpretation": "Regularised logistic regression (AUC=0.659) suggests **paid_search** delivers the largest incremental lift (++0.632) across 53 touches (raw CR 28.30%). Conversely, **display** under-performs (-0.413).  Re-allocate budget accordingly."
}
```

---

### Field semantics
 
| Field              | Meaning                                                                                                                                                          |
|------------------- |----------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `raw_cr`           | Straight conversion-rate = (converted users with ≥1 touch in channel) / (all users touched by channel).                                                          |
| `incremental_lift` | Estimated average treatment effect for the channel after controlling for all supplied features. Positive → channel adds conversions, negative → it cannibalises. |
| `description`      | Quick triage tag:  
|                    |                                                                                                                             ↗ strong driver (lift > +0.15)  
|                    |                                                                                                                      neutral / needs test (-0.15 ≤ lift ≤ +0.15)  
|                    |                                                                                                                             ↘ drag on conversions (lift < -0.15) |

---

### Under the hood

- **Feature engineering** – categorical keys → one-hot; numeric passed as is.  
- **Estimator choice**  
- If `doubleml` available → DML-PLR (causal) with cross-fitted learners.  
- Otherwise → elastic-net logistic regression; coefficients are used as quasi-lifts, AUC reported.  
- **Per-channel ATE** – average marginal effect of flipping each channel flag from 0 → 1 while holding confounders fixed.  
- **Descriptions** – heuristic thresholds map lift values to 📈 / ⚖️ / 📉 tags.

---

## Practical workflow

| Step                  | Action                                                                                                                                |
|---------------------- |-------------------------------------------------------------------------------------------------------------------------------------- |
| Collect touches       | Export a week or month of unified touch-point logs from your CDP or analytics stack.                                                  |
| POST to this endpoint | Make sure the payload clears `min_events`.                                                                                            |
| Read the lift table   | Channels marked ↘ drag are candidates for creative refresh or budget cuts; ↗ strong driver ones merit more spend or experimentation. |
| Iterate               | Re-run after major campaign changes and compare `incremental_lift` deltas over time.                                                  |

---

# 4.5.4 /api/v1/ai/journey_markov

**Map drop-offs & winning paths with a Markov funnel model**

---

### Purpose 
Turns raw click-stream sessions into a tidy Markov-chain: transition probabilities, step-level abandonment, and at-a-glance optimisation cues.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/journey_markov
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

## Why you’d call it

| **Need**                                         | **What the route delivers**                                                              |
|--------------------------------------------------|-------------------------------------------------------------------------------------------|
| “Which screen leaks the most traffic?”           | `drop_off_probs` per step.                                                               |
| “What’s the chance a user who hits PDP will reach Cart?” | `transitions` array with conditional probabilities.                                      |
| “Where should the UX team start first?”          | `interpretation` auto-highlights top bottlenecks & average journey depth.                |

---

## Request payload reference

| **Path**      | **Type**       | **Required** | **Notes**                                                                                      |
|---------------|----------------|--------------|------------------------------------------------------------------------------------------------|
| `absorb_on`   | string          | ✔︎           | Label for the success state (e.g. `"Conversion"`). The model appends this as an absorbing final step. |
| `sessions[]`  | array<object>   | ✔︎           | One object = one anonymous session.                                                            |
| ↳ `session_id`| string          | ✔︎           | Only for debugging/tracing; not used in maths.                                                 |
| ↳ `steps[]`   | array<string>   | ✔︎           | Ordered list of unique page / event labels before the success step.                           |
| ↳ `converted` | 0 \| 1          | ✔︎           | 1 → funnel succeeds; 0 → session ends in implicit `"EXIT"` absorbing state.                    |

> **Tip** Include micro-events (e.g. Checkout, Payment) to inspect deeper frictions; granularity is up to you.

---

### Response (Field semantics)

| **Field**        | **Meaning**                                                                             |
|------------------|---------------------------------------------------------------------------------------- |
| `transitions[]`  | Conditional probabilities `P(next step \| current)`                                     |
| `drop_off_probs` | Probability a session terminates right after each step. 1.0 for "Conversion" or "EXIT". |
| `interpretation` | Natural-language digest – flags worst offenders, surfaces mean journey length.          |

---

### How it’s computed (under the hood)

- **Session stitching** – duplicates & loops collapsed so each step appears once per session in order.  
- **Absorbing states**  
- Success → label from `absorb_on`.  
- Failure → synthetic `"EXIT"`.  
- **Transition counts** – every adjacent pair tallied, then row-normalised → probabilities.  
- **Drop-off** – `1 − ∑ row(p)` for each non-absorbing state.  
- **Diagnostics** – mean steps, top K leak points, surfaced in `interpretation`.

---

## Typical workflow

| **Step**                      | **Action**                                                                 |
|------------------------------ |--------------------------------------------------------------------------- |
| Pull recent session logs      | Include all in-journey events (web, app, kiosk, …).                        |
| POST to `/api/journey_markov` | One call per funnel variant (e.g. device, market).                         |
| Read `drop_off_probs`         | Prioritise UX / promo tweaks where abandonment is highest.                 |
| Re-run after changes          | Compare transition deltas to confirm improvements.                         |

---

# 4.5.5 /api/v1/ai/journey_sequences

**Mine the highest-volume paths through any digital funnel**

---

### Purpose
Find every frequent sequential pattern – the journeys your visitors actually take – with straight-forward support/length controls.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/journey_sequences
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### When to use it

| **Question**                                                  | **What the route gives you**                                                   |
|-------------------------------------------------------------- |--------------------------------------------------------------------------------|
| “Which chains of screens appear most often?”                  | `frequent_paths` sorted by raw support.                                        |
| “Do visitors who start on Category differ from Search users?” | Mine separately per cohort, then compare patterns.                             |
| “What prefixes justify personalising the next suggestion?”    | Limit `max_len` to the number of steps you can react to.                       |

---

## Request payload reference

| **Path**      | **Type**         | **Required** | **Details**                                                                 |
|---------------|----------------- |--------------|-----------------------------------------------------------------------------|
| `min_support` | integer          | ✔︎           | Minimum absolute occurrences for a path to qualify.                         |
| `max_len`     | integer          | ✔︎           | Longest prefix the miner will return (to avoid combinatorial blow-up).     |
| `sessions[]`  | array<object>    | ✔︎           | One object per browsing / purchase session.                                |
| ↳ `session_id`| string           | ✔︎           | Only for tracebacks – not used in pattern mining.                          |
| ↳ `user_id`   | string           | optional     | Present if you later de-duplicate across devices.                          |
| ↳ `steps[]`   | array<string>    | ✔︎           | Ordered list of unique page / event labels.                                |
| ↳ `converted` | 0 \| 1           | optional     | Not consumed by the algorithm – but handy for downstream slicing.          |

 **Tip** Set `min_support` as a count, not a percentage – keeps intent crystal clear for stakeholders.

---

### Request

```json
// ───────────────────────────  POST  /api/journey_sequences  ───────────────────────────
//  Synthetic dataset – 200 browsing / purchase sessions
//  • min_support = 30   (every frequent-pattern we care about appears ≥30×)
//  • max_len     = 4    (longest prefix mined by the route)
//  ──────────────────────────────────────────────────────────────────────────────────────
//  Legend of common paths in this sample
//      A. Home  → Category → PDP → Cart → Conversion              (60×)
//      B. Home  → Search   → PDP → Cart → Conversion              (40×)
//      C. Home  → Category                                          (30×)  drop-off
//      D. Home  → Search   → PDP                                    (30×)  drop-off
//      E. Home                                                      (20×)  bounce
//      F. Home  → Promo    → PDP → Cart → Conversion               (20×)
//  This gives:
//      • 120 converted sessions  (A+B+F)
//      • 80 non-converted sessions (C+D+E)
//  Use it “as-is”: paste into Postman and call  /api/journey_sequences
{
  "min_support": 30,
  "max_len": 4,
  "sessions": [
    // ── 60 × Path A ───────────────────────────────────────────────
    { "session_id": "S-001", "user_id": "U-001", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-002", "user_id": "U-002", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-003", "user_id": "U-003", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-004", "user_id": "U-004", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-005", "user_id": "U-005", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-006", "user_id": "U-006", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-007", "user_id": "U-007", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-008", "user_id": "U-008", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-009", "user_id": "U-009", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-010", "user_id": "U-010", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-011", "user_id": "U-011", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-012", "user_id": "U-012", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-013", "user_id": "U-013", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-014", "user_id": "U-014", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-015", "user_id": "U-015", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-016", "user_id": "U-016", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-017", "user_id": "U-017", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-018", "user_id": "U-018", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-019", "user_id": "U-019", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-020", "user_id": "U-020", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-021", "user_id": "U-021", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-022", "user_id": "U-022", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-023", "user_id": "U-023", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-024", "user_id": "U-024", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-025", "user_id": "U-025", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-026", "user_id": "U-026", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-027", "user_id": "U-027", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-028", "user_id": "U-028", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-029", "user_id": "U-029", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-030", "user_id": "U-030", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-031", "user_id": "U-031", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-032", "user_id": "U-032", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-033", "user_id": "U-033", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-034", "user_id": "U-034", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-035", "user_id": "U-035", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-036", "user_id": "U-036", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-037", "user_id": "U-037", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-038", "user_id": "U-038", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-039", "user_id": "U-039", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-040", "user_id": "U-040", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-041", "user_id": "U-041", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-042", "user_id": "U-042", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-043", "user_id": "U-043", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-044", "user_id": "U-044", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-045", "user_id": "U-045", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-046", "user_id": "U-046", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-047", "user_id": "U-047", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-048", "user_id": "U-048", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-049", "user_id": "U-049", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-050", "user_id": "U-050", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-051", "user_id": "U-051", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-052", "user_id": "U-052", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-053", "user_id": "U-053", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-054", "user_id": "U-054", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-055", "user_id": "U-055", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-056", "user_id": "U-056", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-057", "user_id": "U-057", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-058", "user_id": "U-058", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-059", "user_id": "U-059", "steps": ["Home","Category","PDP","Cart","Conversion"] },
    { "session_id": "S-060", "user_id": "U-060", "steps": ["Home","Category","PDP","Cart","Conversion"] },

    // ── 40 × Path B ───────────────────────────────────────────────
    { "session_id": "S-061", "user_id": "U-061", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-062", "user_id": "U-062", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-063", "user_id": "U-063", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-064", "user_id": "U-064", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-065", "user_id": "U-065", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-066", "user_id": "U-066", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-067", "user_id": "U-067", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-068", "user_id": "U-068", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-069", "user_id": "U-069", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-070", "user_id": "U-070", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-071", "user_id": "U-071", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-072", "user_id": "U-072", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-073", "user_id": "U-073", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-074", "user_id": "U-074", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-075", "user_id": "U-075", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-076", "user_id": "U-076", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-077", "user_id": "U-077", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-078", "user_id": "U-078", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-079", "user_id": "U-079", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-080", "user_id": "U-080", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-081", "user_id": "U-081", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-082", "user_id": "U-082", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-083", "user_id": "U-083", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-084", "user_id": "U-084", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-085", "user_id": "U-085", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-086", "user_id": "U-086", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-087", "user_id": "U-087", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-088", "user_id": "U-088", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-089", "user_id": "U-089", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-090", "user_id": "U-090", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-091", "user_id": "U-091", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-092", "user_id": "U-092", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-093", "user_id": "U-093", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-094", "user_id": "U-094", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-095", "user_id": "U-095", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-096", "user_id": "U-096", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-097", "user_id": "U-097", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-098", "user_id": "U-098", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-099", "user_id": "U-099", "steps": ["Home","Search","PDP","Cart","Conversion"] },
    { "session_id": "S-100", "user_id": "U-100", "steps": ["Home","Search","PDP","Cart","Conversion"] },

    // ── 30 × Path C (drop-off after Category) ─────────────────────
    { "session_id": "S-101", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-102", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-103", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-104", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-105", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-106", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-107", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-108", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-109", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-110", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-111", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-112", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-113", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-114", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-115", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-116", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-117", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-118", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-119", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-120", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-121", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-122", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-123", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-124", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-125", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-126", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-127", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-128", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-129", "steps": ["Home","Category"], "converted": 0 },
    { "session_id": "S-130", "steps": ["Home","Category"], "converted": 0 },

    // ── 30 × Path D (drop-off after Search & PDP) ─────────────────
    { "session_id": "S-131", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-132", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-133", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-134", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-135", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-136", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-137", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-138", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-139", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-140", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-141", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-142", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-143", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-144", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-145", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-146", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-147", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-148", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-149", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-150", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-151", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-152", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-153", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-154", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-155", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-156", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-157", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-158", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-159", "steps": ["Home","Search","PDP"], "converted": 0 },
    { "session_id": "S-160", "steps": ["Home","Search","PDP"], "converted": 0 },

    // ── 20 × Path E (single-page bounce) ──────────────────────────
    { "session_id": "S-161", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-162", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-163", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-164", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-165", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-166", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-167", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-168", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-169", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-170", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-171", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-172", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-173", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-174", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-175", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-176", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-177", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-178", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-179", "steps": ["Home"], "converted": 0 },
    { "session_id": "S-180", "steps": ["Home"], "converted": 0 },

    // ── 20 × Path F (Promo path converts) ─────────────────────────
    { "session_id": "S-181", "user_id": "U-181", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-182", "user_id": "U-182", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-183", "user_id": "U-183", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-184", "user_id": "U-184", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-185", "user_id": "U-185", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-186", "user_id": "U-186", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-187", "user_id": "U-187", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-188", "user_id": "U-188", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-189", "user_id": "U-189", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-190", "user_id": "U-190", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-191", "user_id": "U-191", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-192", "user_id": "U-192", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-193", "user_id": "U-193", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-194", "user_id": "U-194", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-195", "user_id": "U-195", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-196", "user_id": "U-196", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-197", "user_id": "U-197", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-198", "user_id": "U-198", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-199", "user_id": "U-199", "steps": ["Home","Promo","PDP","Cart","Conversion"] },
    { "session_id": "S-200", "user_id": "U-200", "steps": ["Home","Promo","PDP","Cart","Conversion"] }
  ]
}
```

---

### Response

```json
{
    "frequent_paths": [
        {
            "path": [
                "Home"
            ],
            "support": 200
        },
        {
            "path": [
                "Home",
                "Category"
            ],
            "support": 90
        },
        {
            "path": [
                "Home",
                "Search"
            ],
            "support": 70
        },
        {
            "path": [
                "Home",
                "Search",
                "PDP"
            ],
            "support": 70
        },
        {
            "path": [
                "Home",
                "Category",
                "PDP"
            ],
            "support": 60
        },
        {
            "path": [
                "Home",
                "Category",
                "PDP",
                "Cart"
            ],
            "support": 60
        },
        {
            "path": [
                "Home",
                "Search",
                "PDP",
                "Cart"
            ],
            "support": 40
        }
    ],
    "interpretation": "Top path **Home** occurs 200×. Use these insights for funnel personalisation & next-best-action rules."
}
```

---

### Field semantics

| **Field**          | **Meaning**                                                                                                                                                               |
|--------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `frequent_paths[]` | Prefix-closed patterns up to `max_len`, sorted by support (desc). Each support is the raw count of sessions containing that exact prefix, regardless of what comes later. |
| `interpretation`   | One-sentence summary calling out the #1 pattern and an optimisation nudge.                                                                                                |

---

## Under the hood

- **Prefix tree** is built from every session.  
- **Support pruning** – branches with totals < `min_support` are discarded early.  
- **Depth limit** – traversal stops at `max_len`; deeper continuations are ignored.  
- **Sorting** – surviving prefixes returned in descending support.  
- **No association** -rule lift metrics are computed – the endpoint focuses on **volume**, making results easy to present to non-technical stakeholders.

---

## Typical workflow

| **Step**                     | **Action**                                                                                                       |
|----------------------------- |------------------------------------------------------------------------------------------------------------------|
| **Snapshot recent sessions** | Decide cut-off (week, sprint, experiment).                                                                       |
| **POST payload**             | Tune `min_support` to trim noise; adjust `max_len` if you only want short prefixes for live on-site messaging.   |
| **Scan `frequent_paths`**    | Spot dominant journeys & drop-offs.                                                                              |
| **Segment**                  | Re-run filtering by `converted`, `device`, or `campaign` to uncover segment-specific flows.                      |
| **Optimise & repeat**        | Add quick links, remove friction, then mine again to track behavioural shifts.                                   |

Turn thousands of raw click-streams into a short, data-driven to-do list for your CRO and product teams.

---

# 4.5.6 /api/v1/ai/anomaly_transactions

### Real-time transaction fraud & anomaly scoring

## Purpose 
Turns raw click-stream sessions into a tidy Markov-chain: transition probabilities, step-level abandonment, and at-a-glance optimisation cues.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST https://api.abintel.ai/api/v1/ai/anomaly_transactions
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### Why you’d hit this route

| **Question**                                    | **What the endpoint returns**                                    |
| ----------------------------------------------- | ---------------------------------------------------------------- |
| “Which transactions look fraudulent right now?” | `details[].fraud_flag = true` with raw `anomaly_score`.          |
| “How good is the model on the labelled rows?”   | `kpi.auc` (ROC-AUC on the subset that has `label`).              |
| “How many did we catch?”                        | `kpi.detected_pct` = % of all rows crossing the score threshold. |

---

### Request payload reference

| **Path**      | **Type**      | **Required** | **Notes**                                                                                  |
| ------------- | ------------- | ------------ | ------------------------------------------------------------------------------------------ |
| contamination | number (0–1)  | ✔︎           | Your guess of anomaly share. Used only to set the decision threshold.                      |
| rows[]        | array<object> | ✔︎           | One object = one transaction.                                                              |
| ↳ id          | string        | ✔︎           | Unique transaction ID for trace-back.                                                      |
| ↳ features    | object        | ✔︎           | Any helpful fields – numeric or categorical (auto one-hot encoded).                        |
| ↳ label       | 0 / 1         | optional     | 1 = confirmed fraud, 0 = confirmed legit. If absent or null, row is treated as unlabelled. |

**Tip More columns** ⇒ smarter model. Add device, merchant MCC, velocity metrics, 3-DS flag – whatever you track.

---

### Request Example

```json
{
  "contamination": 0.04,
  "rows": [
    {
      "id": "txn-001",
      "features": { "amount": 58.90, "channel": "web", "country": "BR", "hour": 17 },
      "label": 0
    },
    {
      "id": "txn-002",
      "features": { "amount": 102.15, "channel": "mobile", "country": "BR", "hour": 13 },
      "label": 0
    },
    {
      "id": "txn-003",
      "features": { "amount": 36.50, "channel": "web", "country": "US", "hour": 10 },
      "label": 0
    },
    {
      "id": "txn-004",
      "features": { "amount": 9100.00, "channel": "pos", "country": "NG", "hour": 2 },
      "label": 1
    },
    {
      "id": "txn-005",
      "features": { "amount": 4999.99, "channel": "atm", "country": "RU", "hour": 1 },
      "label": 1
    },
    {
      "id": "txn-006",
      "features": { "amount": 820.00, "channel": "mobile", "country": "BR", "hour": 23 }
    },
    {
      "id": "txn-007",
      "features": { "amount": 165.40, "channel": "web", "country": "US", "hour": 9 }
    }
  ]
}
```

---

### Response Example

```json
{
  "kpi": {
    "detected_pct": 14.29,
    "auc": 1.0
  },
  "details": [
    { "id": "txn-001", "anomaly_score": -0.12235, "fraud_flag": false },
    { "id": "txn-002", "anomaly_score": -0.13145, "fraud_flag": false },
    { "id": "txn-003", "anomaly_score": -0.13628, "fraud_flag": false },
    { "id": "txn-004", "anomaly_score": 0.00636, "fraud_flag": true },
    { "id": "txn-005", "anomaly_score": -0.02015, "fraud_flag": false },
    { "id": "txn-006", "anomaly_score": -0.09873, "fraud_flag": false },
    { "id": "txn-007", "anomaly_score": -0.13424, "fraud_flag": false }
  ],
  "interpretation": "14.29% of records flagged by IsolationForest. Threshold=-0.0000 (quantile 0.96)."
}
```

---

### Field semantics

| **Field**          | **Meaning**                                                                          |
| ------------------ | ------------------------------------------------------------------------------------ |
| `anomaly_score`    | Higher ⇒ farther from the “normal” cluster. Scaled around 0 or reconstruction error.|
| `fraud_flag`       | `true` if `anomaly_score` ≥ threshold, based on the (1 - contamination) quantile.    |
| `kpi.detected_pct` | % of all rows that were flagged (your actual anomaly rate this batch).               |
| `kpi.auc`          | Quality check on rows that have labels. Absent if none were provided.                |
| `interpretation`   | One-liner: model used, share flagged, threshold selected.                            |

---

### What happens under the hood

**Pre-processing**

* One-hot encode categoricals

* Robust-scale numerics

**Model bake-off**

* Trains: Isolation-Forest, Local-Outlier-Factor, Auto-Encoder

* Selects model with highest AUC (fallback = Isolation-Forest)

**Thresholding**

* Score distribution cut at the (1 - contamination) quantile

**Packaging**

* Returns KPIs and per-row verdicts

---

### Typical analysis workflow

| **Step** | **Action**                                                               |
| -------- | ------------------------------------------------------------------------ |
| 1        | Pipe the last N minutes/hours of transactions into the route.            |
| 2        | Sort `details` by `anomaly_score` descending – investigate from the top. |
| 3        | Feed analyst feedback back as `label` on the next call → improves `auc`. |
| 4        | Tune `contamination`: lower = stricter, higher = exploratory.            |
| 5        | Promote high-score rules to real-time block list / MFA challenge.        |

---

### Best practices

* Velocity features help! – e.g. `"txn_in_last_5min": 8` improves detection.

* Retrain periodically with fresh labels – endpoint auto-adapts to data.

* Watch `detected_pct` drift – large spikes may mean threshold or feature changes needed.

* Use `/api/anomaly_transactions` to turn raw streams into concise fraud lists – no in-house ML team required.

---

# 4.5.7 /api/v1/ai/anomaly_accounts

**Spot risky or compromised user profiles in one shot**

### Purpose
Push a batch of customer / account descriptors in, get back a ranked list of which profiles look off-pattern and the model quality on any rows you’ve already labelled.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST https://api.abintel.ai/api/v1/ai/anomaly_accounts
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### What this route answers

| **Business question**                                  | **Where to look in the response**                                 |
| ------------------------------------------------------ | ----------------------------------------------------------------- |
| “Which accounts should my trust-&-safety team review?” | `details[].fraud_flag = true` (plus `anomaly_score` for ranking). |
| “Is the model actually separating fakes from reals?”   | `kpi.auc` (ROC-AUC on the subset that has label).                 |
| “How many accounts are being flagged?”                 | `kpi.detected_pct` – share of rows above the threshold.           |

---

### Request payload schema

| **Path**      | **Type**      | **Req?** | **Description**                                                              |
| ------------- | ------------- | -------- | ---------------------------------------------------------------------------- |
| contamination | number (0–1)  | ✔︎       | Your expected % of anomalous accounts in this batch. Sets the score cut-off. |
| rows[]        | array<object> | ✔︎       | One object per account / customer.                                           |
| ↳ id          | string        | ✔︎       | Stable account identifier.                                                   |
| ↳ features    | object        | ✔︎       | Any metrics — counts, rates, booleans, categoricals (auto one-hot).          |
| ↳ label       | 0 / 1         | optional | 1 = confirmed fraud/bot, 0 = legit. Leave out if unknown.                    |

Tip More behavioural signals ≈ sharper separation.
Log-ins per day, failed payments, IP diversity, chargeback rate, last-seen device… all help.

---

### Request Example

```json
{
  "contamination": 0.05,
  "rows": [
    {
      "id": "acct-001",
      "features": {
        "age_days": 730,
        "num_logins": 120,
        "avg_txn": 45.2,
        "device_os": "ios",
        "2fa_enabled": 1
      },
      "label": 0
    },
    {
      "id": "acct-002",
      "features": {
        "age_days": 14,
        "num_logins": 75,
        "avg_txn": 3.1,
        "device_os": "android",
        "2fa_enabled": 0
      }
    },
    {
      "id": "acct-003",
      "features": {
        "age_days": 1,
        "num_logins": 350,
        "avg_txn": 0.0,
        "device_os": "windows",
        "2fa_enabled": 0
      },
      "label": 1
    },
    {
      "id": "acct-004",
      "features": {
        "age_days": 3,
        "num_logins": 280,
        "avg_txn": 999.9,
        "device_os": "linux",
        "2fa_enabled": 0
      }
    }
  ]
}
```

---

### Response Example

```json
{
  "kpi": {
    "detected_pct": 75.0,
    "auc": 0.6666666666666667
  },
  "details": [
    { "id": "acct-001", "anomaly_score": -0.0825, "fraud_flag": true },
    { "id": "acct-002", "anomaly_score": -0.0825, "fraud_flag": true },
    { "id": "acct-003", "anomaly_score": -0.0825, "fraud_flag": true },
    { "id": "acct-004", "anomaly_score": -0.0825, "fraud_flag": false }
  ],
  "interpretation": "75.0% of records flagged by LOF. Threshold=-0.0825 (quantile 0.95)."
}
```

---

### What the auc field means

| **Field** | **Meaning**                                                                                   |
| --------- | --------------------------------------------------------------------------------------------- |
| `auc`     | Area Under the ROC Curve (AUROC). Measures how well the model separates label=1 from label=0. |

---

* 0.5 → random guessing

* > 0.7 → decent separation

* > 0.9 → excellent

* Only returned if your payload has both label = 0 and label = 1 rows.


### Example:
**auc = 0.667 ⇒** the LOF model separates fraud from legit a bit better than random (66.7% of the time a fraud score is higher than a legit one).

----

### Field cheat-sheet

| **Field**          | **Meaning**                                                                                    |
| ------------------ | ---------------------------------------------------------------------------------------------- |
| `anomaly_score`    | Higher (less negative/more positive) ⇒ further from the normal cluster. Scale varies by model. |
| `fraud_flag`       | `true` if score ≥ threshold (where threshold = (1 − contamination) quantile).                  |
| `kpi.detected_pct` | % of accounts flagged in this call.                                                            |
| `kpi.auc`          | AUROC – only present with labelled data.                                                       |
| `interpretation`   | Human-readable summary of model used, share flagged, and threshold applied.                    |

---

### Behind the scenes

* Pre-processing – One-hot encoding of categoricals, robust scaling of numerics.

* Model bake-off – Isolation-Forest, Local Outlier Factor, Auto-Encoder.

* Winner = highest AUC (fallback to Isolation-Forest if no labels).

* Cut-off = score quantile (1 - contamination).

* Packaging – KPIs + verdicts returned per account.

---

### Using the output

| **Next step**                      | **Why**                                                   |
| ---------------------------------- | --------------------------------------------------------- |
| Sort by `anomaly_score` descending | Review the weirdest profiles first.                       |
| Add `label` from analyst feedback  | Improves model selection and future `auc`.                |
| Tune `contamination`               | Lower = stricter queue; higher = exploratory mode.        |
| Add richer features                | Best lever to increase recall and reduce false positives. |

---

### Bottom line:
`/api/anomaly_accounts` turns raw account metrics into a prioritized queue for your fraud ops or trust-&-safety team — no bespoke ML pipeline required.

---

# 4.5.8 /api/v1/ai/anomaly_graph

### Expose suspicious “hub” nodes in any interaction network

### Purpose
Drop an edge list (device ↔ account, IP ↔ email, wallet ↔ merchant…) and the endpoint returns which nodes sit at the abnormal centre of activity given a simple degree-based heuristic.  
The logic is pluggable – if the container finds networkx + stellargraph, it can be upgraded to deep-graph embeddings without changing your payload.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST https://api.abintel.ai/api/v1/ai/anomaly_graph  
X-Customer-Api-Id: <uuid>  
X-Secret: <secret>  
Content-Type: application/json
```

---

### What problem does this solve?

| **Question you ask**                                     | **Where the answer is**                                  |
| -------------------------------------------------------- | -------------------------------------------------------- |
| “Which accounts / devices / IPs look way too connected?” | `details[].flag == true` (rank by `anomaly_score`)       |
| “How aggressive is the cut-off?”                         | `interpretation` – shows score threshold & contamination |

---

**Common uses:**

* Mule-account rings in payments

* Botnet controller nodes in infrastructure logs

* Credential-stuffing sources that hammer many victims

---

### Request payload schema

| **Path**      | **Type**      | **Req?** | **Description**                                |
| ------------- | ------------- | -------- | ---------------------------------------------- |
| contamination | number (0–1)  | ✔︎       | Fraction of nodes to flag (top-N by degree).   |
| edges[]       | array<object> | ✔︎       | One row per interaction. Order doesn’t matter. |
| ↳ src         | string        | ✔︎       | Origin node ID.                                |
| ↳ dst         | string        | ✔︎       | Destination node ID.                           |
| ↳ weight      | number        | optional | Strength / frequency (default = 1).            |

Only need one direction. The API treats the graph as undirected unless you send `"directed": true`.

---

### Request Example

```json
{
  "contamination": 0.10,
  "edges": [
    { "src": "acct-001", "dst": "acct-002", "weight": 1 },
    { "src": "acct-002", "dst": "acct-003", "weight": 1 },
    { "src": "acct-003", "dst": "acct-004", "weight": 5 },
    { "src": "acct-003", "dst": "acct-005", "weight": 4 },
    { "src": "acct-004", "dst": "acct-006", "weight": 3 },
    { "src": "acct-004", "dst": "acct-007", "weight": 3 },
    { "src": "acct-004", "dst": "acct-008", "weight": 3 },
    { "src": "acct-002", "dst": "acct-008", "weight": 1 },
    { "src": "acct-007", "dst": "acct-001", "weight": 1 }
  ]
}
```

---

### Response Example

```json
{
  "details": [
    { "node": "acct-001", "anomaly_score": 2.0, "flag": false },
    { "node": "acct-002", "anomaly_score": 3.0, "flag": false },
    { "node": "acct-003", "anomaly_score": 10.0, "flag": false },
    { "node": "acct-004", "anomaly_score": 14.0, "flag": true },
    { "node": "acct-005", "anomaly_score": 4.0, "flag": false },
    { "node": "acct-006", "anomaly_score": 3.0, "flag": false },
    { "node": "acct-007", "anomaly_score": 4.0, "flag": false },
    { "node": "acct-008", "anomaly_score": 4.0, "flag": false }
  ],
  "interpretation": "1 nodes flagged (threshold 11.20, contamination=0.1)."
}
```

---

### Field cheat-sheet

| **Field**        | **Meaning**                                                    |
| ---------------- | -------------------------------------------------------------- |
| `anomaly_score`  | Weighted degree of the node (sum of edge weights).             |
| `flag`           | `true` if `anomaly_score` ≥ threshold.                         |
| `interpretation` | Human summary — flagged count, threshold, contamination recap. |

---

### Under the hood

* Graph build → coalesce multiple edges, treat as undirected.

* Score → `degree(node)` = Σ weights.

* Threshold → top `contamination × |V|` nodes.

* Return → sorted list descending by score.

If **stellargraph** is available, the model switches to graph-SAGE embeddings + Isolation-Forest (same API response).

---

### Using the results

| **Action**                   | **Why**                                                                  |
| ---------------------------- | ------------------------------------------------------------------------ |
| Investigate high-score nodes | They interact with many distinct entities – potential fraud/bot control. |
| Tune contamination           | `0.02` for strict review, `0.20` for broader detection sweeps.           |
| Enrich the edge list         | Add edge weights like `#transactions` or `bytes transferred`.            |
| Iterate                      | Use confirmed cases in `/api/anomaly_accounts` to blend signals.         |

---

### Take-away:
`/api/anomaly_graph` is your quick radar for over-connected nodes in any relationship graph – ideal for detecting mule hubs, spam emitters, or compromised devices without custom graph ML.

---

# 4.5.9 /api/v1/ai/sentiment_report

### Turn raw verbatims into a compact Voice-of-Customer dashboard

### Purpose Pipe in any free-text feedback (reviews, tickets, tweets, chat logs…) and the route classifies each item, rolls up weekly/daily KPIs, and highlights trending topics that deserve action.

---

### Headers `X-Customer-Api-Id`, `X-Secret`


```yaml
POST https://api.abintel.ai/api/v1/ai/sentiment_report
X-Customer-Api-Id: <uuid>  
X-Secret: <secret>  
Content-Type: application/json
```

---

### What problem does this solve?

| **You want to know**                    | **Where to look**                                              |
| --------------------------------------- | -------------------------------------------------------------- |
| “How happy are users this week?”        | `kpis.positive_pct / negative_pct`                             |
| “What keeps breaking?”                  | `kpis.top_topics[]` and `details[].key_topics`                 |
| “Which verbatims drive the score down?” | Filter `details[]` by `sentiment = negative` and sort by score |

---

### Request payload schema

| **Path**    | **Type**            | **Req?** | **Description**                                                |
| ----------- | ------------------- | -------- | -------------------------------------------------------------- |
| timeframe   | "daily" or "weekly" | ✔︎       | How the backend will group entries and calculate period dates. |
| entries[]   | array<object>       | ✔︎ (≥ 5) | Each verbatim to analyse.                                      |
| ↳ id        | string              | ✔︎       | Your unique identifier (ticket ID, tweet ID…).                 |
| ↳ timestamp | ISO-8601 date       | ✔︎       | When the feedback was created.                                 |
| ↳ text      | string              | ✔︎       | Raw message text (emojis & punctuation fine).                  |

Minimum size – at least 5 entries; bigger batches produce stabler percentages and topic extraction.

---

### Request Example

```json
{
  "timeframe": "weekly",
  "entries": [
    { "id": "rev-001", "timestamp": "2025-04-21", "text": "Checkout keeps crashing 😡" },
    { "id": "ticket-042", "timestamp": "2025-04-22", "text": "Great support, thank you!" },
    { "id": "tweet-088", "timestamp": "2025-04-23", "text": "New update rocks but battery drains fast." },
    { "id": "chat-105",  "timestamp": "2025-04-23", "text": "Please add PayPal option." },
    { "id": "fb-109",    "timestamp": "2025-04-24", "text": "App still freezes on login." }
  ]
}
```

---

### Response Example

```json
{
  "period_start": "2025-05-21",
  "period_end": "2025-05-21",
  "kpis": {
    "positive_pct": 20.0,
    "neutral_pct": 40.0,
    "negative_pct": 40.0,
    "top_topics": [
      "checkout",
      "crashing",
      "technical issues",
      "support",
      "customer service"
    ]
  },
  "details": [
    {
      "id": "rev-001",
      "sentiment": "negative",
      "emotion": "frustration",
      "score": -0.8,
      "key_topics": [
        "checkout",
        "crashing",
        "technical issues"
      ],
      "interpretation": "Score -0.80 → NEGATIVE (−1…+1). Topics: checkout, crashing, technical issues"
    },
    {
      "id": "ticket-042",
      "sentiment": "positive",
      "emotion": "gratitude",
      "score": 0.9,
      "key_topics": [
        "support",
        "customer service"
      ],
      "interpretation": "Score +0.90 → POSITIVE (−1…+1). Topics: support, customer service"
    },
    {
      "id": "tweet-088",
      "sentiment": "mixed",
      "emotion": "frustration",
      "score": 0.2,
      "key_topics": [
        "update",
        "battery life",
        "performance"
      ],
      "interpretation": "Score +0.20 → MIXED (−1…+1). Topics: update, battery life, performance"
    },
    {
      "id": "chat-105",
      "sentiment": "neutral",
      "emotion": "request",
      "score": 0.0,
      "key_topics": [
        "PayPal",
        "payment options",
        "customer request"
      ],
      "interpretation": "Score +0.00 → NEUTRAL (−1…+1). Topics: PayPal, payment options, customer request"
    },
    {
      "id": "fb-109",
      "sentiment": "negative",
      "emotion": "frustration",
      "score": -0.7,
      "key_topics": [
        "app performance",
        "login issues",
        "freezing"
      ],
      "interpretation": "Score -0.70 → NEGATIVE (−1…+1). Topics: app performance, login issues, freezing"
    }
  ],
  "interpretation": "20.0% positive vs 40.0% negative this daily. Top pain-points: checkout, crashing, technical issues."
}
```

---

### Field cheat-sheet

| **Field**                   | **Meaning**                                                           |
| --------------------------- | --------------------------------------------------------------------- |
| period_start / period_end   | Bounding dates computed from `entries[].timestamp` and `timeframe`.   |
| kpis.*_pct                  | Share of entries in each sentiment bucket (percent).                  |
| kpis.top_topics[]           | Most common key-phrases across all entries.                           |
| details[].score             | Normalised sentiment polarity (VADER / transformer blend).            |
| details[].emotion           | First-level emotion tag (e.g., frustration, joy, gratitude, request). |
| details[].key_topics[]      | Phrases auto-extracted from that entry only.                          |

---

### Under the hood

* Text normalisation → emoji→word, lower-case, URL stripping.

* Sentiment model → ensemble (VADER + RoBERTa) for polarity score.

* Emotion classifier → lightweight transformer fine-tuned on GoEmotions.

* Topic extraction → KeyBERT + POS filters + k-means clustering.

* Roll-up → period aggregation and summary generation.

Everything is stateless; resend same entries with a different timeframe for a new view (e.g., daily cut).

---

### Best-practice tips

| **Tip**                     | **Why it matters**                                                |
| --------------------------- | ----------------------------------------------------------------- |
| Batch at least \~30 entries | Topic clustering stabilises; small sets may be noisy.             |
| Retain raw emojis           | Boosts emotion detection (😡, 😍, 👍).                           |
| Feed support tags into text | E.g., `#login #bug` – appears as key topics.                      |
| Stream daily, recap weekly  | Daily alerts (`timeframe=daily`); weekly slices for exec reports. |

---

**TL;DR** – Point `/api/sentiment_report` at your feedback fire-hose to auto-grade each verbatim, roll it into easy-to-read KPIs, and instantly learn which themes shout the loudest.

---

# 4.5.10 /api/v1/ai/sentiment_realtime

### Instantly triage a single customer message

### Purpose
Use this low-latency endpoint when you need an on-the-spot read of a chat, tweet, review, or call transcript snippet. The service returns polarity, dominant emotion, extracted topics, and a helper “priority” hint so support agents can react before the user rage-quits.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST https://api.abintel.ai/api/v1/ai/sentiment_realtime
X-Customer-Api-Id: <uuid>  
X-Secret: <secret>  
Content-Type: application/json
```

---

### Payload formats

**Choose one of the two shortcuts below:**

| **Option**     | **Use-case**                             | **Required fields**            |
| -------------- | ---------------------------------------- | ------------------------------ |
| A. Plain text  | Quick ping from a bot or lightweight SDK | `text`                         |
| B. Rich record | You already store IDs / timestamps       | Either `text` or `record.text` |

---

### A Plain-text payload

```json
{
  "text": "Checkout keeps crashing 😡"
}
```

---

### B Record payload (recommended)

```json
{
  "id": "msg-1042",
  "timestamp": "2025-05-21T14:07Z",
  "text": "App freezes after every photo upload. I'm furious!",
  "metadata": {
    "customer_id": "C-987",
    "channel":     "chat",
    "ticket_id":   "TCK-2025-1042"
  }
}
```
Tip: You may omit id and timestamp; the backend autogenerates them if absent.

---

### Real-time response

```json
{
  "analysis": {
    "id":         "msg-1042",
    "sentiment":  "negative",
    "emotion":    "anger",
    "score":      -0.80,
    "key_topics": [ "app freeze", "photo upload", "frustration" ],
    "interpretation": "Score -0.80 → NEGATIVE (−1…+1 scale)."
  },
  "interpretation": "Suggested priority: HIGH."
}
```

---

### Field glossary

| **Path**                | **Meaning**                                                                           |
| ----------------------- | ------------------------------------------------------------------------------------- |
| analysis.score          | Polarity score (continuous).                                                          |
| analysis.sentiment      | Discrete bucket from score (≤ -0.3 = negative, ≥ 0.3 = positive, else neutral/mixed). |
| analysis.emotion        | Primary emotion from GoEmotions-style classifier.                                     |
| analysis.key_topics[]   | Top noun-phrases / hashtags extracted from the message.                               |
| interpretation          | Short human sentence with urgency heuristic (HIGH when negative + frustration/anger). |

---

### Under the hood

* Pre-processing – emoji mapping, spelling normalisation, language auto-detection (non-English fallback to multilingual model).

* Sentiment & emotion – distilled RoBERTa (<30 ms) delivers polarity & emotion.

* Topic extraction – KeyBERT-lite pulls 1– to 3-gram noun phrases.

* Priority rule – if score < -0.5 or contains anger/frustration, flag as HIGH.

---

### Best practices & hacks

| **Do**                           | **Why**                                          |
| -------------------------------- | ------------------------------------------------ |
| Stream every chat line           | Surfaces spikes of anger immediately.            |
| Keep emojis in place             | 😡 and ❤️ boost model accuracy.                 |
| Attach `metadata.channel`        | Enables slicing satisfaction by support channel. |
| Batch to `/api/sentiment_report` | Spot macro-trends weekly.                        |

---

**TL;DR** – Fire a single JSON with the customer’s text to `/api/sentiment_realtime`; get back polarity, emotion, topics, and a one-liner telling your agent how urgent it is.
