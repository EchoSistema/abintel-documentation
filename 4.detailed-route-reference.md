# 4.1 Customer Intelligence

**Customer Intelligence endpoints**:  
`purchasing_segmentation*`, `segmentation_report*`, `segment_hierarchy_chart`, `segment_subsegment_explore`, `segment_cluster_profiles`, `customer_segmentation`, `customer_features`, `customer_loyalty`, `customer_rfm`, `customer_clv_features`, `customer_clv_forecast`, `churn_risk`, `nps`, `churn_label`

---

## 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Purpose
Autonomously cluster customers; returns labels, centroids, KPIs, and plain-language personas.

### Headers
| Header               | Value    |
| -------------------- | -------- |
| `X-Customer-Api-Id`  | `<uuid>` |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json

Body:
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    …
  ]
}
```

#### Request Body Schema

| JSON Key             | Type              | Required | Description                                       | Notes/Formula                                    |
| -------------------- | ----------------- | -------- | ------------------------------------------------- | ------------------------------------------------ |
| `max_clusters`       | integer ≥ 2       | optional | Upper bound for K-Means & GMM                      | Recommend 8–15 for 5k–200k customers             |
| `dbscan_eps`         | float (0 < ε ≤ 1) | optional | Radius for DBSCAN after z-score scaling           | Start at 0.35–0.45                               |
| `dbscan_min_samples` | integer ≥ 3       | optional | Minimum neighbors for DBSCAN core point           | Use 5 (default); adjust for small/large datasets |
| `data`               | array<object>     | required | List of customer objects with features            | Usually from 12–18 months of transaction data    |

#### Features Inside `data[].features`

| Feature             | Type/Range  | Business Definition                            | SQL/Python Example                                       |
| ------------------- | ----------- | ---------------------------------------------- | -------------------------------------------------------- |
| `purchase_total`    | float ≥ 0   | Lifetime revenue in observation window         | `SUM(order_total)`                                       |
| `visit_frequency`   | integer ≥ 0 | Number of distinct purchase sessions           | `COUNT(DISTINCT order_date)`                             |
| `avg_ticket`        | float ≥ 0   | Average value per purchase                     | `purchase_total / NULLIF(visit_frequency,0)`             |
| `product_diversity` | integer ≥ 0 | Count of distinct product categories purchased | `COUNT(DISTINCT category_lvl1)`                          |
| `loyalty_score`     | float (0–1) | Normalized loyalty score from points or RFM    | `current_points / max_points_cap` or RFM z-score average |
| `recency_days`      | integer ≥ 0 | Days since last order                          | `DATEDIFF(CURRENT_DATE, MAX(order_date))`                |

#### Practical Data-Engineering Recipe
```sql
WITH base AS (
  SELECT
    o.customer_id,
    SUM(o.order_total) AS purchase_total,
    COUNT(DISTINCT o.order_date) AS visit_frequency,
    AVG(o.order_total) AS avg_ticket,
    COUNT(DISTINCT p.category_lvl1) AS product_diversity,
    MAX(o.order_date) AS last_order_date
  FROM orders o
  JOIN products p ON p.product_id = o.product_id
  WHERE o.order_date BETWEEN DATE_SUB(CURDATE(), INTERVAL 18 MONTH) AND CURDATE()
  GROUP BY o.customer_id
),
enriched AS (
  SELECT
    b.*,
    l.points_balance / 10000 AS loyalty_score,
    DATEDIFF(CURDATE(), b.last_order_date) AS recency_days
  FROM base b
  LEFT JOIN loyalty l ON l.customer_id = b.customer_id
)
SELECT
  JSON_OBJECT(
    'customer_id', customer_id,
    'features', JSON_OBJECT(
      'purchase_total', purchase_total,
      'visit_frequency', visit_frequency,
      'avg_ticket', avg_ticket,
      'product_diversity', product_diversity,
      'loyalty_score', ROUND(loyalty_score,2),
      'recency_days', recency_days
    )
  ) AS customer_json
FROM enriched;
```

#### Suggested Hyperparameters

| Dataset Size       | `max_clusters` | `dbscan_eps` | `dbscan_min_samples` |
| ------------------ | -------------- | ------------ | -------------------- |
| ≤ 10k customers    | 6–10           | 0.45         | 4                    |
| 10k–250k customers | 8–15           | 0.40         | 5–7                  |
| > 250k customers   | 12–25          | 0.35         | 7–10                 |

> **Tuning tip:** After first run, if silhouette < 0.35 or most points fall into one DBSCAN cluster, decrease `dbscan_eps` by 0.05 and/or increase `max_clusters` by 2–3.

#### Why Each Feature Matters
- **purchase_total / avg_ticket** – Identify whales vs. bargain shoppers  
- **visit_frequency / recency_days** – Loyalty insight (dormant vs. active)  
- **product_diversity** – Capture breadth shoppers (ideal for bundles)  
- **loyalty_score** – Engagement not reflected in transactions  

These 6 features explain ~80% of the variance in over 30 live retailers.

#### Example Response
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    },
    {
      "algorithm": "Agglomerative",
      "params": { "k": 2 },
      "silhouette": 0.6208,
      "davies_bouldin": 0.4732,
      "calinski_harabasz": 49.7456,
      "n_clusters": 2
    }
  ],
  "clusters": [...],
  "customer_labels": [...]
}
```

##### Top-level Keys

| Key                   | Type          | Meaning                                                                                          | Usage                                            |
| --------------------- | ------------- | ------------------------------------------------------------------------------------------------ | ------------------------------------------------ |
| `best_algorithm`      | string        | Model with highest silhouette / lowest Davies-Bouldin                                           | Store with run-ID for A/B testing                |
| `evaluation_metrics`  | array<object> | Benchmarks for each algorithm + params                                                          | Monitor in ML-Ops dashboards, rerun if needed    |
| `clusters`            | array<object> | Summary of each cluster: ID, size, centroids, persona labels                                     | For campaigns, loyalty tiers, product bundles    |
| `customer_labels`     | array<object> | Mapping of each `customer_id` → `cluster_id`                                                    | Join back to CRM/CDP to create audiences etc.    |

---

## 4.1.2 `/api/v1/ai/customer_features`

### Purpose
Generate a clean, analytically-ready feature vector for every customer by rolling up raw transaction rows (and any supplied loyalty metadata).

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json

{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" },
        { "transaction_id": "T-003", "date": "2025-03-29", "amount": 310.00, "product_id": "P-01" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key           | Type / Range          | Required     | Meaning                          | How to obtain / SQL formula                        |
| ------------------ | --------------------- | ------------ | -------------------------------- | -------------------------------------------------- |
| `today`            | ISO date (YYYY-MM-DD) | Optional     | Reference date for recency       | `CURRENT_DATE` or pipeline parameter               |
| `customers`        | array<object>         | Yes          | Customer snapshot list           | From daily ETL query                               |
| ↳ `customer_id`    | string                | Yes (unique) | CRM/ERP primary key              | `orders.customer_id`                               |
| ↳ `loyalty_score`  | float (0–1)           | Optional     | Precomputed loyalty or RFM score | `points / max_points_cap` or `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>         | Yes (≥1)     | Raw transaction data             | Use 12–18 months of history                        |
| ↳ `transaction_id` | string                | Yes          | Order ID                         | `orders.order_id`                                  |
| ↳ `date`           | ISO date              | Yes          | Transaction date                 | `orders.order_date`                                |
| ↳ `amount`         | float ≥ 0             | Yes          | Order total                      | `orders.order_total`                               |
| ↳ `product_id`     | string                | Yes          | SKU or category ID               | `order_items.product_id`                           |

#### Calculated Features

| Feature Key         | Formula                      | Business Interpretation         |
| ------------------- | ---------------------------- | ------------------------------- |
| `purchase_total`    | `SUM(amount)`                | Lifetime spend (GMV)            |
| `visit_frequency`   | `COUNT(transactions)`        | Number of purchase occasions    |
| `avg_ticket`        | `purchase_total / visits`    | Average basket size             |
| `product_diversity` | `COUNT(DISTINCT product_id)` | Breadth of purchase             |
| `loyalty_score`     | passed or `0.0`              | Loyalty indicator               |
| `recency_days`      | `DATEDIFF(today, MAX(date))` | Time since last purchase        |

> **Note:** All math is done exactly as above; no additional scaling.

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 1228.95,
        "visit_frequency": 3.0,
        "avg_ticket": 409.65,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

##### Response Keys Explained

| Key Path        | Type   | Meaning                 | Next-Step Usage                                              |
| --------------- | ------ | ----------------------- | ------------------------------------------------------------ |
| `customers[]`   | array  | Each entry = 1 customer | Send to `/purchasing_segmentation`, `/churn_risk`, etc.     |
| ↳ `customer_id` | string | Echoes the ID sent      | For joins with CRM/CDP                                       |
| ↳ `features`    | object | Vector of 6 KPIs        | Store in feature store or view in database                   |

> **Why these six features?**  
> They capture monetary, frequency, breadth, loyalty and time dimensions—covering > 80% of purchase-behaviour variance.

---

## 4.1.3 `/api/v1/ai/customer_loyalty`

### Purpose
Calculate a 0–1 loyalty index for every customer using weighted behavioral metrics, then bucket them into business-friendly segments.  
Default tiers: Platinum, Gold, Silver, Bronze, At-Risk.

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_loyalty
Content-Type: application/json

{
  "weights": {
    "purchase_total": 0.25,
    "visit_frequency": 0.30,
    "avg_ticket": 0.10,
    "product_diversity": 0.15,
    "recency_days": 0.20
  },
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "recency_days": 3
      }
    }
  ]
}
```

#### Response Example
```json
{
  "customers": [
    { "customer_id": "C-1001", "loyalty_score": 1.0,    "segment": "Platinum" },
    { "customer_id": "C-1002", "loyalty_score": 0.8705, "segment": "Platinum" },
    { "customer_id": "C-1003", "loyalty_score": 0.5348, "segment": "Silver"   },
    { "customer_id": "C-1004", "loyalty_score": 0.0,    "segment": "At-Risk"  }
  ],
  "summary": {
    "mean_score": 0.6013,
    "median_score": 0.7026,
    "top_decile_threshold": 0.9611,
    "segment_counts": {
      "Platinum": 2,
      "Silver":   1,
      "At-Risk":  1
    }
  }
}
```

##### Response Keys

| Key Path                    | Type        | Meaning                                  | How to Use                                           |
| --------------------------- | ----------- | ---------------------------------------- | ---------------------------------------------------- |
| `customers[].loyalty_score` | float (0–1) | Min-max weighted loyalty index (1 = best) | Feed into CRM tiers, bid multipliers, DWH exports    |
| `customers[].segment`       | enum        | Default segment tier                     | Override via `segment_thresholds` param (Q3), remap  |
| `summary.mean_score`        | float       | Average score across cohort              | Track monthly loyalty health                         |
| `summary.top_decile_threshold` | float    | 90th percentile score                    | Use as VIP threshold in campaigns                    |
| `summary.segment_counts`    | object      | Distribution across loyalty tiers        | Planning perks, rewards, support resources           |

###### Default Segments

- **Platinum:** ≥ 0.85  
- **Gold:** 0.70–0.84  
- **Silver:** 0.50–0.69  
- **Bronze:** 0.30–0.49  
- **At-Risk:** < 0.30  

---

## 4.1.4 `/api/v1/ai/customer_rfm`

### Purpose
Classic RFM (Recency-Frequency-Monetary) scoring, binned into lifecycle tiers (Champion, Loyal, At-Risk, etc.).

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_rfm
Content-Type: application/json

{
  "bins": 5,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2025-04-21", "amount": 520.55 },
        { "date": "2025-03-29", "amount": 310.00 },
        { "date": "2025-02-10", "amount": 398.40 }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key         | Type / Range   | Req.?    | Meaning                       | Guideline / SQL Derivation             |
| ---------------- | -------------- | -------- | ----------------------------- | -------------------------------------- |
| `bins`           | integer 2–10   | Optional | Number of buckets per metric  | Default = 5 (quintiles)               |
| `today`          | ISO date       | Optional | Reference date for recency    | Omit → server date                    |
| `customers`      | array<object>  | Required | List of customer transactions | Output of nightly ETL                 |
| → `customer_id`  | string         | Required | Primary key                   | `orders.customer_id`                  |
| → `transactions` | array<object>  | Required | List of order events          | 6–18 months typical                   |
| → `date`         | ISO date       | Yes      | Order date                    | —                                     |
| → `amount`       | float ≥ 0      | Yes      | Order value                   | —                                     |

#### What the API Computes

| Metric           | Formula                         |
| ---------------- | ------------------------------- |
| `recency_days`   | `DATEDIFF(today, MAX(date))`    |
| `frequency`      | `COUNT(transactions)`           |
| `monetary_total` | `SUM(amount)`                   |

#### Tier Mapping

| Tier      | Heuristic                        |
| --------- | -------------------------------- |
| Champion  | `rfm_total ≥ bins*3 – 2`         |
| Loyal     | Top 30% by total, not Champion   |
| Potential | Mid-upper band                   |
| Promising | Mid-lower band                   |
| At-Risk   | Bottom 20%                       |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "recency_days": 3,
      "frequency": 3,
      "monetary_total": 1228.95,
      "recency_score": 3,
      "frequency_score": 3,
      "monetary_score": 5,
      "rfm_class": "335",
      "rfm_total": 11,
      "rfm_tier": "Loyal",
      "interpretation": "Loyal customer – last purchase was recent, buys with high frequency and has very high spending…"
    }
  ],
  "thresholds": {
    "recency":   [66.6, 24.2, 2.6, 1.8],
    "frequency": [2.4, 2.8, 3.2, 3.6],
    "monetary":  [381.54, 567.18, 773.79, 1001.37]
  }
}
```

---

## 4.1.5 `/api/v1/ai/customer_clv_features`

### Purpose
Feature-engineer the four classic CLV metrics (frequency, recency, T, monetary_value) ± potential tier for downstream CLV modeling.

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_features
Content-Type: application/json

{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-10-12", "amount": 520.55, "cost": 312.33 },
        { "date": "2025-02-20", "amount": 398.40, "cost": 210.00 }
      ]
    }
  ]
}
```

#### Calculated Outputs

| Output Field         | Formula                                    | Notes                                            |
| -------------------- | ------------------------------------------ | ------------------------------------------------ |
| `frequency`          | `#orders − 1`                              | BG/NBD: 0 = one-time buyer                       |
| `recency`            | `days_between(first_tx, last_tx)`          | Float, in days                                   |
| `T`                  | `days_between(first_tx, today)`            | Customer age at snapshot                         |
| `monetary_value`     | `AVG(margin)` if cost present, else `AVG(amount)` |                                                    |
| `churned`            | bool                                       | True if last_tx ≤ threshold (planned feature)    |
| `clv_potential_tier` | enum (High/Medium/Low)                     | High if top 30% monetary_value & frequency ≥1     |

#### Sample Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "frequency": 1,
      "recency": 131.0,
      "T": 194.0,
      "monetary_value": 188.40,
      "churned": false,
      "clv_potential_tier": "High",
      "interpretation": "…Focus on VIP retention & upsell.",
      "explanations": { … }
    }
  ]
}
```

---

## 4.1.6 `/api/v1/ai/customer_clv_forecast`

### Purpose
Predict dollar-value CLV over 6-, 12-, 36-month horizons; auto-select best model (BG/NBD + Gamma-Gamma or GBM).

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_forecast
Content-Type: application/json

{
  "horizon_months": 6,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-01-15", "amount": 250, "cost": 140 },
        { "date": "2024-05-10", "amount": 480, "cost": 270 },
        { "date": "2024-10-12", "amount": 520, "cost": 312 },
        { "date": "2025-02-20", "amount": 398, "cost": 210 }
      ]
    }
  ]
}
```

#### Response Example
```json
{
  "best_algorithm": "GradientBoosting",
  "horizon_months": 6,
  "evaluation_mae": { "GradientBoosting": 188.0 },
  "customers": [
    {
      "customer_id": "C-1001",
      "predicted_clv": 188.0,
      "algorithm_used": "GradientBoosting",
      "clv_tier": "Low",
      "interpretation": "…Consider automated win-back.",
      "explanations": { … }
    }
  ]
}
```
**Formatando seção 4.1.7**

Parece que eu preciso fornecer a formatação em markdown da seção 4.1.7. Vou seguir o formato utilizado nas seções anteriores, incluindo todos os itens como cabeçalhos, descrição, solicitações, tabela k\_range recomendada, amostra de código, explicação da resposta, tabelas de benchmark, seção do melhor modelo, centroides, rótulos, dendrograma e muito mais. Confirmei que íamos até a seção 4.1.6 antes, então agora vou cuidar direitinho da 4.1.7, sem deixar nada de fora!

**Formatando seção 4.1.7 em markdown**

Acredito que a intenção do usuário é que eu formate a seção 4.1.7 de acordo com a estrutura markdown, sem incluir citações. Vou seguir as instruções e formatar as seções corretamente.

Vou utilizar a estrutura markdown com cada cabeçalho como solicitado e me atentar para manter tudo o mais conciso possível, sem truncar demais. Para seções com arrays grandes, como "centroids" ou "labels", vou usar elipses ou uma breve indicação dessa informação sem incluir os valores completos, para não tornar a resposta muito longa.

**Resumindo a resposta da seção 4.1.7**

Preciso resumir as chaves da resposta: benchmark, resultados do modelo, centroides, rótulos, interpretações, dendrograma, playbooks operacionais, KPI rápido, SQL, FAQ, e Próximos Passos. Vou usar tabelas e incluir um exemplo de requisição JSON. Para manter a clareza e brevidade, posso truncar partes do JSON ou usar a notação de elipses ("..."). De acordo com os padrões anteriores, vou incluir apenas os elementos principais da resposta, sem o JSON completo, garantindo que a formatação siga o formato das seções anteriores.

Pensou por 42 segundos

````markdown
## 4.1.7 `/api/v1/ai/purchasing_segmentation`

**Behavioral Clustering via Model Benchmarking**

### Purpose
Benchmark four clustering families (K-Means, Gaussian-Mixture, Agglomerative, DBSCAN); auto-select the statistically best model; return:
- **Customer-to-cluster labels**  
- **Feature-space centroids**  
- **Cluster personas** (English descriptors)  
- **Full dendrogram** for visualization  

### Headers
| Header               | Value      |
| -------------------- | ---------- |
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation
Content-Type: application/json

{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop","mouse","keyboard","monitor"] },
    … (40 items total)
  ],
  "k_range": [3, 4, 5, 6]
}
````

### Request Body Schema

| JSON Key          | Type / Range                 | Required | Meaning                                   | Best Practice                         |          |                            |                       |
| ----------------- | ---------------------------- | -------- | ----------------------------------------- | ------------------------------------- | -------- | -------------------------- | --------------------- |
| `customers`       | `array<object>`              | Yes      | One row per shopper with minimal features | Use a materialized view (6–18 months) |          |                            |                       |
| ↳ `id`            | `string` (unique)            | Yes      | Primary key from CRM                      | —                                     |          |                            |                       |
| ↳ `frequency`     | `int` ≥ 1                    | Yes      | Count of transactions                     | `COUNT(order_id)`                     |          |                            |                       |
| ↳ `amount_spent`  | `float` ≥ 0                  | Yes      | Total revenue in window                   | `SUM(order_total)`                    |          |                            |                       |
| ↳ `product_types` | `array<string>` (length ≥ 1) | Yes      | Purchased SKUs or categories              | `array_agg(DISTINCT category_lvl1)`   |          |                            |                       |
| `k_range`         | `array<int>` (3–30)          | Optional | k values to try for K-Means, GMM, Agglo   | Keep short (3–10) for performance     |          |                            |                       |
| `algorithms`      | \`array<"kmeans"             | "gmm"    | "agglo"                                   | "dbscan">\`                           | Optional | Specify algorithm families | Omit to test all four |

#### Recommended `k_range`

| Customer Base Size | Suggested `k_range` |
| ------------------ | ------------------- |
| ≤ 50k              | `[3,4,5]`           |
| 50k–250k           | `[3,4,5,6]`         |
| > 250k             | `[4,5,6,7,8]`       |

> **Tip:** Keep `k_range` short for faster benchmarking.

---

## Response Structure

```json
{
  "benchmark": [...],
  "best_model": {
    "algo": "agglo",
    "k": 3,
    "silhouette": 0.6783,
    "davies_bouldin": 0.3762,
    "n_clusters": 3
  },
  "centroids": [
    [8.81, 591.11, 1.97],
    [23.14, 2577.37, 2.29],
    [29.00, 4321.67, 4.00]
  ],
  "labels": { "C001": 2, "C002": 0, … },
  "interpretations_en": {
    "0": "31 customers, avg spend 591, 8.8 purchases/mo. Top categories: wine, cheese, diapers.",
    "1": "7 customers, avg spend 2 577, 23.1 purchases/mo. Top categories: smart-tv, soundbar, hdmi-cable.",
    "2": "2 customers, avg spend 4 322, 29.0 purchases/mo. Top categories: laptop, mouse, keyboard."
  },
  "dendrogram": { ... }
}
```

### `benchmark[]` – Algorithm Scorecard

| Field            | Meaning                                    | Good Rule-of-Thumb | Example Insight            |
| ---------------- | ------------------------------------------ | ------------------ | -------------------------- |
| `silhouette`     | Cohesion/separation (0–1, higher = better) | ≥ 0.60 = strong    | `agglo-3` scores **0.678** |
| `davies_bouldin` | Compactness (lower = better; typical 0–2)  | ≤ 0.50 = great     | `agglo-3` yields **0.376** |

### `best_model`

* **algo**: `agglo`
* **k**: 3
* **silhouette**: 0.6783
* **davies\_bouldin**: 0.3762
* **n\_clusters**: 3

### `centroids`

Array of `[frequency, amount_spent, avg_product_types]` per cluster.

### `labels`

Mapping `customer_id → cluster_id` (join to CRM).

### `interpretations_en`

Plain-language persona blurbs per cluster ID.

### `dendrogram`

Provides `linkage_matrix`, `leaf_labels`, `cluster_legend` for hierarchical charts.

| Key                | Meaning                                                      |
| ------------------ | ------------------------------------------------------------ |
| `linkage_matrix[]` | `[child1, child2, distance, sample_count]` via Ward’s method |
| `leaf_labels[]`    | Matches customers in original payload order                  |
| `cluster_legend[]` | Stats: size, avg\_spend, avg\_frequency, top\_categories     |

---

### Operational Playbooks

| Cluster ID | Persona        | Suggested Actions                            |
| ---------- | -------------- | -------------------------------------------- |
| 0          | Value Basket   | Discovery emails, lightweight upsells        |
| 1          | Power Shoppers | VIP tier, early access, high-margin bundles  |
| 2          | Tech Whales    | Dedicated CS rep, exclusive product launches |

---

### Quick KPI Interpretation

* ✅ Silhouette 0.678 + Davies-Bouldin 0.376 → **Excellent**
* ℹ️ Stick with 3 clusters unless finer granularity is needed.

---

### SQL Example to Build Payload

```sql
WITH base AS (
  SELECT
    c.id,
    c.frequency,
    c.amount_spent,
    ARRAY_AGG(DISTINCT p.category_lvl1) AS product_types
  FROM agg_customer_metrics c
  JOIN order_items oi ON oi.customer_id = c.id
  JOIN products p     ON p.product_id = oi.product_id
  WHERE c.window_start >= '2024-05-01'
  GROUP BY 1,2,3
)
SELECT JSON_BUILD_OBJECT(
  'customers', JSON_AGG(base),
  'k_range',   ARRAY[3,4,5,6]
) AS payload
FROM base;
```

---

### FAQ

| Question                           | Answer                                                                                  |
| ---------------------------------- | --------------------------------------------------------------------------------------- |
| Why only three numeric features?   | Frequency & Spend explain >70% of variance; `product_types` adds qualitative diversity. |
| What’s the 3rd value in centroids? | Avg number of unique product types per customer.                                        |
| Can I force K-Means only?          | Yes—include `"algorithms":["kmeans"]` in your payload.                                  |
| Why is DBSCAN silhouette = -1?     | Means >50% points flagged as noise; tweak `eps` or omit DBSCAN.                         |

---

**Next Step:** ▶ POST the same payload to `/api/segmentation_report_json_i18n` for a multilingual KPI + persona pack (EN/ES/PT) ready for slides, dashboards, and strategy reviews.

```
```

