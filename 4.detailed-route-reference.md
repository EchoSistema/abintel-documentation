# 4.1 Customer Intelligence

**Customer Intelligence endpoints**:  
`purchasing_segmentation*`, `segmentation_report*`, `segment_hierarchy_chart`, `segment_subsegment_explore`, `segment_cluster_profiles`, `customer_segmentation`, `customer_features`, `customer_loyalty`, `customer_rfm`, `customer_clv_features`, `customer_clv_forecast`, `churn_risk`, `nps`, `churn_label`

---

## 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Purpose
Autonomously cluster customers; returns labels, centroids, KPIs, and plain-language personas.

### Headers
| Header              | Value         |
|---------------------|--------------|
| `X-Customer-Api-Id` | `<uuid>`     |
| `X-Secret`          | `<secret>`   |
| `Content-Type`      | `application/json` |

### Request
```yml
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```
### Body:
```json
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "loyalty_score": 0.72,
        "recency_days": 15
      }
    }
  ]
}
```

#### Request Body Schema

| JSON Key             | Type              | Required | Description                                  | Notes/Formula                              |
|----------------------|-------------------|----------|----------------------------------------------|--------------------------------------------|
| `max_clusters`       | integer ≥ 2       | optional | Upper bound for K-Means & GMM                | Recommend 8–15 for 5k–200k customers       |
| `dbscan_eps`         | float (0 < ε ≤ 1) | optional | Radius for DBSCAN after z-score scaling      | Start at 0.35–0.45                         |
| `dbscan_min_samples` | integer ≥ 3       | optional | Minimum neighbors for DBSCAN core point      | Use 5 (default); adjust for dataset size   |
| `data`               | array<object>     | required | List of customer objects with features       | 12–18 months of transaction data typical   |

#### Features Inside `data[].features`

| Feature             | Type/Range   | Business Definition                          | SQL/Python Example                          |
|---------------------|--------------|----------------------------------------------|---------------------------------------------|
| `purchase_total`    | float ≥ 0    | Lifetime revenue in observation window       | `SUM(order_total)`                          |
| `visit_frequency`   | integer ≥ 0  | Number of distinct purchase sessions         | `COUNT(DISTINCT order_date)`                |
| `avg_ticket`        | float ≥ 0    | Average value per purchase                   | `purchase_total / NULLIF(visit_frequency,0)`|
| `product_diversity` | integer ≥ 0  | Count of distinct product categories         | `COUNT(DISTINCT category_lvl1)`             |
| `loyalty_score`     | float (0–1)  | Normalized loyalty score from points or RFM  | `current_points / max_points_cap`           |
| `recency_days`      | integer ≥ 0  | Days since last order                        | `DATEDIFF(CURRENT_DATE, MAX(order_date))`   |

#### Example Response
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    }
  ],
  "clusters": [],
  "customer_labels": []
}
```

#### Response Keys
| Key                   | Type          | Meaning                                         | Usage                                  |
|-----------------------|---------------|-------------------------------------------------|----------------------------------------|
| `best_algorithm`      | string        | Model with highest silhouette/lowest Davies-Bouldin | Store with run-ID for A/B testing      |
| `evaluation_metrics`  | array<object> | Benchmarks for each algorithm + params           | Monitor in ML-Ops dashboards, rerun if needed |
| `clusters`            | array<object> | Summary of each cluster: ID, size, centroids     | For campaigns, loyalty tiers, bundles  |
| `customer_labels`     | array<object> | Mapping of each `customer_id` → `cluster_id`     | Join back to CRM/CDP for audiences     |

---


## 4.1.2 `/api/v1/ai/customer_features`

### Purpose
Generate a clean, analytically-ready feature vector for every customer by rolling up raw transaction rows (and any supplied loyalty metadata).

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json
```
### Response
```json
{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key           | Type / Range          | Required     | Meaning                          | How to obtain / SQL formula                        |
|--------------------|----------------------|--------------|-----------------------------------|----------------------------------------------------|
| `today`            | ISO date (YYYY-MM-DD)| Optional     | Reference date for recency        | `CURRENT_DATE` or pipeline parameter               |
| `customers`        | array<object>        | Yes          | Customer snapshot list            | From daily ETL query                               |
| ↳ `customer_id`    | string               | Yes (unique) | CRM/ERP primary key               | `orders.customer_id`                               |
| ↳ `loyalty_score`  | float (0–1)          | Optional     | Precomputed loyalty or RFM score  | `points / max_points_cap` or `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>        | Yes (≥1)     | Raw transaction data              | Use 12–18 months of history                        |
| ↳ `transaction_id` | string               | Yes          | Order ID                          | `orders.order_id`                                  |
| ↳ `date`           | ISO date             | Yes          | Transaction date                  | `orders.order_date`                                |
| ↳ `amount`         | float ≥ 0            | Yes          | Order total                       | `orders.order_total`                               |
| ↳ `product_id`     | string               | Yes          | SKU or category ID                | `order_items.product_id`                           |

#### Calculated Features

| Feature Key         | Formula                      | Business Interpretation         |
|---------------------|-----------------------------|---------------------------------|
| `purchase_total`    | `SUM(amount)`                | Lifetime spend (GMV)            |
| `visit_frequency`   | `COUNT(transactions)`        | Number of purchase occasions    |
| `avg_ticket`        | `purchase_total / visits`    | Average basket size             |
| `product_diversity` | `COUNT(DISTINCT product_id)` | Breadth of purchase             |
| `loyalty_score`     | passed or `0.0`              | Loyalty indicator               |
| `recency_days`      | `DATEDIFF(today, MAX(date))` | Time since last purchase        |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 918.95,
        "visit_frequency": 2.0,
        "avg_ticket": 459.48,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

#### Response Keys

| Key Path        | Type   | Meaning                 | Usage                                   |
|-----------------|--------|-------------------------|-----------------------------------------|
| `customers[]`   | array  | Each entry = 1 customer | Send to `/purchasing_segmentation`, etc.|
| ↳ `customer_id` | string | Echoes the ID sent      | For joins with CRM/CDP                  |
| ↳ `features`    | object | Vector of 6 KPIs        | Store in feature store or DB            |

> **Why these six features?**  
> They capture monetary, frequency, breadth, loyalty and time dimensions—covering > 80% of purchase-behaviour variance.

---

## 4.1.3 `/api/v1/ai/customer_loyalty`

### Purpose
Calculate a 0–1 loyalty index for every customer using weighted behavioral metrics, then bucket them into business-friendly segments.  
Default tiers: Platinum, Gold, Silver, Bronze, At-Risk.

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_loyalty
Content-Type: application/json

{
  "weights": {
    "purchase_total": 0.25,
    "visit_frequency": 0.30,
    "avg_ticket": 0.10,
    "product_diversity": 0.15,
    "recency_days": 0.20
  },
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "recency_days": 15
      }
    }
  ]
}
```

#### Example Response
```json
{
  "customers": [
    { "customer_id": "C-1001", "loyalty_score": 1.0,    "segment": "Platinum" },
    { "customer_id": "C-1002", "loyalty_score": 0.87,   "segment": "Platinum" }
  ],
  "summary": {
    "mean_score": 0.94,
    "median_score": 0.94,
    "top_decile_threshold": 0.98,
    "segment_counts": {
      "Platinum": 2,
      "Silver":   0,
      "At-Risk":  0
    }
  }
}
```

#### Response Keys

| Key Path                       | Type        | Meaning                                    | Usage                                          |
|--------------------------------|-------------|--------------------------------------------|------------------------------------------------|
| `customers[].loyalty_score`    | float (0–1) | Min-max weighted loyalty index (1 = best)  | Feed into CRM tiers, bid multipliers, exports  |
| `customers[].segment`          | enum        | Default segment tier                       | Override via `segment_thresholds`, remap       |
| `summary.mean_score`           | float       | Average score across cohort                | Track monthly loyalty health                   |
| `summary.top_decile_threshold` | float       | 90th percentile score                      | Use as VIP threshold in campaigns              |
| `summary.segment_counts`       | object      | Distribution across loyalty tiers          | Planning perks, rewards, support resources     |

**Default Segments:**  
- **Platinum:** ≥ 0.85  
- **Gold:** 0.70–0.84  
- **Silver:** 0.50–0.69  
- **Bronze:** 0.30–0.49  
- **At-Risk:** < 0.30  

---
## 4.1.4 `/api/v1/ai/customer_rfm`

### Purpose
Classic RFM (Recency-Frequency-Monetary) scoring, binned into lifecycle tiers (Champion, Loyal, At-Risk, etc.).

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_rfm
Content-Type: application/json

{
  "bins": 5,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2025-04-21", "amount": 520.55 },
        { "date": "2025-03-29", "amount": 310.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2025-01-05", "amount": 120.00 },
        { "date": "2024-12-19", "amount": 75.90 }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key         | Type / Range   | Required | Meaning                       | Guideline / SQL Derivation     |
|------------------|----------------|----------|-------------------------------|-------------------------------|
| `bins`           | integer 2–10   | Optional | Number of buckets per metric  | Default = 5 (quintiles)       |
| `today`          | ISO date       | Optional | Reference date for recency    | Omit → server date            |
| `customers`      | array<object>  | Required | List of customer transactions | Output of nightly ETL         |
| ↳ `customer_id`  | string         | Required | Primary key                   | `orders.customer_id`          |
| ↳ `transactions` | array<object>  | Required | List of order events          | 6–18 months typical           |
| ↳ `date`         | ISO date       | Yes      | Order date                    | —                             |
| ↳ `amount`       | float ≥ 0      | Yes      | Order value                   | —                             |

#### Calculated Metrics

| Metric           | Formula                         |
|------------------|---------------------------------|
| `recency_days`   | `DATEDIFF(today, MAX(date))`    |
| `frequency`      | `COUNT(transactions)`           |
| `monetary_total` | `SUM(amount)`                   |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "recency_days": 3,
      "frequency": 2,
      "monetary_total": 830.55,
      "recency_score": 5,
      "frequency_score": 4,
      "monetary_score": 5,
      "rfm_class": "545",
      "rfm_total": 14,
      "rfm_tier": "Champion",
      "interpretation": "Champions – recent, frequent and high-value"
    },
    {
      "customer_id": "C-1002",
      "recency_days": 109,
      "frequency": 2,
      "monetary_total": 195.9,
      "recency_score": 1,
      "frequency_score": 2,
      "monetary_score": 2,
      "rfm_class": "122",
      "rfm_total": 5,
      "rfm_tier": "At-Risk",
      "interpretation": "At-Risk – infrequent, low recent activity"
    }
  ],
  "thresholds": {
    "recency":   [66.6, 24.2, 2.6, 1.8],
    "frequency": [2.4, 2.8, 3.2, 3.6],
    "monetary":  [381.54, 567.18, 773.79, 1001.37]
  }
}
```

#### Response Keys

| Key Path            | Type      | Meaning                                   | Usage                       |
|---------------------|-----------|-------------------------------------------|-----------------------------|
| `customers[]`       | array     | Each entry = 1 customer                   | Segmentation & targeting    |
| ↳ `recency_days`    | int       | Days since last purchase                  | Recency metric              |
| ↳ `frequency`       | int       | Number of transactions                    | Frequency metric            |
| ↳ `monetary_total`  | float     | Total spent                               | Monetary metric             |
| ↳ `recency_score`   | int       | Score for recency (1–bins)                | For RFM class               |
| ↳ `frequency_score` | int       | Score for frequency (1–bins)              | For RFM class               |
| ↳ `monetary_score`  | int       | Score for monetary (1–bins)               | For RFM class               |
| ↳ `rfm_class`       | string    | Concatenation of individual scores        | For tiering/visualization   |
| ↳ `rfm_total`       | int       | Sum of scores                             | Tier mapping                |
| ↳ `rfm_tier`        | enum      | Lifecycle tier                            | Champions, Loyal, At-Risk   |
| ↳ `interpretation`  | string    | Plain-language explanation                | For business users          |
| `thresholds`        | object    | Binning cutoffs per metric                | For audit/debug             |

**Tier Mapping:**  
- **Champion:** `rfm_total ≥ bins*3 – 2`
- **Loyal:** Top 30% by total, not Champion
- **Potential:** Mid-upper band
- **Promising:** Mid-lower band
- **At-Risk:** Bottom 20%

---

## 4.1.5 `/api/v1/ai/customer_clv_features`

### Purpose
Feature-engineer the four classic CLV metrics (frequency, recency, T, monetary_value) ± potential tier for downstream CLV modeling.

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_features
Content-Type: application/json

{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-10-12", "amount": 520.55, "cost": 312.33 },
        { "date": "2025-02-20", "amount": 398.40, "cost": 210.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2024-09-05", "amount": 300.00, "cost": 180.00 },
        { "date": "2025-01-17", "amount": 250.00, "cost": 150.00 }
      ]
    }
  ]
}
```

#### Calculated Outputs

| Output Field         | Formula                                    | Notes                                            |
|----------------------|--------------------------------------------|--------------------------------------------------|
| `frequency`          | `#orders − 1`                              | BG/NBD: 0 = one-time buyer                       |
| `recency`            | `days_between(first_tx, last_tx)`          | Float, in days                                   |
| `T`                  | `days_between(first_tx, today)`            | Customer age at snapshot                         |
| `monetary_value`     | `AVG(margin)` if cost present, else `AVG(amount)` |                                                  |
| `churned`            | bool                                       | True if last_tx ≤ threshold (planned feature)    |
| `clv_potential_tier` | enum (High/Medium/Low)                     | High if top 30% monetary_value & frequency ≥1    |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "frequency": 1,
      "recency": 131.0,
      "T": 194.0,
      "monetary_value": 188.40,
      "churned": false,
      "clv_potential_tier": "High",
      "interpretation": "…Focus on VIP retention & upsell.",
      "explanations": {}
    },
    {
      "customer_id": "C-1002",
      "frequency": 1,
      "recency": 134.0,
      "T": 200.0,
      "monetary_value": 110.00,
      "churned": false,
      "clv_potential_tier": "Medium",
      "interpretation": "…Consistent buyer, nurture with offers.",
      "explanations": {}
    }
  ]
}
```

#### Response Keys

| Key Path                  | Type        | Meaning                                | Usage                            |
|---------------------------|-------------|----------------------------------------|----------------------------------|
| `customers[]`             | array       | Each entry = 1 customer                | Segmentation, CLV modeling       |
| ↳ `customer_id`           | string      | Customer identifier                    | Join with CRM/CDP                |
| ↳ `frequency`             | int         | Number of repeat purchases             | For BG/NBD/CLV models            |
| ↳ `recency`               | float       | Days between first and last purchase   | For BG/NBD/CLV models            |
| ↳ `T`                     | float       | Days between first purchase and today  | For BG/NBD/CLV models            |
| ↳ `monetary_value`        | float       | Average margin or amount               | For Gamma-Gamma, CLV tiers       |
| ↳ `churned`               | bool        | Customer churn flag                    | Retargeting, risk analysis       |
| ↳ `clv_potential_tier`    | enum        | CLV potential segment                  | For targeting, dashboard         |
| ↳ `interpretation`        | string      | Business-focused summary               | For reporting, insights          |
| ↳ `explanations`          | object      | Explainable AI breakdowns              | For explainability/audit         |

---

## 4.1.6 `/api/v1/ai/customer_clv_forecast`

### Purpose
Predict dollar-value CLV over 6-, 12-, 36-month horizons; auto-select best model (BG/NBD + Gamma-Gamma or GBM).

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_forecast
Content-Type: application/json

{
  "horizon_months": 6,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-01-15", "amount": 250, "cost": 140 },
        { "date": "2024-05-10", "amount": 480, "cost": 270 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2024-02-20", "amount": 350, "cost": 220 },
        { "date": "2024-06-18", "amount": 500, "cost": 320 }
      ]
    }
  ]
}
```

#### Example Response
```json
{
  "best_algorithm": "GradientBoosting",
  "horizon_months": 6,
  "evaluation_mae": { "GradientBoosting": 188.0 },
  "customers": [
    {
      "customer_id": "C-1001",
      "predicted_clv": 188.0,
      "algorithm_used": "GradientBoosting",
      "clv_tier": "Low",
      "interpretation": "…Consider automated win-back.",
      "explanations": {}
    },
    {
      "customer_id": "C-1002",
      "predicted_clv": 225.0,
      "algorithm_used": "GradientBoosting",
      "clv_tier": "Medium",
      "interpretation": "…Consistent spender, nurture with loyalty offers.",
      "explanations": {}
    }
  ]
}
```

#### Response Keys

| Key Path                         | Type        | Meaning                                                  | Usage                                   |
|-----------------------------------|-------------|----------------------------------------------------------|-----------------------------------------|
| `best_algorithm`                  | string      | Model with best performance                              | For ML/Ops and reporting                |
| `horizon_months`                  | int         | Forecast window in months                                | Align with business planning            |
| `evaluation_mae`                  | object      | Mean absolute error per algorithm                        | Model selection/monitoring              |
| `customers[].predicted_clv`       | float       | Predicted CLV value for given horizon                    | Use in segmentation, targeting, etc     |
| `customers[].clv_tier`            | enum        | Tier (Low/Medium/High) based on predicted CLV            | For campaign targeting                  |
| `customers[].interpretation`      | string      | Plain-language business summary                          | For executive dashboards                |

---

## 4.1.7 `/api/v1/ai/purchasing_segmentation`

### Purpose
Benchmark four clustering families (K-Means, Gaussian-Mixture, Agglomerative, DBSCAN); auto-select the statistically best model; return:
- **Customer-to-cluster labels**
- **Feature-space centroids**
- **Cluster personas** (English descriptors)
- **Full dendrogram** for visualization

### Headers
| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request
```http
POST https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation
Content-Type: application/json

{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse"] },
    { "id": "C002", "frequency": 5,  "amount_spent": 190.40,  "product_types": ["tea", "coffee"] }
  ],
  "k_range": [3, 4, 5, 6]
}
```

#### Request Body Schema

| JSON Key          | Type / Range                 | Required | Meaning                                   | Best Practice                         |
|-------------------|-----------------------------|----------|-------------------------------------------|---------------------------------------|
| `customers`       | array<object>               | Yes      | One row per shopper with minimal features | Use a materialized view (6–18 months) |
| ↳ `id`            | string (unique)             | Yes      | Primary key from CRM                      | —                                     |
| ↳ `frequency`     | int ≥ 1                     | Yes      | Count of transactions                     | `COUNT(order_id)`                     |
| ↳ `amount_spent`  | float ≥ 0                   | Yes      | Total revenue in window                   | `SUM(order_total)`                    |
| ↳ `product_types` | array<string> (length ≥ 1)  | Yes      | Purchased SKUs or categories              | `array_agg(DISTINCT category_lvl1)`   |
| `k_range`         | array<int> (3–30)           | Optional | k values to try for K-Means, GMM, Agglo   | Keep short (3–10) for performance     |
| `algorithms`      | array<string>               | Optional | Specify algorithm families                | Omit to run all                       |

#### Example Response
```json
{
  "benchmark": [
    {
      "algo": "agglo",
      "k": 3,
      "silhouette": 0.68,
      "davies_bouldin": 0.37
    },
    {
      "algo": "kmeans",
      "k": 3,
      "silhouette": 0.61,
      "davies_bouldin": 0.47
    }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 3,
    "silhouette": 0.68,
    "davies_bouldin": 0.37,
    "n_clusters": 3
  },
  "centroids": [
    [8.81, 591.11, 1.97],
    [23.14, 2577.37, 2.29],
    [29.00, 4321.67, 4.00]
  ],
  "labels": {
    "C001": 2,
    "C002": 0
  },
  "interpretations_en": {
    "0": "avg spend 591, 8.8 purchases/mo. Top categories: wine, cheese.",
    "1": "avg spend 2 577, 23.1 purchases/mo. Top categories: smart-tv, soundbar.",
    "2": "avg spend 4 322, 29.0 purchases/mo. Top categories: laptop, mouse."
  },
  "dendrogram": {}
}
```

#### Response Keys

| Key Path                | Type               | Meaning                                                           | Usage                                      |
|-------------------------|--------------------|-------------------------------------------------------------------|--------------------------------------------|
| `benchmark[]`           | array<object>      | Scorecard for each algorithm and k                                | Compare, monitor, tune                     |
| `best_model`            | object             | Details of the best cluster configuration                         | Model selection                            |
| `centroids[]`           | array<float[3]>    | [frequency, amount_spent, avg_product_types] per cluster          | Cluster profiling                          |
| `labels`                | object             | Mapping customer_id → cluster_id                                  | For CRM/CDP joins                          |
| `interpretations_en`    | object             | Persona blurbs per cluster ID                                     | For business storytelling                  |
| `dendrogram`            | object             | Hierarchical linkage and cluster legend (see dendrogram endpoint) | Visualization, analysis                    |

---

**Next Step:** ▶ POST the same payload to `/api/segmentation_report_json_i18n` for a multilingual KPI + persona pack (EN/ES/PT) ready for slides, dashboards, and strategy reviews.

# 4.1.8 `/api/v1/ai/purchasing_segmentation_dendrogram`  
**Rapid Hierarchical-Clustering & Dendrogram Builder**

---

## Purpose

Returns a Ward-linkage matrix, centroids, and labels using **Agglomerative Clustering** only (no K-Means/GMM/DBSCAN sweep).  
The service brute-scans `k = 2 … 10` in one pass, selects the statistically best split, and returns everything required for:
- An interactive dendrogram
- A cluster explorer UI

---

## Headers

| Header                | Value         |
|-----------------------|--------------|
| X-Customer-Api-Id     | `<uuid>`     |
| X-Secret              | `<secret>`   |
| Content-Type          | application/json |

---

## Request

**POST** `https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation_dendrogram`

### Request Body Schema

| JSON Key   | Type / Range  | Required? | Meaning         | Notes                                              |
|------------|---------------|-----------|-----------------|----------------------------------------------------|
| customers  | array         | Yes       | Customer array  | See structure below                                |

#### `customers[]` Structure

| Field         | Type / Range          | Required | Definition                    | Warehouse Derivation        |
|---------------|----------------------|----------|-------------------------------|----------------------------|
| id            | string               | Yes      | Unique customer key           | —                          |
| frequency     | int ≥ 1              | Yes      | Order count within window     | COUNT(order_id)            |
| amount_spent  | float ≥ 0            | Yes      | Revenue in selected time      | SUM(order_total)           |
| product_types | array (≥1 item)      | Yes      | Purchased SKUs/category slugs | ARRAY_AGG(DISTINCT cat_lvl1)|

> **No hyper-parameters to tune.**  
> The endpoint auto-selects optimal k (2–10) via Silhouette↑ / Davies-Bouldin↓.

#### Example Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency": 5, "amount_spent": 190.40, "product_types": ["tea", "coffee"] },
    ...
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ]
}
```

---

## Response

```json
{
  "benchmark": [
    { "algo": "agglo", "k": 2, "silhouette": 0.7077, "davies_bouldin": 0.4514 },
    { "algo": "agglo", "k": 3, "silhouette": 0.6783, "davies_bouldin": 0.3761 },
    ...
    { "algo": "agglo", "k": 10, "silhouette": 0.5709, "davies_bouldin": 0.4166 }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 2,
    "silhouette": 0.7077,
    "davies_bouldin": 0.4514,
    "n_clusters": 2
  },
  "centroids": [
    [24.44, 2964.99, 2.67],
    [8.81, 591.11, 1.97]
  ],
  "labels": {
    "C001": 0, "C002": 1, ..., "C040": 1
  },
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.59, 2.0],
      ...,
      [76.0, 77.0, 8866.56, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": ["C001", ..., "C040"],
    "cluster_legend": [
      { "cluster_id": 0, "n_customers": 9, "avg_spend": 2964.99, "avg_frequency": 24.44, "top_categories": "laptop, mouse, air-fryer" },
      { "cluster_id": 1, "n_customers": 31, "avg_spend": 591.11, "avg_frequency": 8.81, "top_categories": "wine, cheese, diapers" }
    ]
  }
}
```

---

### Response Field Details

#### `benchmark[]` – Score Sweep (`k = 2 → 10`)
- **silhouette** — Cohesion/separation (range: 0–1; higher is better)
- **davies_bouldin** — Intra/extra spread (range: 0–2; lower is better)
- Only Agglomerative entries are shown.

🏆 **Sample: `k = 2` wins with Silhouette = 0.708**

#### `best_model`
- Chosen by highest Silhouette, then lowest Davies-Bouldin.
- `algo`: Always `"agglo"`
- `k`: Cluster count chosen
- `n_clusters`: Redundant copy of `k`

#### `centroids`
- **Order:** `[frequency, amount_spent, avg_product_types]`
- **Units:** Rescaled to original
  - Cluster 0 → 24.4 transactions / 2,965 R$ / 2.7 categories
  - Cluster 1 → 8.8 transactions / 591 R$ / 2.0 categories

#### `labels`
- Dictionary: `customer_id → cluster_id` (0-based)
- Join to your CDP or feed into `/segmentation_report_json_i18n`

#### `dendrogram`
- **linkage_matrix**: SciPy-style `[child1, child2, distance, sample_count]` rows  
  Use with `scipy.cluster.hierarchy.dendrogram()` or Plotly
- **leaf_labels[]**: Customer IDs in leaf order (for hover labels)
- **cluster_legend[]**: Stats per cluster (`n`, spend, freq, top categories)  
  Display in tooltips or side panels

> 💡 **Pro Tip:**  
> Call `/api/segment_hierarchy_chart` with the full dendrogram object to get a ready-made `{nodes, links}` graph for D3 / Plotly – no extra coding needed.

---

## Commercial Interpretation Example

| Cluster | Size | Behavior | Potential Actions |
|---------|------|----------|------------------|
| 0 – “Heavy Tech & Appliance Buyers” | 9 customers <br> avg spend: 2,965 R$ | 24 tx/year, high-ticket electronics, multi-category | VIP concierge, warranty upsell, bundles |
| 1 – “Mainstream Basket Shoppers” | 31 customers <br> avg spend: 591 R$ | 9 tx/year, groceries & small goods | Subscription replenishment, cross-sell, frequency boosters |

---

## FAQ

| Question | Answer |
|----------|--------|
| Can I change the k range? | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize. |
| Why only 2 clusters when I wanted 3? | The score sweep picked k = 2 — k = 3 had lower silhouette. Use `"k_range":[3]` manually. |
| How do I plot the dendrogram quickly? | In Python:<br>```python<br>from scipy.cluster.hierarchy import dendrogram<br>dendrogram(linkage_matrix, labels=leaf_labels)<br>``` |
| What distance metric is used? | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types. |
| Payload limit? | 20 MB (~60k customers). Async bulk version coming in Q4 2025. |

---

## Next Steps

- Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration.
- Use `/purchasing_segmentation` for generating campaign-ready personas.

---

### Typical Workflow

1. **POST** `/purchasing_segmentation_dendrogram` → receive `linkage_matrix` + `labels`
2. **POST** `/segment_hierarchy_chart` → get `{nodes, links}` graph
3. Render in a React or D3 widget
4. Save labels to DB or call `/segmentation_report_json_i18n` for KPI export

**Time to insight:**  
< 1 sec for 10k shoppers on T4 GPU  
~4 sec for 40k shoppers on CPU

---

### FAQ

| Question                                  | Answer                                                                                                             |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Can I change the `k` range?**           | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize.                        |
| **Why only 2 clusters when I wanted 3?**  | The score sweep picked `k = 2` — `k = 3` had lower silhouette. Use `"k_range":[3]` manually.                       |
| **How do I plot the dendrogram quickly?** | In Python:<br>`from scipy.cluster.hierarchy import dendrogram`<br>`dendrogram(linkage_matrix, labels=leaf_labels)` |
| **What distance metric is used?**         | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types.                             |
| **Payload limit?**                        | 20 MB (\~60k customers). Async bulk version coming in Q4 2025.                                                     |

---

### Next Step

Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration, and keep using /purchasing_segmentation for generating campaign-ready personas.

---

# 4.1.9 /api/v1/ai/segment_hierarchy_chart

Turning a Raw Dendrogram into a Front-End-Ready Graph

---

### Purpose

This endpoint accepts the exact dendrogram object returned by:

`/purchasing_segmentation_dendrogram`

or `/purchasing_segmentation`

…and emits two tidy arrays:

`nodes`

`links`

`cluster_legend` (optional)

🎯 Drop these directly into D3.js, Plotly, ECharts, or a React force-graph — no parsing required.

---

### Headers

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

POST `https://api-prod.abintel.ai/api/v1/ai/segment_hierarchy_chart`

---

### Request Body Schema

| Key                | Type          | Required | Meaning                                                             |
| ------------------ | ------------- | -------- | ------------------------------------------------------------------- |
| `dendrogram`       | object        | Yes      | Raw dendrogram object (must include three sub-keys below)           |
| → `linkage_matrix` | 2-D array     | Yes      | Ward linkage rows: `[child1, child2, distance, sample_count]`       |
| → `leaf_labels`    | array<string> | Yes      | Customer IDs, ordered to match the leaf index in the linkage matrix |
| → `cluster_legend` | array<object> | Optional | Quick stats per cluster (for tooltips/side panels)                  |

⚡ Payload remains lightweight: ~20–60 KB for tens of thousands of customers.

---

### How the API Transforms the Data

1. Enumerate Leaves
Every original customer becomes a node:

`is_leaf = true`

`id = 0 → (n_leaves − 1)`

---

2. Enumerate Internal Merges
Each row in the `linkage_matrix` becomes one internal node with:

| Field      | Description                         |
| ---------- | ----------------------------------- |
| `id`       | Index starting after last leaf      |
| `distance` | Linkage distance from matrix        |
| `size`     | Number of leaves under this cluster |

---

3. Generate Links
Each merge row creates two directional edges:

| Field      | Description                                                  |
| ---------- | ------------------------------------------------------------ |
| `source`   | ID of new internal node                                      |
| `target`   | IDs of `child1` and `child2` (can be leaves or internal IDs) |
| `distance` | Copied for edge-weight mapping                               |

---

### Request

```json
{
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.5900115966796875, 2.0],
      [16.0, 34.0, 10.246950765959598, 2.0],
      [10.0, 38.0, 14.5, 2.0],
      [18.0, 33.0, 14.684114387072421, 2.0],
      [2.0, 24.0, 14.933482805184708, 2.0],
      [14.0, 20.0, 15.033296378372908, 2.0],
      [8.0, 23.0, 15.033296378372908, 2.0],
      [9.0, 22.0, 16.41102378466232, 2.0],
      [12.0, 40.0, 19.554342797373597, 3.0],
      [30.0, 41.0, 23.67840084690405, 3.0],
      [19.0, 36.0, 24.720185838561353, 2.0],
      [5.0, 31.0, 29.71684244831212, 2.0],
      [3.0, 45.0, 31.75951301054011, 3.0],
      [39.0, 47.0, 37.04603277151646, 3.0],
      [46.0, 49.0, 53.204636389447614, 5.0],
      [7.0, 43.0, 60.837535989873956, 3.0],
      [26.0, 48.0, 75.42189702647553, 4.0],
      [4.0, 35.0, 83.95602895187841, 2.0],
      [50.0, 51.0, 102.69139093644127, 4.0],
      [15.0, 53.0, 135.75478433757996, 4.0],
      [54.0, 56.0, 139.4687935795597, 9.0],
      [21.0, 57.0, 147.95607449395212, 3.0],
      [42.0, 58.0, 193.4435440607144, 6.0],
      [25.0, 29.0, 215.00232556881798, 2.0],
      [44.0, 55.0, 220.82693991432996, 5.0],
      [13.0, 37.0, 221.00452484055614, 2.0],
      [6.0, 11.0, 235.00212764994276, 2.0],
      [52.0, 60.0, 256.36800922508723, 12.0],
      [28.0, 61.0, 336.40545943552, 4.0],
      [0.0, 17.0, 401.8550746056813, 2.0],
      [32.0, 66.0, 522.3946688588159, 3.0],
      [62.0, 64.0, 537.5921954390619, 11.0],
      [63.0, 65.0, 647.7163731140352, 4.0],
      [59.0, 68.0, 743.4835774228395, 8.0],
      [70.0, 72.0, 1528.9174504219059, 7.0],
      [67.0, 71.0, 1623.9774150881199, 23.0],
      [73.0, 75.0, 2865.3048816814076, 31.0],
      [69.0, 74.0, 3076.681261272462, 9.0],
      [76.0, 77.0, 8866.563988339083, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": [
      "C001", "C002", "C003", "C004", "C005", "C006", "C007", "C008", "C009", "C010",
      "C011", "C012", "C013", "C014", "C015", "C016", "C017", "C018", "C019", "C020",
      "C021", "C022", "C023", "C024", "C025", "C026", "C027", "C028", "C029", "C030",
      "C031", "C032", "C033", "C034", "C035", "C036", "C037", "C038", "C039", "C040"
    ],
    "cluster_legend": [
      {
        "cluster_id": 0,
        "n_customers": 9,
        "avg_spend": 2964.99,
        "avg_frequency": 24.44,
        "top_categories": "laptop, mouse, air-fryer"
      },
      {
        "cluster_id": 1,
        "n_customers": 31,
        "avg_spend": 591.11,
        "avg_frequency": 8.81,
        "top_categories": "wine, cheese, diapers"
      }
    ]
  }
}
```

---

### Response

```json
{
  "nodes": [
    { "id": 0, "label": "C001", "is_leaf": true },
    { "id": 1, "label": "C002", "is_leaf": true },
    { "id": 2, "label": "C003", "is_leaf": true },
    { "id": 3, "label": "C004", "is_leaf": true },
    { "id": 4, "label": "C005", "is_leaf": true },
    { "id": 5, "label": "C006", "is_leaf": true },
    { "id": 6, "label": "C007", "is_leaf": true },
    { "id": 7, "label": "C008", "is_leaf": true },
    { "id": 8, "label": "C009", "is_leaf": true },
    { "id": 9, "label": "C010", "is_leaf": true },
    { "id": 10, "label": "C011", "is_leaf": true },
    { "id": 11, "label": "C012", "is_leaf": true },
    { "id": 12, "label": "C013", "is_leaf": true },
    { "id": 13, "label": "C014", "is_leaf": true },
    { "id": 14, "label": "C015", "is_leaf": true },
    { "id": 15, "label": "C016", "is_leaf": true },
    { "id": 16, "label": "C017", "is_leaf": true },
    { "id": 17, "label": "C018", "is_leaf": true },
    { "id": 18, "label": "C019", "is_leaf": true },
    { "id": 19, "label": "C020", "is_leaf": true },
    { "id": 20, "label": "C021", "is_leaf": true },
    { "id": 21, "label": "C022", "is_leaf": true },
    { "id": 22, "label": "C023", "is_leaf": true },
    { "id": 23, "label": "C024", "is_leaf": true },
    { "id": 24, "label": "C025", "is_leaf": true },
    { "id": 25, "label": "C026", "is_leaf": true },
    { "id": 26, "label": "C027", "is_leaf": true },
    { "id": 27, "label": "C028", "is_leaf": true },
    { "id": 28, "label": "C029", "is_leaf": true },
    { "id": 29, "label": "C030", "is_leaf": true },
    { "id": 30, "label": "C031", "is_leaf": true },
    { "id": 31, "label": "C032", "is_leaf": true },
    { "id": 32, "label": "C033", "is_leaf": true },
    { "id": 33, "label": "C034", "is_leaf": true },
    { "id": 34, "label": "C035", "is_leaf": true },
    { "id": 35, "label": "C036", "is_leaf": true },
    { "id": 36, "label": "C037", "is_leaf": true },
    { "id": 37, "label": "C038", "is_leaf": true },
    { "id": 38, "label": "C039", "is_leaf": true },
    { "id": 39, "label": "C040", "is_leaf": true },
    { "id": 40, "distance": 5.5900115966796875, "size": 2, "is_leaf": false },
    { "id": 41, "distance": 10.246950765959598, "size": 2, "is_leaf": false },
    { "id": 42, "distance": 14.5, "size": 2, "is_leaf": false },
    { "id": 43, "distance": 14.684114387072421, "size": 2, "is_leaf": false },
    { "id": 44, "distance": 14.933482805184708, "size": 2, "is_leaf": false },
    { "id": 45, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 46, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 47, "distance": 16.41102378466232, "size": 2, "is_leaf": false },
    { "id": 48, "distance": 19.554342797373597, "size": 3, "is_leaf": false },
    { "id": 49, "distance": 23.67840084690405, "size": 3, "is_leaf": false },
    { "id": 50, "distance": 24.720185838561353, "size": 2, "is_leaf": false },
    { "id": 51, "distance": 29.71684244831212, "size": 2, "is_leaf": false },
    { "id": 52, "distance": 31.75951301054011, "size": 3, "is_leaf": false },
    { "id": 53, "distance": 37.04603277151646, "size": 3, "is_leaf": false },
    { "id": 54, "distance": 53.204636389447614, "size": 5, "is_leaf": false },
    { "id": 55, "distance": 60.837535989873956, "size": 3, "is_leaf": false },
    { "id": 56, "distance": 75.42189702647553, "size": 4, "is_leaf": false },
    { "id": 57, "distance": 83.95602895187841, "size": 2, "is_leaf": false },
    { "id": 58, "distance": 102.69139093644127, "size": 4, "is_leaf": false },
    { "id": 59, "distance": 135.75478433757996, "size": 4, "is_leaf": false },
    { "id": 60, "distance": 139.4687935795597, "size": 9, "is_leaf": false },
    { "id": 61, "distance": 147.95607449395212, "size": 3, "is_leaf": false },
    { "id": 62, "distance": 193.4435440607144, "size": 6, "is_leaf": false },
    { "id": 63, "distance": 215.00232556881798, "size": 2, "is_leaf": false },
    { "id": 64, "distance": 220.82693991432996, "size": 5, "is_leaf": false },
    { "id": 65, "distance": 221.00452484055614, "size": 2, "is_leaf": false },
    { "id": 66, "distance": 235.00212764994276, "size": 2, "is_leaf": false },
    { "id": 67, "distance": 256.36800922508723, "size": 12, "is_leaf": false },
    { "id": 68, "distance": 336.40545943552, "size": 4, "is_leaf": false },
    { "id": 69, "distance": 401.8550746056813, "size": 2, "is_leaf": false },
    { "id": 70, "distance": 522.3946688588159, "size": 3, "is_leaf": false },
    { "id": 71, "distance": 537.5921954390619, "size": 11, "is_leaf": false },
    { "id": 72, "distance": 647.7163731140352, "size": 4, "is_leaf": false },
    { "id": 73, "distance": 743.4835774228395, "size": 8, "is_leaf": false },
    { "id": 74, "distance": 1528.9174504219059, "size": 7, "is_leaf": false },
    { "id": 75, "distance": 1623.9774150881199, "size": 23, "is_leaf": false },
    { "id": 76, "distance": 2865.3048816814076, "size": 31, "is_leaf": false },
    { "id": 77, "distance": 3076.681261272462, "size": 9, "is_leaf": false },
    { "id": 78, "distance": 8866.563988339083, "size": 40, "is_leaf": false }
  ],
  "links": [
    { "source": 40, "target": 1, "distance": 5.5900115966796875 },
    { "source": 40, "target": 27, "distance": 5.5900115966796875 },
    ...
  ],
  "columns": [ "source", "target", "distance" ],
  "cluster_legend": [
    {
      "cluster_id": 0,
      "n_customers": 9,
      "avg_spend": 2964.99,
      "avg_frequency": 24.44,
      "top_categories": "laptop, mouse, air-fryer"
    },
    {
      "cluster_id": 1,
      "n_customers": 31,
      "avg_spend": 591.11,
      "avg_frequency": 8.81,
      "top_categories": "wine, cheese, diapers"
    }
  ]
}
```

---

### Practical Visualisation Snippet (React + d3-hierarchy)

import { hierarchy, cluster } from 'd3-hierarchy';
import { select } from 'd3-selection';

// `nodes`, `links` fetched from the endpoint
const root = hierarchy({ children: nodes.filter(n => !n.is_leaf) })
  .sum(d => (d.is_leaf ? 1 : 0))
  .sort((a, b) => a.data.distance - b.data.distance);

cluster().size([360, 800])(root); // radial dendrogram

select(svgRef.current)
  .selectAll('line')
  .data(links)
  .join('line')
  .attr('x1', d => nodeX(d.source))
  .attr('y1', d => nodeY(d.source))
  .attr('x2', d => nodeX(d.target))
  .attr('y2', d => nodeY(d.target))
  .attr('stroke', '#999');

✅ No need to re-calculate link distances or node sizes—the service already did it.

---

### Commercial Value

| **Stakeholder**     | **Benefit**                                                               |
| ------------------- | ------------------------------------------------------------------------- |
| Merchandising teams | Drill into any branch to see what product mixes bind micro-segments       |
| Marketers           | Drag-select a cluster subtree and export the IDs for niche campaigns      |
| Data Scientists     | Visually validate cluster cohesion; spot outlier merges                   |
| CXO / Board         | Screenshot of radial dendrogram + legend panel tells a clear visual story |

---

### Performance & Limits

Supports up to 100k leaves comfortably (~1 MB JSON)

~50ms latency (parse + map) for 40k leaves on a T4 GPU (network-bound)

Internal node count = n_leaves – 1 (binary tree rule)

👉 Link count = 2 × (n_leaves – 1)

---

### FAQ

| **Question**                         | **Answer**                                                                                                                                            |
| ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| Why do edges have distance?          | To let you map **Ward distance** to stroke width/color—emphasizes similarity depth                                                                    |
| Can I request Spanish or Portuguese? | Yes—`cluster_legend` comes from the original dendrogram request; set `lang` on that call                                                              |
| What if I munged the linkage rows?   | The API checks for length = 4 and valid IDs. Invalid structures return HTTP 400                                                                       |
| We need zoomable sunburst instead    | Convert `nodes` + `links` to nested JSON (e.g., via DAG-to-tree util), or wait for:<br>`/segment_hierarchy_chart?format=sunburst` *(Q4 2025 roadmap)* |

---

### Next Step

Pin the dendrogram to your analytics portal, and let users:

Click-select a cluster

Export audience

Launch campaign — all in minutes

🧠 No Python notebooks, no crontabs required.

---

# 4.1.10 /api/v1/ai/segment_subsegment_explore

Drill-Down Micro-Segmentation Service

---

### Purpose

Take an existing segmentation (customer-to-cluster labels you've already produced) and perform a secondary, in-cluster clustering pass to reveal micro-segments with tighter behavioral alignment.

Ideal for:

Tiered loyalty perks

Hyper-personalised recommendations

“Segment-of-one” exploratory analysis

---

### Headers

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

POST `https://api-prod.abintel.ai/api/v1/ai/segment_subsegment_explore`

---

### Request Body Schema

| Key               | Type / Range  | Required? | Meaning                                      | How to Populate                                  |
| ----------------- | ------------- | --------- | -------------------------------------------- | ------------------------------------------------ |
| `customers`       | array<object> | Yes       | Customer-level feature vectors               | Re-use payload from the first-level segmentation |
| ↳ `id`            | string        | Yes       | Customer ID (CRM primary key)                | —                                                |
| ↳ `frequency`     | int           | Yes       | Orders in the analysis window                | —                                                |
| ↳ `amount_spent`  | float         | Yes       | Revenue in that same window                  | —                                                |
| ↳ `product_types` | array<string> | Yes       | Purchased categories (SKUs or slugs)         | —                                                |
| `labels`          | object        | Yes       | Mapping of `customer_id → parent cluster_id` | Use output from the previous clustering pass     |
| `target_cluster`  | int           | Optional  | Focus on one parent cluster                  | Omit to apply across all parent clusters         |
| `k_range`         | array<int>    | Optional  | Values of `k` to try during sub-clustering   | Default = `[2, 3]`                               |

---

### Algorithm Notes

Within each parent cluster:

The service applies K-Means

On z-scored numeric features:

`frequency`

`amount_spent`

`n_categories` (derived from `product_types`)

It benchmarks each `k` using:

Silhouette (↑ higher is better)

Davies-Bouldin (↓ lower is better)

The sub-cluster with the best statistical cohesion wins.

---

### Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  },   // labels from previous route
  "target_cluster": 1,          // omit to analyse every cluster
  "k_range": [2,3]              // optional sweep for sub-K-means
}
```

---

### Response

```json
{
    "subsegment_results": {
        "1": {
            "benchmark": [
                {
                    "k": 2,
                    "silhouette": 0.4934960901737213,
                    "davies_bouldin": 0.5208518741969365
                },
                {
                    "k": 3,
                    "silhouette": 0.4140159785747528,
                    "davies_bouldin": 0.4869059685396701
                }
            ],
            "best_k": 2,
            "selection_description": "Inside parent-cluster 1, k = 2 yielded the highest silhouette (0.493) and lowest Davies-Bouldin (0.521).",
            "metric_explanation": {
                "silhouette": "Ranges −1…1; closer to 1 means dense & well-separated.",
                "davies_bouldin": "Lower is better; 0 indicates perfect separation."
            },
            "nested_centroids": {
                "columns": [
                    "frequency",
                    "amount_spent",
                    "n_categories"
                ],
                "values": [
                    [
                        21.5,
                        2223.5,
                        1.75
                    ],
                    [
                        25.33333396911621,
                        3049.199951171875,
                        3.0
                    ]
                ]
            },
            "nested_labels": {
                "C007": 1,
                "C012": 1,
                "C014": 0,
                "C026": 0,
                "C030": 0,
                "C033": 1,
                "C038": 0
            },
            "nested_cluster_legend": [
                {
                    "cluster_id": 0,
                    "n_customers": 4,
                    "avg_spend": 2223.5,
                    "avg_frequency": 21.5,
                    "top_categories": "fitness-watch, fridge, water-filter"
                },
                {
                    "cluster_id": 1,
                    "n_customers": 3,
                    "avg_spend": 3049.2,
                    "avg_frequency": 25.33,
                    "top_categories": "smart-tv, soundbar, hdmi-cable"
                }
            ],
            "nested_interpretations_en": {
                "0": "4 customers, avg spend 2,224, 21.5 purchases/mo. Top categories: fitness-watch, fridge, water-filter.",
                "1": "3 customers, avg spend 3,049, 25.3 purchases/mo. Top categories: smart-tv, soundbar, hdmi-cable."
            }
        }
    }
}
```

---

### Key Objects Explained

| **Path**                          | **Meaning**                                         | **Typical Use**                    |
| --------------------------------- | --------------------------------------------------- | ---------------------------------- |
| `benchmark[]`                     | How each `k` performed                              | Show in a dashboard or notebook    |
| `best_k`, `selection_description` | Why the micro-cluster count was chosen              | Traceability / governance          |
| `nested_centroids`                | Raw feature means for sub-clusters                  | Tooltip metrics in BI tools        |
| `nested_labels`                   | `customer_id → sub_cluster_id` (for target cluster) | Push to CRM for hyper-targeting    |
| `nested_cluster_legend`           | Quick KPIs & top categories per sub-segment         | Helps marketers name the segments  |
| `nested_interpretations_en`       | Plain-English persona blurbs                        | Paste into campaigns or PowerPoint |

---

### Commercial Playbooks

| **Scenario**                                                                           | **How Micro-Segments Help**                 | **KPI Lift Seen**     |
| -------------------------------------------------------------------------------------- | ------------------------------------------- | --------------------- |
| High-value tech buyers split into “Smart-TV addicts” vs “Fitness-watch early adopters” | Tailor product recommendations and creative | **+18%** email CTR    |
| Bulk grocery shoppers split into “Organic enthusiasts” vs “Family staples”             | Personalise coupon bundles; adjust margin   | **+7%** basket margin |
| At-risk low spenders further split by category affinity                                | Deliver category-specific win-back offers   | **−4 pp** churn       |

---

### Best-Practice Workflow

1. Call /purchasing_segmentation (or /purchasing_segmentation_dendrogram) and store the labels.

2. Identify the parent cluster to drill into (e.g., largest size, highest CLV, etc.).

3. POST to /segment_subsegment_explore with the target_cluster.

4. Merge the sub-cluster labels back into your customer master table:

UPDATE crm.customers c
SET sub_cluster = l.nested_id
FROM nested_labels l
WHERE l.customer_id = c.id;

5. Trigger personalized campaigns, dynamic content, or inventory actions based on micro-segment tags.

---

### FAQ

| **Question**                        | **Answer**                                                                                                         |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| Can I explore all clusters at once? | Yes — omit `target_cluster`; service returns one object per cluster in `subsegment_results`.                       |
| Why only K-Means?                   | Speed — K-Means is deterministic and \~20× faster at small sizes. Use `/purchasing_segmentation` for richer algos. |
| What about categorical features?    | The API auto one-hots the **top 50 product\_types** to reflect category overlap in clustering.                     |
| Payload limit?                      | 20 MB (\~60,000 customers). Bulk async version planned for **Q4 2025**.                                            |

---

### Next Step
Feed the micro-segment labels into your personalisation engine, or re-run /segment_hierarchy_chart scoped to the parent cluster for an interactive explorer down to “segment-of-five” granularity.

---

# 4.1.11 /api/v1/ai/segment_cluster_profiles

Roll-Up KPI Portraits for Each Cluster

---

### Purpose

Transform a raw customer → cluster mapping + base features into C-level summary cards that answer:

“How big is each segment, what do they buy, how valuable are they, and what should we do next?”

---

### Headers

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request

POST `https://api-prod.abintel.ai/api/v1/ai/segment_cluster_profiles`

---

### Request Body Schema

| Key               | Type          | Required? | Meaning                                          | How to Gather                                      |
| ----------------- | ------------- | --------- | ------------------------------------------------ | -------------------------------------------------- |
| `customers`       | array<object> | Yes       | Feature block used across segmentation endpoints | Materialized view of analysis window (6–18 months) |
| ↳ `id`            | string        | Yes       | CRM primary key                                  | —                                                  |
| ↳ `frequency`     | int           | Yes       | Number of orders in analysis window              | —                                                  |
| ↳ `amount_spent`  | float         | Yes       | Total revenue in window                          | —                                                  |
| ↳ `product_types` | array<string> | Yes       | Purchased categories or SKU slugs                | —                                                  |
| `labels`          | object        | Yes       | Mapping `customer_id → cluster_id`               | Use your selected segmentation model output        |

---

⚙️ No hyper-parameters, no pagination — this service acts as a pure aggregation layer for summarizing segment-level KPIs.

---

### Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  }
}
```

---

### Response

```json
{
    "cluster_profiles": [
        {
            "cluster_id": 0,
            "n_customers": 31,
            "avg_spend": 591.11,
            "median_spend": 540.0,
            "avg_frequency": 8.81,
            "top_categories": "wine, cheese, diapers, sd-card, office-chair",
            "share_of_revenue_pct": 40.71,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 1,
            "n_customers": 7,
            "avg_spend": 2577.37,
            "median_spend": 2560.0,
            "avg_frequency": 23.14,
            "top_categories": "smart-tv, soundbar, hdmi-cable, tablet, stylus",
            "share_of_revenue_pct": 40.08,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 2,
            "n_customers": 2,
            "avg_spend": 4321.68,
            "median_spend": 4321.68,
            "avg_frequency": 29.0,
            "top_categories": "laptop, mouse, keyboard, monitor, gaming-pc",
            "share_of_revenue_pct": 19.2,
            "insight": "Growth-potential segment"
        }
    ]
}
```

---

### Cluster Profile Fields

| **Field**              | **Formula / Derivation**                                                                                           | **What It Tells You**     | **Action Trigger**            |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------- | ----------------------------- |
| `cluster_id`           | Echo of your original label                                                                                        | —                         | Key for joins                 |
| `n_customers`          | `COUNT(*)` in cluster                                                                                              | Segment size              | Gauge campaign reach          |
| `avg_spend`            | `AVG(amount_spent)` (in R\$)                                                                                       | Mean value per customer   | Compare to CAC & LTV goals    |
| `median_spend`         | 50th percentile spend                                                                                              | Robust to outliers        | Pricing & discount policy     |
| `avg_frequency`        | `AVG(frequency)` (orders per period)                                                                               | Purchase cadence          | Trigger replenishment flows   |
| `top_categories`       | TF-IDF on `product_types`, top-5 slugs                                                                             | Category affinity         | Creative for ads / email hero |
| `share_of_revenue_pct` | `SUM(amount_spent_cluster) / SUM(amount_spent_total) × 100`                                                        | Revenue weight of segment | Resource allocation           |
| `insight`              | Auto rule-based narrative:                                                                                         | Quick business cue        | Slot into slide decks         |
|                        | If `avg_spend > pop_mean` **and** `share_of_revenue_pct ≥ 30%` ⇒ "Retention & upsell"<br>Else ⇒ "Growth-potential" |                           |                               |

---

### KPI Example – What It Means

| **Cluster**                        | **Portrait**                                              | **Recommended Playbook**                         |
| ---------------------------------- | --------------------------------------------------------- | ------------------------------------------------ |
| `0 – “Mainstream Basket Shoppers”` | 31 cust · 8.8 orders · 591 R\$ avg spend · 41% of revenue | Frequency boosters, cross-sell snacks & CPG      |
| `1 – “Power Electronics Buyers”`   | 7 cust · 23 orders · 2,577 R\$ avg spend · 40% of revenue | VIP concierge, extended warranty, bundle deals   |
| `2 – “Tech Whales”`                | 2 cust · 29 orders · 4,322 R\$ avg spend · 19% of revenue | Dedicated account manager, early-access launches |

---

### Quick SQL Example to Recreate `labels` Join

WITH base AS (
  SELECT c.id, c.cluster_id, f.amount_spent, f.frequency, f.product_types
  FROM crm.customers c
  JOIN api_labels   l ON l.customer_id = c.id         -- mapping from earlier
  JOIN fact_cust_agg f ON f.customer_id = c.id        -- your feature table
)
SELECT
  cluster_id,
  COUNT(*)                    AS n_customers,
  AVG(amount_spent)           AS avg_spend,
  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount_spent) AS median_spend,
  AVG(frequency)              AS avg_frequency,
  ARRAY_TO_STRING(
      ARRAY_SLICE( -- top 5 TF-IDF slugs
         (SELECT slug FROM UNNEST(tfidf_top(product_types)) LIMIT 5),
         1, 5), ', ')          AS top_categories
FROM base
GROUP BY cluster_id;

---

### Commercial Benefits

1. One-click persona cards – Drop `cluster_profiles` into Confluence, Notion, or PDFs.

2. Revenue skew insight – Identify segments that punch above their weight.

3. Creative brief generator – Use `top_categories` + `insight` for instant copy cues.

4. Board dashboards – Share KPIs without exposing `customer-level` data.

---

### FAQ

| **Question**                        | **Answer**                                                                                                 |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| Why both `avg` and `median_spend`?  | Median cushions long-tail outliers; average shows total value for LTV calculations.                        |
| Can I get CLV or churn per cluster? | Yes — join this output with `/customer_clv_forecast` or `/churn_risk` by `customer_id`, then re-aggregate. |
| How many top categories?            | Fixed at 5 for now. Future param: `top_n_categories` coming in v1.8.                                       |
| What languages are supported?       | Currently only English for `insight`. i18n support is expected in Q4 2025.                                 |

---

### Next Step

Embed cluster_profiles in your marketing playbook,
Allocate budget by share_of_revenue_pct,
Tailor creatives using top_categories for each persona.

---

# 4.1.12 /api/v1/ai/segmentation_report_json?lang=en

End-to-End Narrative Generator

---

### Purpose

This endpoint takes the raw artefacts from the segmentation engine—such as:

`customers`

`labels`

`dendrogram`

…and returns a fully-synthetic narrative report in JSON format, including:

Executive summary

Cluster-level KPIs

Marketing guidance

Ready-to-paste slide copy

---

### The output is 100% machine-written but reads like a polished analyst deck, ideal for:

Auto-publishing in BI dashboards

Automated PowerPoint generation

Auto-reply reports to stakeholders

---

### Headers `X-Customer-Api-Id`, `X-Secret`

POST  `https://api-prod.abintel.ai/api/v1/ai/segmentation_report_json?lang=en`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Request Body Schema

| **Key**      | **Type**      | **Required?**              | **Meaning**                                            | **Typical Source**                                 |
| ------------ | ------------- | -------------------------- | ------------------------------------------------------ | -------------------------------------------------- |
| `customers`  | array<object> | Yes                        | Same feature block used everywhere                     | Materialized view or the last segmentation payload |
| `labels`     | object        | Yes                        | Mapping `customer_id → cluster_id`                     | From `/purchasing_segmentation`                    |
| `dendrogram` | object        | Optional (but recommended) | Raw dendrogram including `linkage`, `labels`, `legend` | From `/purchasing_segmentation_dendrogram`         |

📝 If you omit the `dendrogram`, the service still returns a complete report.
However, the dendrogram-specific insights and visual hierarchy analysis sections will be skipped.

---

### Request

```json
{"customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
 "labels": {
        "C001": 2,
        "C002": 0,
        "C003": 0,
        "C004": 0,
        "C005": 0,
        "C006": 0,
        "C007": 1,
        "C008": 0,
        "C009": 0,
        "C010": 0,
        "C011": 0,
        "C012": 1,
        "C013": 0,
        "C014": 1,
        "C015": 0,
        "C016": 0,
        "C017": 0,
        "C018": 2,
        "C019": 0,
        "C020": 0,
        "C021": 0,
        "C022": 0,
        "C023": 0,
        "C024": 0,
        "C025": 0,
        "C026": 1,
        "C027": 0,
        "C028": 0,
        "C029": 0,
        "C030": 1,
        "C031": 0,
        "C032": 0,
        "C033": 1,
        "C034": 0,
        "C035": 0,
        "C036": 0,
        "C037": 0,
        "C038": 1,
        "C039": 0,
        "C040": 0
    },

   "dendrogram": {
        "linkage_matrix": [
            [
                1.0,
                27.0,
                5.5900115966796875,
                2.0
            ],
            [
                16.0,
                34.0,
                10.246950765959598,
                2.0
            ],
            [
                10.0,
                38.0,
                14.5,
                2.0
            ],
            [
                18.0,
                33.0,
                14.684114387072421,
                2.0
            ],
            [
                2.0,
                24.0,
                14.933482805184708,
                2.0
            ],
            [
                14.0,
                20.0,
                15.033296378372908,
                2.0
            ],
            [
                8.0,
                23.0,
                15.033296378372908,
                2.0
            ],
            [
                9.0,
                22.0,
                16.41102378466232,
                2.0
            ],
            [
                12.0,
                40.0,
                19.554342797373597,
                3.0
            ],
            [
                30.0,
                41.0,
                23.67840084690405,
                3.0
            ],
            [
                19.0,
                36.0,
                24.720185838561353,
                2.0
            ],
            [
                5.0,
                31.0,
                29.71684244831212,
                2.0
            ],
            [
                3.0,
                45.0,
                31.75951301054011,
                3.0
            ],
            [
                39.0,
                47.0,
                37.04603277151646,
                3.0
            ],
            [
                46.0,
                49.0,
                53.204636389447614,
                5.0
            ],
            [
                7.0,
                43.0,
                60.837535989873956,
                3.0
            ],
            [
                26.0,
                48.0,
                75.42189702647553,
                4.0
            ],
            [
                4.0,
                35.0,
                83.95602895187841,
                2.0
            ],
            [
                50.0,
                51.0,
                102.69139093644127,
                4.0
            ],
            [
                15.0,
                53.0,
                135.75478433757996,
                4.0
            ],
            [
                54.0,
                56.0,
                139.4687935795597,
                9.0
            ],
            [
                21.0,
                57.0,
                147.95607449395212,
                3.0
            ],
            [
                42.0,
                58.0,
                193.4435440607144,
                6.0
            ],
            [
                25.0,
                29.0,
                215.00232556881798,
                2.0
            ],
            [
                44.0,
                55.0,
                220.82693991432996,
                5.0
            ],
            [
                13.0,
                37.0,
                221.00452484055614,
                2.0
            ],
            [
                6.0,
                11.0,
                235.00212764994276,
                2.0
            ],
            [
                52.0,
                60.0,
                256.36800922508723,
                12.0
            ],
            [
                28.0,
                61.0,
                336.40545943552,
                4.0
            ],
            [
                0.0,
                17.0,
                401.8550746056813,
                2.0
            ],
            [
                32.0,
                66.0,
                522.3946688588159,
                3.0
            ],
            [
                62.0,
                64.0,
                537.5921954390619,
                11.0
            ],
            [
                63.0,
                65.0,
                647.7163731140352,
                4.0
            ],
            [
                59.0,
                68.0,
                743.4835774228395,
                8.0
            ],
            [
                70.0,
                72.0,
                1528.9174504219059,
                7.0
            ],
            [
                67.0,
                71.0,
                1623.9774150881199,
                23.0
            ],
            [
                73.0,
                75.0,
                2865.3048816814076,
                31.0
            ],
            [
                69.0,
                74.0,
                3076.681261272462,
                9.0
            ],
            [
                76.0,
                77.0,
                8866.563988339083,
                40.0
            ]
        ],
        "columns": [
            "child1",
            "child2",
            "distance",
            "sample_count"
        ],
        "leaf_labels": [
            "C001",
            "C002",
            "C003",
            "C004",
            "C005",
            "C006",
            "C007",
            "C008",
            "C009",
            "C010",
            "C011",
            "C012",
            "C013",
            "C014",
            "C015",
            "C016",
            "C017",
            "C018",
            "C019",
            "C020",
            "C021",
            "C022",
            "C023",
            "C024",
            "C025",
            "C026",
            "C027",
            "C028",
            "C029",
            "C030",
            "C031",
            "C032",
            "C033",
            "C034",
            "C035",
            "C036",
            "C037",
            "C038",
            "C039",
            "C040"
        ],
        "cluster_legend": [
            {
                "cluster_id": 0,
                "n_customers": 31,
                "avg_spend": 591.11,
                "avg_frequency": 8.81,
                "top_categories": "wine, cheese, diapers"
            },
            {
                "cluster_id": 1,
                "n_customers": 7,
                "avg_spend": 2577.37,
                "avg_frequency": 23.14,
                "top_categories": "smart-tv, soundbar, hdmi-cable"
            },
            {
                "cluster_id": 2,
                "n_customers": 2,
                "avg_spend": 4321.68,
                "avg_frequency": 29.0,
                "top_categories": "laptop, mouse, keyboard"
            }
        ]
    }
}
```

---

### What the Service Does Internally

1. Aggregates customer-level data into cluster metrics (`n_customers`, revenue share, TF-IDF categories…).

2. Generates text via a structured NLG pipeline (templating + GPT-4-Turbo fine-tune) in the requested language.

3. Packages everything into a single JSON object – each top-level key is a ready-made paragraph or table.

4. Echoes raw payload at the bottom so the entire request/response is self-contained for audit. Latency: ~400 ms for ≤ 50 k customers on CPU.

---

### Response

```json
{
    "language": "English",
    "generated_on": "2025-05-20T17:47:09",
    "executive_summary": "The segmentation analysis has revealed three distinct customer clusters among the 40 customers, each exhibiting unique buying behaviors, spending patterns, and product preferences. Cluster 0, the largest group with 31 customers, shows moderate spending and lower purchase frequency, with top categories including everyday items like wine, cheese, and diapers. Cluster 1, composed of 7 customers, reflects higher average spending and frequency, with a clear inclination towards home entertainment electronics such as smart TVs, soundbars, and HDMI cables. Meanwhile, Cluster 2, although the smallest with only 2 customers, represents a niche segment focused on premium technology products like laptops, mice, and keyboards. These insights are backed by both the classic cluster legend summary and the dendrogram analysis, which provides granular insights into the hierarchical relationships among the customers based on their purchase behaviors.",
    "cluster_analysis": "The dendrogram and cluster legend provide a thorough breakdown of each cluster, highlighting important metrics such as the average spend and purchase frequency. Cluster 0 has an average spend of approximately 591.11 and purchase frequency of 8.81, indicating a more conservative shopping behavior with emphasis on cost-effective and everyday items. Cluster 1 shows an average spend of about 2577.37 with a frequency of 23.14, suggesting these customers are more engaged, possibly making deliberate and technology-focused investments at a higher price point. Cluster 2, with an average spend of 4321.68 and a purchase frequency of 29, targets power users or tech enthusiasts who demand high-end, performance-oriented products. This segmentation allows for clear targeting and differentiation strategies, ensuring that marketing efforts can be customized based on the customer's spending power and product affinity.",
    "customer_insights": "Each customer segment exhibits distinct characteristics that can be leveraged for targeted communication and engagement. Customers in Cluster 0 are likely to be price-conscious and value-driven, prioritizing affordability and convenience, which aligns with essential or recurring purchases. Cluster 1 customers appear to value enhanced experiences and technological upgrades, demonstrating a willingness to invest in quality home entertainment and electronics. The niche Cluster 2 customers are high spenders with a keen interest in premium technology products, potentially tech-savvy individuals who demand the latest and highest performing gadgets. These insights reveal a layered customer base, where understanding the underlying motivations and purchase patterns is critical in tailoring personalized messaging and offers that meet each segment's unique needs.",
    "marketing_recommendations": "Based on the detailed segmentation, it is recommended that marketing campaigns be highly personalized to address the distinct needs of each cluster. For Cluster 0, promotions should focus on value-for-money, bundling everyday items with loyalty discounts and seasonal offers that emphasize cost savings. Cluster 1 should be targeted with campaigns showcasing cutting-edge technology, product demos, and bundled high-tech entertainment packages alongside opportunities for upgrades and trade-ins. For the high-end Cluster 2, marketing should highlight premium quality, exclusive features, and after-sales support that reaffirms the brand’s leadership in innovation. Cross-channel promotions and personalized offers based on customer behavior analytics will ensure that messaging resonates effectively with each apportioned customer segment.",
    "channel_strategy": "The channel strategy must be diversified to meet the varied preferences of each customer segment. Digital channels, including targeted social media advertising, email marketing, and search engine marketing, can be utilized to effectively reach both Cluster 1 and Cluster 2 populations who are likely to be more digitally connected and responsive to dynamic content. For Cluster 0, a mix of traditional channels like direct mailers, local promotions, and in-store advertisements can complement digital outreach. Additionally, leveraging data-driven platforms to analyze web behavior and purchase history will enable retargeting efforts that refine messaging across channels. An integrated omni-channel approach, supported by a customer relationship management system that tracks engagement across platforms, is essential to deliver timely, relevant communications that drive both acquisition and retention.",
    "product_cross_sell_ideas": "There exists significant potential for cross-selling across the different customer clusters by identifying complementary products based on current purchasing habits. For instance, customers in Cluster 0 purchasing everyday items could be effectively introduced to bundled packages that include high-margin accessories or value-added services such as subscription models for essential consumables. In Cluster 1, a tech pairing of smart TVs with available streaming devices or enhanced sound systems can drive incremental sales. For Cluster 2, premium accessory upgrades such as ergonomic chairs, advanced peripheral devices, or extended warranties for laptops and high-end gadgets can be promoted. Additionally, targeting customers with complementary lifestyle or utility products based on their prior purchases offers the opportunity for personalized recommendations that add value to the customer experience while increasing average order value.",
    "retention_actions": "Retention efforts should focus on creating cohesive loyalty programs and personalized post-purchase support that continuously reinforces the value derived from ongoing engagement with the brand. For Cluster 0, incentives such as reward points, membership discounts, and exclusive offers on repeat purchases will help reduce churn. Cluster 1 customers can benefit from early access to new releases, invitations to exclusive product launches, and dedicated customer support that emphasizes premium service. For the higher-end Cluster 2, tailored concierge services, loyalty tiers with benefits such as extended warranties or priority support, and invitations to VIP events or tech expos can solidify long-term loyalty. Systematic customer engagement initiatives, including follow-up surveys and proactive feedback loops, are recommended to continuously gauge satisfaction levels and preemptively address concerns before they escalate.",
    "next_steps": "The next steps involve a detailed review of the segmentation findings by the marketing, data science, and product teams to align on targeting strategies and content personalization for each distinct customer cluster. It is recommended to develop pilot campaigns for each segment, monitor performance metrics closely, and adjust strategies based on real-time customer feedback and behavior analytics. Investing in advanced CRM tools to better track multi-channel engagement and integrating these insights with customer lifetime value models will further refine targeting refinements. Additionally, a cross-functional workshop should be organized to translate these insights into actionable marketing tactics, ensuring that product development, customer support, and sales are aligned in executing the tailored strategies efficiently and effectively.",
    "auto_insights": [
        "Cluster 0 has the most customers (31).",
        "Cluster 2 shows the highest average ticket (4,322).",
        "Cluster 0 generates 40.7% of total revenue."
    ],
    "dendrogram_insights": "• The clusters can be thought of as segments on a continuum from lower to higher spend and frequency, with Cluster 0 at the lower end and Cluster 2 at the higher end.  \n – Cluster 0:  \n  • 31 customers with the lowest average spend and frequency.  \n  • Their top purchases mix lifestyle goods (wine, cheese) with commodity items (diapers), implying a diverse but low-intensity purchasing pattern.  \n  • Synergy Opportunity: There is potential to cross-promote higher-margin or complementary products that are common to other clusters, by leveraging their everyday purchasing habits.  \n  • Cannibalisation Risk: Minimal if differentiated offers are maintained since their product mix is distinct from technology-focused clusters.  \n  • Migration Path: With targeted marketing or loyalty programs, some users might be nudged toward premium products offered in Clusters 1 and 2 if they develop a taste for technology or upgrade their lifestyle conveniences.\n\n• Cluster 1:  \n – 7 customers with moderate average spend and frequency.  \n – Their top categories are tech-related consumer electronics (smart-tv, soundbar, hdmi-cable), which nestles them between general lifestyle and high-end tech buyers.  \n – Synergy",
    "cluster_metrics": [
        {
            "cluster_id": 0,
            "n_customers": 31,
            "avg_spend": 591.11,
            "avg_frequency": 8.81,
            "top_categories": "wine, cheese, diapers",
            "share_revenue_pct": 40.71244292298313
        },
        {
            "cluster_id": 1,
            "n_customers": 7,
            "avg_spend": 2577.37,
            "avg_frequency": 23.14,
            "top_categories": "smart-tv, soundbar, hdmi-cable",
            "share_revenue_pct": 40.084084732597844
        },
        {
            "cluster_id": 2,
            "n_customers": 2,
            "avg_spend": 4321.68,
            "avg_frequency": 29.0,
            "top_categories": "laptop, mouse, keyboard",
            "share_revenue_pct": 19.20347234441903
        }
    ],
    "raw_payload": {
        "customers": [
            {
                "id": "C001",
                "frequency": 28,
                "amount_spent": 4120.75,
                "product_types": [
                    "laptop",
                    "mouse",
                    "keyboard",
                    "monitor"
                ]
            },
            {
                "id": "C002",
                "frequency": 5,
                "amount_spent": 190.4,
                "product_types": [
                    "tea",
                    "coffee"
                ]
            },
            {
                "id": "C003",
                "frequency": 12,
                "amount_spent": 845.1,
                "product_types": [
                    "jeans",
                    "t-shirt",
                    "sneakers"
                ]
            },
            {
                "id": "C004",
                "frequency": 2,
                "amount_spent": 75.0,
                "product_types": [
                    "notebook"
                ]
            },
            {
                "id": "C005",
                "frequency": 17,
                "amount_spent": 1324.55,
                "product_types": [
                    "smartphone",
                    "earbuds"
                ]
            },
            {
                "id": "C006",
                "frequency": 8,
                "amount_spent": 510.3,
                "product_types": [
                    "dog food",
                    "cat food"
                ]
            },
            {
                "id": "C007",
                "frequency": 24,
                "amount_spent": 2780.9,
                "product_types": [
                    "smart-tv",
                    "soundbar",
                    "hdmi-cable"
                ]
            },
            {
                "id": "C008",
                "frequency": 10,
                "amount_spent": 660.0,
                "product_types": [
                    "yogurt",
                    "milk",
                    "cheese"
                ]
            },
            {
                "id": "C009",
                "frequency": 3,
                "amount_spent": 120.0,
                "product_types": [
                    "stationery"
                ]
            },
            {
                "id": "C010",
                "frequency": 15,
                "amount_spent": 975.65,
                "product_types": [
                    "beer",
                    "wine",
                    "snacks"
                ]
            },
            {
                "id": "C011",
                "frequency": 7,
                "amount_spent": 450.25,
                "product_types": [
                    "books",
                    "pens"
                ]
            },
            {
                "id": "C012",
                "frequency": 25,
                "amount_spent": 3015.9,
                "product_types": [
                    "tablet",
                    "stylus",
                    "cover"
                ]
            },
            {
                "id": "C013",
                "frequency": 6,
                "amount_spent": 210.1,
                "product_types": [
                    "pasta",
                    "sauce"
                ]
            },
            {
                "id": "C014",
                "frequency": 20,
                "amount_spent": 1884.0,
                "product_types": [
                    "fitness-watch"
                ]
            },
            {
                "id": "C015",
                "frequency": 1,
                "amount_spent": 40.0,
                "product_types": [
                    "batteries"
                ]
            },
            {
                "id": "C016",
                "frequency": 13,
                "amount_spent": 1105.35,
                "product_types": [
                    "printer",
                    "ink"
                ]
            },
            {
                "id": "C017",
                "frequency": 4,
                "amount_spent": 160.0,
                "product_types": [
                    "flour",
                    "sugar",
                    "eggs"
                ]
            },
            {
                "id": "C018",
                "frequency": 30,
                "amount_spent": 4522.6,
                "product_types": [
                    "gaming-pc",
                    "rgb-mouse",
                    "gaming-chair",
                    "headset"
                ]
            },
            {
                "id": "C019",
                "frequency": 11,
                "amount_spent": 720.0,
                "product_types": [
                    "makeup",
                    "skincare"
                ]
            },
            {
                "id": "C020",
                "frequency": 9,
                "amount_spent": 585.4,
                "product_types": [
                    "toys",
                    "board-games"
                ]
            },
            {
                "id": "C021",
                "frequency": 2,
                "amount_spent": 55.0,
                "product_types": [
                    "candles"
                ]
            },
            {
                "id": "C022",
                "frequency": 18,
                "amount_spent": 1410.7,
                "product_types": [
                    "camera",
                    "sd-card"
                ]
            },
            {
                "id": "C023",
                "frequency": 14,
                "amount_spent": 992.0,
                "product_types": [
                    "office-chair",
                    "desk-lamp"
                ]
            },
            {
                "id": "C024",
                "frequency": 3,
                "amount_spent": 135.0,
                "product_types": [
                    "juice",
                    "cookies"
                ]
            },
            {
                "id": "C025",
                "frequency": 12,
                "amount_spent": 830.2,
                "product_types": [
                    "running-shoes",
                    "sports-socks"
                ]
            },
            {
                "id": "C026",
                "frequency": 23,
                "amount_spent": 2560.0,
                "product_types": [
                    "fridge",
                    "water-filter"
                ]
            },
            {
                "id": "C027",
                "frequency": 6,
                "amount_spent": 260.4,
                "product_types": [
                    "vitamins"
                ]
            },
            {
                "id": "C028",
                "frequency": 5,
                "amount_spent": 195.99,
                "product_types": [
                    "wine",
                    "cheese"
                ]
            },
            {
                "id": "C029",
                "frequency": 19,
                "amount_spent": 1599.95,
                "product_types": [
                    "e-reader",
                    "ebooks"
                ]
            },
            {
                "id": "C030",
                "frequency": 22,
                "amount_spent": 2345.0,
                "product_types": [
                    "washing-machine",
                    "detergent"
                ]
            },
            {
                "id": "C031",
                "frequency": 4,
                "amount_spent": 175.5,
                "product_types": [
                    "herbs",
                    "spices"
                ]
            },
            {
                "id": "C032",
                "frequency": 8,
                "amount_spent": 540.0,
                "product_types": [
                    "diapers",
                    "baby-wipes",
                    "formula"
                ]
            },
            {
                "id": "C033",
                "frequency": 27,
                "amount_spent": 3350.8,
                "product_types": [
                    "console",
                    "controller",
                    "games"
                ]
            },
            {
                "id": "C034",
                "frequency": 10,
                "amount_spent": 705.35,
                "product_types": [
                    "sunscreen",
                    "after-sun"
                ]
            },
            {
                "id": "C035",
                "frequency": 3,
                "amount_spent": 150.0,
                "product_types": [
                    "frozen-pizza"
                ]
            },
            {
                "id": "C036",
                "frequency": 16,
                "amount_spent": 1240.6,
                "product_types": [
                    "tool-set",
                    "drill"
                ]
            },
            {
                "id": "C037",
                "frequency": 9,
                "amount_spent": 610.1,
                "product_types": [
                    "organic-vegetables"
                ]
            },
            {
                "id": "C038",
                "frequency": 21,
                "amount_spent": 2105.0,
                "product_types": [
                    "air-fryer",
                    "cookbook"
                ]
            },
            {
                "id": "C039",
                "frequency": 7,
                "amount_spent": 435.75,
                "product_types": [
                    "flowers",
                    "vase"
                ]
            },
            {
                "id": "C040",
                "frequency": 14,
                "amount_spent": 1015.9,
                "product_types": [
                    "winter-jacket",
                    "gloves",
                    "scarf"
                ]
            }
        ],
        "labels": {
            "C001": 2,
            "C002": 0,
            "C003": 0,
            "C004": 0,
            "C005": 0,
            "C006": 0,
            "C007": 1,
            "C008": 0,
            "C009": 0,
            "C010": 0,
            "C011": 0,
            "C012": 1,
            "C013": 0,
            "C014": 1,
            "C015": 0,
            "C016": 0,
            "C017": 0,
            "C018": 2,
            "C019": 0,
            "C020": 0,
            "C021": 0,
            "C022": 0,
            "C023": 0,
            "C024": 0,
            "C025": 0,
            "C026": 1,
            "C027": 0,
            "C028": 0,
            "C029": 0,
            "C030": 1,
            "C031": 0,
            "C032": 0,
            "C033": 1,
            "C034": 0,
            "C035": 0,
            "C036": 0,
            "C037": 0,
            "C038": 1,
            "C039": 0,
            "C040": 0
        },
        "dendrogram": {
            "linkage_matrix": [
                [
                    1.0,
                    27.0,
                    5.5900115966796875,
                    2.0
                ],
                [
                    16.0,
                    34.0,
                    10.246950765959598,
                    2.0
                ],
                [
                    10.0,
                    38.0,
                    14.5,
                    2.0
                ],
                [
                    18.0,
                    33.0,
                    14.684114387072421,
                    2.0
                ],
                [
                    2.0,
                    24.0,
                    14.933482805184708,
                    2.0
                ],
                [
                    14.0,
                    20.0,
                    15.033296378372908,
                    2.0
                ],
                [
                    8.0,
                    23.0,
                    15.033296378372908,
                    2.0
                ],
                [
                    9.0,
                    22.0,
                    16.41102378466232,
                    2.0
                ],
                [
                    12.0,
                    40.0,
                    19.554342797373597,
                    3.0
                ],
                [
                    30.0,
                    41.0,
                    23.67840084690405,
                    3.0
                ],
                [
                    19.0,
                    36.0,
                    24.720185838561353,
                    2.0
                ],
                [
                    5.0,
                    31.0,
                    29.71684244831212,
                    2.0
                ],
                [
                    3.0,
                    45.0,
                    31.75951301054011,
                    3.0
                ],
                [
                    39.0,
                    47.0,
                    37.04603277151646,
                    3.0
                ],
                [
                    46.0,
                    49.0,
                    53.204636389447614,
                    5.0
                ],
                [
                    7.0,
                    43.0,
                    60.837535989873956,
                    3.0
                ],
                [
                    26.0,
                    48.0,
                    75.42189702647553,
                    4.0
                ],
                [
                    4.0,
                    35.0,
                    83.95602895187841,
                    2.0
                ],
                [
                    50.0,
                    51.0,
                    102.69139093644127,
                    4.0
                ],
                [
                    15.0,
                    53.0,
                    135.75478433757996,
                    4.0
                ],
                [
                    54.0,
                    56.0,
                    139.4687935795597,
                    9.0
                ],
                [
                    21.0,
                    57.0,
                    147.95607449395212,
                    3.0
                ],
                [
                    42.0,
                    58.0,
                    193.4435440607144,
                    6.0
                ],
                [
                    25.0,
                    29.0,
                    215.00232556881798,
                    2.0
                ],
                [
                    44.0,
                    55.0,
                    220.82693991432996,
                    5.0
                ],
                [
                    13.0,
                    37.0,
                    221.00452484055614,
                    2.0
                ],
                [
                    6.0,
                    11.0,
                    235.00212764994276,
                    2.0
                ],
                [
                    52.0,
                    60.0,
                    256.36800922508723,
                    12.0
                ],
                [
                    28.0,
                    61.0,
                    336.40545943552,
                    4.0
                ],
                [
                    0.0,
                    17.0,
                    401.8550746056813,
                    2.0
                ],
                [
                    32.0,
                    66.0,
                    522.3946688588159,
                    3.0
                ],
                [
                    62.0,
                    64.0,
                    537.5921954390619,
                    11.0
                ],
                [
                    63.0,
                    65.0,
                    647.7163731140352,
                    4.0
                ],
                [
                    59.0,
                    68.0,
                    743.4835774228395,
                    8.0
                ],
                [
                    70.0,
                    72.0,
                    1528.9174504219059,
                    7.0
                ],
                [
                    67.0,
                    71.0,
                    1623.9774150881199,
                    23.0
                ],
                [
                    73.0,
                    75.0,
                    2865.3048816814076,
                    31.0
                ],
                [
                    69.0,
                    74.0,
                    3076.681261272462,
                    9.0
                ],
                [
                    76.0,
                    77.0,
                    8866.563988339083,
                    40.0
                ]
            ],
            "columns": [
                "child1",
                "child2",
                "distance",
                "sample_count"
            ],
            "leaf_labels": [
                "C001",
                "C002",
                "C003",
                "C004",
                "C005",
                "C006",
                "C007",
                "C008",
                "C009",
                "C010",
                "C011",
                "C012",
                "C013",
                "C014",
                "C015",
                "C016",
                "C017",
                "C018",
                "C019",
                "C020",
                "C021",
                "C022",
                "C023",
                "C024",
                "C025",
                "C026",
                "C027",
                "C028",
                "C029",
                "C030",
                "C031",
                "C032",
                "C033",
                "C034",
                "C035",
                "C036",
                "C037",
                "C038",
                "C039",
                "C040"
            ],
            "cluster_legend": [
                {
                    "cluster_id": 0,
                    "n_customers": 31,
                    "avg_spend": 591.11,
                    "avg_frequency": 8.81,
                    "top_categories": "wine, cheese, diapers"
                },
                {
                    "cluster_id": 1,
                    "n_customers": 7,
                    "avg_spend": 2577.37,
                    "avg_frequency": 23.14,
                    "top_categories": "smart-tv, soundbar, hdmi-cable"
                },
                {
                    "cluster_id": 2,
                    "n_customers": 2,
                    "avg_spend": 4321.68,
                    "avg_frequency": 29.0,
                    "top_categories": "laptop, mouse, keyboard"
                }
            ]
        }
    }
}
```

---

### Response Object – Field-by-Field Guide

| **Top-Level Key**           | **Type**       | **Content**                                                           | **How to Use**                   |
| --------------------------- | -------------- | --------------------------------------------------------------------- | -------------------------------- |
| `language`                  | string         | “English”, “Español”, “Português”                                     | Confirms NLG locale              |
| `generated_on`              | ISO timestamp  | Report creation time (UTC)                                            | Versioning / caching             |
| `executive_summary`         | string         | 250–350 word board-level synopsis                                     | Paste directly into slide 1      |
| `cluster_analysis`          | string         | Deeper numeric comparison of clusters                                 | Analyst commentary               |
| `customer_insights`         | string         | Psychographic / behavioral interpretation                             | Brief for CRM & CX               |
| `marketing_recommendations` | string         | Channel / offer guidance                                              | Feed into campaign briefs        |
| `channel_strategy`          | string         | Omnichannel plan aligned to clusters                                  | Share with media agency          |
| `product_cross_sell_ideas`  | string         | Bundle & upsell suggestions                                           | Merchandise roadmap              |
| `retention_actions`         | string         | Loyalty & churn mitigation tactics                                    | CS & Loyalty teams               |
| `next_steps`                | string         | Action plan & governance                                              | Sprint planning                  |
| `auto_insights[]`           | array<string>  | Auto-mined data facts (e.g. “Cluster 0 has 40% of revenue”)           | Tooltip nuggets in BI dashboards |
| `dendrogram_insights`       | string \| null | Hierarchy commentary (only if dendrogram provided)                    | Present with dendrogram visual   |
| `cluster_metrics[]`         | array<object>  | KPI table (ID, size, spend, frequency, top categories, revenue share) | Load into BI dashboards          |
| `raw_payload`               | object         | Echo of your original request (secrets redacted)                      | Use for audit, reproducibility   |

---

### Commercial Value

| **Stakeholder**    | **Pain Solved**                                  | **How This Report Helps**                                        |
| ------------------ | ------------------------------------------------ | ---------------------------------------------------------------- |
| CMO / VP Marketing | Needs quick view of which segments drive revenue | Reads `executive_summary` + `marketing_recommendations` in 3 min |
| Growth Manager     | Lacks campaign copy ideas                        | Uses `product_cross_sell_ideas` directly                         |
| Merchandising Lead | Wants data-backed bundle recommendations         | Refers to `cluster category affinities`                          |
| Data-Ops           | Struggles with manual slide creation             | Automates with `/json → Lucid + PPTX template`                   |

---

### Integration Blueprint

Nightly ETL →
  /purchasing_segmentation →
  /purchasing_segmentation_dendrogram →
  /segmentation_report_json?lang=en →
  Save JSON to S3 / push sections to:
    • Notion wiki
    • Tableau dashboard (via Web Data Connector)
    • Slack #marketing-daily (via webhook)

---

### Minimal Python Example

import requests, json, boto3, datetime as dt

payload = { "customers": cust, "labels": labels, "dendrogram": dendro }

r = requests.post(
    "https://api.abintel.ai/api/segmentation_report_json?lang=en",
    headers={"X-Customer-Api-Id": ID, "X-Secret": SECRET},
    json=payload, timeout=60
)

report = r.json()

s3.put_object(
    Bucket="reports",
    Key=f"seg_{dt.date.today()}.json",
    Body=json.dumps(report).encode()
)

---

### Tips & Best Practices

Send the full dendrogram → unlocks `dendrogram_insights` your execs will love

Localise once, reuse → same payload, change `lang=pt` or `lang=es`

Version pinning → store `generated_on`, regenerate only if model or payload changes

Custom voice → Enterprise tier supports tone-of-voice fine-tuning (contact support)

GDPR compliance → hash `customer_id` before sharing externally

---

### FAQ

| **Question**                  | **Answer**                                                                                   |
| ----------------------------- | -------------------------------------------------------------------------------------------- |
| Can I change insight lengths? | Roadmap param: `depth=brief`                                                                 |
| Why repeat the raw payload?   | For self-contained audit trails. Strip before sharing if payload size matters.               |
| We need a PDF                 | Use `/segmentation_report_pdf` (same payload) or feed JSON into your template engine         |
| Does it support Chinese?      | Chinese/Japanese support is planned for 2026. Meanwhile, use `/translate_document` endpoint. |

---

### Next Step

Wire this endpoint into your marketing analytics CI/CD.
Every morning, wake up to an auto-written segmentation brief, in the right language, ready to ship.

---

# 4.1.13 /api/v1/ai/churn_risk

Predict, Explain & Act on Customer Churn

---

### Purpose

Feed a flat table of behavior + sentiment + billing signals and receive:

1. An auto-benchmarked model choice (LogReg, Tree, Boosting)

2. Probability-of-churn for every customer

3. Segment-level driver insight (what’s pushing risk up/down)

4. Ready-to-deploy retention playbooks per account

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### POST Endpoint
POST `https://api-prod.abintel.ai/api/v1/ai/churn_risk`

---

### Request Body – Field-by-Field Cheat Sheet

| **JSON Key**        | **Type / Range**      | **Required?** | **Business Meaning**                        | **Typical Derivation**                 |
| ------------------- | --------------------- | ------------- | ------------------------------------------- | -------------------------------------- |
| `data[]`            | array<object>         | Yes           | One row per customer snapshot               | Daily view or rolling weekly export    |
| ↳ `customer_id`     | string                | Yes           | Primary key                                 | CRM / user table                       |
| ↳ `tenure`          | int (days ≥ 0)        | Yes           | Account age at snapshot date                | `DATEDIFF(today, first_purchase_date)` |
| ↳ `usage_frequency` | float (sessions/week) | Yes\*         | Avg. engagement over last 12 weeks          | `AVG(weekly_sessions)`                 |
| ↳ `service_tickets` | int ≥ 0               | Yes\*         | Support tickets opened last 90 days         | Zendesk / Freshdesk export             |
| ↳ `nps`             | int (−100…+100)       | Yes\*         | Latest Net Promoter Score                   | Survey DB; use `0` if missing          |
| ↳ `payment_events`  | int ≥ 0               | Yes\*         | Failed / late payments in last 12 months    | Billing logs                           |
| ↳ `churned`         | 0/1                   | Optional      | Ground-truth label for training/A-B scoring | Omit for inference-only use            |

* The model can impute missing numeric fields using medians, but predictive accuracy may be reduced.

---

### Snapshot-to-Label Rules (Industry Presets)

| **Sector**        | **Churned = 1 if…**                              |
| ----------------- | ------------------------------------------------ |
| Subscription SaaS | Cancelled within 30 days after the snapshot date |
| E-commerce        | No purchase in the following 90 days             |
| Pre-paid usage    | Balance hit zero and no top-up next cycle        |

---

### Request

```json
{
  "data": [
    {
      "customer_id": "C-0001",
      "tenure": 915,
      "usage_frequency": 6.2,
      "service_tickets": 1,
      "nps": 58,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0002",
      "tenure": 310,
      "usage_frequency": 1.9,
      "service_tickets": 4,
      "nps": 12,
      "payment_events": 3,
      "churned": 1
    },
    {
      "customer_id": "C-0003",
      "tenure": 442,
      "usage_frequency": 3.1,
      "service_tickets": 0,
      "nps": 70,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0004",
      "tenure": 95,
      "usage_frequency": 0.4,
      "service_tickets": 6,
      "nps": -10,
      "payment_events": 4,
      "churned": 1
    }
  ]
}
```

---

### Under the Hood – Model Selection Flow

1. `Pre-processing` z-score numeric fields, one-hot business rules (high ticket, detractor, failed_pay).

2. `Benchmark` 4 algos with defaults tuned for tabular data:

* Logistic Regression (elastic-net)

* Random Forest (100 trees)

* XGBoost (200 trees, depth 6)

* CatBoost (ordered boosting, depth 6)

3. `Validation` 5-fold stratified CV on labelled rows (if labels supplied; else use hold-out training set).

4. Pick algorithm with highest ROC-AUC, tie-break on F1 → Accuracy.

5. `Explain` LogReg coefficients or Tree SHAP summarised at group level (top_factors placeholder ready). Latency ~250 ms for 5 k rows on CPU.

---

### Response

```json
{
    "best_algorithm": "Logistic Regression",
    "evaluation_metrics": {
        "Logistic Regression": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "Random Forest": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "XGBoost": {
            "roc_auc": 0.5,
            "f1": 0.6666666666666666,
            "accuracy": 0.5
        },
        "CatBoost": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        }
    },
    "interpretation": "Logistic Regression achieved the highest validation performance (ROC-AUC=1.000, F1=1.000). High ticket volume combined with low NPS were the most influential churn drivers, underscoring the importance of support quality.",
    "results": [
        {
            "customer_id": "C-0001",
            "churn_probability": 1.316118330359693e-22,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0002",
            "churn_probability": 0.9993016452809322,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        },
        {
            "customer_id": "C-0003",
            "churn_probability": 0.0006985619483883015,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0004",
            "churn_probability": 0.9999999999992972,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        }
    ]
}
```

---

### Key Fields

| **Path**               | **Type**      | **Meaning**                                | **Ops Use**                                  |
| ---------------------- | ------------- | ------------------------------------------ | -------------------------------------------- |
| `best_algorithm`       | enum          | Algorithm deployed for inference           | Model-ops audit                              |
| `evaluation_metrics`   | nested object | Cross-validation scores per algorithm      | Gauge confidence, consider alternate models  |
| `interpretation`       | string        | One-paragraph driver summary               | Executive readout                            |
| `results[]`            | array         | Per-customer churn probabilities & actions | Feed to CRM / Customer Success               |
| ↳ `churn_probability`  | float (0–1)   | 0 = loyal, 1 = certain churn               | Use 0.5 as high-risk cut-off                 |
| ↳ `top_factors`        | array<string> | SHAP-style explanation (v1.8+)             | Use in rep scripts: "I noticed your ticket…" |
| ↳ `recommended_action` | enum (text)   | Rule-based retention advice                | Auto-trigger customer journeys               |

---

### Actionable Playbooks

| **Risk Band** | **Probability** | **Recommended Motion**                                 | **Typical Uplift** |
| ------------- | --------------- | ------------------------------------------------------ | ------------------ |
| **High**      | ≥ 0.60          | Offer % discount, priority support, concierge outreach | 15–35% save rate   |
| **Medium**    | 0.25–0.59       | Send value-focused email, usage tips, small promo      | 5–10% save rate    |
| **Low**       | < 0.25          | Light-touch nurture (no incentives)                    | Preserve margin    |

---

### Data Engineering Recipe (SQL)

```SQL
WITH sessions AS (
  SELECT user_id,
         COUNT(*)/12.0 AS usage_frequency
  FROM   app_sessions
  WHERE  session_date >= DATE_SUB(CURDATE(), INTERVAL 12 WEEK)
  GROUP  BY 1
),
tickets AS (
  SELECT user_id,
         COUNT(*) AS service_tickets
  FROM   support_tickets
  WHERE  created_at >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
  GROUP  BY 1
),
payments AS (
  SELECT user_id,
         SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) AS payment_events
  FROM   billing_events
  WHERE  event_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
  GROUP  BY 1
)
SELECT JSON_ARRAYAGG(
         JSON_OBJECT(
           'customer_id',    u.id,
           'tenure',         DATEDIFF(CURDATE(), u.first_purchase),
           'usage_frequency',COALESCE(s.usage_frequency, 0),
           'service_tickets',COALESCE(t.service_tickets, 0),
           'nps',            COALESCE(f.nps, 0),
           'payment_events', COALESCE(p.payment_events, 0)
         )
       ) AS payload
FROM users u
LEFT JOIN sessions  s ON s.user_id = u.id
LEFT JOIN tickets   t ON t.user_id = u.id
LEFT JOIN payments  p ON p.user_id = u.id
LEFT JOIN feedback  f ON f.user_id = u.id
WHERE u.status = 'active';
```

---

### Commercial Impact

| **Team**         | **Benefit**                                                  |
| ---------------- | ------------------------------------------------------------ |
| Customer Success | Auto-prioritise call lists; no more manual Excel scoring     |
| Finance          | Forecast MRR at risk; support LTV\:CAC models                |
| Product          | Identify UX churn causes (e.g. tickets → drop-off)           |
| Marketing        | Trigger re-engagement only for risk cohorts; save incentives |

---

### FAQ

| **Question**                        | **Answer**                                                                   |
| ----------------------------------- | ---------------------------------------------------------------------------- |
| Why are RF & CatBoost tied at 1.0?  | Demo set is tiny → perfect separation; real-world data = ROC-AUC \~0.75–0.92 |
| What if I only have 3 months’ data? | Model adapts; shorter tenure still valid                                     |
| GDPR considerations?                | No PII — only `customer_id`. Hash before sending externally                  |
| Can I upload 1M rows?               | Max 20MB per call (\~250k rows). Async bulk endpoint coming Q4 2025          |

---

### Next Step

Pipe the results[] table into your CRM or CDP, auto-trigger journeys for high-risk users, and track your churn-save KPI in your BI dashboard.

---

# 4.1.14 /api/v1/ai/nps

---

### Purpose

Real-Time Net-Promoter-Score Calculator
Compute the overall NPS for a survey batch and, optionally, slice the score by any categorical field (store, region, plan, agent, channel, etc.).
The service returns ready-made percentages plus a quick-read interpretation band so non-analysts can understand at a glance.

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body Schema

| **JSON Key**    | **Type / Range** | **Required?** | **Business Meaning**           | **Notes / Derivation**               |
| --------------- | ---------------- | ------------- | ------------------------------ | ------------------------------------ |
| `group_by`      | string           | optional      | Column to break out NPS by     | Leave empty to skip grouping         |
| `data[]`        | array<object>    | yes           | List of NPS responses          | Max 50,000 rows / 5 MB               |
| ↳ `customer_id` | string           | yes           | Respondent identifier          | For traceability                     |
| ↳ `question`    | string           | optional      | Survey question text           | Echoed back untouched                |
| ↳ `answer`      | int (0–10)       | yes           | Classic NPS scale              | Out-of-range returns HTTP 400        |
| ↳ `group`       | any              | conditional   | Value of the `group_by` column | Can be anything: store, region, etc. |
| ↳ `date`        | ISO-8601         | optional      | Response date                  | Useful for dashboards                |

---

### Request Example

```json
{
  "group_by": "group",
  "data": [
    {
      "customer_id": "C-0001",
      "question": "How likely are you to recommend our app?",
      "answer": 9,
      "group": "Store-A",
      "date": "2025-04-28"
    },
    {
      "customer_id": "C-0002",
      "answer": 4,
      "group": "Store-A",
      "date": "2025-04-28"
    },
    {
      "customer_id": "C-0003",
      "answer": 10,
      "group": "Store-B",
      "date": "2025-04-28"
    }
  ]
}
```

---

### How the Service Calculates NPS

* `Promoters` = answers 9–10

* `Passives` = answers 7–8

* `Detractors` = answers 0–6

`NPS = (%Promoters − %Detractors) × 100`
Values are rounded to two decimals.

---

### Interpretation Bands

| **NPS Score** | **Label**                   |
| ------------- | --------------------------- |
| ≥ 70          | World-class loyalty         |
| 50 – 69       | Excellent                   |
| 30 – 49       | Good                        |
| 0 – 29        | Fair – room for improvement |
| −100 – −1     | Critical warning            |

Customizable in enterprise plan

---

### Response Example

```json
{
  "overall": {
    "nps": 33.33,
    "promoters_pct": 66.67,
    "passives_pct": 0.0,
    "detractors_pct": 33.33,
    "responses": 3,
    "interpretation": "Fair – room for improvement"
  },
  "by_group": [
    {
      "nps": 0.0,
      "promoters_pct": 50.0,
      "passives_pct": 0.0,
      "detractors_pct": 50.0,
      "responses": 2,
      "group": "Store-A",
      "interpretation": "Fair – room for improvement"
    },
    {
      "nps": 100.0,
      "promoters_pct": 100.0,
      "passives_pct": 0.0,
      "detractors_pct": 0.0,
      "responses": 1,
      "group": "Store-B",
      "interpretation": "World-class loyalty"
    }
  ]
}
```

---

### Field Guide

| **Path**                 | **Type** | **Meaning**               | **Dashboard Use**       |
| ------------------------ | -------- | ------------------------- | ----------------------- |
| `overall.nps`            | float    | Global NPS                | Trend analysis          |
| `overall.promoters_pct`  | float %  | Promoter share            | Target ≥ 60%            |
| `overall.passives_pct`   | float %  | Passive share             | Monitor shifts          |
| `overall.detractors_pct` | float %  | Detractor share           | Trigger alerts if >20%  |
| `by_group[]`             | array    | Per-group metrics         | Heat-maps, slice & dice |
| `interpretation`         | string   | Interpretation band label | Copy to Slack, emails   |

---

### Commercial Playbooks

| **Scenario**               | **Action**                                                       | **Outcome**                         |
| -------------------------- | ---------------------------------------------------------------- | ----------------------------------- |
| Store-B pops 100 NPS       | Use as benchmark in testimonials & ads                           | +12% conversion                     |
| Store-A stuck at 0 NPS     | Deep-dive into CSAT logs, fulfilment issues                      | Find root causes (e.g., stock-outs) |
| Overall slips from 45 → 30 | Fire CSAT survey to Passives, route Detractors to retention team | +8pp recovery within 2 weeks        |

---

### Integration Best Practices

1. Collect responses via email, WhatsApp, app, kiosk, etc.

2. ETL raw data into staging table

3. Call /api/nps hourly and store the snapshot

4. Visualise with heat-maps and trend lines

5. Alert on NPS drops across bands

---

### Python Cron Job Example

```Python
payload = build_payload_from_sql(last_hour())
r = requests.post(
    "https://api.abintel.ai/api/nps",
    headers={"X-Customer-Api-Id": ID, "X-Secret": SECRET},
    json=payload,
    timeout=15
)
db.insert("nps_snapshot", r.json())
```

---

### FAQ

| **Question**               | **Answer**                                                         |
| -------------------------- | ------------------------------------------------------------------ |
| Can I group by two fields? | Not yet. Use multiple calls. Multi-dim grouping in roadmap (v1.9). |
| What if answer is 11?      | Will return HTTP 400. Clean data before sending.                   |
| Max number of groups?      | Up to 1,000 unique group values per call.                          |
| Does it store my data?     | No. Stateless; payload is discarded after \~2 minutes.             |

---

### Next Step
Automate NPS snapshots hourly, trigger alerts on Detractor spikes, and share grouped insights with frontline teams to drive continuous improvement in customer experience (CX).

---

# 4.1.15 /api/v1/ai/churn_label

---

### Purpose

Create a binary churn label `(churned = 0 | 1)` from raw customer lifecycle data using vertical-specific business rules.

Use cases:

* Generate training sets for `/api/churn_risk`

* Benchmark retention initiatives (true / false positives)

* Track “new churn” KPI without spreadsheets

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body Schema

| **Key**        | **Type**                                      | **Required** | **Meaning**                      |
| -------------- | --------------------------------------------- | ------------ | -------------------------------- |
| business\_type | enum `"ecommerce"` \| `"saas"` \| `"prepaid"` | yes          | Chooses the rule set (see below) |
| data           | array<object>                                 | yes          | One row per snapshot at time `t` |

Extra fields are ignored (can be used for auditing).

---

### Built-in Churn Rules

| **Business Type** | **Required Fields**                                          | **Churn Rule (churned = 1 if…)**                         | **Typical Window**      |
| ----------------- | ------------------------------------------------------------ | -------------------------------------------------------- | ----------------------- |
| `ecommerce`       | `snapshot_date`, `last_purchase_date`                        | `snapshot_date - last_purchase_date ≥ 90 days`           | 90 days silence = churn |
| `saas`            | `snapshot_date`, `subscription_cancelled` (bool)             | `subscription_cancelled = true`                          | Same-day detection      |
| `prepaid`         | `snapshot_date`, `balance_after_t`, `topped_up_within_cycle` | `balance_after_t = 0 AND topped_up_within_cycle = false` | One billing cycle       |

* Why 90 days for e-commerce? It reflects the industry median reorder interval across 30+ retailers.

---

### Worked Examples

* E-commerce Example

```json
{
  "business_type": "ecommerce",
  "data": [
    {
      "customer_id": "E-101",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2024-12-15"
    },
    {
      "customer_id": "E-102",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2025-03-20"
    }
  ]
}
```

---

### Response

```json
[
  { "customer_id": "E-101", "snapshot_date": "2025-04-01", "churned": 1 },
  { "customer_id": "E-102", "snapshot_date": "2025-04-01", "churned": 0 }
]
```

---

### SaaS Example

```json
{
  "business_type": "saas",
  "data": [
    {
      "customer_id": "S-001",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": true
    },
    {
      "customer_id": "S-002",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": false
    }
  ]
}
```

---

### Prepaid Example

```json
{
  "business_type": "prepaid",
  "data": [
    {
      "customer_id": "P-777",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": false
    },
    {
      "customer_id": "P-778",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": true
    }
  ]
}
```

---

### Field Dictionary & Rationale

| **Field**                | **Why It Matters**                       | **Example**    |
| ------------------------ | ---------------------------------------- | -------------- |
| `snapshot_date`          | Freeze point: when you check churn state | `"2025-04-01"` |
| `last_purchase_date`     | Recency check for e-commerce             | `"2024-12-15"` |
| `subscription_cancelled` | Definitive SaaS churn signal             | `true`         |
| `balance_after_t`        | Prepaid credit balance                   | `0.0`          |
| `topped_up_within_cycle` | Detect lapse vs. engagement              | `false`        |

---

### Typical ETL Pattern (SQL)

```SQL
INSERT INTO churn_labels
SELECT
    c.customer_id,
    DATE ?snapshot AS snapshot_date,
    CASE
      WHEN ?business_type = 'ecommerce'
           AND DATEDIFF(?snapshot, c.last_purchase) >= 90 THEN 1
      WHEN ?business_type = 'saas'
           AND c.subscription_cancelled THEN 1
      WHEN ?business_type = 'prepaid'
           AND c.balance = 0 AND c.topped_up = 0 THEN 1
      ELSE 0
    END AS churned
FROM staging_customers c;
```

Push this result to /api/churn_risk as your label column.

---

### Commercial Uses

| **Team**      | **Use Case**                                          |
| ------------- | ----------------------------------------------------- |
| Data Science  | Build training sets for churn model                   |
| Finance       | Track true churn for forecasting                      |
| Marketing Ops | Launch win-back flows 90 days post last order (e-com) |
| Product       | Evaluate onboarding impact on cancellations (SaaS)    |

---

### FAQ

| **Question**                                 | **Answer**                                                       |
| -------------------------------------------- | ---------------------------------------------------------------- |
| Can I change the churn window for e-com?     | Yes – use `"window_days": 60` (Enterprise only).                 |
| What happens if required fields are missing? | Returns HTTP 400 with the missing keys listed.                   |
| Does the service store data?                 | No – it is stateless. Payload is discarded post-response.        |
| Max batch size?                              | 250,000 rows or 20 MB per request. Async support coming Q4 2025. |

---

### Next Step

Schedule `/api/churn_label` to run daily, pipe results into your churn training pipeline, and keep models fresh—without touching SQL every time.

---

# 4.2 Propensity & Recommendation

---

### Scope

`propensity_buy_product`

`propensity_respond_campaign`

`propensity_upgrade_plan`

`recommend_user_items`

`recommend_similar_items`

`cross_sell_matrix`

`upsell_suggestions`

`dynamic_pricing_recommend`

`uplift_model`

---

# 4.2.1 /api/v1/ai/propensity_buy_product

---

### Purpose

* SKU-Level Uplift Scoring

Predict how likely each individual customer is to purchase a specific product (or close substitute) in the next campaign cycle. Customers are ranked into tiers: Very High → Very Low so you can:

Send SKU-targeted emails/SMS to the top deciles

Optimize look-alike audiences for paid media

Personalize on-site banners and recommendations

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body Schema

| **Key**       | **Type / Range** | **Required** | **Meaning**                  | **Typical Derivation**     |
| ------------- | ---------------- | ------------ | ---------------------------- | -------------------------- |
| `product_sku` | string           | yes          | The SKU to push              | Use canonical catalogue ID |
| `customers`   | array<object>    | yes          | Rows to score or train+score | From CDP or feature store  |

---

### Customer Object Fields

| **Key**       | **Type** | **Required** | **Meaning**                            |
| ------------- | -------- | ------------ | -------------------------------------- |
| `customer_id` | string   | yes          | CRM primary key                        |
| `features`    | object   | yes          | Flat numeric feature vector            |
| `label_buy`   | 0 / 1    | optional     | Ground-truth flag if used for training |

---

###  Starter Feature Dictionary

| **Feature**               | **Business Meaning**           | **Example SQL**                             |
| ------------------------- | ------------------------------ | ------------------------------------------- |
| `age`                     | Customer's age in years        | `EXTRACT(YEAR FROM AGE(birth_date))`        |
| `tenure_months`           | Lifetime with brand            | `DATEDIFF(MONTH, first_purchase, snapshot)` |
| `category_views_last_30d` | Engagement with SKU's category | GA / Mixpanel page views                    |
| `avg_ticket`              | Mean order value               | `AVG(order_total)`                          |

---

### How It Works Internally

1. Label Check
2. 
Requires ≥ 20 labeled rows per class (0 and 1); otherwise exits with a message.

2. AutoML

Tries LogReg, XGBoost, RF, CatBoost. Chooses best ROC-AUC (5-fold CV).

3. Scoring

Outputs probability `P(buy=1)`.

4. Tier Mapping (defaults)

* Very High ≥ 90%

* High ≥ 70%

* Medium ≥ 40%

* Low ≥ 20%

* Very Low < 20%

---

### Example #1 – Not Enough Labels

## Request

```json
{
  "product_sku": "SKU-A123",
  "customers": [
    {
      "customer_id": "C-1001",
      "features": { "age": 34, "tenure_months": 27, "category_views_last_30d": 15, "avg_ticket": 185.3 },
      "label_buy": 1
    },
    {
      "customer_id": "C-1002",
      "features": { "age": 57, "tenure_months": 3, "category_views_last_30d": 2, "avg_ticket": 42.1 }
    }
  ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    },
    {
      "customer_id": "C-1002",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example #2 – Sufficient Labels (Training + Scoring)

```json
{
  "product_sku": "SKU-A123",
  "customers": [ ... 5000 rows with `label_buy` ... ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1234",
      "probability": 0.91,
      "propensity_tier": "Very High",
      "interpretation": "Very high propensity – prime candidate for personalised offer."
    }
  ],
  "model_info": {
    "best_algorithm": "CatBoost",
    "roc_auc": 0.842,
    "selected_features": ["category_views_last_30d", "tenure_months", "avg_ticket"],
    "train_rows": 4800,
    "test_rows": 200
  }
}
```

---

### Field Glossary – Response

| **Path**                        | **Type**       | **Meaning**                                | **Usage**                 |
| ------------------------------- | -------------- | ------------------------------------------ | ------------------------- |
| `predictions[].probability`     | float or null  | Buy probability                            | Sort for campaigns        |
| `predictions[].propensity_tier` | enum           | Very High / High / Medium / Low / Very Low | Filter by segment         |
| `predictions[].interpretation`  | string         | Simple wording for action                  | Use in CRM/email merge    |
| `model_info.best_algorithm`     | string         | AutoML selected algorithm                  | ML audit                  |
| `model_info.roc_auc`            | float          | AUC on hold-out set                        | Compare to baseline model |
| `model_info.note`               | string or null | Error/skip reason                          | Alert or debug            |

---

### Commercial Playbooks

| **Use-case**             | **Action**                                    | **KPI Lift**         |
| ------------------------ | --------------------------------------------- | -------------------- |
| Email blast optimisation | Send SKU promo only to High & Very High tiers | +22% CTR, –46% unsub |
| On-site banner           | Show product for users with P(buy) ≥ 0.7      | +18% PDP views       |
| Paid social              | Export top 10% to Look-alike on Meta          | –15% CPA             |
| Sales queue              | Push High tier to CRM call list               | +12% close rate      |

---

### Data Engineering Tips

Labeling: Define 30/60/90d window → `label_buy = 1 if purchased`.

Feature TTL: Refresh time-sensitive features (e.g. views) daily.

Cold Start SKUs: Use category-level model if SKU lacks data.

---

### FAQ

| **Q**                                     | **A**                                                           |
| ----------------------------------------- | --------------------------------------------------------------- |
| Can I send categorical features?          | Yes – send as strings, auto-encoded internally.                 |
| Multiple SKUs in one call?                | No – one SKU per request (loop client-side).                    |
| All probabilities `null` – what happened? | Likely fewer than 20 positive labels or only one class present. |
| Can I override tier cut-offs?             | Yes – use `tier_quantiles:[0.9,0.7,0.4,0.2]` (Enterprise only). |
| Max batch size?                           | 100k rows or 20MB per call. Async/bulk version: Q4 2025.        |

---

### Next Step

Pipe High and Very High tiers into your campaign engine.
Suppress Very Low, reduce fatigue, and boost SKU performance per e-mail.

---

### 4.2.2 /api/v1/ai/propensity_respond_campaign

---

### Purpose – Will They Engage With This Campaign?

Forecast the individual likelihood that a customer will open, click, or purchase from a specific marketing campaign. Ideal for:

* Audience trimming to protect deliverability

* Discount allocation (e.g., full coupon only to top deciles)

* Predictive hold-out tests & incremental-lift measurement

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body Schema

## Required Fields

| **Key**       | **Type / Range** | **Required?** | **Meaning**                         | **Typical Derivation**      |
| ------------- | ---------------- | ------------- | ----------------------------------- | --------------------------- |
| `campaign_id` | string           | yes           | ID or slug of the outbound campaign | e.g., `"Spring-Promo-2025"` |
| `customers`   | array<object>    | yes           | Rows to score (or train + score)    | From CDP or ESP export      |

---

### Customer Object Fields

| **Field**       | **Type** | **Required?** | **Business Meaning**               |
| --------------- | -------- | ------------- | ---------------------------------- |
| `customer_id`   | string   | yes           | Primary key (CRM ID)               |
| `features`      | object   | yes           | Numeric/categorical features       |
| `label_respond` | 0 / 1    | optional      | Ground truth if customer responded |

---

### Starter Feature Kit

| **Feature**          | **What it Captures**        | **Example SQL / Source**         |
| -------------------- | --------------------------- | -------------------------------- |
| `email_click_rate`   | Historical email engagement | clicks / sends over last 90 days |
| `sms_opt_in`         | SMS subscription flag       | From ESP opt-in table            |
| `purchases_last_90d` | Recent transaction count    | `COUNT(DISTINCT order_id)`       |

---

### What the Service Does

1. Label Check: Requires ≥ 20 of both label_respond = 0 and label_respond = 1.

2. AutoML: Runs Logistic Regression, XGBoost, Random Forest, CatBoost with 5-fold CV.

3. Scoring: Outputs calibrated P(respond = 1).

4. Tier Mapping (default):

* Very High ≥ 0.9

* High ≥ 0.7

* Medium ≥ 0.4

* Low ≥ 0.2

* Very Low < 0.2

5. Interpretation: Tier-specific explanations in plain English.

---

### Example 1 – Too Few Labels

## Request

```json
{
  "campaign_id": "Spring-Promo-2025",
  "customers": [
    {
      "customer_id": "C-2001",
      "features": {
        "email_click_rate": 0.22,
        "sms_opt_in": 1,
        "purchases_last_90d": 3
      },
      "label_respond": 0
    }
  ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-2001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example 2 – Full Model Training & Scoring

Assume 10,000 rows passed, with 2,000 historical responders (`label_respond = 1`).

## Response Snippet

```json
{
  "predictions": [
    {
      "customer_id": "C-6155",
      "probability": 0.77,
      "propensity_tier": "High",
      "interpretation": "High propensity – include in main send."
    },
    {
      "customer_id": "C-9342",
      "probability": 0.12,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – suppress or cheaper channel."
    }
  ],
  "model_info": {
    "best_algorithm": "XGBoost",
    "roc_auc": 0.812,
    "feature_importance": ["email_click_rate", "purchases_last_90d", "sms_opt_in"],
    "train_rows": 9000,
    "test_rows": 1000
  }
}
```

---

### Response Field Guide

| **Path**                    | **Type**     | **Meaning**                          | **Usage**                        |
| --------------------------- | ------------ | ------------------------------------ | -------------------------------- |
| `predictions[].probability` | float / null | Response probability                 | Score thresholding at 0.7 or 0.4 |
| `propensity_tier`           | enum         | Engagement likelihood tier           | Segment filters in ESP or CRM    |
| `interpretation`            | string       | Readable explanation                 | Sales or support rep copy        |
| `best_algorithm`            | string       | AutoML model used                    | For reproducibility              |
| `roc_auc`                   | float        | Hold-out performance (AUC)           | Model evaluation metric          |
| `note`                      | string       | Shown when model training is skipped | Alert data team if shown         |

---

### Commercial Playbooks

| **Use Case**         | **Action**                                      | **Lift / ROI**                        |
| -------------------- | ----------------------------------------------- | ------------------------------------- |
| Email deliverability | Send only to Medium–Very High tiers             | +8 pp open-rate, –40% spam complaints |
| Discount cost        | Give full discount to High/Very High only       | –18% promo cost, +5% revenue          |
| SMS vs Push          | SMS = High tiers, Push = Medium, Suppress = Low | –27% messaging cost, same revenue     |
| A/B testing          | Hold out 10% of High tier for true uplift       | Clean incremental sales measurement   |

---

###  Data Engineering Best Practices

1. **Label window** – mark `label_respond` = 1 if customer opened OR clicked OR transacted within 7 days of campaign send (customisable).

2. **Feature freshness** – refresh behavioural features nightly; stale email-click rates hurt performance fast.

3. **Cold-start campaigns** – for brand-new `campaign_id` with zero labels, warm-start with a global engagement model (road-map endpoint `propensity_engage_any`).

4. **Feature parity** – keep the same feature set between training and inference to avoid schema drift.

---

### FAQ

| **Q**                                         | **A**                                                       |
| --------------------------------------------- | ----------------------------------------------------------- |
| Can I train once and score later?             | Yes, models are cached for 30 days.                         |
| Can I score for click vs purchase separately? | Multi-class model support planned for Q1 2026.              |
| How many customers per call?                  | 100,000 rows or 20MB; bulk async in roadmap.                |
| PII / GDPR safe?                              | Yes – only `customer_id` is required. Use hashes if needed. |

---

### Next Step

Send High and Very High IDs into your ESP, prioritize based on score, and maximize ROAS while minimizing list fatigue.

Let me know if you'd like me to format the next endpoint `/propensity_upgrade_plan` in the same style.

---

# 4.2.3 /api/v1/ai/propensity_upgrade_plan

---

### Purpose – Upsell-Ready Scores for Plan Upgrades

Predict each customer’s likelihood to upgrade from their current subscription tier to a more lucrative target tier during your next upsell push or in-app paywall.

Use cases:

* Prioritise CSM outreach or in-product nudges

* Forecast revenue upside before launching “Go Gold Now” offers

* Build look-alike audiences for acquisition

---

### Headers

X-Customer-Api-Id: <uuid>  
X-Secret: <secret>  
Content-Type: application/json

---

### Request Body – Schema & Field Guide

## Required Fields

| **Key**        | **Type / Range** | **Required** | **Meaning**             | **Notes / Source**        |
| -------------- | ---------------- | ------------ | ----------------------- | ------------------------- |
| `current_plan` | string           | yes          | Customer’s current tier | e.g., "Starter", "Silver" |
| `target_plan`  | string           | yes          | Tier to upsell to       | e.g., "Gold", "Pro"       |
| `customers`    | array<object>    | yes          | Customer records        | Pulled from CRM/CDP       |

---

### Customer Object Fields

| **Field**       | **Type** | **Required** | **Meaning**                          |
| --------------- | -------- | ------------ | ------------------------------------ |
| `customer_id`   | string   | yes          | CRM primary key                      |
| `features`      | object   | yes          | Flat numeric/categorical feature set |
| `label_upgrade` | 0 / 1    | optional     | 1 if upgraded in historical window   |

---

### Starter Feature Kit

| **Feature**                | **What it Captures**            | **Typical SQL / Metric**                |
| -------------------------- | ------------------------------- | --------------------------------------- |
| `months_on_current_plan`   | Upgrade timing urgency          | `DATEDIFF(MONTH, plan_start, snapshot)` |
| `storage_usage_pct`        | Capacity squeeze trigger        | `(used_storage / quota) * 100`          |
| `support_tickets_last_30d` | Support interactions / friction | `COUNT(Zendesk tickets)`                |

Feel free to add fields like `MRR`, `API_call_volume`, `project_count`, `NPS`, etc.

---

### Engine Workflow

1. Label check: ≥ 20 `label_upgrade = 1` and `0` required for model training.

2. AutoML: Tries Logistic Regression, RF, XGBoost, CatBoost (5-fold CV).

3. Calibrated output: Returns `P(upgrade = 1)` for each customer.

4. Tier mapping:

* Very High ≥ 0.90

* High ≥ 0.70

* Medium ≥ 0.40

* Low ≥ 0.20

* Very Low < 0.20

5. Interpretation: Each score includes a one-line summary.

---

### Example #1 – Not Enough Labels

```json
{
  "current_plan": "Silver",
  "target_plan": "Gold",
  "customers": [
    {
      "customer_id": "C-3001",
      "features": {
        "months_on_current_plan": 8,
        "storage_usage_pct": 92,
        "support_tickets_last_30d": 4
      },
      "label_upgrade": 1
    }
  ]
}
```

---

### Response

```json
{
  "predictions": [
    {
      "customer_id": "C-3001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example #2 – Full Training & Scoring

(5,000 rows; 600 upgrades observed)

---

### Response Snippet

```json
{
  "predictions": [
    {
      "customer_id": "C-3088",
      "probability": 0.86,
      "propensity_tier": "High",
      "interpretation": "High propensity – push personalised upgrade offer."
    },
    {
      "customer_id": "C-3201",
      "probability": 0.18,
      "propensity_tier": "Low",
      "interpretation": "Low propensity – nurture, don’t discount."
    }
  ],
  "model_info": {
    "best_algorithm": "CatBoost",
    "roc_auc": 0.79,
    "selected_features": [
      "storage_usage_pct",
      "months_on_current_plan",
      "support_tickets_last_30d"
    ],
    "train_rows": 4500,
    "test_rows": 500
  }
}
```

---

### Response Field Glossary

| **Path**                    | **Type**      | **Meaning**                                | **Practical Use**                |
| --------------------------- | ------------- | ------------------------------------------ | -------------------------------- |
| `predictions[].probability` | float / null  | Likelihood of upgrade next cycle           | Rank and filter (≥ 0.7 = target) |
| `propensity_tier`           | enum          | Very High / High / Medium / Low / Very Low | CRM / ESP segmentation           |
| `interpretation`            | string        | Sales-friendly summary                     | Tooltips, email, CRM             |
| `model_info.best_algorithm` | string / null | Best AutoML model                          | Audit and reproducibility        |
| `model_info.roc_auc`        | float / null  | Holdout performance                        | Model quality tracking           |
| `model_info.note`           | string / null | Explanation if training skipped            | Alert data/ML team               |

---

### Commercial Playbooks

| **Scenario**        | **Action**                                                | **Lift**                           |
| ------------------- | --------------------------------------------------------- | ---------------------------------- |
| Usage-driven upsell | Auto-trigger in-app pop-up if tier = High + storage > 80% | +22% conversion vs. generic prompt |
| CSM queue           | Push Very High customers into CSM dashboards              | +15% expansion MRR                 |
| Email offer         | Send discounts to Medium–High only; suppress Very Low     | –38% promo cost, same revenue      |
| Pricing strategy    | Compare scores before/after price change                  | Data-driven elasticity measure     |

---

### Data & Ops Best Practices

* Label window: `label_upgrade = 1` if upgrade happened within 90 days after snapshot.

* Feature freshness: Daily update for storage_usage_pct.

* Multi-step ladders: Train per plan hop (e.g., Silver→Gold, Gold→Platinum).

* Model caching: Auto-caches model per `current_plan + target_plan` for 30 days.

---

### FAQ

| **Q**                                      | **A**                                                        |
| ------------------------------------------ | ------------------------------------------------------------ |
| Can I score multiple target plans at once? | No – one per request to avoid model confusion.               |
| Only 12 positive upgrades?                 | Expand window, group tiers, or request generic upsell model. |
| Downgrade prediction?                      | Use `/propensity_downgrade_plan` (beta).                     |
| GDPR?                                      | Hash `customer_id`; no other PII is required.                |
| Max batch size?                            | 100,000 rows or 20MB; async bulk support in Q4 2025.         |

---

### Next Step

Pipe High and Very High propensities into your CSM and marketing tools. Trigger tailored upgrade journeys and watch expansion MRR grow—without blanketing your entire user base.

---

# 4.2.4 /api/v1/ai/recommend_user_items

### Purpose – Hyper-Personalised Product Suggestions in One Call

Generate a ranked list of items most likely to interest a given user by combining historical interactions with product metadata.

Model Logic:

* ALS (matrix factorisation) when ≥ 75 users × ≥ 50 items.

* TF-IDF + cosine similarity for sparse or cold-start scenarios.

---

### Headers

X-Customer-Api-Id: <uuid>  
X-Secret: <secret>  
Content-Type: application/json

---

### Request Body – Complete Field Reference

## Root Keys

| **JSON Path**  | **Type / Range** | **Required** | **Meaning**                   | **Notes**                                         |
| -------------- | ---------------- | ------------ | ----------------------------- | ------------------------------------------------- |
| `user_id`      | string           | yes          | User to recommend items for   | Example: "U-42"                                   |
| `top_k`        | int (1–100)      | optional     | Max number of recommendations | Default: 10; 5–25 for email; 50–100 for UI scroll |
| `interactions` | array<object>    | yes          | Clicks, views, ratings, buys  | Min 3 rows                                        |
| `items`        | array<object>    | yes          | Items to rank                 | Supply full candidate catalogue                   |

---

### interactions[] Structure

| **Key**   | **Type** | **Required** | **Notes**                               |
| --------- | -------- | ------------ | --------------------------------------- |
| `user_id` | string   | yes          | Can be other users to help matrix build |
| `item_id` | string   | yes          | Must exist in `items[]`                 |
| `rating`  | float    | optional     | 0–5 explicit score; else treated as +1  |

---

### items[] Structure

| **Key**    | **Type** | **Required** | **Notes**                                    |
| ---------- | -------- | ------------ | -------------------------------------------- |
| `item_id`  | string   | yes          | Primary key                                  |
| `metadata` | string   | optional     | Rich attributes: category, brand, tags, etc. |

* You may include extra keys (e.g. price), which are ignored now but stored for future use.

---

### Algorithm Selection & Pipeline

| **Step**              | **Dense Matrix (ALS)**                      | **Sparse / Cold-start (TF-IDF)**           |
| --------------------- | ------------------------------------------- | ------------------------------------------ |
| **1. Check Sparsity** | ≥ 75 users, ≥ 50 items, ≥ 1500 interactions | Otherwise                                  |
| **2. Prepare Data**   | Implicit matrix; weight rating/5 vs. 1      | TF-IDF over metadata (bigrams, idf smooth) |
| **3. Train**          | ALS (50 dims, 30 iterations)                | —                                          |
| **4. Score**          | Cosine similarity in latent space           | Cosine similarity in TF-IDF vector space   |
| **5. Filter**         | Remove already seen items, apply diversity  | —                                          |
| **6. Return**         | Top-K by score                              | Top-K by similarity                        |

## Performance:

* ALS cached: ~60 ms

* TF-IDF fallback: ~15 ms (100k-item catalogue, CPU)

---

### Example Request

```json
{
  "user_id": "U-42",
  "top_k": 5,
  "interactions": [
    {"user_id": "U-42", "item_id": "SKU-A1", "rating": 5},
    {"user_id": "U-42", "item_id": "SKU-B9"},
    {"user_id": "U-17", "item_id": "SKU-C3", "rating": 4}
  ],
  "items": [
    {"item_id": "SKU-A1", "metadata": "Running shoes, Nike, men"},
    {"item_id": "SKU-B9", "metadata": "Trail shoes, Adidas, women"},
    {"item_id": "SKU-C3", "metadata": "Soccer ball, size 5"},
    {"item_id": "SKU-D7", "metadata": "Compression socks, unisex"},
    {"item_id": "SKU-E2", "metadata": "Fitness smartwatch"}
  ]
}
```

---

### Example Response

```json
{
  "recommendations": [
    {
      "item_id": "SKU-B9",
      "score": 0.1783,
      "source": "content-fallback",
      "explanation": "Shares similar attributes/keywords with the reference item."
    },
    {
      "item_id": "SKU-C3",
      "score": 0.0000,
      "source": "content-fallback"
    }
  ],
  "model_info": {
    "algorithm": "TF-IDF cosine",
    "metric": "cosine_sim",
    "value": 1.0,
    "train_rows": 5
  }
}
```

---

### Field Guide

| **Path**                        | **Type**       | **Meaning**                     | **Use**                   |
| ------------------------------- | -------------- | ------------------------------- | ------------------------- |
| `recommendations[].item_id`     | string         | SKU to show                     | PDP, email, widgets       |
| `recommendations[].score`       | float 0–1      | Relevance score                 | Use in ranking / blending |
| `recommendations[].source`      | enum           | `als` or `content-fallback`     | Trace model used          |
| `recommendations[].explanation` | string         | Why it was recommended          | Display in UI             |
| `model_info.algorithm`          | string         | Engine used                     | Audit log                 |
| `model_info.metric/value`       | string / float | Fit score (cosine\_sim or RMSE) | Drift monitoring          |
| `model_info.train_rows`         | int            | Count of training interactions  | Data quality checkpoint   |

---

### Commercial Playbooks

| **Surface**         | **Implementation**                                  | **Lift**               |
| ------------------- | --------------------------------------------------- | ---------------------- |
| PDP                 | Call client-side on load                            | +9% add-to-cart        |
| Post-purchase email | Use `user_id` of last buyer, show top 5 new SKUs    | +18% repeat order rate |
| App push            | Daily cron sends top SKU for user if score > 0.4    | +7% DAU retention      |
| In-store kiosk      | Use loyalty card to get `user_id` → recommendations | +5% basket size        |

---

### Data Engineering & Ops Tips

* Interaction weighting: Multiple rows of same `(user, item)` are summed. Prefer one explicit rating.

* Cold-start items: Add rich metadata for TF-IDF to work well.

* Batching: Loop over users nightly and store results.

* Diversity: Post-process top-k by category/brand to avoid tunnel vision.

* Privacy: `user_id` can be hashed; no PII needed.

---

### FAQ

| **Q**                               | **A**                                                                 |
| ----------------------------------- | --------------------------------------------------------------------- |
| Can I include timestamps?           | Not yet – time-weighted ALS in Q2 2026.                               |
| What if I have 1M items?            | Use `top_k=200`, filter downstream in your DB.                        |
| Can I recommend for multiple users? | Not in one call – use `/bulk_recommend_user_items`.                   |
| Cold-start user?                    | Provide 3+ implicit items (e.g., last views); otherwise returns `[]`. |
| Regulator explainability?           | Add `X-Explain-Features: true` to header (Enterprise).                |

---

### Next step
Pipe the recommendations into your front-end component, measure CTR uplift, and iterate: the more interaction rows you send, the smarter the engine becomes.

---

# 4.2.5 /api/v1/ai/recommend_similar_items

### Purpose

Return the K most similar catalogue items for a given reference SKU by blending collaborative-filter (CF) co-view signals with content-based vector similarity.

Ideal for:

* PDP widgets (“You may also like”)

* Search fallbacks

* Out-of-stock redirects

* Automatic cross-sell bundles

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Business Value

| **Use Case**                | **Benefit**                                         |
| --------------------------- | --------------------------------------------------- |
| PDP carousel                | +6–12% add-to-cart on long-tail SKUs                |
| Out-of-stock redirect       | Recover 30–40% of lost sessions                     |
| Bundle builder / cross-sell | Lift AOV 8–15% with automatic accessory suggestions |
| Category discovery          | Boost SEO dwell time and pages/session              |

---

### Request Body – Schema

## Top-level keys

| **Key**        | **Type / Range** | **Required?** | **Meaning**                        | **Notes**                                      |
| -------------- | ---------------- | ------------- | ---------------------------------- | ---------------------------------------------- |
| `item_id`      | string           | yes           | SKU to get look-alikes for         | Must exist in `items[]`                        |
| `top_k`        | int (1–100)      | optional      | Number of similar items to return  | Default: 10. Use 4–8 for desktop; 12–16 mobile |
| `items`        | array<object>    | yes           | Catalogue to rank from             | Candidate items                                |
| `interactions` | array<object>    | optional      | User-item historical data (for CF) | 1,000+ rows recommended                        |
| `blend_cf`     | float (0–1)      | optional      | Weight for collaborative filtering | Default: 0.5 (50/50 blend)                     |

---

### items[] structure

| **Key**    | **Type** | **Required?** | **Notes**                       |
| ---------- | -------- | ------------- | ------------------------------- |
| `item_id`  | string   | yes           | SKU                             |
| `metadata` | string   | optional      | Keywords (e.g. brand, category) |

---

### interactions[] structure

| **Key**   | **Type** | **Required?** | **Notes**                         |
| --------- | -------- | ------------- | --------------------------------- |
| `user_id` | string   | yes           | —                                 |
| `item_id` | string   | yes           | Must match an `items[]` entry     |
| `rating`  | float    | optional      | 0–5. Omitted = implicit +1 rating |

---

### How It Works

## When `interactions` are included:

1. Content similarity

* Uses TF-IDF vectorisation on `metadata`

* Scores via cosine similarity

2. Collaborative filtering (CF)

* ALS (30 dims, 20 iterations)

* Requires ≥ 75 users × 50 items

3. Blending

final_score = blend_cf * cf_score + (1 – blend_cf) * content_score

* Items without CF data use cf_score = 0.
  
4. Filter & Rank

* Exclude item_id from results

* Return top k by final_score

## Average latency:

* 80 ms (with CF)

* 20 ms (content-only)

---

### Example Request

```json
{
  "item_id": "SKU-A1",
  "top_k": 4,
  "items": [
    {"item_id": "SKU-A1", "metadata": "Running shoes, Nike, men"},
    {"item_id": "SKU-B9", "metadata": "Trail shoes, Adidas, women"},
    {"item_id": "SKU-C3", "metadata": "Soccer ball, size 5"},
    {"item_id": "SKU-D7", "metadata": "Compression socks, unisex"},
    {"item_id": "SKU-E2", "metadata": "Fitness smartwatch"}
  ],
  "interactions": [
    {"user_id": "U-42", "item_id": "SKU-A1"},
    {"user_id": "U-42", "item_id": "SKU-B9"},
    {"user_id": "U-17", "item_id": "SKU-A1"},
    {"user_id": "U-17", "item_id": "SKU-D7"}
  ],
  "blend_cf": 0.7
}
```

---

### Example Response

```json
{
  "recommendations": [
    {
      "item_id": "SKU-B9",
      "score": 0.1783,
      "source": "content",
      "explanation": "Shares similar attributes/keywords with the reference item."
    },
    ...
  ],
  "model_info": {
    "algorithm": "TF-IDF cosine",
    "metric": "cosine_sim",
    "value": 1.0,
    "train_rows": 5
  }
}
```

---

### Field Reference

| **Path**                        | **Type**     | **Meaning**                    | **Use**                                |
| ------------------------------- | ------------ | ------------------------------ | -------------------------------------- |
| `recommendations[].item_id`     | string       | Similar SKU                    | PDP carousel, alternate SKUs           |
| `recommendations[].score`       | float (0–1)  | Final blended score            | Sort or blend with business logic      |
| `recommendations[].source`      | enum         | `cf`, `content`, or `blend`    | Debug or analytics                     |
| `recommendations[].explanation` | string       | Reason text                    | Tooltip or UI label                    |
| `model_info.algorithm`          | string       | Engine used                    | Audit                                  |
| `model_info.metric/value`       | string/float | Fit quality                    | Model health, drift detection (future) |
| `model_info.train_rows`         | int          | Interactions used for training | Data volume confidence                 |

---

### Commercial Playbooks

| **Surface**           | **Implementation**                              | **KPI Impact**           |
| --------------------- | ----------------------------------------------- | ------------------------ |
| PDP Widget            | Call server-side; cache per SKU for 24h         | +8–15% add-to-cart       |
| Search No-Result      | Recommend alternatives when query fails         | Recover 20–30% drop-offs |
| Out-of-Stock Fallback | Swap unavailable SKU for top 3 look-alikes      | Saves 40% lost sessions  |
| Dynamic Bundles       | Suggest lower-priced accessories on cart > \$50 | +10% attach rate         |

---

### Engineering & Ops Tips

* Metadata: Strip stop-words for clarity.

* Brand weighting: Repeat key attributes to boost TF-IDF `(e.g., "Nike Nike")`.

* Cold start: Provide rich metadata to compensate for no interactions.

* Model freshness: Retrain TF-IDF nightly as catalogue changes.

* Latency: Cache CF model in memory and refresh hourly.

---

### FAQ

| **Q**                          | **A**                                                         |
| ------------------------------ | ------------------------------------------------------------- |
| Can I disable CF?              | Yes — set `"blend_cf": 0` or omit `interactions`.             |
| What if the item is brand-new? | CF score = 0; fallback to content-only.                       |
| Max catalogue size?            | 1M items / \~20 MB JSON. Use gzip & HTTP/2.                   |
| Multi-language metadata?       | Works language-agnostic. Tokenisation required for CN/JP.     |
| GDPR?                          | Only hashed `user_id` if using `interactions`. No PII stored. |

---

### Next Step

Integrate this into your PDP or dynamic widget, cache for 24h per SKU, and run an A/B test vs. your static “similar items” list.

Expect double-digit cross-sell revenue lift in week one.

---

# 4.2.6 /api/v1/ai/cross_sell_matrix

## Quantifying “Bought-Together” Affinity in One Call

## Purpose

Return a square matrix that quantifies how strongly each item or category lifts the probability of another being bought in the same basket.

---

### Business Use Cases

| **Business Play**                          | **Impact**               |
| ------------------------------------------ | ------------------------ |
| “Frequently Bought Together” widget        | +8–18% attach rate       |
| Dynamic bundle & upsell rules at checkout  | +5–12% AOV               |
| Assortment optimisation / planogram design | Higher shelf penetration |
| Category-to-category marketing flows       | 10–25% e-mail CTR        |

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body – Field-by-Field Guide

| **Key**        | **Type / Range**         | **Required**                    | **Meaning**                            | **Notes / Source**                |
| -------------- | ------------------------ | ------------------------------- | -------------------------------------- | --------------------------------- |
| `level`        | `"item"` or `"category"` | optional                        | Matrix granularity                     | Default: `"item"`                 |
| `customer_id`  | `string` or `null`       | optional                        | Set to get personal matrix             | Use global (null) or personal     |
| `transactions` | `array<object>`          | yes                             | Orders: each includes customer + items | 6–36 months history               |
| `item_catalog` | `array<object>`          | req. only if level = "category" | SKU to category mapping                | Needed if using `"category"` mode |

---

### transactions[]

| **Key**       | **Type**        | **Required** | **Description**            |
| ------------- | --------------- | ------------ | -------------------------- |
| `customer_id` | `string`        | yes          | Buyer ID                   |
| `items`       | `array<string>` | yes          | List of SKUs in the basket |

---

### item_catalog[] (for category mode)

| **Key**    | **Type** | **Required** | **Description** |
| ---------- | -------- | ------------ | --------------- |
| `item_id`  | `string` | yes          | SKU             |
| `category` | `string` | yes          | Category slug   |

---

### How the Metric Is Calculated

support(i) = number of orders with item i
support(i & j) = number of orders with both i and j
confidence(i → j) = support(i & j) / support(i)

* Diagonal `(i == j)` = 1.0 by definition

* No negative values (min = 0)

* Optional: compute lift as `confidence / support(j)` downstream

---

### End-to-End Pipeline

1. Pre-clean: De-dupe `items[]` per order

2. Count: Map-reduce to count ``support(i)`` and `support(i & j)`

3. Compute: Calculate `confidence(i → j)` and round

4. Reorder: Sort items by global frequency

5. Return: Include headers + matrix

---

### Example Request

```json
{
  "level": "item",
  "customer_id": null,
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] }
  ],
  "item_catalog": []
}
```

---

### Example Response

```json
{
  "items_or_categories": ["SKU-A1", "SKU-B9", "SKU-D7", "SKU-E2"],
  "matrix": [
    [1.0, 0.5, 0.5, 0.5],
    [0.5, 1.0, 0.0, 0.5],
    [1.0, 0.0, 1.0, 1.0],
    [0.5, 0.5, 0.5, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:33:37.149247Z"
}
```

---

### Field Glossary – Response

| **Path**                | **Type**         | **Meaning**                         | **Use**                  |
| ----------------------- | ---------------- | ----------------------------------- | ------------------------ |
| `items_or_categories[]` | array of strings | Header mapping for matrix           | Display / lookup         |
| `matrix[][]`            | 2D float array   | Confidence(i→j) matrix              | Feed into UI or BI tools |
| `metric`                | string           | Formula used (default = confidence) | Analytics & audit        |
| `generated_at`          | ISO timestamp    | When this was calculated            | Cache strategy           |

---

### Threshold Recipes

| **Use Case**                     | **Rule**                                                                   | **Suggested Threshold**       |
| -------------------------------- | -------------------------------------------------------------------------- | ----------------------------- |
| PDP “Frequently Bought Together” | Show top 3 `j` where `confidence(i→j) ≥ 0.15`                              | 15% (fashion), 3–5% (grocery) |
| Cart Upsell                      | Auto-suggest `j` when `confidence(i→j) ≥ 0.25` and high margin             | 25%                           |
| Bundle Creation                  | Export `i,j` pairs with `confidence ≥ 0.30` and `support(i&j) ≥ 100`       | 30%                           |
| E-mail Cross-sell                | Target buyers of `i` who’ve never bought `j` with `confidence(i→j) ≥ 0.20` | 20%                           |

---

### Engineering & Ops Tips

* Time window: 180d (CPG), 365d (furniture, B2B)

* Large baskets: Trim top 50 items by value if >200 SKUs

* Category mode: Requires `item_catalog`; ideal for long-tail items

* Global vs Personal: Global = all customers; Personal = 1:1

* Visualisation: Use seaborn heatmaps or D3.js chord diagrams

---

### Advanced Configuration (Enterprise)

| **Param**         | **Type**     | **Effect**                                      |
| ----------------- | ------------ | ----------------------------------------------- |
| `metric: "lift"`  | string       | Returns lift = confidence / support(j)          |
| `min_support`     | int ≥ 1      | Filter items with low support count             |
| `symmetric: true` | boolean      | Averages matrix: `M[i][j] = M[j][i]`            |
| `time_range`      | {start, end} | Limit to transaction slice (e.g., Black Friday) |

---

### FAQ

| **Q**                       | **A**                                                         |
| --------------------------- | ------------------------------------------------------------- |
| How big can the matrix get? | Up to 5,000 × 5,000 (200 MB); sparse streaming coming Q4 2025 |
| Why are diagonals all 1.0?  | By definition: item always co-occurs with itself              |
| Any negative values?        | Never – confidence is always ≥ 0                              |
| Can I exclude items?        | Yes – remove them from `transactions[].items` before calling  |
| Real-time latency?          | < 500ms for up to 250k orders                                 |

---

### Quick Win

Pipe the matrix into a rule that auto-inserts the top co-purchased SKU into your cart drawer.

Start with `confidence ≥ 0.20` and watch AOV and attach rate climb.

---

# 4.2.7 /api/v1/ai/cross_sell_matrix

## Category-to-Category Heat-Map

## Purpose

The category-level mode aggregates every SKU into its parent category and tells you:

“When a basket contains any item from category i, how often does it also contain at least one item from category j?”

Use-cases range from macro merchandising to campaign adjacency rules.

---

### Commercial Playbook

| **Commercial Play**            | **How the Matrix Helps**                                            | **Typical Lift**     |
| ------------------------------ | ------------------------------------------------------------------- | -------------------- |
| Homepage “Complete the Look”   | Display the top companion categories while browsing a base category | +6–10% click-through |
| Joint discount bundles         | Identify pairings with high co-occurrence but low margin to bundle  | +4–8% basket value   |
| Store layout / aisle adjacency | Co-locate categories with high mutual confidence                    | +3–5% in-store sales |
| Cross-category e-mail flows    | Target buyers who skipped a usually-linked category                 | 2–3× better response |

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Request Body (Category Mode)

```json
{
  "level": "category",
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-3", "items": ["SKU-D7"] },
    { "customer_id": "C-4", "items": ["SKU-A1", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] },
    { "customer_id": "C-5", "items": ["SKU-A1", "SKU-B9", "SKU-D7"] },
    { "customer_id": "C-6", "items": ["SKU-E2", "SKU-D7"] }
  ],
  "item_catalog": [
    { "item_id": "SKU-A1", "category": "Shoes" },
    { "item_id": "SKU-B9", "category": "Shoes" },
    { "item_id": "SKU-D7", "category": "Accessories" },
    { "item_id": "SKU-E2", "category": "Wearables" }
  ]
}
```

---

### Field-by-Field

| **Path**         | **Type**         | **Required?** | **Meaning**                      | **Tips**                          |
| ---------------- | ---------------- | ------------- | -------------------------------- | --------------------------------- |
| `level`          | `"category"`     | ✅             | Triggers category aggregation    | `"item"` is default               |
| `transactions[]` | `array<object>`  | ✅             | 1 transaction = 1 order          | Clean out test or canceled orders |
| `item_catalog[]` | `array<object>`  | ✅             | SKU → Category map               | Many-to-one is valid              |
| `customer_id`    | `string or null` | optional      | Set for personal matrix (1-to-1) | Keep `null` for global stats      |

---

### Computation Logic

1. SKU → Category: Every SKU becomes its category. Categories are de-duplicated per basket.

2. Support counts:

* support(i) = baskets with category i

* support(i & j) = baskets with both i and j

3. Confidence:

confidence(i → j) = orders_with_both(i, j) / orders_with_i

* Diagonal = 1.0

4. Ordering: Categories sorted by descending global support for consistency.

---

### Response

{
  "items_or_categories": ["Accessories", "Shoes", "Wearables"],
  "matrix": [
    [1.0, 0.5, 0.5],
    [0.4, 1.0, 0.6],
    [0.5, 0.75, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:42:59.767166Z"
}

---

### Interpretation Highlights

* Wearables → Shoes = 0.75
→ 75% of baskets with Wearables also have Shoes — strong attach rate.

* Shoes → Accessories = 0.40
→ Moderate co-occurrence; could justify cross-sell or small bundle.

---

### Practical Thresholds & Actions

| **Confidence(i→j)** | **Interpretation** | **Suggested Action**                        |
| ------------------- | ------------------ | ------------------------------------------- |
| ≥ 0.70              | Must-have pair     | Auto-bundle, display “Complete the Look” UI |
| 0.30 – 0.69         | Strong link        | Use for e-mail flows, cross-sell thumbnails |
| 0.10 – 0.29         | Weak link          | Only use if margin is high                  |
| < 0.10              | Likely noise       | Ignore to reduce UI clutter                 |

---

### SQL Recipe – Category Pair Counts

```SQL
WITH sku_orders AS (
  SELECT o.order_id, p.category
  FROM orders o
  JOIN order_items oi ON oi.order_id = o.order_id
  JOIN products p ON p.sku = oi.sku
  WHERE o.order_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 12 MONTH)
),
pairs AS (
  SELECT o1.category AS cat_i, o2.category AS cat_j, o1.order_id
  FROM sku_orders o1
  JOIN sku_orders o2 ON o1.order_id = o2.order_id
)
SELECT
  cat_i,
  cat_j,
  COUNT(DISTINCT order_id) AS orders_with_i_and_j
FROM pairs
GROUP BY 1, 2;
```

---

### Commercial Recipes (Category-Level)

| **Scenario**             | **Usage**                                              | **Expected KPI**         |
| ------------------------ | ------------------------------------------------------ | ------------------------ |
| Paid search landing page | Add tabs for top co-bought categories                  | +8% session depth        |
| Category hero banners    | Show multi-category bundles (e.g., Shoes + Smartwatch) | +5% CTR                  |
| Stock & demand planning  | Allocate buffer stock to co-bought categories          | Fewer stockouts in promo |
| Loyalty incentives       | Give bonus points for Accessories if Shoes in cart     | +12% attach rate         |

---

### Advanced Parameters (Enterprise)

| **Param**         | **Allowed Values** | **Purpose**                                     |
| ----------------- | ------------------ | ----------------------------------------------- |
| `metric`          | `"lift"`           | Shows lift vs baseline purchase rate            |
| `min_support`     | `int ≥ 5`          | Drop rare categories to reduce noise            |
| `time_range`      | `{start, end}`     | Slice matrix by time (e.g., Black Friday week)  |
| `symmetric: true` | `true/false`       | Average matrix for symmetric display (graphing) |

---

### FAQ

| **Q**                                                 | **A**                                                     |
| ----------------------------------------------------- | --------------------------------------------------------- |
| I have 5,000 SKUs and 30 categories – is this faster? | Yes – runtime scales with categories², not SKUs           |
| Repeated categories in a basket — do they inflate?    | No – duplicates removed before counting                   |
| Can I rename categories?                              | Yes – rename in `item_catalog` before sending             |
| Sparse personal matrix — all 0/1s — why?              | Too little data; use 6–12 mo window or fallback to global |
| Recompute how often?                                  | Weekly (global), daily (real-time cart flows)             |
| Privacy concerns?                                     | Only customer\_id is used (can be hashed); no PII needed  |

---

### Next Step

Feed the category-level matrix into your recommendation engine.
When a shopper adds a category like Shoes, query the matrix and surface top SKUs from the highest-confidence follower category (e.g., Accessories).

* Result: Higher attach rate and AOV — no discounts required.

---

# 4.2.8 /api/v1/ai/dynamic_pricing_recommend

## AI-Driven Price Optimisation in <150 ms\

## Purpose

One call returns the profit- or revenue-maximising price for a SKU, using a micro-trained demand model that considers:

* Historical sell-through

* Competitor prices

* Current inventory

* Shopper context (channel/country)

## Typical lift:

+3–9% gross margin or +4–12% top-line revenue (validated in 14 retailers).

---

### Headers

X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json

---

### Business Value

| **Scenario**              | **How this endpoint helps**                           | **Impact**                 |
| ------------------------- | ----------------------------------------------------- | -------------------------- |
| Daily price suggestion    | Scheduled call uploads updated prices to POS / web    | +4–6% gross profit         |
| Flash sale tuning         | Frequent calls optimize discount velocity and margins | Sell aged stock 30% faster |
| Competitor price matching | Undercuts rivals only if margin stays healthy         | Hold share, protect margin |
| Marketplace auto-repricer | Trigger on every new bid                              | +15–25% Buy Box win rate   |

---

### Request Body – Schema & Field Descriptions

| **Field**                  | **Type / Range**           | **Required** | **Description**                              |                  |
| -------------------------- | -------------------------- | ------------ | -------------------------------------------- | ---------------- |
| `product_id`               | `string`                   | ✅            | SKU to price                                 |                  |
| `cost_per_unit`            | `float ≥ 0`                | ✅            | Landed cost incl. logistics                  |                  |
| `optimize_for`             | \`"profit"                 | "revenue"\`  | ✅                                            | What to maximize |
| `candidate_prices`         | `array<float>`             | ✅            | Price points to evaluate                     |                  |
| `historical[]`             | `array<object> (≥10 rows)` | ✅            | Recent sales data to train the model         |                  |
| `competitor_price_current` | `float`                    | optional     | Live rival price (defaults to last observed) |                  |
| `inventory_level_current`  | `int`                      | optional     | Current stock level                          |                  |
| `segment_current`          | `object`                   | optional     | Contextual info: channel, country, etc.      |                  |

---

### Historical Row Fields

| **Field**          | **Type**   | **Required** | **Description**                               |
| ------------------ | ---------- | ------------ | --------------------------------------------- |
| `date`             | `ISO date` | ✅            | Day of sale                                   |
| `price`            | `float`    | ✅            | Price used that day                           |
| `units_sold`       | `int ≥ 0`  | ✅            | Quantity sold                                 |
| `competitor_price` | `float`    | optional     | Rival price on same day                       |
| `inventory_level`  | `int ≥ 0`  | optional     | Inventory at start of day                     |
| `segment`          | `object`   | optional     | e.g., `{ "channel": "web", "country": "BR" }` |

---

### Sample Request

```json
{
  "product_id": "SKU-123",
  "cost_per_unit": 50.0,
  "optimize_for": "profit",
  "candidate_prices": [79.0, 89.0, 99.0, 109.0],
  "historical": [
    { "date": "2025-03-01", "price": 99.0, "units_sold": 38, "competitor_price": 95.0, "inventory_level": 180, "segment": { "channel": "web", "country": "BR" } },
    { "date": "2025-03-02", "price": 99.0, "units_sold": 41, "competitor_price": 96.0, "inventory_level": 170, "segment": { "channel": "web", "country": "BR" } },
    ...
    { "date": "2025-03-10", "price": 109.0, "units_sold": 25, "competitor_price": 103.0, "inventory_level": 200, "segment": { "channel": "store", "country": "BR" } }
  ],
  "competitor_price_current": 94.0,
  "inventory_level_current": 120,
  "segment_current": { "channel": "mobile", "country": "BR" }
}
```

---

### Engine Workflow (Simplified)

1. Clean & encode data (e.g., one-hot segment, log transform).

2. Train ElasticNet, XGBoost, Random Forest on 75% of history.

3. Extract demand elasticity.

4. Predict demand per price in candidate_prices.

5. Compute:

* revenue = price × expected_units

* profit = (price – cost) × expected_units

6. Select best_price based on objective (profit or revenue).

7. Apply guardrails (min margin, max discount).

8. Return prediction.

9. Log for drift monitoring.

---

### Response

```json
{
  "best_price": 79.0,
  "outcomes": [
    { "candidate_price": 79.0, "expected_units": 85.0, "expected_revenue": 6714.9, "expected_profit": 2464.96 },
    { "candidate_price": 89.0, "expected_units": 61.13, "expected_revenue": 5440.35, "expected_profit": 2383.97 },
    { "candidate_price": 99.0, "expected_units": 44.56, "expected_revenue": 4411.79, "expected_profit": 2183.61 },
    { "candidate_price": 109.0, "expected_units": 35.23, "expected_revenue": 3839.86, "expected_profit": 2078.46 }
  ],
  "model_info": {
    "algorithm": "XGBoost",
    "mape": 0.0,
    "train_rows": 10
  },
  "interpretation": "Setting the price at 79.00 maximises PROFIT: +3.4% versus the next-best option (89.00) given today’s competitor price (94.0) and inventory level (120 units)."
}
```

---

### Response Fields

| **Field**              | **Type** | **Description**                  | **Use Case**               |
| ---------------------- | -------- | -------------------------------- | -------------------------- |
| `best_price`           | `float`  | Optimal price                    | Push to web/POS            |
| `outcomes[]`           | `array`  | Simulated results per candidate  | Build price ladders        |
| ↳ `expected_units`     | `float`  | Forecasted demand                | Plan inventory or ops      |
| ↳ `expected_revenue`   | `float`  | Price × Units                    | —                          |
| ↳ `expected_profit`    | `float`  | (Price – Cost) × Units           | —                          |
| `model_info.algorithm` | `string` | Chosen ML model                  | ML audit                   |
| `model_info.mape`      | `float`  | Mean Absolute % Error (hold-out) | Trigger retrain if > 0.2   |
| `interpretation`       | `string` | Plain-English summary            | Show in pricing dashboards |

---

### Commercial Playbooks

| **Use-case**         | **Recipe**                                                             | **KPI Lift**             |
| -------------------- | ---------------------------------------------------------------------- | ------------------------ |
| Clear slow movers    | Use `[cost×1.05, cost×1.1…]`, optimize\_for: `"revenue"`               | Free DC space 25% faster |
| Flagship products    | Call every 2h if `MAPE < 0.10`; widen price range if `elasticity > -2` | Protect margin & share   |
| End-of-season sale   | Set `cost=0`; maximize revenue                                         | +8–12% clearance revenue |
| Channel segmentation | Call twice: `segment_current.channel = web` vs. `store`                | AOV +3%, Profit +4%      |

---

### Engineering & Ops Tips

* Candidate grid: Try 4–8 prices near current tag

* Psychology-aware: Include .90, .99 variants

* Lagging competitor: Use competitor_price_current explicitly

* Inventory spike: Narrow grid to preserve margin

* Batch nightly: Loop SKUs, push best prices to ERP

* A/B test: +10% pricing to 10% traffic to measure elasticity

---

### FAQ

| **Q**                                    | **A**                                                        |
| ---------------------------------------- | ------------------------------------------------------------ |
| What if `MAPE = 0.00`?                   | Likely only 1 hold-out row; add more historical data.        |
| Minimum distinct prices?                 | At least two – otherwise no curve fitting possible.          |
| Can I add features like weekday/weather? | Yes – include as columns in `historical[]`; auto-encoded.    |
| Currency format?                         | Use same currency throughout; endpoint is currency-agnostic. |
| How to set pricing guardrails?           | Use header: `X-Min-Margin-Pct: 0.25` (Enterprise only).      |

---

### Next Step

Feed yesterday’s sales snapshot into this endpoint with 4–8 candidate prices.
Then push the `best_price` to your e-commerce, store POS or marketplace.
Measure margin lift in days – most clients break even on implementation in < 30 days.

---

# 4.2.9 /api/v1/ai/uplift_model

## Individual-level causal lift scoring

## Purpose

Identify who’s truly persuadable (and who isn’t) before you send your next campaign.
The endpoint ingests treatment / control outcomes and returns an incremental-lift (uplift) score for every single customer plus decile roll-ups.
Typical usage: mail only the top‐2 uplift deciles and hold out the bottom two, slashing CAC 25-40 % while keeping the same conversions.

---

### Headers X-Customer-Api-Id, X-Secret

POST  https://api-prod.abintel.ai/api/v1/ai/uplift_model
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json

  ---

### Business Value

| **Pain-point**                        | **How the endpoint helps**                                                                | **Typical lift**                               |
| ------------------------------------- | ----------------------------------------------------------------------------------------- | ---------------------------------------------- |
| Spray-and-pray campaigns waste budget | Scores “true-positives” (= will buy because of the promo) vs. sure-things & never-buyers. | –30 % send volume at flat conversions          |
| Costly hold-outs                      | Automatically produces control deciles (negative uplift) for statistically sound tests.   | +5-8 pp improvement in net incremental revenue |
| Complex in-house causal ML            | Micro-trains a model in < 30 s; no infra to maintain.                                     | Deploy in 1 sprint                             |

---

### Request Body – Every Field

| **JSON path** | **Type / Range** | **Req.?** | **Meaning**                                                            | **Notes**                  |
| ------------- | ---------------- | --------- | ---------------------------------------------------------------------- | -------------------------- |
| contamination | 0 … 1            | optional  | Share of control users who were accidentally exposed to treatment.     | Default 0.0                |
| rows[]       | array<object>    | yes       | Min 200 rows. Each row needs …                                         |                            |
| ↳ id          | string           | yes       | Customer identifier.                                                   | Returned verbatim.         |
| ↳ treatment   | 0 \| 1           | yes       | 1 = received campaign/exposure                                         | Binary only.               |
| ↳ outcome     | 0 \| 1           | yes       | 1 = converted / purchased                                              | Define your success event. |
| ↳ features.* | number \| string | yes       | Any mix of numeric & categorical predictors (age, country, RFM, etc.). | Auto one-hot / scaling.    |

* Data sufficiency rule – at least 200 rows and > 0 variants of both treatment & outcome → else request is rejected.

```SQL
{
  // ──────────────────────────────────────────────────────────────────────────────
  //  🎯  INDIVIDUAL-LEVEL UPLIFT SCORING  –  POST  /api/uplift_model
  //  ---------------------------------------------------------------------------
  //  What this route does
  //  ─────────────────────
  //  • Accepts **treatment / control** data and estimates the incremental
  //    impact (“uplift”, i.e. *causal lift*) of a campaign **for every customer**.
  //  • Internals:
  //        – If the library **causalml** is available the endpoint runs an
  //          `UpliftRandomForestClassifier` (KL criterion).
  //        – Otherwise it falls back to a **T-Learner**: two separate
  //          Gradient-Boosting Models (one on treated rows, one on control).
  //  • Requires **≥ 200 rows** for a stable model (binary *treatment* & *outcome*).
  //
  //  Field-by-field specification
  //  ────────────────────────────
  //  • rows[] (array)          :  Each object **must** contain:
  //        – id          (string) : Unique customer ID.
  //        – treatment    (0|1)   : 1 = received campaign / was exposed.
  //        – outcome      (0|1)   : 1 = converted / purchased / subscribed.
  //        – features     (object): Arbitrary numeric or categorical fields
  //                                  (age, country, prior_purchases, …).
  //                                  Categorical keys are one-hot-encoded auto-
  //                                  matically – you can mix types freely.
  //
  //  What the response means
  //  ───────────────────────
  //  • `average_treatment_effect` – global ATE across all rows (positive = good).
  //  • `decile_summary[]`         – mean uplift & #customers in each decile
  //                                 (1 = lowest, 10 = highest uplift).
  //  • `details[]`                – per-customer uplift score and assigned decile
  //                                 so you can pick top-decile customers for the
  //                                 next wave and hold out the bottom decile.
  //
  //  Practical reading
  //  ─────────────────
  //  • High positive **uplift_score** → customer is MORE likely to convert if
  //    targeted – prioritise for campaigns.
  //  • Negative score → persuasion-proof segment (or even net-negative) – skip
  //    or A/B-test cautiously.
  //
  //  ---------------------------------------------------------------------------
  //  ↓  Stub payload – paste ≥ 200 real rows in “rows[]” before sending
  // ─────────────────────────────────────────────────────────────────────────────
  "contamination": 0.15,
  "rows": [
    { "id": "C-001", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-002", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-003", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-004", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-005", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-006", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-007", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-008", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-009", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-010", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },
    { "id": "C-011", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-012", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-013", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-014", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-015", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-016", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 5 } },
    { "id": "C-017", "treatment": 1, "outcome": 1, "features": { "age": 45, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-018", "treatment": 0, "outcome": 1, "features": { "age": 30, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-019", "treatment": 1, "outcome": 0, "features": { "age": 39, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-020", "treatment": 0, "outcome": 0, "features": { "age": 47, "country": "US", "prior_purchases": 3 } },

    { "id": "C-021", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-022", "treatment": 0, "outcome": 0, "features": { "age": 28, "country": "US", "prior_purchases": 0 } },
    { "id": "C-023", "treatment": 1, "outcome": 1, "features": { "age": 40, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-024", "treatment": 0, "outcome": 0, "features": { "age": 34, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-025", "treatment": 1, "outcome": 0, "features": { "age": 27, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-026", "treatment": 0, "outcome": 0, "features": { "age": 53, "country": "US", "prior_purchases": 4 } },
    { "id": "C-027", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-028", "treatment": 0, "outcome": 1, "features": { "age": 25, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-029", "treatment": 1, "outcome": 0, "features": { "age": 48, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-030", "treatment": 0, "outcome": 0, "features": { "age": 36, "country": "US", "prior_purchases": 2 } },
    { "id": "C-031", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-032", "treatment": 0, "outcome": 1, "features": { "age": 29, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-033", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "US", "prior_purchases": 0 } },
    { "id": "C-034", "treatment": 0, "outcome": 0, "features": { "age": 38, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-035", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-036", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-037", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-038", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-039", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-040", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-041", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-042", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-043", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-044", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-045", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-046", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-047", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-048", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-049", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-050", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-051", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-052", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-053", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-054", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-055", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-056", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-057", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-058", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-059", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-060", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-061", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-062", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-063", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-064", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-065", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-066", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-067", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-068", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-069", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-070", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-071", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-072", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-073", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-074", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-075", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-076", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 5 } },
    { "id": "C-077", "treatment": 1, "outcome": 1, "features": { "age": 45, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-078", "treatment": 0, "outcome": 1, "features": { "age": 30, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-079", "treatment": 1, "outcome": 0, "features": { "age": 39, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-080", "treatment": 0, "outcome": 0, "features": { "age": 47, "country": "US", "prior_purchases": 3 } },

    { "id": "C-081", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-082", "treatment": 0, "outcome": 0, "features": { "age": 28, "country": "US", "prior_purchases": 0 } },
    { "id": "C-083", "treatment": 1, "outcome": 1, "features": { "age": 40, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-084", "treatment": 0, "outcome": 0, "features": { "age": 34, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-085", "treatment": 1, "outcome": 0, "features": { "age": 27, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-086", "treatment": 0, "outcome": 0, "features": { "age": 53, "country": "US", "prior_purchases": 4 } },
    { "id": "C-087", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-088", "treatment": 0, "outcome": 1, "features": { "age": 25, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-089", "treatment": 1, "outcome": 0, "features": { "age": 48, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-090", "treatment": 0, "outcome": 0, "features": { "age": 36, "country": "US", "prior_purchases": 2 } },

    { "id": "C-091", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-092", "treatment": 0, "outcome": 1, "features": { "age": 29, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-093", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "US", "prior_purchases": 0 } },
    { "id": "C-094", "treatment": 0, "outcome": 0, "features": { "age": 38, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-095", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-096", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-097", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-098", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-099", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-100", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-101", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-102", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-103", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-104", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-105", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-106", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-107", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-108", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-109", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-110", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-111", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-112", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-113", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-114", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-115", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-116", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-117", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-118", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-119", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-120", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-121", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-122", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-123", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-124", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-125", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-126", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-127", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-128", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-129", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-130", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-131", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-132", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-133", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-134", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-135", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-136", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-137", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-138", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-139", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-140", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-141", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-142", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-143", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-144", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-145", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-146", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-147", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-148", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-149", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-150", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-151", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-152", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-153", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-154", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-155", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-156", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-157", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-158", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-159", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-160", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-161", "treatment": 1, "outcome": 1, "features": { "age": 34, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-162", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-163", "treatment": 1, "outcome": 1, "features": { "age": 42, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-164", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-165", "treatment": 1, "outcome": 0, "features": { "age": 29, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-166", "treatment": 0, "outcome": 0, "features": { "age": 50, "country": "US", "prior_purchases": 4 } },
    { "id": "C-167", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-168", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-169", "treatment": 1, "outcome": 0, "features": { "age": 46, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-170", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } },

    { "id": "C-171", "treatment": 1, "outcome": 1, "features": { "age": 33, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-172", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-173", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-174", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-175", "treatment": 1, "outcome": 0, "features": { "age": 26, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-176", "treatment": 0, "outcome": 0, "features": { "age": 54, "country": "US", "prior_purchases": 5 } },
    { "id": "C-177", "treatment": 1, "outcome": 1, "features": { "age": 46, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-178", "treatment": 0, "outcome": 1, "features": { "age": 31, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-179", "treatment": 1, "outcome": 0, "features": { "age": 40, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-180", "treatment": 0, "outcome": 0, "features": { "age": 48, "country": "US", "prior_purchases": 3 } },

    { "id": "C-181", "treatment": 1, "outcome": 1, "features": { "age": 35, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-182", "treatment": 0, "outcome": 0, "features": { "age": 27, "country": "US", "prior_purchases": 0 } },
    { "id": "C-183", "treatment": 1, "outcome": 1, "features": { "age": 41, "country": "CA", "prior_purchases": 3 } },
    { "id": "C-184", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-185", "treatment": 1, "outcome": 0, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-186", "treatment": 0, "outcome": 0, "features": { "age": 55, "country": "US", "prior_purchases": 4 } },
    { "id": "C-187", "treatment": 1, "outcome": 1, "features": { "age": 47, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-188", "treatment": 0, "outcome": 1, "features": { "age": 26, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-189", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-190", "treatment": 0, "outcome": 0, "features": { "age": 37, "country": "US", "prior_purchases": 2 } },

    { "id": "C-191", "treatment": 1, "outcome": 1, "features": { "age": 30, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-192", "treatment": 0, "outcome": 0, "features": { "age": 41, "country": "US", "prior_purchases": 0 } },
    { "id": "C-193", "treatment": 1, "outcome": 1, "features": { "age": 37, "country": "CA", "prior_purchases": 4 } },
    { "id": "C-194", "treatment": 0, "outcome": 0, "features": { "age": 33, "country": "UK", "prior_purchases": 1 } },
    { "id": "C-195", "treatment": 1, "outcome": 0, "features": { "age": 49, "country": "US", "prior_purchases": 3 } },
    { "id": "C-196", "treatment": 0, "outcome": 1, "features": { "age": 28, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-197", "treatment": 1, "outcome": 1, "features": { "age": 44, "country": "UK", "prior_purchases": 5 } },
    { "id": "C-198", "treatment": 0, "outcome": 0, "features": { "age": 39, "country": "CA", "prior_purchases": 2 } },
    { "id": "C-199", "treatment": 1, "outcome": 1, "features": { "age": 32, "country": "US", "prior_purchases": 1 } },
    { "id": "C-200", "treatment": 0, "outcome": 0, "features": { "age": 45, "country": "BR", "prior_purchases": 3 } },

    { "id": "C-201", "treatment": 1, "outcome": 1, "features": { "age": 36, "country": "BR", "prior_purchases": 2 } },
    { "id": "C-202", "treatment": 0, "outcome": 0, "features": { "age": 29, "country": "US", "prior_purchases": 0 } },
    { "id": "C-203", "treatment": 1, "outcome": 1, "features": { "age": 43, "country": "UK", "prior_purchases": 3 } },
    { "id": "C-204", "treatment": 0, "outcome": 0, "features": { "age": 31, "country": "CA", "prior_purchases": 1 } },
    { "id": "C-205", "treatment": 1, "outcome": 0, "features": { "age": 30, "country": "BR", "prior_purchases": 0 } },
    { "id": "C-206", "treatment": 0, "outcome": 0, "features": { "age": 52, "country": "US", "prior_purchases": 4 } },
    { "id": "C-207", "treatment": 1, "outcome": 1, "features": { "age": 38, "country": "UK", "prior_purchases": 2 } },
    { "id": "C-208", "treatment": 0, "outcome": 1, "features": { "age": 24, "country": "BR", "prior_purchases": 1 } },
    { "id": "C-209", "treatment": 1, "outcome": 0, "features": { "age": 47, "country": "CA", "prior_purchases": 5 } },
    { "id": "C-210", "treatment": 0, "outcome": 0, "features": { "age": 35, "country": "US", "prior_purchases": 2 } }
  ]
}
```

---

### What Happens Under the Hood

1. Pre-process – handle contamination (re-weights control), one-hot categories, scale numerics.

2. Model selection

* If causalml lib present ▶︎ UpliftRandomForestClassifier (KL criterion).

* Else T-Learner (two Gradient-Boosting trees).

3. Cross-validation × 3 folds → choose hyper-parameters with highest Qini uplift.

4. Score each row: P(outcome | treat) – P(outcome | control) → uplift_score.

5. Rank & bucket into ten equal-sized deciles.

6. Return global ATE, conversion rates, decile table & per-ID details. Average latency: < 40 s on 50 k rows (CPU).

---

### Resonse

```json
{
    "average_treatment_effect": 0.3857,
    "treatment_cr": 0.6381,
    "control_cr": 0.2571,
    "decile_summary": [
        {
            "decile": 1,
            "mean_uplift": -0.9986,
            "n_customers": 21
        },
        {
            "decile": 2,
            "mean_uplift": -0.2695,
            "n_customers": 21
        },
        {
            "decile": 3,
            "mean_uplift": 0.0006,
            "n_customers": 24
        },
        {
            "decile": 4,
            "mean_uplift": 0.0018,
            "n_customers": 18
        },
        {
            "decile": 5,
            "mean_uplift": 0.2048,
            "n_customers": 23
        },
        {
            "decile": 6,
            "mean_uplift": 0.9957,
            "n_customers": 19
        },
        {
            "decile": 7,
            "mean_uplift": 0.9988,
            "n_customers": 21
        },
        {
            "decile": 8,
            "mean_uplift": 0.9992,
            "n_customers": 21
        },
        {
            "decile": 9,
            "mean_uplift": 0.9998,
            "n_customers": 21
        },
        {
            "decile": 10,
            "mean_uplift": 0.9999,
            "n_customers": 21
        }
    ],
    "details": [
        {
            "id": "C-001",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-002",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-003",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-004",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-005",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-006",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-007",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-008",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-009",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-010",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-011",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-012",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-013",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-014",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-015",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-016",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-017",
            "uplift_score": 0.9991,
            "uplift_decile": 7
        },
        {
            "id": "C-018",
            "uplift_score": 0.0018,
            "uplift_decile": 4
        },
        {
            "id": "C-019",
            "uplift_score": -0.82,
            "uplift_decile": 2
        },
        {
            "id": "C-020",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-021",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-022",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-023",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-024",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-025",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-026",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-027",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-028",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-029",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-030",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-031",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-032",
            "uplift_score": 0.0026,
            "uplift_decile": 5
        },
        {
            "id": "C-033",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-034",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-035",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-036",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-037",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-038",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-039",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-040",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-041",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-042",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-043",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-044",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-045",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-046",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-047",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-048",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-049",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-050",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-051",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-052",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-053",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-054",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-055",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-056",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-057",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-058",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-059",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-060",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-061",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-062",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-063",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-064",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-065",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-066",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-067",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-068",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-069",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-070",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-071",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-072",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-073",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-074",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-075",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-076",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-077",
            "uplift_score": 0.9991,
            "uplift_decile": 7
        },
        {
            "id": "C-078",
            "uplift_score": 0.0018,
            "uplift_decile": 4
        },
        {
            "id": "C-079",
            "uplift_score": -0.82,
            "uplift_decile": 2
        },
        {
            "id": "C-080",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-081",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-082",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-083",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-084",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-085",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-086",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-087",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-088",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-089",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-090",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-091",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-092",
            "uplift_score": 0.0026,
            "uplift_decile": 5
        },
        {
            "id": "C-093",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-094",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-095",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-096",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-097",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-098",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-099",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-100",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-101",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-102",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-103",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-104",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-105",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-106",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-107",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-108",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-109",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-110",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-111",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-112",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-113",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-114",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-115",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-116",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-117",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-118",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-119",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-120",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-121",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-122",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-123",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-124",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-125",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-126",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-127",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-128",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-129",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-130",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-131",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-132",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-133",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-134",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-135",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-136",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-137",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-138",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-139",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-140",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-141",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-142",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-143",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-144",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-145",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-146",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-147",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-148",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-149",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-150",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-151",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-152",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-153",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-154",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-155",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-156",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-157",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-158",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-159",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-160",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-161",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-162",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-163",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-164",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-165",
            "uplift_score": -0.9972,
            "uplift_decile": 2
        },
        {
            "id": "C-166",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-167",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-168",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-169",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-170",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-171",
            "uplift_score": 0.0017,
            "uplift_decile": 4
        },
        {
            "id": "C-172",
            "uplift_score": 0.0015,
            "uplift_decile": 4
        },
        {
            "id": "C-173",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-174",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-175",
            "uplift_score": -0.9985,
            "uplift_decile": 1
        },
        {
            "id": "C-176",
            "uplift_score": 0.1182,
            "uplift_decile": 5
        },
        {
            "id": "C-177",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-178",
            "uplift_score": 0.0025,
            "uplift_decile": 4
        },
        {
            "id": "C-179",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-180",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-181",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-182",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-183",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-184",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-185",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-186",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-187",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-188",
            "uplift_score": 0.0015,
            "uplift_decile": 3
        },
        {
            "id": "C-189",
            "uplift_score": -0.0027,
            "uplift_decile": 2
        },
        {
            "id": "C-190",
            "uplift_score": 0.999,
            "uplift_decile": 7
        },
        {
            "id": "C-191",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-192",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-193",
            "uplift_score": 0.9973,
            "uplift_decile": 6
        },
        {
            "id": "C-194",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-195",
            "uplift_score": -0.0001,
            "uplift_decile": 2
        },
        {
            "id": "C-196",
            "uplift_score": -0.999,
            "uplift_decile": 1
        },
        {
            "id": "C-197",
            "uplift_score": 0.9912,
            "uplift_decile": 5
        },
        {
            "id": "C-198",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-199",
            "uplift_score": 0.9999,
            "uplift_decile": 10
        },
        {
            "id": "C-200",
            "uplift_score": 0.9984,
            "uplift_decile": 7
        },
        {
            "id": "C-201",
            "uplift_score": 0.0,
            "uplift_decile": 3
        },
        {
            "id": "C-202",
            "uplift_score": 0.9998,
            "uplift_decile": 9
        },
        {
            "id": "C-203",
            "uplift_score": 0.9913,
            "uplift_decile": 6
        },
        {
            "id": "C-204",
            "uplift_score": 0.9992,
            "uplift_decile": 8
        },
        {
            "id": "C-205",
            "uplift_score": -0.9983,
            "uplift_decile": 1
        },
        {
            "id": "C-206",
            "uplift_score": 0.9998,
            "uplift_decile": 10
        },
        {
            "id": "C-207",
            "uplift_score": 0.0028,
            "uplift_decile": 5
        },
        {
            "id": "C-208",
            "uplift_score": 0.0014,
            "uplift_decile": 3
        },
        {
            "id": "C-209",
            "uplift_score": -0.0026,
            "uplift_decile": 2
        },
        {
            "id": "C-210",
            "uplift_score": 0.999,
            "uplift_decile": 7
        }
    ],
    "interpretation": "Treatment group converted at 63.81% vs control 25.71% (ATE +0.386).  **Decile 10** contains 21 customers with mean uplift +1.000, representing ≈ 21.0 additional conversions if fully targeted.  **Decile 1**’s mean uplift is -0.999 — ideal as a hold-out or cost-control segment."
}
```

---

### Path

| Path                       | Meaning                      | How to act                                   |
| -------------------------- | ---------------------------- | -------------------------------------------- |
| average_treatment_effect   | Global incremental lift.     | > 0 → campaign works; < 0 → re-think.        |
| decile_summary[]           | Mean uplift by 10 % buckets. | Target deciles 8-10, test 5-7, suppress 1-2. |
| details[]                  | Per-customer score & bucket. | Feed top deciles into ESP / CRM segment.     |

---

### Activation Recipes

| Goal                   | Playbook                                                      | KPI impact                    |
| ---------------------- | ------------------------------------------------------------- | ----------------------------- |
| Email blast cost-cut   | Send only deciles 8-10; keep 3-4 for future; never email 1-2. | –35 % send cost, flat orders  |
| Personalised discounts | Give 10 % off to decile 10, 5 % to 8-9, none to others.       | Same revenue, half promo cost |
| A/B hold-out           | Use decile 1 as natural control in follow-up experiment.      | Robust incrementality proof   |

---

### Engineering Tips

* Cold-start customers – set treatment=0, outcome=0, include features; they’ll still be scored via model priors.

* Categorical explosions – cap rare categories (< 100 rows) into “Other” to keep trees shallow.

* Feature drift – if ≥ 2 categorical values disappear for > 30 days, re-train.

* Minimum decile size – endpoint enforces ≥ 15 rows; else merges neighbouring buckets.

* Storing scores – upsert uplift_decile column in your CDP for fast audience builds.

---

### Next step
Run a one-off call on last campaign’s data, export the top two uplift deciles, and launch a 72-h retargeting email. Measure incremental revenue v. hold-out – most clients break even in the first blast.

---

# 4.3 Forecasting & Planning

## Forecasting & Planning

`forecast_revenue`, `forecast_units`, `forecast_units_asyncio`, `forecast_cost`, `forecast_cost_improved`

---

# 4.3.1 /api/v1/ai/forecast_revenue

## Purpose
Generate a 12-month revenue outlook (calendar & business days), pick the best model automatically, and get back ready-to-plot numbers plus error diagnostics.

### Headers X-Customer-Api-Id, X-Secret

POST https://api.abintel.ai/api/v1/ai/forecast_revenue
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json

---

### Why you’ll use it

| Business question                           | How the route helps                                                                                      | Typical win                        |
| ------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ---------------------------------- |
| “How much cash do we book next quarter?”    | Outputs monthly forecast with 80 % & 95 % CIs (not shown in sample).                                     | Replaces xls extrapolations in 5 s |
| “Which model should we trust?”              | Benchmarks ARIMA, Prophet, ETS, TBATS, Aggregation (naïve), etc., selects the lowest RMSE automatically. | No data-science headcount needed   |
| “Ops wants both calendar & business views.” | Returns two matrices: one counting all days, one excluding weekends/holidays.                            | Direct feed into FP\&A dashboards  |

---

### Request body – every field

| Path             | Type       | Req.? | Meaning                  | Notes                                    |
| ---------------- | ---------- | ----- | ------------------------ | ---------------------------------------- |
| forecast_period  | int ≥ 1    | yes   | # months to predict      | Typical 6-, 12-, 18-month horizons       |
| data[]           | array      | yes   | Historical daily revenue | Needs ≥ 60 rows (≈ 2 months)             |
| ↳ date           | YYYY-MM-DD | yes   | Day in ISO format        | Gaps allowed; endpoint auto-fills zeroes |
| ↳ revenue        | float ≥ 0  | yes   | Gross revenue that day   | Same currency every row                  |

```json
{
  "forecast_period": 12,
  "data": [
    {"date": "2024-01-01", "revenue": 1000.0},
    {"date": "2024-01-02", "revenue": 1010.0},
    {"date": "2024-01-03", "revenue": 1020.0},
    {"date": "2024-01-04", "revenue": 1030.0},
    {"date": "2024-01-05", "revenue": 1040.0},
    {"date": "2024-01-06", "revenue": 824.0},
    {"date": "2024-01-07", "revenue": 832.0},
    {"date": "2024-01-08", "revenue": 1070.0},
    {"date": "2024-01-09", "revenue": 1080.0},
    {"date": "2024-01-10", "revenue": 1090.0},
    {"date": "2024-01-11", "revenue": 1100.0},
    {"date": "2024-01-12", "revenue": 1110.0},
    {"date": "2024-01-13", "revenue": 888.0},
    {"date": "2024-01-14", "revenue": 896.0},
    {"date": "2024-01-15", "revenue": 1140.0},
    {"date": "2024-01-16", "revenue": 1150.0},
    {"date": "2024-01-17", "revenue": 1160.0},
    {"date": "2024-01-18", "revenue": 1170.0},
    {"date": "2024-01-19", "revenue": 1180.0},
    {"date": "2024-01-20", "revenue": 952.0},
    {"date": "2024-01-21", "revenue": 960.0},
    {"date": "2024-01-22", "revenue": 1210.0},
    {"date": "2024-01-23", "revenue": 1220.0},
    {"date": "2024-01-24", "revenue": 1230.0},
    {"date": "2024-01-25", "revenue": 1240.0},
    {"date": "2024-01-26", "revenue": 1250.0},
    {"date": "2024-01-27", "revenue": 1016.0},
    {"date": "2024-01-28", "revenue": 1024.0},
    {"date": "2024-01-29", "revenue": 1280.0},
    {"date": "2024-01-30", "revenue": 1290.0},
    {"date": "2024-01-31", "revenue": 1300.0},
    {"date": "2024-02-01", "revenue": 1000.0},
    {"date": "2024-02-02", "revenue": 1010.0},
    {"date": "2024-02-03", "revenue": 808.0},
    {"date": "2024-02-04", "revenue": 816.0},
    {"date": "2024-02-05", "revenue": 1040.0},
    {"date": "2024-02-06", "revenue": 1050.0},
    {"date": "2024-02-07", "revenue": 1060.0},
    {"date": "2024-02-08", "revenue": 1070.0},
    {"date": "2024-02-09", "revenue": 1080.0},
    {"date": "2024-02-10", "revenue": 864.0},
    {"date": "2024-02-11", "revenue": 872.0},
    {"date": "2024-02-12", "revenue": 1110.0},
    {"date": "2024-02-13", "revenue": 1120.0},
    {"date": "2024-02-14", "revenue": 1130.0},
    {"date": "2024-02-15", "revenue": 1140.0},
    {"date": "2024-02-16", "revenue": 1150.0},
    {"date": "2024-02-17", "revenue": 920.0},
    {"date": "2024-02-18", "revenue": 928.0},
    {"date": "2024-02-19", "revenue": 1180.0},
    {"date": "2024-02-20", "revenue": 1190.0},
    {"date": "2024-02-21", "revenue": 1200.0},
    {"date": "2024-02-22", "revenue": 1210.0},
    {"date": "2024-02-23", "revenue": 1220.0},
    {"date": "2024-02-24", "revenue": 984.0},
    {"date": "2024-02-25", "revenue": 992.0},
    {"date": "2024-02-26", "revenue": 1250.0},
    {"date": "2024-02-27", "revenue": 1260.0},
    {"date": "2024-02-28", "revenue": 1270.0},
    {"date": "2024-02-29", "revenue": 1280.0},
    {"date": "2024-03-01", "revenue": 1000.0},
    {"date": "2024-03-02", "revenue": 800.0},
    {"date": "2024-03-03", "revenue": 808.0},
    {"date": "2024-03-04", "revenue": 1030.0},
    {"date": "2024-03-05", "revenue": 1040.0},
    {"date": "2024-03-06", "revenue": 1050.0},
    {"date": "2024-03-07", "revenue": 1060.0},
    {"date": "2024-03-08", "revenue": 1070.0},
    {"date": "2024-03-09", "revenue": 856.0},
    {"date": "2024-03-10", "revenue": 864.0},
    {"date": "2024-03-11", "revenue": 1100.0},
    {"date": "2024-03-12", "revenue": 1110.0},
    {"date": "2024-03-13", "revenue": 1120.0},
    {"date": "2024-03-14", "revenue": 1130.0},
    {"date": "2024-03-15", "revenue": 1140.0},
    {"date": "2024-03-16", "revenue": 912.0},
    {"date": "2024-03-17", "revenue": 920.0},
    {"date": "2024-03-18", "revenue": 1170.0},
    {"date": "2024-03-19", "revenue": 1180.0},
    {"date": "2024-03-20", "revenue": 1190.0},
    {"date": "2024-03-21", "revenue": 1200.0},
    {"date": "2024-03-22", "revenue": 1210.0},
    {"date": "2024-03-23", "revenue": 976.0},
    {"date": "2024-03-24", "revenue": 984.0},
    {"date": "2024-03-25", "revenue": 1240.0},
    {"date": "2024-03-26", "revenue": 1250.0},
    {"date": "2024-03-27", "revenue": 1260.0},
    {"date": "2024-03-28", "revenue": 1270.0},
    {"date": "2024-03-29", "revenue": 1280.0},
    {"date": "2024-03-30", "revenue": 1048.0}
  ]
}
```

---

### What happens under the hood

1. Pre-process – sort, fill missing days → 0 revenue, detect outliers (IQR winsorise), box-cox if needed.

2. Model zoo – ARIMA, STL-ETS, Prophet, TBATS, Croston (if > 40 % zeros) + Aggregation benchmark.

3. Cross-validation – rolling origin (4 folds) scoring RMSE & MAPE.

4. Champion select – lowest weighted RMSE (calendar 0.6 × business 0.4).

5. Post-process – make sure predictions ≥ 0; re-add outliers if suppressed.

6. Return forecast + error table + run-time.

Average latency: ~0.3 s on 90 days history; scales linearly.

---

### Response

```json
{
    "forecast_period": 12,
    "forecast_result": {
        "analysis_type": "generic_revenue",
        "best_algorithm": "Aggregation",
        "evaluation_metrics": {
            "RMSE": 111.63593256467632,
            "MAE": 109.6766254147977,
            "R2": 0.09176299947242217,
            "average_daily_revenue": 1105.017787752007,
            "Interpretation": "The Aggregation algorithm was selected because it achieved a low RMSE of 111.64, MAE of 109.68, and R² of 0.09. The average daily revenue forecast is 1105.02."
        },
        "forecast": {
            "calendar": [
                {
                    "yyyy-mm": "2024-04",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-05",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-06",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-07",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-08",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-09",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-10",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2024-11",
                    "value": 35509.98094676594
                },
                {
                    "yyyy-mm": "2024-12",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2025-01",
                    "value": 36693.6469783248
                },
                {
                    "yyyy-mm": "2025-02",
                    "value": 33142.64888364821
                },
                {
                    "yyyy-mm": "2025-03",
                    "value": 36693.6469783248
                }
            ],
            "business": [
                {
                    "yyyy-mm": "2024-04",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2024-05",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-06",
                    "value": 23673.320631177296
                },
                {
                    "yyyy-mm": "2024-07",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-08",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2024-09",
                    "value": 24856.98666273616
                },
                {
                    "yyyy-mm": "2024-10",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2024-11",
                    "value": 24856.98666273616
                },
                {
                    "yyyy-mm": "2024-12",
                    "value": 26040.652694295022
                },
                {
                    "yyyy-mm": "2025-01",
                    "value": 27224.31872585389
                },
                {
                    "yyyy-mm": "2025-02",
                    "value": 23673.320631177296
                },
                {
                    "yyyy-mm": "2025-03",
                    "value": 24856.98666273616
                }
            ]
        }
    },
    "execution_time_seconds": 0.268125057220459
}
```

---

### Field

| Field                | How to read                                | Action                                                             |
| -------------------- | ------------------------------------------ | -----------------------------------------------------------------  |
| best_algorithm       | Model with lowest cross-val error.         | Track changes – if it flips often you may have structural breaks.  |
| evaluation_metrics   | RMSE / MAE (absolute), R² (explained var.) | MAE ≤ 10 % of mean ⇒ “good”; else inspect seasonality or promos   |
| forecast.calendar[]  | Revenue including weekends & holidays.     | Feed to top-line board decks.                                      |
| forecast.business[]  | Revenue excluding weekends/holidays.       | Feed to capacity & staffing planning.                              |

---

### Power-user tips

* Promo bumps – send an extra boolean column `promo_day`: the API auto-segments regime switches (beta preview).

* Currency roll-ups – if you mix multi-currency streams, convert externally first; endpoint expects single unit.

* Edge series (< 60 pts) – fallback to “Aggregation” by design → consider weekly aggregation then re-call.

* Scenario testing – call twice: once full history, once minus last promo month → quantify uplift delta.

---

### Next step
Run the endpoint weekly, store `forecast.calendar` in your BI layer, and chart actual vs forecast. Alert finance if ±10 % deviation materialises for two consecutive weeks — teams can re-allocate paid-media budget in-flight.

---

### 4.3.2 /api/v1/ai/forecast_units

## One-Shot SKU-Level Demand Forecast

## Purpose

Call once, get a 6-month, day-to-business-day unit forecast for an individual SKU – automatically benchmarks statistical & ML models and returns the winner with diagnostics.

---

### Headers X-Customer-Api-Id, X-Secret

POST https://api.abintel.ai/api/v1/ai/forecast_units
headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json

---

### When you’ll reach for it

| Business question                                         | How the route answers                                                                                  | Typical payoff                                 |
| --------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| “How many pieces should we replenish per SKU each month?” | Calendar & business-day unit forecast plus ±2 σ error band (not shown below).                          | Cuts stock-out / over-stock cost without       |
|                                                           |                                                                                                        | spreadsheet kung-fu                            |
| “Which model works for lumpy demand?”                     | Runs ARIMA, TBATS, Prophet, Random-Forest, Gradient Boost, Croston (intermittent) & picks lowest RMSE. | Gives you Croston/ML without writing a line of |
|                                                           |                                                                                                        | code                                           |
| “Ops wants the figure in pieces, not revenue.”            | Accepts sales_quantity straight from POS/OMS.                                                          | No price inflation noise                       |

---

### Request body – every key explained

| Path              | Type       | Req.? | Meaning                | Notes                       |
| ----------------- | ---------- | ----- | ---------------------- | --------------------------  |
| product_code      | string     | yes   | SKU or internal code   | Returned as-is in response  |
| forecast_period   | int ≥ 1    | yes   | Months to predict      | 3, 6, 12 typical            |
| data[]            | array      | yes   | Daily historical units | ≥ 45 rows recommended       |
| ↳ date            | YYYY-MM-DD | yes   | ISO calendar date      | Gaps auto-filled with 0     |
| ↳ sales_quantity  | int ≥ 0    | yes   | Units sold that day    | Same UoM entire series      |

```json
{
  "product_code": "38788",
  "forecast_period": 6,
  "data": [
    { "date": "2025-02-20", "sales_quantity": 11 },
    { "date": "2025-02-21", "sales_quantity": 12 },
    { "date": "2025-02-22", "sales_quantity": 6  },
    { "date": "2025-02-23", "sales_quantity": 5  },
    { "date": "2025-02-24", "sales_quantity": 14 },
    { "date": "2025-02-25", "sales_quantity": 13 },
    { "date": "2025-02-26", "sales_quantity": 12 },
    { "date": "2025-02-27", "sales_quantity": 13 },
    { "date": "2025-02-28", "sales_quantity": 12 },
    { "date": "2025-03-01", "sales_quantity": 7  },
    { "date": "2025-03-02", "sales_quantity": 6  },
    { "date": "2025-03-03", "sales_quantity": 15 },
    { "date": "2025-03-04", "sales_quantity": 14 },
    { "date": "2025-03-05", "sales_quantity": 13 },
    { "date": "2025-03-06", "sales_quantity": 14 },
    { "date": "2025-03-07", "sales_quantity": 13 },
    { "date": "2025-03-08", "sales_quantity": 7  },
    { "date": "2025-03-09", "sales_quantity": 6  },
    { "date": "2025-03-10", "sales_quantity": 16 },
    { "date": "2025-03-11", "sales_quantity": 15 },
    { "date": "2025-03-12", "sales_quantity": 14 },
    { "date": "2025-03-13", "sales_quantity": 15 },
    { "date": "2025-03-14", "sales_quantity": 14 },
    { "date": "2025-03-15", "sales_quantity": 8  },
    { "date": "2025-03-16", "sales_quantity": 7  },
    { "date": "2025-03-17", "sales_quantity": 16 },
    { "date": "2025-03-18", "sales_quantity": 15 },
    { "date": "2025-03-19", "sales_quantity": 14 },
    { "date": "2025-03-20", "sales_quantity": 15 },
    { "date": "2025-03-21", "sales_quantity": 14 },
    { "date": "2025-03-22", "sales_quantity": 7  },
    { "date": "2025-03-23", "sales_quantity": 6  },
    { "date": "2025-03-24", "sales_quantity": 17 },
    { "date": "2025-03-25", "sales_quantity": 16 },
    { "date": "2025-03-26", "sales_quantity": 15 },
    { "date": "2025-03-27", "sales_quantity": 16 },
    { "date": "2025-03-28", "sales_quantity": 15 },
    { "date": "2025-03-29", "sales_quantity": 8  },
    { "date": "2025-03-30", "sales_quantity": 7  },
    { "date": "2025-03-31", "sales_quantity": 17 },
    { "date": "2025-04-01", "sales_quantity": 16 },
    { "date": "2025-04-02", "sales_quantity": 15 },
    { "date": "2025-04-03", "sales_quantity": 16 },
    { "date": "2025-04-04", "sales_quantity": 15 },
    { "date": "2025-04-05", "sales_quantity": 8  },
    { "date": "2025-04-06", "sales_quantity": 7  },
    { "date": "2025-04-07", "sales_quantity": 18 },
    { "date": "2025-04-08", "sales_quantity": 17 },
    { "date": "2025-04-09", "sales_quantity": 16 },
    { "date": "2025-04-10", "sales_quantity": 17 },
    { "date": "2025-04-11", "sales_quantity": 16 },
    { "date": "2025-04-12", "sales_quantity": 9  },
    { "date": "2025-04-13", "sales_quantity": 8  },
    { "date": "2025-04-14", "sales_quantity": 18 },
    { "date": "2025-04-15", "sales_quantity": 17 },
    { "date": "2025-04-16", "sales_quantity": 16 },
    { "date": "2025-04-17", "sales_quantity": 17 },
    { "date": "2025-04-18", "sales_quantity": 16 },
    { "date": "2025-04-19", "sales_quantity": 9  },
    { "date": "2025-04-20", "sales_quantity": 8  }
  ]
}
```

---

### Behind the curtain

1. Cleaning – sort, fill missing dates (=0), Hampel filter outliers (kept but flagged).

2. Feature crafting – lag-7/14/28, promo/holiday flags (if extra cols present), rolling means.

3. Model zoo – Seasonal-ARIMA, STL-ETS, Prophet, TBATS, Random-Forest Regressor, Gradient-Boost, Croston for intermittent.

4. Cross-val – expanding window, score RMSE/MAE/R².

5. Champion – lowest RMSE (ties → lowest MAE).

6. Forecast – horizon = forecast_period * 30/30.4 calendar & biz-day splits.

7. Safety floor – clip negatives → 0.

8. Return JSON + run-time (seconds).

---

### Response

```json
{
    "forecast_period": 6,
    "forecasts": [
        {
            "product_code": "38788",
            "best_algorithm": "Random Forest",
            "evaluation_metrics": {
                "RMSE": 1.0094506384700848,
                "MAE": 0.9820119348244344,
                "R2": 0.9324114946213251,
                "average_daily_sales": 12.93465473184223,
                "Interpretation": "The Random Forest algorithm was selected because it achieved a low RMSE of 1.01, MAE of 0.98, and R² of 0.93. The average daily sales forecast is 12.93."
            },
            "forecast": {
                "calendar": [
                    {
                        "yyyy-mm": "2025-05",
                        "value": 435.7681071428571
                    },
                    {
                        "yyyy-mm": "2025-06",
                        "value": 420.22091666666665
                    },
                    {
                        "yyyy-mm": "2025-07",
                        "value": 443.83299999999997
                    },
                    {
                        "yyyy-mm": "2025-08",
                        "value": 426.7840714285714
                    },
                    {
                        "yyyy-mm": "2025-09",
                        "value": 429.2682619047619
                    },
                    {
                        "yyyy-mm": "2025-10",
                        "value": 442.8730714285714
                    }
                ],
                "business": [
                    {
                        "yyyy-mm": "2025-05",
                        "value": 362.24461904761904
                    },
                    {
                        "yyyy-mm": "2025-06",
                        "value": 347.66261904761905
                    },
                    {
                        "yyyy-mm": "2025-07",
                        "value": 378.9077619047619
                    },
                    {
                        "yyyy-mm": "2025-08",
                        "value": 345.62752380952384
                    },
                    {
                        "yyyy-mm": "2025-09",
                        "value": 364.3430238095238
                    },
                    {
                        "yyyy-mm": "2025-10",
                        "value": 377.94783333333334
                    }
                ]
            }
        }
    ],
    "execution_time_seconds": 1.5340442657470703
}
```

---

### Field

| Field                 | How to read                    | Action                                                                             |
| --------------------- | ------------------------------ | ---------------------------------------------------------------------------------- |
| best_algorithm        | Model with lowest RMSE.        | Track per-SKU – if it flips to Croston your item may have become slow-moving.      |
| average_daily_sales   | Mean of historical series.     | Quick reasonableness check: forecast shouldn’t diverge > ±30 % unless seasonality. |
| forecast.calendar[]   | Units incl. weekends/holidays. | Feed to S\&OP, supplier POs.                                                       |
| forecast.business[]   | Units excl. weekends.          | Feed to labour & picking slot planning.                                            |

---

### Common gotchas & pro tips

* Intermittent demand – ≥ 40 % zero days? The route auto-tests Croston & TSB – flag appears in `evaluation_metrics.model_candidates` (omit here for brevity).

* Promotions – add a boolean `promo` column; tree models ingest it, improving spikes.

* Multi-channel split – want web vs store? Call the endpoint separately per channel code.

* Very new SKUs – < 30 data points defaults to “Naïve mean” and adds `"note":"cold-start"` in metrics.

---

### Next step

Schedule the call on the 1st business day each month, write `forecast.business` into your ERP replenishment table, and compare actual vs forecast weekly; auto-trigger a re-forecast if absolute error > 20 % for two consecutive weeks.

---

