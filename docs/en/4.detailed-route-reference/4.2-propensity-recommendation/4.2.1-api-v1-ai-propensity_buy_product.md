# 4.2.1 /api/v1/ai/propensity_buy_product

---

### Purpose

* SKU-Level Uplift Scoring

Predict how likely each individual customer is to purchase a specific product (or close substitute) in the next campaign cycle. Customers are ranked into tiers: Very High → Very Low so you can:

Send SKU-targeted emails/SMS to the top deciles

Optimize look-alike audiences for paid media

Personalize on-site banners and recommendations

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/propensity_buy_product
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

| **Key**       | **Type / Range** | **Required** | **Meaning**                  | **Typical Derivation**     |
| ------------- | ---------------- | ------------ | ---------------------------- | -------------------------- |
| `product_sku` | string           | yes          | The SKU to push              | Use canonical catalogue ID |
| `customers`   | array<object>    | yes          | Rows to score or train+score | From CDP or feature store  |

---

### Customer Object Fields

| **Key**       | **Type** | **Required** | **Meaning**                            |
| ------------- | -------- | ------------ | -------------------------------------- |
| `customer_id` | string   | yes          | CRM primary key                        |
| `features`    | object   | yes          | Flat numeric feature vector            |
| `label_buy`   | 0 / 1    | optional     | Ground-truth flag if used for training |

---

###  Starter Feature Dictionary

| **Feature**               | **Business Meaning**           | **Example SQL**                             |
| ------------------------- | ------------------------------ | ------------------------------------------- |
| `age`                     | Customer's age in years        | `EXTRACT(YEAR FROM AGE(birth_date))`        |
| `tenure_months`           | Lifetime with brand            | `DATEDIFF(MONTH, first_purchase, snapshot)` |
| `category_views_last_30d` | Engagement with SKU's category | GA / Mixpanel page views                    |
| `avg_ticket`              | Mean order value               | `AVG(order_total)`                          |

---

### How It Works Internally

1. Label Check
2. 
Requires ≥ 20 labeled rows per class (0 and 1); otherwise exits with a message.

2. AutoML

Tries LogReg, XGBoost, RF, CatBoost. Chooses best ROC-AUC (5-fold CV).

3. Scoring

Outputs probability `P(buy=1)`.

4. Tier Mapping (defaults)

* Very High ≥ 90%

* High ≥ 70%

* Medium ≥ 40%

* Low ≥ 20%

* Very Low < 20%

---

### Example #1 – Not Enough Labels

## Request

```json
{
  "product_sku": "SKU-A123",
  "customers": [
    {
      "customer_id": "C-1001",
      "features": { "age": 34, "tenure_months": 27, "category_views_last_30d": 15, "avg_ticket": 185.3 },
      "label_buy": 1
    },
    {
      "customer_id": "C-1002",
      "features": { "age": 57, "tenure_months": 3, "category_views_last_30d": 2, "avg_ticket": 42.1 }
    }
  ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1001",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    },
    {
      "customer_id": "C-1002",
      "probability": null,
      "propensity_tier": "Very Low",
      "interpretation": "Very low propensity – deprioritise in current cycle."
    }
  ],
  "model_info": {
    "note": "not enough labelled rows to train (need ≥20 & both classes)"
  }
}
```

---

### Example #2 – Sufficient Labels (Training + Scoring)

```json
{
  "product_sku": "SKU-A123",
  "customers": [ ... 5000 rows with `label_buy` ... ]
}
```

---

## Response

```json
{
  "predictions": [
    {
      "customer_id": "C-1234",
      "probability": 0.91,
      "propensity_tier": "Very High",
      "interpretation": "Very high propensity – prime candidate for personalised offer."
    }
  ],
  "model_info": {
    "best_algorithm": "CatBoost",
    "roc_auc": 0.842,
    "selected_features": ["category_views_last_30d", "tenure_months", "avg_ticket"],
    "train_rows": 4800,
    "test_rows": 200
  }
}
```

---

### Field Glossary – Response

| **Path**                        | **Type**       | **Meaning**                                | **Usage**                 |
| ------------------------------- | -------------- | ------------------------------------------ | ------------------------- |
| `predictions[].probability`     | float or null  | Buy probability                            | Sort for campaigns        |
| `predictions[].propensity_tier` | enum           | Very High / High / Medium / Low / Very Low | Filter by segment         |
| `predictions[].interpretation`  | string         | Simple wording for action                  | Use in CRM/email merge    |
| `model_info.best_algorithm`     | string         | AutoML selected algorithm                  | ML audit                  |
| `model_info.roc_auc`            | float          | AUC on hold-out set                        | Compare to baseline model |
| `model_info.note`               | string or null | Error/skip reason                          | Alert or debug            |

---

### Commercial Playbooks

| **Use-case**             | **Action**                                    | **KPI Lift**         |
| ------------------------ | --------------------------------------------- | -------------------- |
| Email blast optimisation | Send SKU promo only to High & Very High tiers | +22% CTR, –46% unsub |
| On-site banner           | Show product for users with P(buy) ≥ 0.7      | +18% PDP views       |
| Paid social              | Export top 10% to Look-alike on Meta          | –15% CPA             |
| Sales queue              | Push High tier to CRM call list               | +12% close rate      |

---

### Data Engineering Tips

Labeling: Define 30/60/90d window → `label_buy = 1 if purchased`.

Feature TTL: Refresh time-sensitive features (e.g. views) daily.

Cold Start SKUs: Use category-level model if SKU lacks data.

---

### FAQ

| **Q**                                     | **A**                                                           |
| ----------------------------------------- | --------------------------------------------------------------- |
| Can I send categorical features?          | Yes – send as strings, auto-encoded internally.                 |
| Multiple SKUs in one call?                | No – one SKU per request (loop client-side).                    |
| All probabilities `null` – what happened? | Likely fewer than 20 positive labels or only one class present. |
| Can I override tier cut-offs?             | Yes – use `tier_quantiles:[0.9,0.7,0.4,0.2]` (Enterprise only). |
| Max batch size?                           | 100k rows or 20MB per call. Async/bulk version: Q4 2025.        |

---

### Next Step

Pipe High and Very High tiers into your campaign engine.
Suppress Very Low, reduce fatigue, and boost SKU performance per e-mail.

---

