# 4.2.6 /api/v1/ai/cross_sell_matrix

## Quantifying “Bought-Together” Affinity in One Call

## Purpose

Return a square matrix that quantifies how strongly each item or category lifts the probability of another being bought in the same basket.

---

### Business Use Cases

| **Business Play**                          | **Impact**               |
| ------------------------------------------ | ------------------------ |
| “Frequently Bought Together” widget        | +8–18% attach rate       |
| Dynamic bundle & upsell rules at checkout  | +5–12% AOV               |
| Assortment optimisation / planogram design | Higher shelf penetration |
| Category-to-category marketing flows       | 10–25% e-mail CTR        |

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/cross_sell_matrix
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body – Field-by-Field Guide

| **Key**        | **Type / Range**         | **Required**                    | **Meaning**                            | **Notes / Source**                |
| -------------- | ------------------------ | ------------------------------- | -------------------------------------- | --------------------------------- |
| `level`        | `"item"` or `"category"` | optional                        | Matrix granularity                     | Default: `"item"`                 |
| `customer_id`  | `string` or `null`       | optional                        | Set to get personal matrix             | Use global (null) or personal     |
| `transactions` | `array<object>`          | yes                             | Orders: each includes customer + items | 6–36 months history               |
| `item_catalog` | `array<object>`          | req. only if level = "category" | SKU to category mapping                | Needed if using `"category"` mode |

---

### transactions[]

| **Key**       | **Type**        | **Required** | **Description**            |
| ------------- | --------------- | ------------ | -------------------------- |
| `customer_id` | `string`        | yes          | Buyer ID                   |
| `items`       | `array<string>` | yes          | List of SKUs in the basket |

---

### item_catalog[] (for category mode)

| **Key**    | **Type** | **Required** | **Description** |
| ---------- | -------- | ------------ | --------------- |
| `item_id`  | `string` | yes          | SKU             |
| `category` | `string` | yes          | Category slug   |

---

### How the Metric Is Calculated

support(i) = number of orders with item i
support(i & j) = number of orders with both i and j
confidence(i → j) = support(i & j) / support(i)

* Diagonal `(i == j)` = 1.0 by definition

* No negative values (min = 0)

* Optional: compute lift as `confidence / support(j)` downstream

---

### End-to-End Pipeline

1. Pre-clean: De-dupe `items[]` per order

2. Count: Map-reduce to count ``support(i)`` and `support(i & j)`

3. Compute: Calculate `confidence(i → j)` and round

4. Reorder: Sort items by global frequency

5. Return: Include headers + matrix

---

### Example Request

```json
{
  "level": "item",
  "customer_id": null,
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] }
  ],
  "item_catalog": []
}
```

---

### Example Response

```json
{
  "items_or_categories": ["SKU-A1", "SKU-B9", "SKU-D7", "SKU-E2"],
  "matrix": [
    [1.0, 0.5, 0.5, 0.5],
    [0.5, 1.0, 0.0, 0.5],
    [1.0, 0.0, 1.0, 1.0],
    [0.5, 0.5, 0.5, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:33:37.149247Z"
}
```

---

### Field Glossary – Response

| **Path**                | **Type**         | **Meaning**                         | **Use**                  |
| ----------------------- | ---------------- | ----------------------------------- | ------------------------ |
| `items_or_categories[]` | array of strings | Header mapping for matrix           | Display / lookup         |
| `matrix[][]`            | 2D float array   | Confidence(i→j) matrix              | Feed into UI or BI tools |
| `metric`                | string           | Formula used (default = confidence) | Analytics & audit        |
| `generated_at`          | ISO timestamp    | When this was calculated            | Cache strategy           |

---

### Threshold Recipes

| **Use Case**                     | **Rule**                                                                   | **Suggested Threshold**       |
| -------------------------------- | -------------------------------------------------------------------------- | ----------------------------- |
| PDP “Frequently Bought Together” | Show top 3 `j` where `confidence(i→j) ≥ 0.15`                              | 15% (fashion), 3–5% (grocery) |
| Cart Upsell                      | Auto-suggest `j` when `confidence(i→j) ≥ 0.25` and high margin             | 25%                           |
| Bundle Creation                  | Export `i,j` pairs with `confidence ≥ 0.30` and `support(i&j) ≥ 100`       | 30%                           |
| E-mail Cross-sell                | Target buyers of `i` who’ve never bought `j` with `confidence(i→j) ≥ 0.20` | 20%                           |

---

### Engineering & Ops Tips

* Time window: 180d (CPG), 365d (furniture, B2B)

* Large baskets: Trim top 50 items by value if >200 SKUs

* Category mode: Requires `item_catalog`; ideal for long-tail items

* Global vs Personal: Global = all customers; Personal = 1:1

* Visualisation: Use seaborn heatmaps or D3.js chord diagrams

---

### Advanced Configuration (Enterprise)

| **Param**         | **Type**     | **Effect**                                      |
| ----------------- | ------------ | ----------------------------------------------- |
| `metric: "lift"`  | string       | Returns lift = confidence / support(j)          |
| `min_support`     | int ≥ 1      | Filter items with low support count             |
| `symmetric: true` | boolean      | Averages matrix: `M[i][j] = M[j][i]`            |
| `time_range`      | {start, end} | Limit to transaction slice (e.g., Black Friday) |

---

### FAQ

| **Q**                       | **A**                                                         |
| --------------------------- | ------------------------------------------------------------- |
| How big can the matrix get? | Up to 5,000 × 5,000 (200 MB); sparse streaming coming Q4 2025 |
| Why are diagonals all 1.0?  | By definition: item always co-occurs with itself              |
| Any negative values?        | Never – confidence is always ≥ 0                              |
| Can I exclude items?        | Yes – remove them from `transactions[].items` before calling  |
| Real-time latency?          | < 500ms for up to 250k orders                                 |

---

### Quick Win

Pipe the matrix into a rule that auto-inserts the top co-purchased SKU into your cart drawer.

Start with `confidence ≥ 0.20` and watch AOV and attach rate climb.

---

