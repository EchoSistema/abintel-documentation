# 4.2.7 /api/v1/ai/cross_sell_matrix

## Category-to-Category Heat-Map

## Purpose

The category-level mode aggregates every SKU into its parent category and tells you:

“When a basket contains any item from category i, how often does it also contain at least one item from category j?”

Use-cases range from macro merchandising to campaign adjacency rules.

---

### Commercial Playbook

| **Commercial Play**            | **How the Matrix Helps**                                            | **Typical Lift**     |
| ------------------------------ | ------------------------------------------------------------------- | -------------------- |
| Homepage “Complete the Look”   | Display the top companion categories while browsing a base category | +6–10% click-through |
| Joint discount bundles         | Identify pairings with high co-occurrence but low margin to bundle  | +4–8% basket value   |
| Store layout / aisle adjacency | Co-locate categories with high mutual confidence                    | +3–5% in-store sales |
| Cross-category e-mail flows    | Target buyers who skipped a usually-linked category                 | 2–3× better response |

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/cross_sell_matrix
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body (Category Mode)

```json
{
  "level": "category",
  "transactions": [
    { "customer_id": "C-1", "items": ["SKU-A1", "SKU-B9"] },
    { "customer_id": "C-2", "items": ["SKU-A1", "SKU-D7", "SKU-E2"] },
    { "customer_id": "C-3", "items": ["SKU-D7"] },
    { "customer_id": "C-4", "items": ["SKU-A1", "SKU-E2"] },
    { "customer_id": "C-1", "items": ["SKU-B9", "SKU-E2"] },
    { "customer_id": "C-5", "items": ["SKU-A1", "SKU-B9", "SKU-D7"] },
    { "customer_id": "C-6", "items": ["SKU-E2", "SKU-D7"] }
  ],
  "item_catalog": [
    { "item_id": "SKU-A1", "category": "Shoes" },
    { "item_id": "SKU-B9", "category": "Shoes" },
    { "item_id": "SKU-D7", "category": "Accessories" },
    { "item_id": "SKU-E2", "category": "Wearables" }
  ]
}
```

---

### Field-by-Field

| **Path**         | **Type**         | **Required?** | **Meaning**                      | **Tips**                          |
| ---------------- | ---------------- | ------------- | -------------------------------- | --------------------------------- |
| `level`          | `"category"`     | ✅             | Triggers category aggregation    | `"item"` is default               |
| `transactions[]` | `array<object>`  | ✅             | 1 transaction = 1 order          | Clean out test or canceled orders |
| `item_catalog[]` | `array<object>`  | ✅             | SKU → Category map               | Many-to-one is valid              |
| `customer_id`    | `string or null` | optional      | Set for personal matrix (1-to-1) | Keep `null` for global stats      |

---

### Computation Logic

1. SKU → Category: Every SKU becomes its category. Categories are de-duplicated per basket.

2. Support counts:

* support(i) = baskets with category i

* support(i & j) = baskets with both i and j

3. Confidence:

confidence(i → j) = orders_with_both(i, j) / orders_with_i

* Diagonal = 1.0

4. Ordering: Categories sorted by descending global support for consistency.

---

### Response

{
  "items_or_categories": ["Accessories", "Shoes", "Wearables"],
  "matrix": [
    [1.0, 0.5, 0.5],
    [0.4, 1.0, 0.6],
    [0.5, 0.75, 1.0]
  ],
  "metric": "orders_with_i_and_j / orders_with_i",
  "generated_at": "2025-05-21T10:42:59.767166Z"
}

---

### Interpretation Highlights

* Wearables → Shoes = 0.75
→ 75% of baskets with Wearables also have Shoes — strong attach rate.

* Shoes → Accessories = 0.40
→ Moderate co-occurrence; could justify cross-sell or small bundle.

---

### Practical Thresholds & Actions

| **Confidence(i→j)** | **Interpretation** | **Suggested Action**                        |
| ------------------- | ------------------ | ------------------------------------------- |
| ≥ 0.70              | Must-have pair     | Auto-bundle, display “Complete the Look” UI |
| 0.30 – 0.69         | Strong link        | Use for e-mail flows, cross-sell thumbnails |
| 0.10 – 0.29         | Weak link          | Only use if margin is high                  |
| < 0.10              | Likely noise       | Ignore to reduce UI clutter                 |

---

### SQL Recipe – Category Pair Counts

```SQL
WITH sku_orders AS (
  SELECT o.order_id, p.category
  FROM orders o
  JOIN order_items oi ON oi.order_id = o.order_id
  JOIN products p ON p.sku = oi.sku
  WHERE o.order_date >= DATE_SUB(CURRENT_DATE(), INTERVAL 12 MONTH)
),
pairs AS (
  SELECT o1.category AS cat_i, o2.category AS cat_j, o1.order_id
  FROM sku_orders o1
  JOIN sku_orders o2 ON o1.order_id = o2.order_id
)
SELECT
  cat_i,
  cat_j,
  COUNT(DISTINCT order_id) AS orders_with_i_and_j
FROM pairs
GROUP BY 1, 2;
```

---

### Commercial Recipes (Category-Level)

| **Scenario**             | **Usage**                                              | **Expected KPI**         |
| ------------------------ | ------------------------------------------------------ | ------------------------ |
| Paid search landing page | Add tabs for top co-bought categories                  | +8% session depth        |
| Category hero banners    | Show multi-category bundles (e.g., Shoes + Smartwatch) | +5% CTR                  |
| Stock & demand planning  | Allocate buffer stock to co-bought categories          | Fewer stockouts in promo |
| Loyalty incentives       | Give bonus points for Accessories if Shoes in cart     | +12% attach rate         |

---

### Advanced Parameters (Enterprise)

| **Param**         | **Allowed Values** | **Purpose**                                     |
| ----------------- | ------------------ | ----------------------------------------------- |
| `metric`          | `"lift"`           | Shows lift vs baseline purchase rate            |
| `min_support`     | `int ≥ 5`          | Drop rare categories to reduce noise            |
| `time_range`      | `{start, end}`     | Slice matrix by time (e.g., Black Friday week)  |
| `symmetric: true` | `true/false`       | Average matrix for symmetric display (graphing) |

---

### FAQ

| **Q**                                                 | **A**                                                     |
| ----------------------------------------------------- | --------------------------------------------------------- |
| I have 5,000 SKUs and 30 categories – is this faster? | Yes – runtime scales with categories², not SKUs           |
| Repeated categories in a basket — do they inflate?    | No – duplicates removed before counting                   |
| Can I rename categories?                              | Yes – rename in `item_catalog` before sending             |
| Sparse personal matrix — all 0/1s — why?              | Too little data; use 6–12 mo window or fallback to global |
| Recompute how often?                                  | Weekly (global), daily (real-time cart flows)             |
| Privacy concerns?                                     | Only customer\_id is used (can be hashed); no PII needed  |

---

### Next Step

Feed the category-level matrix into your recommendation engine.
When a shopper adds a category like Shoes, query the matrix and surface top SKUs from the highest-confidence follower category (e.g., Accessories).

* Result: Higher attach rate and AOV — no discounts required.

---

