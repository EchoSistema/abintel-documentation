# 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Purpose
Autonomously cluster customers; returns labels, centroids, KPIs, and plain-language personas.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value         |
|---------------------|--------------|
| `X-Customer-Api-Id` | `<uuid>`     |
| `X-Secret`          | `<secret>`   |
| `Content-Type`      | `application/json` |

### Request
```yml
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```
### Body:
```json
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "loyalty_score": 0.72,
        "recency_days": 15
      }
    }
  ]
}
```

#### Request Body Schema

| JSON Key             | Type              | Required | Description                                  | Notes/Formula                              |
|----------------------|-------------------|----------|----------------------------------------------|--------------------------------------------|
| `max_clusters`       | integer ≥ 2       | optional | Upper bound for K-Means & GMM                | Recommend 8–15 for 5k–200k customers       |
| `dbscan_eps`         | float (0 < ε ≤ 1) | optional | Radius for DBSCAN after z-score scaling      | Start at 0.35–0.45                         |
| `dbscan_min_samples` | integer ≥ 3       | optional | Minimum neighbors for DBSCAN core point      | Use 5 (default); adjust for dataset size   |
| `data`               | array<object>     | required | List of customer objects with features       | 12–18 months of transaction data typical   |

#### Features Inside `data[].features`

| Feature             | Type/Range   | Business Definition                          | SQL/Python Example                          |
|---------------------|--------------|----------------------------------------------|---------------------------------------------|
| `purchase_total`    | float ≥ 0    | Lifetime revenue in observation window       | `SUM(order_total)`                          |
| `visit_frequency`   | integer ≥ 0  | Number of distinct purchase sessions         | `COUNT(DISTINCT order_date)`                |
| `avg_ticket`        | float ≥ 0    | Average value per purchase                   | `purchase_total / NULLIF(visit_frequency,0)`|
| `product_diversity` | integer ≥ 0  | Count of distinct product categories         | `COUNT(DISTINCT category_lvl1)`             |
| `loyalty_score`     | float (0–1)  | Normalized loyalty score from points or RFM  | `current_points / max_points_cap`           |
| `recency_days`      | integer ≥ 0  | Days since last order                        | `DATEDIFF(CURRENT_DATE, MAX(order_date))`   |

#### Example Response
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    }
  ],
  "clusters": [],
  "customer_labels": []
}
```

#### Response Keys
| Key                   | Type          | Meaning                                         | Usage                                  |
|-----------------------|---------------|-------------------------------------------------|----------------------------------------|
| `best_algorithm`      | string        | Model with highest silhouette/lowest Davies-Bouldin | Store with run-ID for A/B testing      |
| `evaluation_metrics`  | array<object> | Benchmarks for each algorithm + params           | Monitor in ML-Ops dashboards, rerun if needed |
| `clusters`            | array<object> | Summary of each cluster: ID, size, centroids     | For campaigns, loyalty tiers, bundles  |
| `customer_labels`     | array<object> | Mapping of each `customer_id` → `cluster_id`     | Join back to CRM/CDP for audiences     |

---


