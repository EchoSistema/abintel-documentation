# 4.1.2 `/api/v1/ai/customer_features`

### Purpose
Generate a clean, analytically-ready feature vector for every customer by rolling up raw transaction rows (and any supplied loyalty metadata).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json
```
### Response
```json
{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key           | Type / Range          | Required     | Meaning                          | How to obtain / SQL formula                        |
|--------------------|----------------------|--------------|-----------------------------------|----------------------------------------------------|
| `today`            | ISO date (YYYY-MM-DD)| Optional     | Reference date for recency        | `CURRENT_DATE` or pipeline parameter               |
| `customers`        | array<object>        | Yes          | Customer snapshot list            | From daily ETL query                               |
| ↳ `customer_id`    | string               | Yes (unique) | CRM/ERP primary key               | `orders.customer_id`                               |
| ↳ `loyalty_score`  | float (0–1)          | Optional     | Precomputed loyalty or RFM score  | `points / max_points_cap` or `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>        | Yes (≥1)     | Raw transaction data              | Use 12–18 months of history                        |
| ↳ `transaction_id` | string               | Yes          | Order ID                          | `orders.order_id`                                  |
| ↳ `date`           | ISO date             | Yes          | Transaction date                  | `orders.order_date`                                |
| ↳ `amount`         | float ≥ 0            | Yes          | Order total                       | `orders.order_total`                               |
| ↳ `product_id`     | string               | Yes          | SKU or category ID                | `order_items.product_id`                           |

#### Calculated Features

| Feature Key         | Formula                      | Business Interpretation         |
|---------------------|-----------------------------|---------------------------------|
| `purchase_total`    | `SUM(amount)`                | Lifetime spend (GMV)            |
| `visit_frequency`   | `COUNT(transactions)`        | Number of purchase occasions    |
| `avg_ticket`        | `purchase_total / visits`    | Average basket size             |
| `product_diversity` | `COUNT(DISTINCT product_id)` | Breadth of purchase             |
| `loyalty_score`     | passed or `0.0`              | Loyalty indicator               |
| `recency_days`      | `DATEDIFF(today, MAX(date))` | Time since last purchase        |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 918.95,
        "visit_frequency": 2.0,
        "avg_ticket": 459.48,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

#### Response Keys

| Key Path        | Type   | Meaning                 | Usage                                   |
|-----------------|--------|-------------------------|-----------------------------------------|
| `customers[]`   | array  | Each entry = 1 customer | Send to `/purchasing_segmentation`, etc.|
| ↳ `customer_id` | string | Echoes the ID sent      | For joins with CRM/CDP                  |
| ↳ `features`    | object | Vector of 6 KPIs        | Store in feature store or DB            |

> **Why these six features?**  
> They capture monetary, frequency, breadth, loyalty and time dimensions—covering > 80% of purchase-behaviour variance.

---

