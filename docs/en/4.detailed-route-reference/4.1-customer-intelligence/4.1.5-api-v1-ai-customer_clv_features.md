# 4.1.5 `/api/v1/ai/customer_clv_features`

### Purpose
Feature-engineer the four classic CLV metrics (frequency, recency, T, monetary_value) ± potential tier for downstream CLV modeling.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_clv_features
Content-Type: application/json

{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2024-10-12", "amount": 520.55, "cost": 312.33 },
        { "date": "2025-02-20", "amount": 398.40, "cost": 210.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2024-09-05", "amount": 300.00, "cost": 180.00 },
        { "date": "2025-01-17", "amount": 250.00, "cost": 150.00 }
      ]
    }
  ]
}
```

#### Calculated Outputs

| Output Field         | Formula                                    | Notes                                            |
|----------------------|--------------------------------------------|--------------------------------------------------|
| `frequency`          | `#orders − 1`                              | BG/NBD: 0 = one-time buyer                       |
| `recency`            | `days_between(first_tx, last_tx)`          | Float, in days                                   |
| `T`                  | `days_between(first_tx, today)`            | Customer age at snapshot                         |
| `monetary_value`     | `AVG(margin)` if cost present, else `AVG(amount)` |                                                  |
| `churned`            | bool                                       | True if last_tx ≤ threshold (planned feature)    |
| `clv_potential_tier` | enum (High/Medium/Low)                     | High if top 30% monetary_value & frequency ≥1    |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "frequency": 1,
      "recency": 131.0,
      "T": 194.0,
      "monetary_value": 188.40,
      "churned": false,
      "clv_potential_tier": "High",
      "interpretation": "…Focus on VIP retention & upsell.",
      "explanations": {}
    },
    {
      "customer_id": "C-1002",
      "frequency": 1,
      "recency": 134.0,
      "T": 200.0,
      "monetary_value": 110.00,
      "churned": false,
      "clv_potential_tier": "Medium",
      "interpretation": "…Consistent buyer, nurture with offers.",
      "explanations": {}
    }
  ]
}
```

#### Response Keys

| Key Path                  | Type        | Meaning                                | Usage                            |
|---------------------------|-------------|----------------------------------------|----------------------------------|
| `customers[]`             | array       | Each entry = 1 customer                | Segmentation, CLV modeling       |
| ↳ `customer_id`           | string      | Customer identifier                    | Join with CRM/CDP                |
| ↳ `frequency`             | int         | Number of repeat purchases             | For BG/NBD/CLV models            |
| ↳ `recency`               | float       | Days between first and last purchase   | For BG/NBD/CLV models            |
| ↳ `T`                     | float       | Days between first purchase and today  | For BG/NBD/CLV models            |
| ↳ `monetary_value`        | float       | Average margin or amount               | For Gamma-Gamma, CLV tiers       |
| ↳ `churned`               | bool        | Customer churn flag                    | Retargeting, risk analysis       |
| ↳ `clv_potential_tier`    | enum        | CLV potential segment                  | For targeting, dashboard         |
| ↳ `interpretation`        | string      | Business-focused summary               | For reporting, insights          |
| ↳ `explanations`          | object      | Explainable AI breakdowns              | For explainability/audit         |

---

