# 4.1.15 /api/v1/ai/churn_label

---

### Purpose

Create a binary churn label `(churned = 0 | 1)` from raw customer lifecycle data using vertical-specific business rules.

Use cases:

* Generate training sets for `/api/churn_risk`

* Benchmark retention initiatives (true / false positives)

* Track “new churn” KPI without spreadsheets

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/churn_label
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body Schema

| **Key**        | **Type**                                      | **Required** | **Meaning**                      |
| -------------- | --------------------------------------------- | ------------ | -------------------------------- |
| business\_type | enum `"ecommerce"` \| `"saas"` \| `"prepaid"` | yes          | Chooses the rule set (see below) |
| data           | array<object>                                 | yes          | One row per snapshot at time `t` |

Extra fields are ignored (can be used for auditing).

---

### Built-in Churn Rules

| **Business Type** | **Required Fields**                                          | **Churn Rule (churned = 1 if…)**                         | **Typical Window**      |
| ----------------- | ------------------------------------------------------------ | -------------------------------------------------------- | ----------------------- |
| `ecommerce`       | `snapshot_date`, `last_purchase_date`                        | `snapshot_date - last_purchase_date ≥ 90 days`           | 90 days silence = churn |
| `saas`            | `snapshot_date`, `subscription_cancelled` (bool)             | `subscription_cancelled = true`                          | Same-day detection      |
| `prepaid`         | `snapshot_date`, `balance_after_t`, `topped_up_within_cycle` | `balance_after_t = 0 AND topped_up_within_cycle = false` | One billing cycle       |

* Why 90 days for e-commerce? It reflects the industry median reorder interval across 30+ retailers.

---

### Worked Examples

* E-commerce Example

```json
{
  "business_type": "ecommerce",
  "data": [
    {
      "customer_id": "E-101",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2024-12-15"
    },
    {
      "customer_id": "E-102",
      "snapshot_date": "2025-04-01",
      "last_purchase_date": "2025-03-20"
    }
  ]
}
```

---

### Response

```json
[
  { "customer_id": "E-101", "snapshot_date": "2025-04-01", "churned": 1 },
  { "customer_id": "E-102", "snapshot_date": "2025-04-01", "churned": 0 }
]
```

---

### SaaS Example

```json
{
  "business_type": "saas",
  "data": [
    {
      "customer_id": "S-001",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": true
    },
    {
      "customer_id": "S-002",
      "snapshot_date": "2025-04-01",
      "subscription_cancelled": false
    }
  ]
}
```

---

### Prepaid Example

```json
{
  "business_type": "prepaid",
  "data": [
    {
      "customer_id": "P-777",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": false
    },
    {
      "customer_id": "P-778",
      "snapshot_date": "2025-04-01",
      "balance_after_t": 0.0,
      "topped_up_within_cycle": true
    }
  ]
}
```

---

### Field Dictionary & Rationale

| **Field**                | **Why It Matters**                       | **Example**    |
| ------------------------ | ---------------------------------------- | -------------- |
| `snapshot_date`          | Freeze point: when you check churn state | `"2025-04-01"` |
| `last_purchase_date`     | Recency check for e-commerce             | `"2024-12-15"` |
| `subscription_cancelled` | Definitive SaaS churn signal             | `true`         |
| `balance_after_t`        | Prepaid credit balance                   | `0.0`          |
| `topped_up_within_cycle` | Detect lapse vs. engagement              | `false`        |

---

### Typical ETL Pattern (SQL)

```SQL
INSERT INTO churn_labels
SELECT
    c.customer_id,
    DATE ?snapshot AS snapshot_date,
    CASE
      WHEN ?business_type = 'ecommerce'
           AND DATEDIFF(?snapshot, c.last_purchase) >= 90 THEN 1
      WHEN ?business_type = 'saas'
           AND c.subscription_cancelled THEN 1
      WHEN ?business_type = 'prepaid'
           AND c.balance = 0 AND c.topped_up = 0 THEN 1
      ELSE 0
    END AS churned
FROM staging_customers c;
```

Push this result to /api/churn_risk as your label column.

---

### Commercial Uses

| **Team**      | **Use Case**                                          |
| ------------- | ----------------------------------------------------- |
| Data Science  | Build training sets for churn model                   |
| Finance       | Track true churn for forecasting                      |
| Marketing Ops | Launch win-back flows 90 days post last order (e-com) |
| Product       | Evaluate onboarding impact on cancellations (SaaS)    |

---

### FAQ

| **Question**                                 | **Answer**                                                       |
| -------------------------------------------- | ---------------------------------------------------------------- |
| Can I change the churn window for e-com?     | Yes – use `"window_days": 60` (Enterprise only).                 |
| What happens if required fields are missing? | Returns HTTP 400 with the missing keys listed.                   |
| Does the service store data?                 | No – it is stateless. Payload is discarded post-response.        |
| Max batch size?                              | 250,000 rows or 20 MB per request. Async support coming Q4 2025. |

---

### Next Step

Schedule `/api/churn_label` to run daily, pipe results into your churn training pipeline, and keep models fresh—without touching SQL every time.

---

