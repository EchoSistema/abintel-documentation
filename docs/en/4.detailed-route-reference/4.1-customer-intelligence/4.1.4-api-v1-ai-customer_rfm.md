# 4.1.4 `/api/v1/ai/customer_rfm`

### Purpose
Classic RFM (Recency-Frequency-Monetary) scoring, binned into lifecycle tiers (Champion, Loyal, At-Risk, etc.).

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_rfm
Content-Type: application/json

{
  "bins": 5,
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "transactions": [
        { "date": "2025-04-21", "amount": 520.55 },
        { "date": "2025-03-29", "amount": 310.00 }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "date": "2025-01-05", "amount": 120.00 },
        { "date": "2024-12-19", "amount": 75.90 }
      ]
    }
  ]
}
```

#### Request Body Schema

| JSON Key         | Type / Range   | Required | Meaning                       | Guideline / SQL Derivation     |
|------------------|----------------|----------|-------------------------------|-------------------------------|
| `bins`           | integer 2–10   | Optional | Number of buckets per metric  | Default = 5 (quintiles)       |
| `today`          | ISO date       | Optional | Reference date for recency    | Omit → server date            |
| `customers`      | array<object>  | Required | List of customer transactions | Output of nightly ETL         |
| ↳ `customer_id`  | string         | Required | Primary key                   | `orders.customer_id`          |
| ↳ `transactions` | array<object>  | Required | List of order events          | 6–18 months typical           |
| ↳ `date`         | ISO date       | Yes      | Order date                    | —                             |
| ↳ `amount`       | float ≥ 0      | Yes      | Order value                   | —                             |

#### Calculated Metrics

| Metric           | Formula                         |
|------------------|---------------------------------|
| `recency_days`   | `DATEDIFF(today, MAX(date))`    |
| `frequency`      | `COUNT(transactions)`           |
| `monetary_total` | `SUM(amount)`                   |

#### Example Response
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "recency_days": 3,
      "frequency": 2,
      "monetary_total": 830.55,
      "recency_score": 5,
      "frequency_score": 4,
      "monetary_score": 5,
      "rfm_class": "545",
      "rfm_total": 14,
      "rfm_tier": "Champion",
      "interpretation": "Champions – recent, frequent and high-value"
    },
    {
      "customer_id": "C-1002",
      "recency_days": 109,
      "frequency": 2,
      "monetary_total": 195.9,
      "recency_score": 1,
      "frequency_score": 2,
      "monetary_score": 2,
      "rfm_class": "122",
      "rfm_total": 5,
      "rfm_tier": "At-Risk",
      "interpretation": "At-Risk – infrequent, low recent activity"
    }
  ],
  "thresholds": {
    "recency":   [66.6, 24.2, 2.6, 1.8],
    "frequency": [2.4, 2.8, 3.2, 3.6],
    "monetary":  [381.54, 567.18, 773.79, 1001.37]
  }
}
```

#### Response Keys

| Key Path            | Type      | Meaning                                   | Usage                       |
|---------------------|-----------|-------------------------------------------|-----------------------------|
| `customers[]`       | array     | Each entry = 1 customer                   | Segmentation & targeting    |
| ↳ `recency_days`    | int       | Days since last purchase                  | Recency metric              |
| ↳ `frequency`       | int       | Number of transactions                    | Frequency metric            |
| ↳ `monetary_total`  | float     | Total spent                               | Monetary metric             |
| ↳ `recency_score`   | int       | Score for recency (1–bins)                | For RFM class               |
| ↳ `frequency_score` | int       | Score for frequency (1–bins)              | For RFM class               |
| ↳ `monetary_score`  | int       | Score for monetary (1–bins)               | For RFM class               |
| ↳ `rfm_class`       | string    | Concatenation of individual scores        | For tiering/visualization   |
| ↳ `rfm_total`       | int       | Sum of scores                             | Tier mapping                |
| ↳ `rfm_tier`        | enum      | Lifecycle tier                            | Champions, Loyal, At-Risk   |
| ↳ `interpretation`  | string    | Plain-language explanation                | For business users          |
| `thresholds`        | object    | Binning cutoffs per metric                | For audit/debug             |

**Tier Mapping:**  
- **Champion:** `rfm_total ≥ bins*3 – 2`
- **Loyal:** Top 30% by total, not Champion
- **Potential:** Mid-upper band
- **Promising:** Mid-lower band
- **At-Risk:** Bottom 20%

---

