# 4.1.3 `/api/v1/ai/customer_loyalty`

### Purpose
Calculate a 0–1 loyalty index for every customer using weighted behavioral metrics, then bucket them into business-friendly segments.  
Default tiers: Platinum, Gold, Silver, Bronze, At-Risk.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value              |
|----------------------|------------------- |
| `X-Customer-Api-Id`  | `<uuid>`           |
| `X-Secret`           | `<secret>`         |
| `Content-Type`       | `application/json` |

### Request

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_loyalty
Content-Type: application/json

{
  "weights": {
    "purchase_total": 0.25,
    "visit_frequency": 0.30,
    "avg_ticket": 0.10,
    "product_diversity": 0.15,
    "recency_days": 0.20
  },
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "recency_days": 15
      }
    }
  ]
}
```

#### Example Response
```json
{
  "customers": [
    { "customer_id": "C-1001", "loyalty_score": 1.0,    "segment": "Platinum" },
    { "customer_id": "C-1002", "loyalty_score": 0.87,   "segment": "Platinum" }
  ],
  "summary": {
    "mean_score": 0.94,
    "median_score": 0.94,
    "top_decile_threshold": 0.98,
    "segment_counts": {
      "Platinum": 2,
      "Silver":   0,
      "At-Risk":  0
    }
  }
}
```

#### Response Keys

| Key Path                       | Type        | Meaning                                    | Usage                                          |
|--------------------------------|-------------|--------------------------------------------|------------------------------------------------|
| `customers[].loyalty_score`    | float (0–1) | Min-max weighted loyalty index (1 = best)  | Feed into CRM tiers, bid multipliers, exports  |
| `customers[].segment`          | enum        | Default segment tier                       | Override via `segment_thresholds`, remap       |
| `summary.mean_score`           | float       | Average score across cohort                | Track monthly loyalty health                   |
| `summary.top_decile_threshold` | float       | 90th percentile score                      | Use as VIP threshold in campaigns              |
| `summary.segment_counts`       | object      | Distribution across loyalty tiers          | Planning perks, rewards, support resources     |

**Default Segments:**  
- **Platinum:** ≥ 0.85  
- **Gold:** 0.70–0.84  
- **Silver:** 0.50–0.69  
- **Bronze:** 0.30–0.49  
- **At-Risk:** < 0.30  

---
