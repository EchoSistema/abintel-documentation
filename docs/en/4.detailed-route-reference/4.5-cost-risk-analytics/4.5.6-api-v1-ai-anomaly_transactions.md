# 4.5.6 /api/v1/ai/anomaly_transactions

### Real-time transaction fraud & anomaly scoring

## Purpose 
Turns raw click-stream sessions into a tidy Markov-chain: transition probabilities, step-level abandonment, and at-a-glance optimisation cues.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST https://api.abintel.ai/api/v1/ai/anomaly_transactions
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

### Why you’d hit this route

| **Question**                                    | **What the endpoint returns**                                    |
| ----------------------------------------------- | ---------------------------------------------------------------- |
| “Which transactions look fraudulent right now?” | `details[].fraud_flag = true` with raw `anomaly_score`.          |
| “How good is the model on the labelled rows?”   | `kpi.auc` (ROC-AUC on the subset that has `label`).              |
| “How many did we catch?”                        | `kpi.detected_pct` = % of all rows crossing the score threshold. |

---

### Request payload reference

| **Path**      | **Type**      | **Required** | **Notes**                                                                                  |
| ------------- | ------------- | ------------ | ------------------------------------------------------------------------------------------ |
| contamination | number (0–1)  | ✔︎           | Your guess of anomaly share. Used only to set the decision threshold.                      |
| rows[]        | array<object> | ✔︎           | One object = one transaction.                                                              |
| ↳ id          | string        | ✔︎           | Unique transaction ID for trace-back.                                                      |
| ↳ features    | object        | ✔︎           | Any helpful fields – numeric or categorical (auto one-hot encoded).                        |
| ↳ label       | 0 / 1         | optional     | 1 = confirmed fraud, 0 = confirmed legit. If absent or null, row is treated as unlabelled. |

**Tip More columns** ⇒ smarter model. Add device, merchant MCC, velocity metrics, 3-DS flag – whatever you track.

---

### Request Example

```json
{
  "contamination": 0.04,
  "rows": [
    {
      "id": "txn-001",
      "features": { "amount": 58.90, "channel": "web", "country": "BR", "hour": 17 },
      "label": 0
    },
    {
      "id": "txn-002",
      "features": { "amount": 102.15, "channel": "mobile", "country": "BR", "hour": 13 },
      "label": 0
    },
    {
      "id": "txn-003",
      "features": { "amount": 36.50, "channel": "web", "country": "US", "hour": 10 },
      "label": 0
    },
    {
      "id": "txn-004",
      "features": { "amount": 9100.00, "channel": "pos", "country": "NG", "hour": 2 },
      "label": 1
    },
    {
      "id": "txn-005",
      "features": { "amount": 4999.99, "channel": "atm", "country": "RU", "hour": 1 },
      "label": 1
    },
    {
      "id": "txn-006",
      "features": { "amount": 820.00, "channel": "mobile", "country": "BR", "hour": 23 }
    },
    {
      "id": "txn-007",
      "features": { "amount": 165.40, "channel": "web", "country": "US", "hour": 9 }
    }
  ]
}
```

---

### Response Example

```json
{
  "kpi": {
    "detected_pct": 14.29,
    "auc": 1.0
  },
  "details": [
    { "id": "txn-001", "anomaly_score": -0.12235, "fraud_flag": false },
    { "id": "txn-002", "anomaly_score": -0.13145, "fraud_flag": false },
    { "id": "txn-003", "anomaly_score": -0.13628, "fraud_flag": false },
    { "id": "txn-004", "anomaly_score": 0.00636, "fraud_flag": true },
    { "id": "txn-005", "anomaly_score": -0.02015, "fraud_flag": false },
    { "id": "txn-006", "anomaly_score": -0.09873, "fraud_flag": false },
    { "id": "txn-007", "anomaly_score": -0.13424, "fraud_flag": false }
  ],
  "interpretation": "14.29% of records flagged by IsolationForest. Threshold=-0.0000 (quantile 0.96)."
}
```

---

### Field semantics

| **Field**          | **Meaning**                                                                          |
| ------------------ | ------------------------------------------------------------------------------------ |
| `anomaly_score`    | Higher ⇒ farther from the “normal” cluster. Scaled around 0 or reconstruction error.|
| `fraud_flag`       | `true` if `anomaly_score` ≥ threshold, based on the (1 - contamination) quantile.    |
| `kpi.detected_pct` | % of all rows that were flagged (your actual anomaly rate this batch).               |
| `kpi.auc`          | Quality check on rows that have labels. Absent if none were provided.                |
| `interpretation`   | One-liner: model used, share flagged, threshold selected.                            |

---

### What happens under the hood

**Pre-processing**

* One-hot encode categoricals

* Robust-scale numerics

**Model bake-off**

* Trains: Isolation-Forest, Local-Outlier-Factor, Auto-Encoder

* Selects model with highest AUC (fallback = Isolation-Forest)

**Thresholding**

* Score distribution cut at the (1 - contamination) quantile

**Packaging**

* Returns KPIs and per-row verdicts

---

### Typical analysis workflow

| **Step** | **Action**                                                               |
| -------- | ------------------------------------------------------------------------ |
| 1        | Pipe the last N minutes/hours of transactions into the route.            |
| 2        | Sort `details` by `anomaly_score` descending – investigate from the top. |
| 3        | Feed analyst feedback back as `label` on the next call → improves `auc`. |
| 4        | Tune `contamination`: lower = stricter, higher = exploratory.            |
| 5        | Promote high-score rules to real-time block list / MFA challenge.        |

---

### Best practices

* Velocity features help! – e.g. `"txn_in_last_5min": 8` improves detection.

* Retrain periodically with fresh labels – endpoint auto-adapts to data.

* Watch `detected_pct` drift – large spikes may mean threshold or feature changes needed.

* Use `/api/anomaly_transactions` to turn raw streams into concise fraud lists – no in-house ML team required.

---

