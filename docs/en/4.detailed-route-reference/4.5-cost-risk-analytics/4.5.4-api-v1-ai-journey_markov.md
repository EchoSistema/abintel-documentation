# 4.5.4 /api/v1/ai/journey_markov

**Map drop-offs & winning paths with a Markov funnel model**

---

### Purpose 
Turns raw click-stream sessions into a tidy Markov-chain: transition probabilities, step-level abandonment, and at-a-glance optimisation cues.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yml
POST https://api.abintel.ai/api/v1/ai/journey_markov
headers:
X-Customer-Api-Id: <uuid>
X-Secret: <secret>
Content-Type: application/json
```

---

## Why you’d call it

| **Need**                                         | **What the route delivers**                                                              |
|--------------------------------------------------|-------------------------------------------------------------------------------------------|
| “Which screen leaks the most traffic?”           | `drop_off_probs` per step.                                                               |
| “What’s the chance a user who hits PDP will reach Cart?” | `transitions` array with conditional probabilities.                                      |
| “Where should the UX team start first?”          | `interpretation` auto-highlights top bottlenecks & average journey depth.                |

---

## Request payload reference

| **Path**      | **Type**       | **Required** | **Notes**                                                                                      |
|---------------|----------------|--------------|------------------------------------------------------------------------------------------------|
| `absorb_on`   | string          | ✔︎           | Label for the success state (e.g. `"Conversion"`). The model appends this as an absorbing final step. |
| `sessions[]`  | array<object>   | ✔︎           | One object = one anonymous session.                                                            |
| ↳ `session_id`| string          | ✔︎           | Only for debugging/tracing; not used in maths.                                                 |
| ↳ `steps[]`   | array<string>   | ✔︎           | Ordered list of unique page / event labels before the success step.                           |
| ↳ `converted` | 0 \| 1          | ✔︎           | 1 → funnel succeeds; 0 → session ends in implicit `"EXIT"` absorbing state.                    |

> **Tip** Include micro-events (e.g. Checkout, Payment) to inspect deeper frictions; granularity is up to you.

---

### Response (Field semantics)

| **Field**        | **Meaning**                                                                             |
|------------------|---------------------------------------------------------------------------------------- |
| `transitions[]`  | Conditional probabilities `P(next step \| current)`                                     |
| `drop_off_probs` | Probability a session terminates right after each step. 1.0 for "Conversion" or "EXIT". |
| `interpretation` | Natural-language digest – flags worst offenders, surfaces mean journey length.          |

---

### How it’s computed (under the hood)

- **Session stitching** – duplicates & loops collapsed so each step appears once per session in order.  
- **Absorbing states**  
- Success → label from `absorb_on`.  
- Failure → synthetic `"EXIT"`.  
- **Transition counts** – every adjacent pair tallied, then row-normalised → probabilities.  
- **Drop-off** – `1 − ∑ row(p)` for each non-absorbing state.  
- **Diagnostics** – mean steps, top K leak points, surfaced in `interpretation`.

---

## Typical workflow

| **Step**                      | **Action**                                                                 |
|------------------------------ |--------------------------------------------------------------------------- |
| Pull recent session logs      | Include all in-journey events (web, app, kiosk, …).                        |
| POST to `/api/journey_markov` | One call per funnel variant (e.g. device, market).                         |
| Read `drop_off_probs`         | Prioritise UX / promo tweaks where abandonment is highest.                 |
| Re-run after changes          | Compare transition deltas to confirm improvements.                         |

---

