# 4.1.11 /api/v1/ai/segment_cluster_profiles
+> Nota: traducción generada automáticamente desde el inglés; revisar antes de publicar.


Roll-Up KPI Portraits for Each Cluster

---

### Propósito

Transform a raw customer → cluster mapping + base features into C-level summary cards that answer:

“How big is each segment, what do they buy, how valuable are they, and what should we do next?”

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Solicitud

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_cluster_profiles`
```

---

### Esquema del Cuerpo de la Solicitud

| Key               | Type          | Required? | Meaning                                          | How to Gather                                      |
| ----------------- | ------------- | --------- | ------------------------------------------------ | -------------------------------------------------- |
| `customers`       | array<object> | Yes       | Feature block used across segmentation endpoints | Materialized view of analysis window (6–18 months) |
| ↳ `id`            | string        | Yes       | CRM primary key                                  | —                                                  |
| ↳ `frequency`     | int           | Yes       | Number of orders in analysis window              | —                                                  |
| ↳ `amount_spent`  | float         | Yes       | Total revenue in window                          | —                                                  |
| ↳ `product_types` | array<string> | Yes       | Purchased categories or SKU slugs                | —                                                  |
| `labels`          | object        | Yes       | Mapping `customer_id → cluster_id`               | Use your selected segmentation model output        |

---

⚙️ No hyper-parameters, no pagination — this service acts as a pure aggregation layer for summarizing segment-level KPIs.

---

### Solicitud

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  }
}
```

---

### Respuesta

```json
{
    "cluster_profiles": [
        {
            "cluster_id": 0,
            "n_customers": 31,
            "avg_spend": 591.11,
            "median_spend": 540.0,
            "avg_frequency": 8.81,
            "top_categories": "wine, cheese, diapers, sd-card, office-chair",
            "share_of_revenue_pct": 40.71,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 1,
            "n_customers": 7,
            "avg_spend": 2577.37,
            "median_spend": 2560.0,
            "avg_frequency": 23.14,
            "top_categories": "smart-tv, soundbar, hdmi-cable, tablet, stylus",
            "share_of_revenue_pct": 40.08,
            "insight": "Focus on retention & upsell"
        },
        {
            "cluster_id": 2,
            "n_customers": 2,
            "avg_spend": 4321.68,
            "median_spend": 4321.68,
            "avg_frequency": 29.0,
            "top_categories": "laptop, mouse, keyboard, monitor, gaming-pc",
            "share_of_revenue_pct": 19.2,
            "insight": "Growth-potential segment"
        }
    ]
}
```

---

### Cluster Profile Fields

| **Field**              | **Formula / Derivation**                                                                                           | **What It Tells You**     | **Action Trigger**            |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------- | ----------------------------- |
| `cluster_id`           | Echo of your original label                                                                                        | —                         | Key for joins                 |
| `n_customers`          | `COUNT(*)` in cluster                                                                                              | Segment size              | Gauge campaign reach          |
| `avg_spend`            | `AVG(amount_spent)` (in R\$)                                                                                       | Mean value per customer   | Compare to CAC & LTV goals    |
| `median_spend`         | 50th percentile spend                                                                                              | Robust to outliers        | Pricing & discount policy     |
| `avg_frequency`        | `AVG(frequency)` (orders per period)                                                                               | Purchase cadence          | Trigger replenishment flows   |
| `top_categories`       | TF-IDF on `product_types`, top-5 slugs                                                                             | Category affinity         | Creative for ads / email hero |
| `share_of_revenue_pct` | `SUM(amount_spent_cluster) / SUM(amount_spent_total) × 100`                                                        | Revenue weight of segment | Resource allocation           |
| `insight`              | Auto rule-based narrative:                                                                                         | Quick business cue        | Slot into slide decks         |
|                        | If `avg_spend > pop_mean` **and** `share_of_revenue_pct ≥ 30%` ⇒ "Retention & upsell"<br>Else ⇒ "Growth-potential" |                           |                               |

---

### KPI Example – What It Means

| **Cluster**                        | **Portrait**                                              | **Recommended Playbook**                         |
| ---------------------------------- | --------------------------------------------------------- | ------------------------------------------------ |
| `0 – “Mainstream Basket Shoppers”` | 31 cust · 8.8 orders · 591 R\$ avg spend · 41% of revenue | Frequency boosters, cross-sell snacks & CPG      |
| `1 – “Power Electronics Buyers”`   | 7 cust · 23 orders · 2,577 R\$ avg spend · 40% of revenue | VIP concierge, extended warranty, bundle deals   |
| `2 – “Tech Whales”`                | 2 cust · 29 orders · 4,322 R\$ avg spend · 19% of revenue | Dedicated account manager, early-access launches |

---

### Quick SQL Example to Recreate `labels` Join

WITH base AS (
  SELECT c.id, c.cluster_id, f.amount_spent, f.frequency, f.product_types
  FROM crm.customers c
  JOIN api_labels   l ON l.customer_id = c.id         -- mapping from earlier
  JOIN fact_cust_agg f ON f.customer_id = c.id        -- your feature table
)
SELECT
  cluster_id,
  COUNT(*)                    AS n_customers,
  AVG(amount_spent)           AS avg_spend,
  PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY amount_spent) AS median_spend,
  AVG(frequency)              AS avg_frequency,
  ARRAY_TO_STRING(
      ARRAY_SLICE( -- top 5 TF-IDF slugs
         (SELECT slug FROM UNNEST(tfidf_top(product_types)) LIMIT 5),
         1, 5), ', ')          AS top_categories
FROM base
GROUP BY cluster_id;

---

### Commercial Benefits

1. One-click persona cards – Drop `cluster_profiles` into Confluence, Notion, or PDFs.

2. Revenue skew insight – Identify segments that punch above their weight.

3. Creative brief generator – Use `top_categories` + `insight` for instant copy cues.

4. Board dashboards – Share KPIs without exposing `customer-level` data.

---

### FAQ

| **Question**                        | **Answer**                                                                                                 |
| ----------------------------------- | ---------------------------------------------------------------------------------------------------------- |
| Why both `avg` and `median_spend`?  | Median cushions long-tail outliers; average shows total value for LTV calculations.                        |
| Can I get CLV or churn per cluster? | Yes — join this output with `/customer_clv_forecast` or `/churn_risk` by `customer_id`, then re-aggregate. |
| How many top categories?            | Fixed at 5 for now. Future param: `top_n_categories` coming in v1.8.                                       |
| What languages are supported?       | Currently only English for `insight`. i18n support is expected in Q4 2025.                                 |

---

### Próximo Paso

Embed cluster_profiles in your marketing playbook,
Allocate budget by share_of_revenue_pct,
Tailor creatives using top_categories for each persona.

---

