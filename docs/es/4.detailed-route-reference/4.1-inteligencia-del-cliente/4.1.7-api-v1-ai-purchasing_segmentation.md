# 4.1.7 `/api/v1/ai/purchasing_segmentation`
+> Nota: traducción generada automáticamente desde el inglés; revisar antes de publicar.


### Propósito
Benchmark four clustering families (K-Means, Gaussian-Mixture, Agglomerative, DBSCAN); auto-select the statistically best model; return:
- **Customer-to-cluster labels**
- **Feature-space centroids**
- **Cluster personas** (English descriptors)
- **Full dendrogram** for visualization

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header               | Value      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Solicitud

```yml
POST https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation
Content-Type: application/json

{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse"] },
    { "id": "C002", "frequency": 5,  "amount_spent": 190.40,  "product_types": ["tea", "coffee"] }
  ],
  "k_range": [3, 4, 5, 6]
}
```

#### Esquema del Cuerpo de la Solicitud

| JSON Key          | Type / Range                 | Required | Meaning                                   | Best Practice                         |
|-------------------|-----------------------------|----------|-------------------------------------------|---------------------------------------|
| `customers`       | array<object>               | Yes      | One row per shopper with minimal features | Use a materialized view (6–18 months) |
| ↳ `id`            | string (unique)             | Yes      | Primary key from CRM                      | —                                     |
| ↳ `frequency`     | int ≥ 1                     | Yes      | Count of transactions                     | `COUNT(order_id)`                     |
| ↳ `amount_spent`  | float ≥ 0                   | Yes      | Total revenue in window                   | `SUM(order_total)`                    |
| ↳ `product_types` | array<string> (length ≥ 1)  | Yes      | Purchased SKUs or categories              | `array_agg(DISTINCT category_lvl1)`   |
| `k_range`         | array<int> (3–30)           | Optional | k values to try for K-Means, GMM, Agglo   | Keep short (3–10) for performance     |
| `algorithms`      | array<string>               | Optional | Specify algorithm families                | Omit to run all                       |

#### Ejemplo de Respuesta
```json
{
  "benchmark": [
    {
      "algo": "agglo",
      "k": 3,
      "silhouette": 0.68,
      "davies_bouldin": 0.37
    },
    {
      "algo": "kmeans",
      "k": 3,
      "silhouette": 0.61,
      "davies_bouldin": 0.47
    }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 3,
    "silhouette": 0.68,
    "davies_bouldin": 0.37,
    "n_clusters": 3
  },
  "centroids": [
    [8.81, 591.11, 1.97],
    [23.14, 2577.37, 2.29],
    [29.00, 4321.67, 4.00]
  ],
  "labels": {
    "C001": 2,
    "C002": 0
  },
  "interpretations_en": {
    "0": "avg spend 591, 8.8 purchases/mo. Top categories: wine, cheese.",
    "1": "avg spend 2 577, 23.1 purchases/mo. Top categories: smart-tv, soundbar.",
    "2": "avg spend 4 322, 29.0 purchases/mo. Top categories: laptop, mouse."
  },
  "dendrogram": {}
}
```

#### Claves de la Respuesta

| Key Path                | Type               | Meaning                                                           | Usage                                      |
|-------------------------|--------------------|-------------------------------------------------------------------|--------------------------------------------|
| `benchmark[]`           | array<object>      | Scorecard for each algorithm and k                                | Compare, monitor, tune                     |
| `best_model`            | object             | Details of the best cluster configuration                         | Model selection                            |
| `centroids[]`           | array<float[3]>    | [frequency, amount_spent, avg_product_types] per cluster          | Cluster profiling                          |
| `labels`                | object             | Mapping customer_id → cluster_id                                  | For CRM/CDP joins                          |
| `interpretations_en`    | object             | Persona blurbs per cluster ID                                     | For business storytelling                  |
| `dendrogram`            | object             | Hierarchical linkage and cluster legend (see dendrogram endpoint) | Visualization, analysis                    |

---

**Next Step:** ▶ POST the same payload to `/api/segmentation_report_json_i18n` for a multilingual KPI + persona pack (EN/ES/PT) ready for slides, dashboards, and strategy reviews.

