# 4.2.4 /api/v1/ai/recommend_user_items
+> Nota: traducción generada automáticamente desde el inglés; revisar antes de publicar.


### Purpose – Hyper-Personalised Product Suggestions in One Call

Generate a ranked list of items most likely to interest a given user by combining historical interactions with product metadata.

Model Logic:

* ALS (matrix factorisation) when ≥ 75 users × ≥ 50 items.

* TF-IDF + cosine similarity for sparse or cold-start scenarios.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

```yaml
POST  https://api-prod.abintel.ai/api/v1/ai/recommend_user_items
Headers
  X-Customer-Api-Id: <uuid>
  X-Secret:          <secret>
  Content-Type:      application/json
```

---

### Request Body – Complete Field Reference

## Root Keys

| **JSON Path**  | **Type / Range** | **Required** | **Meaning**                   | **Notes**                                         |
| -------------- | ---------------- | ------------ | ----------------------------- | ------------------------------------------------- |
| `user_id`      | string           | yes          | User to recommend items for   | Example: "U-42"                                   |
| `top_k`        | int (1–100)      | optional     | Max number of recommendations | Default: 10; 5–25 for email; 50–100 for UI scroll |
| `interactions` | array<object>    | yes          | Clicks, views, ratings, buys  | Min 3 rows                                        |
| `items`        | array<object>    | yes          | Items to rank                 | Supply full candidate catalogue                   |

---

### interactions[] Structure

| **Key**   | **Type** | **Required** | **Notes**                               |
| --------- | -------- | ------------ | --------------------------------------- |
| `user_id` | string   | yes          | Can be other users to help matrix build |
| `item_id` | string   | yes          | Must exist in `items[]`                 |
| `rating`  | float    | optional     | 0–5 explicit score; else treated as +1  |

---

### items[] Structure

| **Key**    | **Type** | **Required** | **Notes**                                    |
| ---------- | -------- | ------------ | -------------------------------------------- |
| `item_id`  | string   | yes          | Primary key                                  |
| `metadata` | string   | optional     | Rich attributes: category, brand, tags, etc. |

* You may include extra keys (e.g. price), which are ignored now but stored for future use.

---

### Algorithm Selection & Pipeline

| **Step**              | **Dense Matrix (ALS)**                      | **Sparse / Cold-start (TF-IDF)**           |
| --------------------- | ------------------------------------------- | ------------------------------------------ |
| **1. Check Sparsity** | ≥ 75 users, ≥ 50 items, ≥ 1500 interactions | Otherwise                                  |
| **2. Prepare Data**   | Implicit matrix; weight rating/5 vs. 1      | TF-IDF over metadata (bigrams, idf smooth) |
| **3. Train**          | ALS (50 dims, 30 iterations)                | —                                          |
| **4. Score**          | Cosine similarity in latent space           | Cosine similarity in TF-IDF vector space   |
| **5. Filter**         | Remove already seen items, apply diversity  | —                                          |
| **6. Return**         | Top-K by score                              | Top-K by similarity                        |

## Performance:

* ALS cached: ~60 ms

* TF-IDF fallback: ~15 ms (100k-item catalogue, CPU)

---

### Example Request

```json
{
  "user_id": "U-42",
  "top_k": 5,
  "interactions": [
    {"user_id": "U-42", "item_id": "SKU-A1", "rating": 5},
    {"user_id": "U-42", "item_id": "SKU-B9"},
    {"user_id": "U-17", "item_id": "SKU-C3", "rating": 4}
  ],
  "items": [
    {"item_id": "SKU-A1", "metadata": "Running shoes, Nike, men"},
    {"item_id": "SKU-B9", "metadata": "Trail shoes, Adidas, women"},
    {"item_id": "SKU-C3", "metadata": "Soccer ball, size 5"},
    {"item_id": "SKU-D7", "metadata": "Compression socks, unisex"},
    {"item_id": "SKU-E2", "metadata": "Fitness smartwatch"}
  ]
}
```

---

### Ejemplo de Respuesta

```json
{
  "recommendations": [
    {
      "item_id": "SKU-B9",
      "score": 0.1783,
      "source": "content-fallback",
      "explanation": "Shares similar attributes/keywords with the reference item."
    },
    {
      "item_id": "SKU-C3",
      "score": 0.0000,
      "source": "content-fallback"
    }
  ],
  "model_info": {
    "algorithm": "TF-IDF cosine",
    "metric": "cosine_sim",
    "value": 1.0,
    "train_rows": 5
  }
}
```

---

### Field Guide

| **Path**                        | **Type**       | **Meaning**                     | **Use**                   |
| ------------------------------- | -------------- | ------------------------------- | ------------------------- |
| `recommendations[].item_id`     | string         | SKU to show                     | PDP, email, widgets       |
| `recommendations[].score`       | float 0–1      | Relevance score                 | Use in ranking / blending |
| `recommendations[].source`      | enum           | `als` or `content-fallback`     | Trace model used          |
| `recommendations[].explanation` | string         | Why it was recommended          | Display in UI             |
| `model_info.algorithm`          | string         | Engine used                     | Audit log                 |
| `model_info.metric/value`       | string / float | Fit score (cosine\_sim or RMSE) | Drift monitoring          |
| `model_info.train_rows`         | int            | Count of training interactions  | Data quality checkpoint   |

---

### Commercial Playbooks

| **Surface**         | **Implementation**                                  | **Lift**               |
| ------------------- | --------------------------------------------------- | ---------------------- |
| PDP                 | Call client-side on load                            | +9% add-to-cart        |
| Post-purchase email | Use `user_id` of last buyer, show top 5 new SKUs    | +18% repeat order rate |
| App push            | Daily cron sends top SKU for user if score > 0.4    | +7% DAU retention      |
| In-store kiosk      | Use loyalty card to get `user_id` → recommendations | +5% basket size        |

---

### Data Engineering & Ops Tips

* Interaction weighting: Multiple rows of same `(user, item)` are summed. Prefer one explicit rating.

* Cold-start items: Add rich metadata for TF-IDF to work well.

* Batching: Loop over users nightly and store results.

* Diversity: Post-process top-k by category/brand to avoid tunnel vision.

* Privacy: `user_id` can be hashed; no PII needed.

---

### FAQ

| **Q**                               | **A**                                                                 |
| ----------------------------------- | --------------------------------------------------------------------- |
| Can I include timestamps?           | Not yet – time-weighted ALS in Q2 2026.                               |
| What if I have 1M items?            | Use `top_k=200`, filter downstream in your DB.                        |
| Can I recommend for multiple users? | Not in one call – use `/bulk_recommend_user_items`.                   |
| Cold-start user?                    | Provide 3+ implicit items (e.g., last views); otherwise returns `[]`. |
| Regulator explainability?           | Add `X-Explain-Features: true` to header (Enterprise).                |

---

### Próximo Paso
Pipe the recommendations into your front-end component, measure CTR uplift, and iterate: the more interaction rows you send, the smarter the engine becomes.

---

