## 1. Resumen Ejecutivo — "¿Por qué ABIntel?"

### Desafío vs Resultado

| **Desafío**                       | **Resultado de ABIntel (Probado en Producción)** |
| --------------------------------- | ------------------------------------------------ |
| Datos en silos desconectados, sin equipo de ML | ✅ Microservicios plug-and-play que ingieren transacciones, facturas, tickets, flujos de sensores o texto libre y entregan predicciones accionables en < 60 s. |
| Tiempo para generar valor lento   | ✅ Primera campaña o proyecto de costos en ≤ 2 horas; aumento típico de 6–14 % en EBIT dentro de un trimestre fiscal. |
| Falta de experiencia en GPU       | ✅ El cambio a GPU o el fallback seguro en CPU es automático. |
| Transferencias entre Datos y Negocio | ✅ Cada respuesta incluye narrativas en inglés, español y portugués para que marketing, planificación y finanzas entiendan el "¿y qué?" al instante. |

---

## 1.1 Arquitectura de la Plataforma en Resumen

* 🧩 Kubernetes con autoscaling hasta **32× T4s** (o **H100s en el Q4 de 2025**)
* 🔐 Auditoría SOC 2 Tipo 2 en progreso; centros de datos certificados **ISO 27001**
* 🚀 **Canary releases** sin tiempo de inactividad
* 🏷️ Versionado semántico mediante `/v1`

---

## 1.2 Servidor de la API

```
https://api-prod.abintel.app
```

---

## 1.3 Encolar una Tarea → `POST /ai/{downstream_route}`

### Ejemplo

```http
POST /api/v1/ai/forecast_revenue
```

#### Encabezados

```http
X-Customer-Api-Id: 4d09ffe5-33d7-4a63-b4fd-fc1decf4fa8f
X-Secret: AfIqb2F9JNET_…HzHUa0w
```

#### Cuerpo

```json
{
  "region": "EU",
  "horizon": 12,
  "include_promotions": true
}
```

### Tras Bambalinas

1. El proxy verifica tu plan → mapeo de cola (`Business → tasks-medium`)
2. Comprueba si la ruta downstream está permitida
3. La tarea se guarda en **Cosmos DB** con `status: "queued"`
4. Se debita un `UsageRecord`
5. El trabajo se encola en **Azure Service Bus**
6. El worker ejecuta el modelo de IA → escribe `status: "completed"` en Cosmos DB

### Respuesta (HTTP 202 - Queued)

```json
{
  "task_id": "c7d1b5e76c67485eab1c9a407f7e6a97",
  "queue": "tasks-medium",
  "status": "queued"
}
```

> 💡 Consejo: Todo lo que envíes por `POST` se almacena exactamente como lo enviaste. Puedes mandar objetos grandes y anidados.

---

## 1.4 Verificar Estado / Descargar Resultados

### 1.4.1 Listar Trabajos Recientes

```http
GET /api/v1/taskadmin/tasks?status_filter=completed&limit=20
```

Mismos encabezados de autenticación.

### 1.4.2 Recuperar un Trabajo

```http
GET /api/v1/taskadmin/tasks/{task_id}?part=response
```

#### Ejemplo – Éxito

```json
{
  "auc": 0.912,
  "predictions": [ ... ],
  "interpretation": "Modelo XGBoost – buena separación."
}
```

#### Ejemplo – Falla

```json
{
  "error": "HTTP 500 Server Error: …",
  "status_code": 500
}
```

---

## 1.5 Dashboards de Cola y Workers

| **Endpoint**                  | **Uso**                                                          | **Ejemplo** |
| ----------------------------- | ---------------------------------------------------------------- | ----------- |
| `GET /taskadmin/queue/stats`  | Resumen: cantidades en cola / completadas / fallidas por cola + trabajo más antiguo | `GET /api/v1/taskadmin/queue/stats` |
| `GET /taskadmin/queue/queued` | Volcado paginado para dashboards personalizados                   | `GET /api/v1/taskadmin/queue/queued?queue=medium` |

> 🧠 Ambos endpoints consultan Cosmos DB – sin carga en los workers.

---

## 1.6 APIs de Uso / Facturación

| Endpoint                       | Descripción                          |
| ------------------------------ | ------------------------------------ |
| `GET /taskadmin/usage/month`   | Número de llamadas y costo del mes   |
| `GET /taskadmin/usage/history` | Historial de uso y costo por mes     |

#### Ejemplo de Respuesta

```json
{
  "month": "2025-05",
  "calls": 842,
  "cost": 42.10
}
```

> 💰 Los costos se derivan de `UsageRecord.cost`. Puedes definir precios por ruta.

---

## 1.7 Ciclo Típico

```
sequenceDiagram
    Customer ->> Proxy /ai/... : POST payload
    Proxy ->> Cosmos DB : Save task (status="queued")
    Proxy ->> Azure Service Bus : Enqueue task
    Celery Worker ->> Azure Bus : Poll
    Worker ->> AI Backend : POST for processing
    Worker ->> Cosmos DB : Save (status="completed" + response)
    Customer ->> /taskadmin/tasks/{id}?part=response : Fetch result
```

---

## 1.8 Guía Rápida de Manejo de Errores

| **Status**  | **Significado**          | **Próximo Paso**                           |
| ----------- | ------------------------ | ------------------------------------------- |
| `queued`    | Esperando un worker libre | Revisa `/queue/stats` para ver el backlog   |
| `completed` | Resultado listo           | Descárgalo                                  |
| `failed`    | Error o timeout           | Revisa el campo `error`; reintenta si es transitorio |

---

## 1.9 FAQ

* **¿Cuánto tiempo se conservan los resultados?**
  ⏳ 30 días (por defecto)

* **¿Puedo cancelar un trabajo?**
  ❌ Aún no – abre un ticket de soporte

* **¿Timeouts?**
  ⏱️ Timeout fijo de 60 s; divide trabajos grandes

* **¿Seguridad?**
  🔐 TLS 1.2 para todos los datos en tránsito
  🔒 Secretos con hash en reposo

---
