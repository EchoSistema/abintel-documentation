# 4.1 Inteligencia del Cliente

**Endpoints de Inteligencia del Cliente**:
`purchasing_segmentation`, `segmentation_report`, `segment_hierarchy_chart`, `segment_subsegment_explore`, `segment_cluster_profiles`, `customer_segmentation`, `customer_features`, `customer_loyalty`, `customer_rfm`, `customer_clv_features`, `customer_clv_forecast`, `churn_risk`, `nps`, `churn_label`

---

# 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Propósito
Agrupa clientes de forma autónoma; devuelve etiquetas, centroides, KPIs y personas en lenguaje sencillo.

---

### Encabezados `X-Customer-Api-Id`, `X-Secret`

| Encabezado          | Valor                |
|---------------------|---------------------|
| `X-Customer-Api-Id` | `<uuid>`            |
| `X-Secret`          | `<secret>`          |
| `Content-Type`      | `application/json` |

### Solicitud
```yml
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```
### Cuerpo:
```json
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "loyalty_score": 0.72,
        "recency_days": 15
      }
    }
  ]
}
```

#### Esquema del Cuerpo de la Solicitud

| Clave JSON          | Tipo              | Requerido | Descripción                                 | Notas/Fórmula                            |
|---------------------|-------------------|-----------|---------------------------------------------|------------------------------------------|
| `max_clusters`       | entero ≥ 2        | opcional  | Límite superior para K-Means y GMM          | Se recomiendan 8–15 para 5k–200k clientes |
| `dbscan_eps`         | float (0 < ε ≤ 1) | opcional  | Radio para DBSCAN después del z-score       | Comience en 0.35–0.45                    |
| `dbscan_min_samples` | entero ≥ 3        | opcional  | Vecinos mínimos para punto central DBSCAN   | Use 5 (por defecto); ajuste según el dataset |
| `data`               | array<object>     | requerido | Lista de objetos de cliente con características | 12–18 meses de datos de transacciones típicos |

#### Características dentro de `data[].features`

| Característica      | Tipo/Rango  | Definición de Negocio                         | Ejemplo SQL/Python                |
|---------------------|-------------|-----------------------------------------------|-----------------------------------|
| `purchase_total`    | float ≥ 0   | Ingresos acumulados en la ventana de observación | `SUM(order_total)`               |
| `visit_frequency`   | entero ≥ 0  | Número de sesiones de compra distintas        | `COUNT(DISTINCT order_date)`     |
| `avg_ticket`        | float ≥ 0   | Valor promedio por compra                     | `purchase_total / NULLIF(visit_frequency,0)` |
| `product_diversity` | entero ≥ 0  | Conteo de categorías de producto distintas    | `COUNT(DISTINCT category_lvl1)`  |
| `loyalty_score`     | float (0–1) | Puntuación de fidelidad normalizada           | `current_points / max_points_cap` |
| `recency_days`      | entero ≥ 0  | Días desde el último pedido                   | `DATEDIFF(CURRENT_DATE, MAX(order_date))` |

#### Ejemplo de Respuesta
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    }
  ],
  "clusters": [],
  "customer_labels": []
}
```

#### Claves de la Respuesta
| Clave               | Tipo          | Significado                                       | Uso                                   |
|---------------------|---------------|---------------------------------------------------|---------------------------------------|
| `best_algorithm`    | string        | Modelo con mayor silhouette/menor Davies-Bouldin  | Guardar con run-ID para pruebas A/B   |
| `evaluation_metrics`| array<object> | Métricas para cada algoritmo + parámetros         | Monitorizar en paneles de ML-Ops; rehacer si es necesario |
| `clusters`          | array<object> | Resumen de cada clúster: ID, tamaño, centroides   | Para campañas, niveles de fidelidad, paquetes |
| `customer_labels`   | array<object> | Mapeo de cada `customer_id` → `cluster_id`        | Unir nuevamente al CRM/CDP para audiencias |

---

# 4.1.2 `/api/v1/ai/customer_features`

### Propósito
Genera un vector de características limpio y listo para análisis para cada cliente, agrupando filas de transacciones en bruto (y cualquier metadato de fidelidad proporcionado).

---

### Encabezados `X-Customer-Api-Id`, `X-Secret`

| Encabezado          | Valor      |
|---------------------|------------|
| `X-Customer-Api-Id` | `<uuid>`   |
| `X-Secret`          | `<secret>` |
| `Content-Type`      | `application/json` |

### Solicitud

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json
```
### Respuesta
```json
{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Esquema del Cuerpo de la Solicitud

| Clave JSON         | Tipo / Rango         | Requerido | Significado                           | Cómo obtener / fórmula SQL           |
|--------------------|----------------------|-----------|---------------------------------------|--------------------------------------|
| `today`            | fecha ISO (YYYY-MM-DD)| opcional | Fecha de referencia para recencia     | `CURRENT_DATE` o parámetro de pipeline |
| `customers`        | array<object>        | sí        | Lista de instantáneas de clientes     | Desde consulta ETL diaria            |
| ↳ `customer_id`    | string               | sí (único)| Clave primaria del CRM/ERP            | `orders.customer_id`                 |
| ↳ `loyalty_score`  | float (0–1)          | opcional  | Puntuación de fidelidad o RFM calculada | `points / max_points_cap` o `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>        | sí (≥1)   | Datos de transacciones en bruto       | Use 12–18 meses de historial         |
| ↳ `transaction_id` | string               | sí        | ID del pedido                         | `orders.order_id`                    |
| ↳ `date`           | fecha ISO            | sí        | Fecha de la transacción               | `orders.order_date`                  |
| ↳ `amount`         | float ≥ 0            | sí        | Total del pedido                      | `orders.order_total`                 |
| ↳ `product_id`     | string               | sí        | ID de SKU o categoría                 | `order_items.product_id`             |

#### Características Calculadas

| Clave de la Característica | Fórmula                      | Interpretación de Negocio    |
|----------------------------|------------------------------|------------------------------|
| `purchase_total`           | `SUM(amount)`                | Gasto de por vida (GMV)      |
| `visit_frequency`          | `COUNT(transactions)`        | Número de ocasiones de compra|
| `avg_ticket`               | `purchase_total / visits`    | Tamaño promedio del carrito  |
| `product_diversity`        | `COUNT(DISTINCT product_id)` | Amplitud de compra           |
| `loyalty_score`            | pasado o `0.0`               | Indicador de fidelidad       |
| `recency_days`             | `DATEDIFF(today, MAX(date))` | Tiempo desde la última compra|

#### Ejemplo de Respuesta
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 918.95,
        "visit_frequency": 2.0,
        "avg_ticket": 459.48,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

#### Claves de la Respuesta

| Ruta de la Clave | Tipo  | Significado                 | Uso                                   |
|------------------|-------|-----------------------------|---------------------------------------|
| `customers[]`    | array | Cada entrada = 1 cliente    | Enviar a `/purchasing_segmentation`, etc. |
| ↳ `customer_id`  | string| Replica el ID enviado       | Para uniones con CRM/CDP              |
| ↳ `features`     | object| Vector de 6 KPIs            | Guardar en feature store o base de datos |

> **¿Por qué estas seis características?**
> Capturan dimensiones de valor, frecuencia, amplitud, fidelidad y tiempo, cubriendo > 80% de la varianza del comportamiento de compra.

---
