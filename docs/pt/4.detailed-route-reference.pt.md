# 4.1 Inteligência do Cliente

**Endpoints de Inteligência do Cliente**:
`purchasing_segmentation`, `segmentation_report`, `segment_hierarchy_chart`, `segment_subsegment_explore`, `segment_cluster_profiles`, `customer_segmentation`, `customer_features`, `customer_loyalty`, `customer_rfm`, `customer_clv_features`, `customer_clv_forecast`, `churn_risk`, `nps`, `churn_label`

---

# 4.1.1 `/api/v1/ai/purchasing_segmentation`

### Objetivo
Agrupa clientes de forma autônoma; retorna rótulos, centróides, KPIs e personas em linguagem simples.

---

### Cabeçalhos `X-Customer-Api-Id`, `X-Secret`

| Cabeçalho            | Valor               |
|----------------------|--------------------|
| `X-Customer-Api-Id`  | `<uuid>`           |
| `X-Secret`           | `<secret>`         |
| `Content-Type`       | `application/json` |

### Requisição
```yml
POST https://api.abintel.ai/api/v1/ai/purchasing_segmentation
Headers:
  X-Customer-Api-Id: <uuid>
  X-Secret: <secret>
  Content-Type: application/json
```
### Corpo:
```json
{
  "max_clusters": 10,
  "dbscan_eps": 0.40,
  "dbscan_min_samples": 5,
  "data": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 17850.55,
        "visit_frequency": 62,
        "avg_ticket": 287.27,
        "product_diversity": 36,
        "loyalty_score": 0.97,
        "recency_days": 3
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 2340.00,
        "visit_frequency": 18,
        "avg_ticket": 130.00,
        "product_diversity": 10,
        "loyalty_score": 0.72,
        "recency_days": 15
      }
    }
  ]
}
```

#### Esquema do Corpo da Requisição

| Chave JSON           | Tipo              | Obrigatório | Descrição                                   | Notas/Fórmula                              |
|----------------------|-------------------|-------------|---------------------------------------------|--------------------------------------------|
| `max_clusters`       | inteiro ≥ 2       | opcional    | Limite superior para K-Means e GMM          | Recomenda-se 8–15 para 5k–200k clientes    |
| `dbscan_eps`         | float (0 < ε ≤ 1) | opcional    | Raio do DBSCAN após padronização z-score    | Comece em 0.35–0.45                        |
| `dbscan_min_samples` | inteiro ≥ 3       | opcional    | Vizinho mínimo para ponto central DBSCAN    | Use 5 (padrão); ajuste conforme o dataset  |
| `data`               | array<object>     | obrigatório | Lista de objetos de cliente com recursos    | 12–18 meses de dados de transações típicos |

#### Recursos em `data[].features`

| Recurso             | Tipo/Faixa  | Definição de Negócio                           | Exemplo SQL/Python                |
|---------------------|-------------|-----------------------------------------------|-----------------------------------|
| `purchase_total`    | float ≥ 0   | Receita acumulada na janela de observação     | `SUM(order_total)`                |
| `visit_frequency`   | inteiro ≥ 0 | Número de sessões de compra distintas         | `COUNT(DISTINCT order_date)`      |
| `avg_ticket`        | float ≥ 0   | Valor médio por compra                        | `purchase_total / NULLIF(visit_frequency,0)` |
| `product_diversity` | inteiro ≥ 0 | Contagem de categorias de produto distintas   | `COUNT(DISTINCT category_lvl1)`   |
| `loyalty_score`     | float (0–1) | Pontuação de fidelidade normalizada           | `current_points / max_points_cap` |
| `recency_days`      | inteiro ≥ 0 | Dias desde o último pedido                    | `DATEDIFF(CURRENT_DATE, MAX(order_date))` |

#### Exemplo de Resposta
```json
{
  "best_algorithm": "Agglomerative",
  "evaluation_metrics": [
    {
      "algorithm": "KMeans",
      "params": { "k": 2 },
      "silhouette": 0.6188,
      "davies_bouldin": 0.4708,
      "calinski_harabasz": 51.6638,
      "n_clusters": 2
    },
    {
      "algorithm": "GaussianMixture",
      "params": { "k": 2 },
      "silhouette": 0.6059,
      "davies_bouldin": 0.4924,
      "calinski_harabasz": 53.1761,
      "n_clusters": 2
    }
  ],
  "clusters": [],
  "customer_labels": []
}
```

#### Chaves da Resposta
| Chave                | Tipo          | Significado                                        | Uso                                      |
|----------------------|---------------|----------------------------------------------------|------------------------------------------|
| `best_algorithm`     | string        | Modelo com maior silhouette/menor Davies-Bouldin   | Armazenar com run-ID para testes A/B     |
| `evaluation_metrics` | array<object> | Métricas para cada algoritmo + parâmetros          | Monitorar em dashboards de ML-Ops; rerun se necessário |
| `clusters`           | array<object> | Resumo de cada cluster: ID, tamanho, centróides    | Para campanhas, níveis de fidelidade, pacotes |
| `customer_labels`    | array<object> | Mapeamento de cada `customer_id` → `cluster_id`    | Juntar novamente ao CRM/CDP para audiências |

---

# 4.1.2 `/api/v1/ai/customer_features`

### Objetivo
Gera um vetor de características limpo e pronto para análise para cada cliente, consolidando linhas de transações brutas (e quaisquer metadados de fidelidade fornecidos).

---

### Cabeçalhos `X-Customer-Api-Id`, `X-Secret`

| Cabeçalho            | Valor      |
|----------------------|------------|
| `X-Customer-Api-Id`  | `<uuid>`   |
| `X-Secret`           | `<secret>` |
| `Content-Type`       | `application/json` |

### Requisição

```yml
POST https://api-prod.abintel.ai/api/v1/ai/customer_features
Content-Type: application/json
```
### Resposta
```json
{
  "today": "2025-04-24",
  "customers": [
    {
      "customer_id": "C-1001",
      "loyalty_score": 0.97,
      "transactions": [
        { "transaction_id": "T-001", "date": "2025-04-21", "amount": 520.55, "product_id": "P-01" },
        { "transaction_id": "T-002", "date": "2025-04-18", "amount": 398.40, "product_id": "P-02" }
      ]
    },
    {
      "customer_id": "C-1002",
      "transactions": [
        { "transaction_id": "T-004", "date": "2025-01-05", "amount": 120.00, "product_id": "P-10" },
        { "transaction_id": "T-005", "date": "2024-12-19", "amount": 75.90,  "product_id": "P-11" }
      ]
    }
  ]
}
```

#### Esquema do Corpo da Requisição

| Chave JSON         | Tipo / Faixa         | Obrigatório | Significado                           | Como obter / fórmula SQL            |
|--------------------|----------------------|-------------|----------------------------------------|-------------------------------------|
| `today`            | data ISO (YYYY-MM-DD)| opcional    | Data de referência para recência       | `CURRENT_DATE` ou parâmetro de pipeline |
| `customers`        | array<object>        | sim         | Lista de snapshot de clientes          | A partir de consulta ETL diária     |
| ↳ `customer_id`    | string               | sim (único) | Chave primária do CRM/ERP              | `orders.customer_id`                |
| ↳ `loyalty_score`  | float (0–1)          | opcional    | Pontuação de fidelidade ou RFM pré-calculada | `points / max_points_cap` ou `(z_R + z_F + z_M)/3` |
| ↳ `transactions`   | array<object>        | sim (≥1)    | Dados de transações brutas             | Use 12–18 meses de histórico        |
| ↳ `transaction_id` | string               | sim         | ID do pedido                           | `orders.order_id`                   |
| ↳ `date`           | data ISO             | sim         | Data da transação                      | `orders.order_date`                 |
| ↳ `amount`         | float ≥ 0            | sim         | Total do pedido                        | `orders.order_total`                |
| ↳ `product_id`     | string               | sim         | ID do SKU ou categoria                 | `order_items.product_id`            |

#### Recursos Calculados

| Chave do Recurso    | Fórmula                     | Interpretação de Negócio      |
|---------------------|-----------------------------|-------------------------------|
| `purchase_total`    | `SUM(amount)`               | Gasto vitalício (GMV)         |
| `visit_frequency`   | `COUNT(transactions)`       | Número de ocasiões de compra  |
| `avg_ticket`        | `purchase_total / visits`   | Tamanho médio do carrinho     |
| `product_diversity` | `COUNT(DISTINCT product_id)`| Amplitude de compra           |
| `loyalty_score`     | passado ou `0.0`            | Indicador de fidelidade       |
| `recency_days`      | `DATEDIFF(today, MAX(date))`| Tempo desde a última compra   |

#### Exemplo de Resposta
```json
{
  "customers": [
    {
      "customer_id": "C-1001",
      "features": {
        "purchase_total": 918.95,
        "visit_frequency": 2.0,
        "avg_ticket": 459.48,
        "product_diversity": 2.0,
        "loyalty_score": 0.97,
        "recency_days": 3.0
      }
    },
    {
      "customer_id": "C-1002",
      "features": {
        "purchase_total": 195.9,
        "visit_frequency": 2.0,
        "avg_ticket": 97.95,
        "product_diversity": 2.0,
        "loyalty_score": 0.0,
        "recency_days": 109.0
      }
    }
  ]
}
```

#### Chaves da Resposta

| Caminho da Chave    | Tipo  | Significado                 | Uso                                   |
|---------------------|-------|-----------------------------|---------------------------------------|
| `customers[]`       | array | Cada entrada = 1 cliente    | Enviar para `/purchasing_segmentation`, etc. |
| ↳ `customer_id`     | string| Replica o ID enviado        | Para junções com CRM/CDP              |
| ↳ `features`        | object| Vetor com 6 KPIs            | Armazenar em feature store ou banco   |

> **Por que essas seis características?**
> Capturam dimensões de valor, frequência, amplitude, fidelidade e tempo — cobrindo > 80% da variância do comportamento de compra.

---
