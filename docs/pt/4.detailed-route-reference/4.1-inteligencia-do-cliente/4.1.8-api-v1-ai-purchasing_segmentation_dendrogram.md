# 4.1.8 `/api/v1/ai/purchasing_segmentation_dendrogram`
+> Nota: tradu√ß√£o gerada automaticamente a partir do ingl√™s; revise antes de publicar.


**Rapid Hierarchical-Clustering & Dendrogram Builder**

---

## Objetivo

Returns a Ward-linkage matrix, centroids, and labels using **Agglomerative Clustering** only (no K-Means/GMM/DBSCAN sweep).  
The service brute-scans `k = 2 ‚Ä¶ 10` in one pass, selects the statistically best split, and returns everything required for:
- An interactive dendrogram
- A cluster explorer UI

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header                | Value         |
|-----------------------|--------------|
| X-Customer-Api-Id     | `<uuid>`     |
| X-Secret              | `<secret>`   |
| Content-Type          | application/json |

---

## Requisi√ß√£o

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/purchasing_segmentation_dendrogram`
```

### Esquema do Corpo da Requisi√ß√£o

| JSON Key   | Type / Range  | Required? | Meaning         | Notes                                              |
|------------|---------------|-----------|-----------------|----------------------------------------------------|
| customers  | array         | Yes       | Customer array  | See structure below                                |

#### `customers[]` Structure

| Field         | Type / Range          | Required | Definition                    | Warehouse Derivation        |
|---------------|----------------------|----------|-------------------------------|----------------------------|
| id            | string               | Yes      | Unique customer key           | ‚Äî                          |
| frequency     | int ‚â• 1              | Yes      | Order count within window     | COUNT(order_id)            |
| amount_spent  | float ‚â• 0            | Yes      | Revenue in selected time      | SUM(order_total)           |
| product_types | array (‚â•1 item)      | Yes      | Purchased SKUs/category slugs | ARRAY_AGG(DISTINCT cat_lvl1)|

> **No hyper-parameters to tune.**  
> The endpoint auto-selects optimal k (2‚Äì10) via Silhouette‚Üë / Davies-Bouldin‚Üì.

#### Example Request

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency": 5, "amount_spent": 190.40, "product_types": ["tea", "coffee"] },
    ...
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ]
}
```

---

## Resposta

```json
{
  "benchmark": [
    { "algo": "agglo", "k": 2, "silhouette": 0.7077, "davies_bouldin": 0.4514 },
    { "algo": "agglo", "k": 3, "silhouette": 0.6783, "davies_bouldin": 0.3761 },
    ...
    { "algo": "agglo", "k": 10, "silhouette": 0.5709, "davies_bouldin": 0.4166 }
  ],
  "best_model": {
    "algo": "agglo",
    "k": 2,
    "silhouette": 0.7077,
    "davies_bouldin": 0.4514,
    "n_clusters": 2
  },
  "centroids": [
    [24.44, 2964.99, 2.67],
    [8.81, 591.11, 1.97]
  ],
  "labels": {
    "C001": 0, "C002": 1, ..., "C040": 1
  },
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.59, 2.0],
      ...,
      [76.0, 77.0, 8866.56, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": ["C001", ..., "C040"],
    "cluster_legend": [
      { "cluster_id": 0, "n_customers": 9, "avg_spend": 2964.99, "avg_frequency": 24.44, "top_categories": "laptop, mouse, air-fryer" },
      { "cluster_id": 1, "n_customers": 31, "avg_spend": 591.11, "avg_frequency": 8.81, "top_categories": "wine, cheese, diapers" }
    ]
  }
}
```

---

### Response Field Details

#### `benchmark[]` ‚Äì Score Sweep (`k = 2 ‚Üí 10`)
- **silhouette** ‚Äî Cohesion/separation (range: 0‚Äì1; higher is better)
- **davies_bouldin** ‚Äî Intra/extra spread (range: 0‚Äì2; lower is better)
- Only Agglomerative entries are shown.

üèÜ **Sample: `k = 2` wins with Silhouette = 0.708**

#### `best_model`
- Chosen by highest Silhouette, then lowest Davies-Bouldin.
- `algo`: Always `"agglo"`
- `k`: Cluster count chosen
- `n_clusters`: Redundant copy of `k`

#### `centroids`
- **Order:** `[frequency, amount_spent, avg_product_types]`
- **Units:** Rescaled to original
  - Cluster 0 ‚Üí 24.4 transactions / 2,965 R$ / 2.7 categories
  - Cluster 1 ‚Üí 8.8 transactions / 591 R$ / 2.0 categories

#### `labels`
- Dictionary: `customer_id ‚Üí cluster_id` (0-based)
- Join to your CDP or feed into `/segmentation_report_json_i18n`

#### `dendrogram`
- **linkage_matrix**: SciPy-style `[child1, child2, distance, sample_count]` rows  
  Use with `scipy.cluster.hierarchy.dendrogram()` or Plotly
- **leaf_labels[]**: Customer IDs in leaf order (for hover labels)
- **cluster_legend[]**: Stats per cluster (`n`, spend, freq, top categories)  
  Display in tooltips or side panels

> üí° **Pro Tip:**  
> Call `/api/segment_hierarchy_chart` with the full dendrogram object to get a ready-made `{nodes, links}` graph for D3 / Plotly ‚Äì no extra coding needed.

---

## Commercial Interpretation Example

| Cluster | Size | Behavior | Potential Actions |
|---------|------|----------|------------------|
| 0 ‚Äì ‚ÄúHeavy Tech & Appliance Buyers‚Äù | 9 customers <br> avg spend: 2,965 R$ | 24 tx/year, high-ticket electronics, multi-category | VIP concierge, warranty upsell, bundles |
| 1 ‚Äì ‚ÄúMainstream Basket Shoppers‚Äù | 31 customers <br> avg spend: 591 R$ | 9 tx/year, groceries & small goods | Subscription replenishment, cross-sell, frequency boosters |

---

## FAQ

| Question | Answer |
|----------|--------|
| Can I change the k range? | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize. |
| Why only 2 clusters when I wanted 3? | The score sweep picked k = 2 ‚Äî k = 3 had lower silhouette. Use `"k_range":[3]` manually. |
| How do I plot the dendrogram quickly? | In Python:<br>```python<br>from scipy.cluster.hierarchy import dendrogram<br>dendrogram(linkage_matrix, labels=leaf_labels)<br>``` |
| What distance metric is used? | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types. |
| Payload limit? | 20 MB (~60k customers). Async bulk version coming in Q4 2025. |

---

## Pr√≥ximos Passos

- Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration.
- Use `/purchasing_segmentation` for generating campaign-ready personas.

---

### Fluxo de Trabalho T√≠pico

1. **POST** `/purchasing_segmentation_dendrogram` ‚Üí receive `linkage_matrix` + `labels`
2. **POST** `/segment_hierarchy_chart` ‚Üí get `{nodes, links}` graph
3. Render in a React or D3 widget
4. Save labels to DB or call `/segmentation_report_json_i18n` for KPI export

**Time to insight:**  
< 1 sec for 10k shoppers on T4 GPU  
~4 sec for 40k shoppers on CPU

---

### FAQ

| Question                                  | Answer                                                                                                             |
| ----------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| **Can I change the `k` range?**           | Not yet. This endpoint is optimized for speed. Use `/purchasing_segmentation` to customize.                        |
| **Why only 2 clusters when I wanted 3?**  | The score sweep picked `k = 2` ‚Äî `k = 3` had lower silhouette. Use `"k_range":[3]` manually.                       |
| **How do I plot the dendrogram quickly?** | In Python:<br>`from scipy.cluster.hierarchy import dendrogram`<br>`dendrogram(linkage_matrix, labels=leaf_labels)` |
| **What distance metric is used?**         | Ward linkage on z-scored numeric features + one-hot encoding for top 50 product types.                             |
| **Payload limit?**                        | 20 MB (\~60k customers). Async bulk version coming in Q4 2025.                                                     |

---

### Pr√≥ximo Passo

Drop the dendrogram into your BI tool or analytics dashboard for interactive exploration, and keep using /purchasing_segmentation for generating campaign-ready personas.

---

