# 4.1.9 /api/v1/ai/segment_hierarchy_chart
+> Nota: traduÃ§Ã£o gerada automaticamente a partir do inglÃªs; revise antes de publicar.


Turning a Raw Dendrogram into a Front-End-Ready Graph

---

### Objetivo

This endpoint accepts the exact dendrogram object returned by:

`/purchasing_segmentation_dendrogram`

or `/purchasing_segmentation`

â€¦and emits two tidy arrays:

`nodes`

`links`

`cluster_legend` (optional)

ðŸŽ¯ Drop these directly into D3.js, Plotly, ECharts, or a React force-graph â€” no parsing required.

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### RequisiÃ§Ã£o

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_hierarchy_chart`
```

---

### Esquema do Corpo da RequisiÃ§Ã£o

| Key                | Type          | Required | Meaning                                                             |
| ------------------ | ------------- | -------- | ------------------------------------------------------------------- |
| `dendrogram`       | object        | Yes      | Raw dendrogram object (must include three sub-keys below)           |
| â†’ `linkage_matrix` | 2-D array     | Yes      | Ward linkage rows: `[child1, child2, distance, sample_count]`       |
| â†’ `leaf_labels`    | array<string> | Yes      | Customer IDs, ordered to match the leaf index in the linkage matrix |
| â†’ `cluster_legend` | array<object> | Optional | Quick stats per cluster (for tooltips/side panels)                  |

âš¡ Payload remains lightweight: ~20â€“60 KB for tens of thousands of customers.

---

### How the API Transforms the Data

1. Enumerate Leaves
Every original customer becomes a node:

`is_leaf = true`

`id = 0 â†’ (n_leaves âˆ’ 1)`

---

2. Enumerate Internal Merges
Each row in the `linkage_matrix` becomes one internal node with:

| Field      | Description                         |
| ---------- | ----------------------------------- |
| `id`       | Index starting after last leaf      |
| `distance` | Linkage distance from matrix        |
| `size`     | Number of leaves under this cluster |

---

3. Generate Links
Each merge row creates two directional edges:

| Field      | Description                                                  |
| ---------- | ------------------------------------------------------------ |
| `source`   | ID of new internal node                                      |
| `target`   | IDs of `child1` and `child2` (can be leaves or internal IDs) |
| `distance` | Copied for edge-weight mapping                               |

---

### RequisiÃ§Ã£o

```json
{
  "dendrogram": {
    "linkage_matrix": [
      [1.0, 27.0, 5.5900115966796875, 2.0],
      [16.0, 34.0, 10.246950765959598, 2.0],
      [10.0, 38.0, 14.5, 2.0],
      [18.0, 33.0, 14.684114387072421, 2.0],
      [2.0, 24.0, 14.933482805184708, 2.0],
      [14.0, 20.0, 15.033296378372908, 2.0],
      [8.0, 23.0, 15.033296378372908, 2.0],
      [9.0, 22.0, 16.41102378466232, 2.0],
      [12.0, 40.0, 19.554342797373597, 3.0],
      [30.0, 41.0, 23.67840084690405, 3.0],
      [19.0, 36.0, 24.720185838561353, 2.0],
      [5.0, 31.0, 29.71684244831212, 2.0],
      [3.0, 45.0, 31.75951301054011, 3.0],
      [39.0, 47.0, 37.04603277151646, 3.0],
      [46.0, 49.0, 53.204636389447614, 5.0],
      [7.0, 43.0, 60.837535989873956, 3.0],
      [26.0, 48.0, 75.42189702647553, 4.0],
      [4.0, 35.0, 83.95602895187841, 2.0],
      [50.0, 51.0, 102.69139093644127, 4.0],
      [15.0, 53.0, 135.75478433757996, 4.0],
      [54.0, 56.0, 139.4687935795597, 9.0],
      [21.0, 57.0, 147.95607449395212, 3.0],
      [42.0, 58.0, 193.4435440607144, 6.0],
      [25.0, 29.0, 215.00232556881798, 2.0],
      [44.0, 55.0, 220.82693991432996, 5.0],
      [13.0, 37.0, 221.00452484055614, 2.0],
      [6.0, 11.0, 235.00212764994276, 2.0],
      [52.0, 60.0, 256.36800922508723, 12.0],
      [28.0, 61.0, 336.40545943552, 4.0],
      [0.0, 17.0, 401.8550746056813, 2.0],
      [32.0, 66.0, 522.3946688588159, 3.0],
      [62.0, 64.0, 537.5921954390619, 11.0],
      [63.0, 65.0, 647.7163731140352, 4.0],
      [59.0, 68.0, 743.4835774228395, 8.0],
      [70.0, 72.0, 1528.9174504219059, 7.0],
      [67.0, 71.0, 1623.9774150881199, 23.0],
      [73.0, 75.0, 2865.3048816814076, 31.0],
      [69.0, 74.0, 3076.681261272462, 9.0],
      [76.0, 77.0, 8866.563988339083, 40.0]
    ],
    "columns": ["child1", "child2", "distance", "sample_count"],
    "leaf_labels": [
      "C001", "C002", "C003", "C004", "C005", "C006", "C007", "C008", "C009", "C010",
      "C011", "C012", "C013", "C014", "C015", "C016", "C017", "C018", "C019", "C020",
      "C021", "C022", "C023", "C024", "C025", "C026", "C027", "C028", "C029", "C030",
      "C031", "C032", "C033", "C034", "C035", "C036", "C037", "C038", "C039", "C040"
    ],
    "cluster_legend": [
      {
        "cluster_id": 0,
        "n_customers": 9,
        "avg_spend": 2964.99,
        "avg_frequency": 24.44,
        "top_categories": "laptop, mouse, air-fryer"
      },
      {
        "cluster_id": 1,
        "n_customers": 31,
        "avg_spend": 591.11,
        "avg_frequency": 8.81,
        "top_categories": "wine, cheese, diapers"
      }
    ]
  }
}
```

---

### Resposta

```json
{
  "nodes": [
    { "id": 0, "label": "C001", "is_leaf": true },
    { "id": 1, "label": "C002", "is_leaf": true },
    { "id": 2, "label": "C003", "is_leaf": true },
    { "id": 3, "label": "C004", "is_leaf": true },
    { "id": 4, "label": "C005", "is_leaf": true },
    { "id": 5, "label": "C006", "is_leaf": true },
    { "id": 6, "label": "C007", "is_leaf": true },
    { "id": 7, "label": "C008", "is_leaf": true },
    { "id": 8, "label": "C009", "is_leaf": true },
    { "id": 9, "label": "C010", "is_leaf": true },
    { "id": 10, "label": "C011", "is_leaf": true },
    { "id": 11, "label": "C012", "is_leaf": true },
    { "id": 12, "label": "C013", "is_leaf": true },
    { "id": 13, "label": "C014", "is_leaf": true },
    { "id": 14, "label": "C015", "is_leaf": true },
    { "id": 15, "label": "C016", "is_leaf": true },
    { "id": 16, "label": "C017", "is_leaf": true },
    { "id": 17, "label": "C018", "is_leaf": true },
    { "id": 18, "label": "C019", "is_leaf": true },
    { "id": 19, "label": "C020", "is_leaf": true },
    { "id": 20, "label": "C021", "is_leaf": true },
    { "id": 21, "label": "C022", "is_leaf": true },
    { "id": 22, "label": "C023", "is_leaf": true },
    { "id": 23, "label": "C024", "is_leaf": true },
    { "id": 24, "label": "C025", "is_leaf": true },
    { "id": 25, "label": "C026", "is_leaf": true },
    { "id": 26, "label": "C027", "is_leaf": true },
    { "id": 27, "label": "C028", "is_leaf": true },
    { "id": 28, "label": "C029", "is_leaf": true },
    { "id": 29, "label": "C030", "is_leaf": true },
    { "id": 30, "label": "C031", "is_leaf": true },
    { "id": 31, "label": "C032", "is_leaf": true },
    { "id": 32, "label": "C033", "is_leaf": true },
    { "id": 33, "label": "C034", "is_leaf": true },
    { "id": 34, "label": "C035", "is_leaf": true },
    { "id": 35, "label": "C036", "is_leaf": true },
    { "id": 36, "label": "C037", "is_leaf": true },
    { "id": 37, "label": "C038", "is_leaf": true },
    { "id": 38, "label": "C039", "is_leaf": true },
    { "id": 39, "label": "C040", "is_leaf": true },
    { "id": 40, "distance": 5.5900115966796875, "size": 2, "is_leaf": false },
    { "id": 41, "distance": 10.246950765959598, "size": 2, "is_leaf": false },
    { "id": 42, "distance": 14.5, "size": 2, "is_leaf": false },
    { "id": 43, "distance": 14.684114387072421, "size": 2, "is_leaf": false },
    { "id": 44, "distance": 14.933482805184708, "size": 2, "is_leaf": false },
    { "id": 45, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 46, "distance": 15.033296378372908, "size": 2, "is_leaf": false },
    { "id": 47, "distance": 16.41102378466232, "size": 2, "is_leaf": false },
    { "id": 48, "distance": 19.554342797373597, "size": 3, "is_leaf": false },
    { "id": 49, "distance": 23.67840084690405, "size": 3, "is_leaf": false },
    { "id": 50, "distance": 24.720185838561353, "size": 2, "is_leaf": false },
    { "id": 51, "distance": 29.71684244831212, "size": 2, "is_leaf": false },
    { "id": 52, "distance": 31.75951301054011, "size": 3, "is_leaf": false },
    { "id": 53, "distance": 37.04603277151646, "size": 3, "is_leaf": false },
    { "id": 54, "distance": 53.204636389447614, "size": 5, "is_leaf": false },
    { "id": 55, "distance": 60.837535989873956, "size": 3, "is_leaf": false },
    { "id": 56, "distance": 75.42189702647553, "size": 4, "is_leaf": false },
    { "id": 57, "distance": 83.95602895187841, "size": 2, "is_leaf": false },
    { "id": 58, "distance": 102.69139093644127, "size": 4, "is_leaf": false },
    { "id": 59, "distance": 135.75478433757996, "size": 4, "is_leaf": false },
    { "id": 60, "distance": 139.4687935795597, "size": 9, "is_leaf": false },
    { "id": 61, "distance": 147.95607449395212, "size": 3, "is_leaf": false },
    { "id": 62, "distance": 193.4435440607144, "size": 6, "is_leaf": false },
    { "id": 63, "distance": 215.00232556881798, "size": 2, "is_leaf": false },
    { "id": 64, "distance": 220.82693991432996, "size": 5, "is_leaf": false },
    { "id": 65, "distance": 221.00452484055614, "size": 2, "is_leaf": false },
    { "id": 66, "distance": 235.00212764994276, "size": 2, "is_leaf": false },
    { "id": 67, "distance": 256.36800922508723, "size": 12, "is_leaf": false },
    { "id": 68, "distance": 336.40545943552, "size": 4, "is_leaf": false },
    { "id": 69, "distance": 401.8550746056813, "size": 2, "is_leaf": false },
    { "id": 70, "distance": 522.3946688588159, "size": 3, "is_leaf": false },
    { "id": 71, "distance": 537.5921954390619, "size": 11, "is_leaf": false },
    { "id": 72, "distance": 647.7163731140352, "size": 4, "is_leaf": false },
    { "id": 73, "distance": 743.4835774228395, "size": 8, "is_leaf": false },
    { "id": 74, "distance": 1528.9174504219059, "size": 7, "is_leaf": false },
    { "id": 75, "distance": 1623.9774150881199, "size": 23, "is_leaf": false },
    { "id": 76, "distance": 2865.3048816814076, "size": 31, "is_leaf": false },
    { "id": 77, "distance": 3076.681261272462, "size": 9, "is_leaf": false },
    { "id": 78, "distance": 8866.563988339083, "size": 40, "is_leaf": false }
  ],
  "links": [
    { "source": 40, "target": 1, "distance": 5.5900115966796875 },
    { "source": 40, "target": 27, "distance": 5.5900115966796875 },
    ...
  ],
  "columns": [ "source", "target", "distance" ],
  "cluster_legend": [
    {
      "cluster_id": 0,
      "n_customers": 9,
      "avg_spend": 2964.99,
      "avg_frequency": 24.44,
      "top_categories": "laptop, mouse, air-fryer"
    },
    {
      "cluster_id": 1,
      "n_customers": 31,
      "avg_spend": 591.11,
      "avg_frequency": 8.81,
      "top_categories": "wine, cheese, diapers"
    }
  ]
}
```

---

### Practical Visualisation Snippet (React + d3-hierarchy)

import { hierarchy, cluster } from 'd3-hierarchy';
import { select } from 'd3-selection';

// `nodes`, `links` fetched from the endpoint
const root = hierarchy({ children: nodes.filter(n => !n.is_leaf) })
  .sum(d => (d.is_leaf ? 1 : 0))
  .sort((a, b) => a.data.distance - b.data.distance);

cluster().size([360, 800])(root); // radial dendrogram

select(svgRef.current)
  .selectAll('line')
  .data(links)
  .join('line')
  .attr('x1', d => nodeX(d.source))
  .attr('y1', d => nodeY(d.source))
  .attr('x2', d => nodeX(d.target))
  .attr('y2', d => nodeY(d.target))
  .attr('stroke', '#999');

âœ… No need to re-calculate link distances or node sizesâ€”the service already did it.

---

### Commercial Value

| **Stakeholder**     | **Benefit**                                                               |
| ------------------- | ------------------------------------------------------------------------- |
| Merchandising teams | Drill into any branch to see what product mixes bind micro-segments       |
| Marketers           | Drag-select a cluster subtree and export the IDs for niche campaigns      |
| Data Scientists     | Visually validate cluster cohesion; spot outlier merges                   |
| CXO / Board         | Screenshot of radial dendrogram + legend panel tells a clear visual story |

---

### Performance & Limits

Supports up to 100k leaves comfortably (~1 MB JSON)

~50ms latency (parse + map) for 40k leaves on a T4 GPU (network-bound)

Internal node count = n_leaves â€“ 1 (binary tree rule)

ðŸ‘‰ Link count = 2 Ã— (n_leaves â€“ 1)

---

### FAQ

| **Question**                         | **Answer**                                                                                                                                            |
| ------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------- |
| Why do edges have distance?          | To let you map **Ward distance** to stroke width/colorâ€”emphasizes similarity depth                                                                    |
| Can I request Spanish or Portuguese? | Yesâ€”`cluster_legend` comes from the original dendrogram request; set `lang` on that call                                                              |
| What if I munged the linkage rows?   | The API checks for length = 4 and valid IDs. Invalid structures return HTTP 400                                                                       |
| We need zoomable sunburst instead    | Convert `nodes` + `links` to nested JSON (e.g., via DAG-to-tree util), or wait for:<br>`/segment_hierarchy_chart?format=sunburst` *(Q4 2025 roadmap)* |

---

### PrÃ³ximo Passo

Pin the dendrogram to your analytics portal, and let users:

Click-select a cluster

Export audience

Launch campaign â€” all in minutes

ðŸ§  No Python notebooks, no crontabs required.

---

