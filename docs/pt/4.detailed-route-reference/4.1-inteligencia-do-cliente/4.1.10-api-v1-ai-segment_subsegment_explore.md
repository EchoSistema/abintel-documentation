# 4.1.10 /api/v1/ai/segment_subsegment_explore
+> Nota: tradução gerada automaticamente a partir do inglês; revise antes de publicar.


Drill-Down Micro-Segmentation Service

---

### Objetivo

Take an existing segmentation (customer-to-cluster labels you've already produced) and perform a secondary, in-cluster clustering pass to reveal micro-segments with tighter behavioral alignment.

Ideal for:

Tiered loyalty perks

Hyper-personalised recommendations

“Segment-of-one” exploratory analysis

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### Requisição

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/segment_subsegment_explore`
```

---

### Esquema do Corpo da Requisição

| Key               | Type / Range  | Required? | Meaning                                      | How to Populate                                  |
| ----------------- | ------------- | --------- | -------------------------------------------- | ------------------------------------------------ |
| `customers`       | array<object> | Yes       | Customer-level feature vectors               | Re-use payload from the first-level segmentation |
| ↳ `id`            | string        | Yes       | Customer ID (CRM primary key)                | —                                                |
| ↳ `frequency`     | int           | Yes       | Orders in the analysis window                | —                                                |
| ↳ `amount_spent`  | float         | Yes       | Revenue in that same window                  | —                                                |
| ↳ `product_types` | array<string> | Yes       | Purchased categories (SKUs or slugs)         | —                                                |
| `labels`          | object        | Yes       | Mapping of `customer_id → parent cluster_id` | Use output from the previous clustering pass     |
| `target_cluster`  | int           | Optional  | Focus on one parent cluster                  | Omit to apply across all parent clusters         |
| `k_range`         | array<int>    | Optional  | Values of `k` to try during sub-clustering   | Default = `[2, 3]`                               |

---

### Algorithm Notes

Within each parent cluster:

The service applies K-Means

On z-scored numeric features:

`frequency`

`amount_spent`

`n_categories` (derived from `product_types`)

It benchmarks each `k` using:

Silhouette (↑ higher is better)

Davies-Bouldin (↓ lower is better)

The sub-cluster with the best statistical cohesion wins.

---

### Requisição

```json
{
  "customers": [
    { "id": "C001", "frequency": 28, "amount_spent": 4120.75, "product_types": ["laptop", "mouse", "keyboard", "monitor"] },
    { "id": "C002", "frequency":  5, "amount_spent":  190.40, "product_types": ["tea", "coffee"] },
    { "id": "C003", "frequency": 12, "amount_spent":  845.10, "product_types": ["jeans", "t-shirt", "sneakers"] },
    { "id": "C004", "frequency":  2, "amount_spent":   75.00, "product_types": ["notebook"] },
    { "id": "C005", "frequency": 17, "amount_spent": 1324.55, "product_types": ["smartphone", "earbuds"] },
    { "id": "C006", "frequency":  8, "amount_spent":  510.30, "product_types": ["dog food", "cat food"] },
    { "id": "C007", "frequency": 24, "amount_spent": 2780.90, "product_types": ["smart-tv", "soundbar", "hdmi-cable"] },
    { "id": "C008", "frequency": 10, "amount_spent":  660.00, "product_types": ["yogurt", "milk", "cheese"] },
    { "id": "C009", "frequency":  3, "amount_spent":  120.00, "product_types": ["stationery"] },
    { "id": "C010", "frequency": 15, "amount_spent":  975.65, "product_types": ["beer", "wine", "snacks"] },

    { "id": "C011", "frequency":  7, "amount_spent":  450.25, "product_types": ["books", "pens"] },
    { "id": "C012", "frequency": 25, "amount_spent": 3015.90, "product_types": ["tablet", "stylus", "cover"] },
    { "id": "C013", "frequency":  6, "amount_spent":  210.10, "product_types": ["pasta", "sauce"] },
    { "id": "C014", "frequency": 20, "amount_spent": 1884.00, "product_types": ["fitness-watch"] },
    { "id": "C015", "frequency":  1, "amount_spent":   40.00, "product_types": ["batteries"] },
    { "id": "C016", "frequency": 13, "amount_spent": 1105.35, "product_types": ["printer", "ink"] },
    { "id": "C017", "frequency":  4, "amount_spent":  160.00, "product_types": ["flour", "sugar", "eggs"] },
    { "id": "C018", "frequency": 30, "amount_spent": 4522.60, "product_types": ["gaming-pc", "rgb-mouse", "gaming-chair", "headset"] },
    { "id": "C019", "frequency": 11, "amount_spent":  720.00, "product_types": ["makeup", "skincare"] },
    { "id": "C020", "frequency":  9, "amount_spent":  585.40, "product_types": ["toys", "board-games"] },

    { "id": "C021", "frequency":  2, "amount_spent":   55.00, "product_types": ["candles"] },
    { "id": "C022", "frequency": 18, "amount_spent": 1410.70, "product_types": ["camera", "sd-card"] },
    { "id": "C023", "frequency": 14, "amount_spent":  992.00, "product_types": ["office-chair", "desk-lamp"] },
    { "id": "C024", "frequency":  3, "amount_spent":  135.00, "product_types": ["juice", "cookies"] },
    { "id": "C025", "frequency": 12, "amount_spent":  830.20, "product_types": ["running-shoes", "sports-socks"] },
    { "id": "C026", "frequency": 23, "amount_spent": 2560.00, "product_types": ["fridge", "water-filter"] },
    { "id": "C027", "frequency":  6, "amount_spent":  260.40, "product_types": ["vitamins"] },
    { "id": "C028", "frequency":  5, "amount_spent":  195.99, "product_types": ["wine", "cheese"] },
    { "id": "C029", "frequency": 19, "amount_spent": 1599.95, "product_types": ["e-reader", "ebooks"] },
    { "id": "C030", "frequency": 22, "amount_spent": 2345.00, "product_types": ["washing-machine", "detergent"] },

    { "id": "C031", "frequency":  4, "amount_spent":  175.50, "product_types": ["herbs", "spices"] },
    { "id": "C032", "frequency":  8, "amount_spent":  540.00, "product_types": ["diapers", "baby-wipes", "formula"] },
    { "id": "C033", "frequency": 27, "amount_spent": 3350.80, "product_types": ["console", "controller", "games"] },
    { "id": "C034", "frequency": 10, "amount_spent":  705.35, "product_types": ["sunscreen", "after-sun"] },
    { "id": "C035", "frequency":  3, "amount_spent":  150.00, "product_types": ["frozen-pizza"] },
    { "id": "C036", "frequency": 16, "amount_spent": 1240.60, "product_types": ["tool-set", "drill"] },
    { "id": "C037", "frequency":  9, "amount_spent":  610.10, "product_types": ["organic-vegetables"] },
    { "id": "C038", "frequency": 21, "amount_spent": 2105.00, "product_types": ["air-fryer", "cookbook"] },
    { "id": "C039", "frequency":  7, "amount_spent":  435.75, "product_types": ["flowers", "vase"] },
    { "id": "C040", "frequency": 14, "amount_spent": 1015.90, "product_types": ["winter-jacket", "gloves", "scarf"] }
  ],
  "labels": {
    "C001": 2,
    "C002": 0,
    "C003": 0,
    "C004": 0,
    "C005": 0,
    "C006": 0,
    "C007": 1,
    "C008": 0,
    "C009": 0,
    "C010": 0,
    "C011": 0,
    "C012": 1,
    "C013": 0,
    "C014": 1,
    "C015": 0,
    "C016": 0,
    "C017": 0,
    "C018": 2,
    "C019": 0,
    "C020": 0,
    "C021": 0,
    "C022": 0,
    "C023": 0,
    "C024": 0,
    "C025": 0,
    "C026": 1,
    "C027": 0,
    "C028": 0,
    "C029": 0,
    "C030": 1,
    "C031": 0,
    "C032": 0,
    "C033": 1,
    "C034": 0,
    "C035": 0,
    "C036": 0,
    "C037": 0,
    "C038": 1,
    "C039": 0,
    "C040": 0
  },   // labels from previous route
  "target_cluster": 1,          // omit to analyse every cluster
  "k_range": [2,3]              // optional sweep for sub-K-means
}
```

---

### Resposta

```json
{
    "subsegment_results": {
        "1": {
            "benchmark": [
                {
                    "k": 2,
                    "silhouette": 0.4934960901737213,
                    "davies_bouldin": 0.5208518741969365
                },
                {
                    "k": 3,
                    "silhouette": 0.4140159785747528,
                    "davies_bouldin": 0.4869059685396701
                }
            ],
            "best_k": 2,
            "selection_description": "Inside parent-cluster 1, k = 2 yielded the highest silhouette (0.493) and lowest Davies-Bouldin (0.521).",
            "metric_explanation": {
                "silhouette": "Ranges −1…1; closer to 1 means dense & well-separated.",
                "davies_bouldin": "Lower is better; 0 indicates perfect separation."
            },
            "nested_centroids": {
                "columns": [
                    "frequency",
                    "amount_spent",
                    "n_categories"
                ],
                "values": [
                    [
                        21.5,
                        2223.5,
                        1.75
                    ],
                    [
                        25.33333396911621,
                        3049.199951171875,
                        3.0
                    ]
                ]
            },
            "nested_labels": {
                "C007": 1,
                "C012": 1,
                "C014": 0,
                "C026": 0,
                "C030": 0,
                "C033": 1,
                "C038": 0
            },
            "nested_cluster_legend": [
                {
                    "cluster_id": 0,
                    "n_customers": 4,
                    "avg_spend": 2223.5,
                    "avg_frequency": 21.5,
                    "top_categories": "fitness-watch, fridge, water-filter"
                },
                {
                    "cluster_id": 1,
                    "n_customers": 3,
                    "avg_spend": 3049.2,
                    "avg_frequency": 25.33,
                    "top_categories": "smart-tv, soundbar, hdmi-cable"
                }
            ],
            "nested_interpretations_en": {
                "0": "4 customers, avg spend 2,224, 21.5 purchases/mo. Top categories: fitness-watch, fridge, water-filter.",
                "1": "3 customers, avg spend 3,049, 25.3 purchases/mo. Top categories: smart-tv, soundbar, hdmi-cable."
            }
        }
    }
}
```

---

### Key Objects Explained

| **Path**                          | **Meaning**                                         | **Typical Use**                    |
| --------------------------------- | --------------------------------------------------- | ---------------------------------- |
| `benchmark[]`                     | How each `k` performed                              | Show in a dashboard or notebook    |
| `best_k`, `selection_description` | Why the micro-cluster count was chosen              | Traceability / governance          |
| `nested_centroids`                | Raw feature means for sub-clusters                  | Tooltip metrics in BI tools        |
| `nested_labels`                   | `customer_id → sub_cluster_id` (for target cluster) | Push to CRM for hyper-targeting    |
| `nested_cluster_legend`           | Quick KPIs & top categories per sub-segment         | Helps marketers name the segments  |
| `nested_interpretations_en`       | Plain-English persona blurbs                        | Paste into campaigns or PowerPoint |

---

### Commercial Playbooks

| **Scenario**                                                                           | **How Micro-Segments Help**                 | **KPI Lift Seen**     |
| -------------------------------------------------------------------------------------- | ------------------------------------------- | --------------------- |
| High-value tech buyers split into “Smart-TV addicts” vs “Fitness-watch early adopters” | Tailor product recommendations and creative | **+18%** email CTR    |
| Bulk grocery shoppers split into “Organic enthusiasts” vs “Family staples”             | Personalise coupon bundles; adjust margin   | **+7%** basket margin |
| At-risk low spenders further split by category affinity                                | Deliver category-specific win-back offers   | **−4 pp** churn       |

---

### Best-Practice Workflow

1. Call /purchasing_segmentation (or /purchasing_segmentation_dendrogram) and store the labels.

2. Identify the parent cluster to drill into (e.g., largest size, highest CLV, etc.).

3. POST to /segment_subsegment_explore with the target_cluster.

4. Merge the sub-cluster labels back into your customer master table:

UPDATE crm.customers c
SET sub_cluster = l.nested_id
FROM nested_labels l
WHERE l.customer_id = c.id;

5. Trigger personalized campaigns, dynamic content, or inventory actions based on micro-segment tags.

---

### FAQ

| **Question**                        | **Answer**                                                                                                         |
| ----------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| Can I explore all clusters at once? | Yes — omit `target_cluster`; service returns one object per cluster in `subsegment_results`.                       |
| Why only K-Means?                   | Speed — K-Means is deterministic and \~20× faster at small sizes. Use `/purchasing_segmentation` for richer algos. |
| What about categorical features?    | The API auto one-hots the **top 50 product\_types** to reflect category overlap in clustering.                     |
| Payload limit?                      | 20 MB (\~60,000 customers). Bulk async version planned for **Q4 2025**.                                            |

---

### Próximo Passo
Feed the micro-segment labels into your personalisation engine, or re-run /segment_hierarchy_chart scoped to the parent cluster for an interactive explorer down to “segment-of-five” granularity.

---

