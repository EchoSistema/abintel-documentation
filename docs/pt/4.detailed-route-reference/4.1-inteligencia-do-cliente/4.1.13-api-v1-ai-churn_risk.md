# 4.1.13 /api/v1/ai/churn_risk
+> Nota: tradução gerada automaticamente a partir do inglês; revise antes de publicar.


Predict, Explain & Act on Customer Churn

---

### Objetivo

Feed a flat table of behavior + sentiment + billing signals and receive:

1. An auto-benchmarked model choice (LogReg, Tree, Boosting)

2. Probability-of-churn for every customer

3. Segment-level driver insight (what’s pushing risk up/down)

4. Ready-to-deploy retention playbooks per account

---

### Headers `X-Customer-Api-Id`, `X-Secret`

| Header              | Value              |
| ------------------- | ------------------ |
| `X-Customer-Api-Id` | `<uuid>`           |
| `X-Secret`          | `<secret>`         |
| `Content-Type`      | `application/json` |

---

### POST Endpoint

```yml
POST `https://api-prod.abintel.ai/api/v1/ai/churn_risk`
```

---

### Request Body – Field-by-Field Cheat Sheet

| **JSON Key**        | **Type / Range**      | **Required?** | **Business Meaning**                        | **Typical Derivation**                 |
| ------------------- | --------------------- | ------------- | ------------------------------------------- | -------------------------------------- |
| `data[]`            | array<object>         | Yes           | One row per customer snapshot               | Daily view or rolling weekly export    |
| ↳ `customer_id`     | string                | Yes           | Primary key                                 | CRM / user table                       |
| ↳ `tenure`          | int (days ≥ 0)        | Yes           | Account age at snapshot date                | `DATEDIFF(today, first_purchase_date)` |
| ↳ `usage_frequency` | float (sessions/week) | Yes\*         | Avg. engagement over last 12 weeks          | `AVG(weekly_sessions)`                 |
| ↳ `service_tickets` | int ≥ 0               | Yes\*         | Support tickets opened last 90 days         | Zendesk / Freshdesk export             |
| ↳ `nps`             | int (−100…+100)       | Yes\*         | Latest Net Promoter Score                   | Survey DB; use `0` if missing          |
| ↳ `payment_events`  | int ≥ 0               | Yes\*         | Failed / late payments in last 12 months    | Billing logs                           |
| ↳ `churned`         | 0/1                   | Optional      | Ground-truth label for training/A-B scoring | Omit for inference-only use            |

* The model can impute missing numeric fields using medians, but predictive accuracy may be reduced.

---

### Snapshot-to-Label Rules (Industry Presets)

| **Sector**        | **Churned = 1 if…**                              |
| ----------------- | ------------------------------------------------ |
| Subscription SaaS | Cancelled within 30 days after the snapshot date |
| E-commerce        | No purchase in the following 90 days             |
| Pre-paid usage    | Balance hit zero and no top-up next cycle        |

---

### Requisição

```json
{
  "data": [
    {
      "customer_id": "C-0001",
      "tenure": 915,
      "usage_frequency": 6.2,
      "service_tickets": 1,
      "nps": 58,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0002",
      "tenure": 310,
      "usage_frequency": 1.9,
      "service_tickets": 4,
      "nps": 12,
      "payment_events": 3,
      "churned": 1
    },
    {
      "customer_id": "C-0003",
      "tenure": 442,
      "usage_frequency": 3.1,
      "service_tickets": 0,
      "nps": 70,
      "payment_events": 0,
      "churned": 0
    },
    {
      "customer_id": "C-0004",
      "tenure": 95,
      "usage_frequency": 0.4,
      "service_tickets": 6,
      "nps": -10,
      "payment_events": 4,
      "churned": 1
    }
  ]
}
```

---

### Under the Hood – Model Selection Flow

1. `Pre-processing` z-score numeric fields, one-hot business rules (high ticket, detractor, failed_pay).

2. `Benchmark` 4 algos with defaults tuned for tabular data:

* Logistic Regression (elastic-net)

* Random Forest (100 trees)

* XGBoost (200 trees, depth 6)

* CatBoost (ordered boosting, depth 6)

3. `Validation` 5-fold stratified CV on labelled rows (if labels supplied; else use hold-out training set).

4. Pick algorithm with highest ROC-AUC, tie-break on F1 → Accuracy.

5. `Explain` LogReg coefficients or Tree SHAP summarised at group level (top_factors placeholder ready). Latency ~250 ms for 5 k rows on CPU.

---

### Resposta

```json
{
    "best_algorithm": "Logistic Regression",
    "evaluation_metrics": {
        "Logistic Regression": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "Random Forest": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        },
        "XGBoost": {
            "roc_auc": 0.5,
            "f1": 0.6666666666666666,
            "accuracy": 0.5
        },
        "CatBoost": {
            "roc_auc": 1.0,
            "f1": 1.0,
            "accuracy": 1.0
        }
    },
    "interpretation": "Logistic Regression achieved the highest validation performance (ROC-AUC=1.000, F1=1.000). High ticket volume combined with low NPS were the most influential churn drivers, underscoring the importance of support quality.",
    "results": [
        {
            "customer_id": "C-0001",
            "churn_probability": 1.316118330359693e-22,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0002",
            "churn_probability": 0.9993016452809322,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        },
        {
            "customer_id": "C-0003",
            "churn_probability": 0.0006985619483883015,
            "top_factors": [],
            "recommended_action": "Low risk → continue standard engagement cadence"
        },
        {
            "customer_id": "C-0004",
            "churn_probability": 0.9999999999992972,
            "top_factors": [],
            "recommended_action": "High risk → offer retention discount & priority support"
        }
    ]
}
```

---

### Key Fields

| **Path**               | **Type**      | **Meaning**                                | **Ops Use**                                  |
| ---------------------- | ------------- | ------------------------------------------ | -------------------------------------------- |
| `best_algorithm`       | enum          | Algorithm deployed for inference           | Model-ops audit                              |
| `evaluation_metrics`   | nested object | Cross-validation scores per algorithm      | Gauge confidence, consider alternate models  |
| `interpretation`       | string        | One-paragraph driver summary               | Executive readout                            |
| `results[]`            | array         | Per-customer churn probabilities & actions | Feed to CRM / Customer Success               |
| ↳ `churn_probability`  | float (0–1)   | 0 = loyal, 1 = certain churn               | Use 0.5 as high-risk cut-off                 |
| ↳ `top_factors`        | array<string> | SHAP-style explanation (v1.8+)             | Use in rep scripts: "I noticed your ticket…" |
| ↳ `recommended_action` | enum (text)   | Rule-based retention advice                | Auto-trigger customer journeys               |

---

### Actionable Playbooks

| **Risk Band** | **Probability** | **Recommended Motion**                                 | **Typical Uplift** |
| ------------- | --------------- | ------------------------------------------------------ | ------------------ |
| **High**      | ≥ 0.60          | Offer % discount, priority support, concierge outreach | 15–35% save rate   |
| **Medium**    | 0.25–0.59       | Send value-focused email, usage tips, small promo      | 5–10% save rate    |
| **Low**       | < 0.25          | Light-touch nurture (no incentives)                    | Preserve margin    |

---

### Data Engineering Recipe (SQL)

```SQL
WITH sessions AS (
  SELECT user_id,
         COUNT(*)/12.0 AS usage_frequency
  FROM   app_sessions
  WHERE  session_date >= DATE_SUB(CURDATE(), INTERVAL 12 WEEK)
  GROUP  BY 1
),
tickets AS (
  SELECT user_id,
         COUNT(*) AS service_tickets
  FROM   support_tickets
  WHERE  created_at >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
  GROUP  BY 1
),
payments AS (
  SELECT user_id,
         SUM(CASE WHEN status = 'failed' THEN 1 ELSE 0 END) AS payment_events
  FROM   billing_events
  WHERE  event_date >= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)
  GROUP  BY 1
)
SELECT JSON_ARRAYAGG(
         JSON_OBJECT(
           'customer_id',    u.id,
           'tenure',         DATEDIFF(CURDATE(), u.first_purchase),
           'usage_frequency',COALESCE(s.usage_frequency, 0),
           'service_tickets',COALESCE(t.service_tickets, 0),
           'nps',            COALESCE(f.nps, 0),
           'payment_events', COALESCE(p.payment_events, 0)
         )
       ) AS payload
FROM users u
LEFT JOIN sessions  s ON s.user_id = u.id
LEFT JOIN tickets   t ON t.user_id = u.id
LEFT JOIN payments  p ON p.user_id = u.id
LEFT JOIN feedback  f ON f.user_id = u.id
WHERE u.status = 'active';
```

---

### Commercial Impact

| **Team**         | **Benefit**                                                  |
| ---------------- | ------------------------------------------------------------ |
| Customer Success | Auto-prioritise call lists; no more manual Excel scoring     |
| Finance          | Forecast MRR at risk; support LTV\:CAC models                |
| Product          | Identify UX churn causes (e.g. tickets → drop-off)           |
| Marketing        | Trigger re-engagement only for risk cohorts; save incentives |

---

### FAQ

| **Question**                        | **Answer**                                                                   |
| ----------------------------------- | ---------------------------------------------------------------------------- |
| Why are RF & CatBoost tied at 1.0?  | Demo set is tiny → perfect separation; real-world data = ROC-AUC \~0.75–0.92 |
| What if I only have 3 months’ data? | Model adapts; shorter tenure still valid                                     |
| GDPR considerations?                | No PII — only `customer_id`. Hash before sending externally                  |
| Can I upload 1M rows?               | Max 20MB per call (\~250k rows). Async bulk endpoint coming Q4 2025          |

---

### Próximo Passo

Pipe the results[] table into your CRM or CDP, auto-trigger journeys for high-risk users, and track your churn-save KPI in your BI dashboard.

---

